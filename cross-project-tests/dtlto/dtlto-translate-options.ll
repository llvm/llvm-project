;; Check that the expected Clang arguments are generated by DTLTO for the 
;; backend compilations and are accepted by Clang.

; RUN: rm -rf %t && split-file %s %t && cd %t

;; Generate bitcode files with a summary index.
; RUN: opt -thinlto-bc x86_64-unknown-linux-gnu.ll -o x86_64-unknown-linux-gnu.bc
; RUN: opt -thinlto-bc x86_64-pc-windows-msvc.ll   -o x86_64-pc-windows-msvc.bc


;; Check that any invalid arguments would cause a Clang error. This property is
;; relied on by the actual testcases later in this test.
; RUN: not %clang -x ir x86_64-unknown-linux-gnu.ll \
; RUN:     -invalid-incorrect-not-an-option 2>&1 | FileCheck %s --check-prefix=SANITY1
; SANITY1: unknown argument: '-invalid-incorrect-not-an-option'


;; Define a substitution used to simplify the testcases.
; DEFINE: %{distributor} = dummy
; DEFINE: %{extra_flags} = dummy
; DEFINE: %{triple} = dummy
; DEFINE: %{command} = llvm-lto2 run \
; DEFINE:   -thinlto-distributor-arg=%llvm_src_root/utils/dtlto/%{distributor} \
; DEFINE:   -thinlto-remote-opt-tool-arg=-Wunused-command-line-argument \
; DEFINE:   @%{triple}.rsp %{extra_flags}


;; Write common arguments to a response files.

; RUN: echo "x86_64-unknown-linux-gnu.bc -o x86_64-unknown-linux-gnu.o \
; RUN:       -dtlto \
; RUN:       -dtlto-remote-opt-tool=%clang \
; RUN:       -thinlto-remote-opt-tool-arg=-Werror \
; RUN:       -dtlto-distributor=%python \
; RUN:       -r=x86_64-unknown-linux-gnu.bc,globalfunc1,plx" > x86_64-unknown-linux-gnu.rsp

; RUN: echo "x86_64-pc-windows-msvc.bc -o x86_64-pc-windows-msvc.o \
; RUN:       -dtlto \
; RUN:       -dtlto-remote-opt-tool=%clang \
; RUN:       -thinlto-remote-opt-tool-arg=-Werror \
; RUN:       -thinlto-remote-opt-tool-arg=-Wno-override-module \
; RUN:       -dtlto-distributor=%python \
; RUN:       -r=x86_64-pc-windows-msvc.bc,globalfunc2,plx" > x86_64-pc-windows-msvc.rsp


;; Check that boolean configuration states are translated as expected and Clang
;; accepts them.

; RUN: echo " \
; RUN:   --addrsig=1 \
; RUN:   -function-sections=1 \
; RUN:   -data-sections=1" > on.rsp

; RUN: echo " \
; RUN:   --addrsig=0 \
; RUN:   -function-sections=0 \
; RUN:   -data-sections=0" > off.rsp

;; Perform DTLTO with configuration state set.
; REDEFINE: %{extra_flags} = @on.rsp
; REDEFINE: %{distributor} = local.py
; REDEFINE: %{triple} = x86_64-unknown-linux-gnu
; RUN: %{command}
; REDEFINE: %{distributor} = validate.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=ON \
; RUN:     --implicit-check-not=-no-pgo-warn-mismatch
; ON-DAG: "-faddrsig"
; ON-DAG: "-ffunction-sections"
; ON-DAG: "-fdata-sections"

;; Perform DTLTO with configuration state unset.
; REDEFINE: %{extra_flags} = @off.rsp
; REDEFINE: %{distributor} = local.py
; RUN: %{command}
; REDEFINE: %{distributor} = validate.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=OFF
; OFF-NOT: --implicit-check-not=--faddrsig
; OFF-NOT: --implicit-check-not=--ffunction-sections
; OFF-NOT: --implicit-check-not=--fdata-sections
; OFF-NOT: --implicit-check-not=-no-pgo-warn-mismatch


;; Check optimisation level.

; RUN: llvm-lto2 run \
; RUN:   -thinlto-distributor-arg=%llvm_src_root/utils/dtlto/local.py \
; RUN:   @x86_64-unknown-linux-gnu.rsp \
; RUN:   -O3

; RUN: not llvm-lto2 run \
; RUN:   -thinlto-distributor-arg=%llvm_src_root/utils/dtlto/validate.py \
; RUN:   @x86_64-unknown-linux-gnu.rsp \
; RUN:   -O3 2>&1 | FileCheck %s --check-prefix=OPTLEVEL
; OPTLEVEL-DAG: "-O3"


;; Check relocation model.

; REDEFINE: %{extra_flags} = -relocation-model=pic
; REDEFINE: %{distributor} = local.py
; RUN: %{command}
; REDEFINE: %{distributor} = validate.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=PIC
; PIC: -fpic


; REDEFINE: %{extra_flags} = -relocation-model=pic
; REDEFINE: %{distributor} = local.py
; REDEFINE: %{triple} = x86_64-pc-windows-msvc
; RUN: %{command}
; REDEFINE: %{distributor} = validate.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=NOPIC
; REDEFINE: %{triple} = x86_64-unknown-linux-gnu
; NOPIC-NOT: -fpic

;; Check specifying a sample profile.
; REDEFINE: %{extra_flags} = --lto-sample-profile-file="missing.profdata"
; REDEFINE: %{distributor} = local.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=SAMPLE_PROFILE_ERR
; SAMPLE_PROFILE_ERR: no such file or directory: 'missing.profdata'
; REDEFINE: %{distributor} = validate.py
; RUN: not %{command} 2>&1 | FileCheck %s --check-prefix=SAMPLE_PROFILE
; SAMPLE_PROFILE-DAG: "-fprofile-sample-use=missing.profdata"


;--- x86_64-unknown-linux-gnu.ll

target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

define void @globalfunc1() {
entry:
  ret void
}

;--- x86_64-pc-windows-msvc.ll

target datalayout = "e-m:w-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-pc-windows-msvc"

define void @globalfunc2() {
entry:
  ret void
}
