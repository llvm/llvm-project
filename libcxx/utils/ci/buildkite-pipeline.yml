#===----------------------------------------------------------------------===##
#
# Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
#
#===----------------------------------------------------------------------===##

#
# This file describes the various pre-commit CI bots used to test libc++.
#
# This file should never contain logic -- all the logic must be offloaded
# into scripts. This is critical to being able to reproduce CI issues outside
# of the CI environment, which is important for debugging.
#
# It is also worth noting that this script is split into several sections, the
# goal being to reduce the load on testers when a commit is known to fail.
#

# The Linux CI runners use the nightly ToT build provided by the Docker image.
# (Note the image isn't updated daily.) The LLVM_HEAD_VERSION contains that
# version number. The Linux CI runners for GCC use the latest stable version.
# Theses numbers are available in all runners, making it easier to update the
# version number.
env:
    # LLVM POST-BRANCH bump version
    # LLVM POST-BRANCH add compiler test for ToT - 1, e.g. "Clang 17"
    # LLVM RELEASE bump remove compiler ToT - 3, e.g. "Clang 15"
    LLVM_HEAD_VERSION: "18"   # Used compiler, update POST-BRANCH.
    GCC_STABLE_VERSION: "13"

definitions:
  _common: &common
    timeout_in_minutes: 120
    retry:
      automatic:
        - exit_status: -1  # Agent was lost
          limit: 2
    artifact_paths:
      - "**/test-results.xml"
      - "**/*.abilist"
      - "**/crash_diagnostics/*"

environment_definitions:
  _common_env: &common_env
      ENABLE_CLANG_TIDY: "On"
      LLVM_SYMBOLIZER_PATH: "/usr/bin/llvm-symbolizer-${LLVM_HEAD_VERSION}"
      CLANG_CRASH_DIAGNOSTICS_DIR: "crash_diagnostics"
      CC: clang-${LLVM_HEAD_VERSION}
      CXX: clang++-${LLVM_HEAD_VERSION}
      CMAKE: /opt/bin/cmake

  _absolute_path_clang: &absolute_path_clang
    # Note modules require and absolute path for clang-scan-deps
    # https://github.com/llvm/llvm-project/issues/61006
    CC: /usr/lib/llvm-${LLVM_HEAD_VERSION}/bin/clang
    CXX: /usr/lib/llvm-${LLVM_HEAD_VERSION}/bin/clang++


steps:
- group: ':windows: Windows'
  steps:
  - label: Clang-cl (DLL)
    command: bash libcxx/utils/ci/run-buildbot clang-cl-dll
    agents:
      queue: windows-test
    <<: *common

  - label: Clang-cl (Static)
    command: bash libcxx/utils/ci/run-buildbot clang-cl-static
    agents:
      queue: windows-test
    <<: *common

  - label: Clang-cl (no vcruntime exceptions)
    command: bash libcxx/utils/ci/run-buildbot clang-cl-no-vcruntime
    <<: *common
    agents:
      queue: windows-test

  - label: Clang-cl (Debug mode)
    command: bash libcxx/utils/ci/run-buildbot clang-cl-debug
    agents:
      queue: windows-test
    <<: *common

  - label: Clang-cl (Static CRT)
    command: bash libcxx/utils/ci/run-buildbot clang-cl-static-crt
    agents:
      queue: windows-test
    <<: *common

  - label: MinGW (DLL, x86_64)
    command: bash libcxx/utils/ci/run-buildbot mingw-dll
    agents:
      queue: windows-test
    <<: *common

  - label: MinGW (Static, x86_64)
    command: bash libcxx/utils/ci/run-buildbot mingw-static
    agents:
      queue: windows-test
    <<: *common

  - label: MinGW (DLL, i686)
    command: bash libcxx/utils/ci/run-buildbot mingw-dll-i686
    agents:
      queue: windows-test
    <<: *common
