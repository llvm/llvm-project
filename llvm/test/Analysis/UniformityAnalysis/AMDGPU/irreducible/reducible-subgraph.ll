; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -S -mtriple=amdgcn-amd-amdhsa -passes='print<uniformity>' %s 2>&1 | FileCheck %s

; In this test, the cycle (bb.3 <-> bb.4) is reducible, but the header is not
; the join block bb.4 of the divergent terminator block bb.5. This should not
; cause an assertion failure.

define void @uniformity_analysis_crash(i1 %v.0, i1 %v.1, i1 %v.2) {
; CHECK-LABEL: define void @uniformity_analysis_crash(
; CHECK-SAME: i1 [[V_0:%.*]], i1 [[V_1:%.*]], i1 [[V_2:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    br i1 [[V_0]], label %[[BB_1:.*]], label %[[BB_2:.*]]
; CHECK:       [[BB_1]]:
; CHECK-NEXT:    br label %[[BB_3:.*]]
; CHECK:       [[BB_3]]:
; CHECK-NEXT:    br i1 [[V_1]], label %[[BB_5:.*]], label %[[BB_4:.*]]
; CHECK:       [[BB_4]]:
; CHECK-NEXT:    br label %[[BB_3]]
; CHECK:       [[BB_5]]:
; CHECK-NEXT:    br i1 [[V_2]], label %[[BB_6:.*]], label %[[BB_7:.*]]
; CHECK:       [[BB_6]]:
; CHECK-NEXT:    br label %[[BB_2]]
; CHECK:       [[BB_7]]:
; CHECK-NEXT:    br label %[[BB_8:.*]]
; CHECK:       [[BB_8]]:
; CHECK-NEXT:    br label %[[BB_3]]
; CHECK:       [[BB_2]]:
; CHECK-NEXT:    br label %[[BB_8]]
;
entry:
  br i1 %v.0, label %bb.1, label %bb.2

bb.1:                                             ; preds = %entry
  br label %bb.3

bb.3:                                             ; preds = %bb.8, %bb.4, %bb.1
  br i1 %v.1, label %bb.5, label %bb.4

bb.4:                                             ; preds = %bb.3
  br label %bb.3

bb.5:                                             ; preds = %bb.3
  br i1 %v.2, label %bb.6, label %bb.7

bb.6:                                             ; preds = %bb.5
  br label %bb.2

bb.7:                                             ; preds = %bb.5
  br label %bb.8

bb.8:                                             ; preds = %bb.2, %bb.7
  br label %bb.3

bb.2:                                             ; preds = %bb.6, %entry
  br label %bb.8
}
