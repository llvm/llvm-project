# RUN: llc -mtriple=amdgcn-- -mcpu=gfx900 -run-pass=print-machine-uniformity -o - %s 2>&1 | FileCheck %s
# RUN: llc -mtriple=amdgcn-- -mcpu=gfx900 -passes='print<machine-uniformity>' -filetype=null %s 2>&1 | FileCheck %s

# Test per-output uniformity analysis for amdgcn.if and amdgcn.else intrinsics.
# These intrinsics produce two outputs:
#   - First result (i1): Inherits divergence from the input condition.
#   - Second result (i64): Saved exec mask - always uniform.

# Test amdgcn.if with UNIFORM input
---
name:            amdgcn_if_uniform_input
tracksRegLiveness: true
machineFunctionInfo:
  isEntryFunction: true
body:             |
  bb.0:
    ; CHECK-LABEL: MachineUniformityInfo for function:  @amdgcn_if_uniform_input
    ; Currently both outputs are marked divergent even with uniform input
    ; CHECK: DIVERGENT: %1
    ; CHECK: DIVERGENT: %2
    %0:_(s1) = G_IMPLICIT_DEF
    %1:_(s1), %2:_(s64) = G_INTRINSIC_W_SIDE_EFFECTS intrinsic(@llvm.amdgcn.if), %0:_(s1)
    S_ENDPGM 0
...

# Test amdgcn.if with DIVERGENT input
---
name:            amdgcn_if_divergent_input
tracksRegLiveness: true
machineFunctionInfo:
  isEntryFunction: true
body:             |
  bb.0:
    ; CHECK-LABEL: MachineUniformityInfo for function:  @amdgcn_if_divergent_input
    ; Both outputs are divergent
    ; CHECK: DIVERGENT: %3
    ; CHECK: DIVERGENT: %4
    %0:_(s32) = G_INTRINSIC intrinsic(@llvm.amdgcn.workitem.id.x)
    %1:_(s32) = G_CONSTANT i32 16
    %2:_(s1) = G_ICMP intpred(slt), %0:_(s32), %1:_
    %3:_(s1), %4:_(s64) = G_INTRINSIC_W_SIDE_EFFECTS intrinsic(@llvm.amdgcn.if), %2:_(s1)
    S_ENDPGM 0
...

# Test amdgcn.else with UNIFORM input
---
name:            amdgcn_else_uniform_input
tracksRegLiveness: true
machineFunctionInfo:
  isEntryFunction: true
body:             |
  bb.0:
    ; CHECK-LABEL: MachineUniformityInfo for function:  @amdgcn_else_uniform_input
    ; Currently both outputs are marked divergent even with uniform input
    ; CHECK: DIVERGENT: %1
    ; CHECK: DIVERGENT: %2
    %0:_(s64) = G_IMPLICIT_DEF
    %1:_(s1), %2:_(s64) = G_INTRINSIC_W_SIDE_EFFECTS intrinsic(@llvm.amdgcn.else), %0:_(s64)
    S_ENDPGM 0
...

# Test amdgcn.else with DIVERGENT input
---
name:            amdgcn_else_divergent_input
tracksRegLiveness: true
machineFunctionInfo:
  isEntryFunction: true
body:             |
  bb.0:
    ; CHECK-LABEL: MachineUniformityInfo for function:  @amdgcn_else_divergent_input
    ; Both outputs are divergent
    ; CHECK: DIVERGENT: %2
    ; CHECK: DIVERGENT: %3
    %0:_(s32) = G_INTRINSIC intrinsic(@llvm.amdgcn.workitem.id.x)
    %1:_(s64) = G_ZEXT %0:_(s32)
    %2:_(s1), %3:_(s64) = G_INTRINSIC_W_SIDE_EFFECTS intrinsic(@llvm.amdgcn.else), %1:_(s64)
    S_ENDPGM 0
...
