; NOTE: Assertions have been autogenerated by utils/update_analyze_test_checks.py UTC_ARGS: --version 5
; RUN: opt < %s -disable-output "-passes=print<da>" -aa-pipeline=basic-aa 2>&1 \
; RUN: | FileCheck %s

; Test case for bug #149991 where Strong SIV test incorrectly concludes "no dependence"
; when the coefficient is symbolic (unknown at compile time) and delta is zero.
;
; In this case, the array access is A[k*i] with both src and dst at the same
; location in the same iteration. If k=0, then all iterations access the same
; element, meaning there IS a dependence between different iterations.
; The Strong SIV test should add a runtime assumption that k != 0.

define void @test_zero_coefficient(ptr noalias %A, i64 %k) {
; CHECK-LABEL: 'test_zero_coefficient'
; CHECK-NEXT:  Src: store i8 42, ptr %idx, align 1 --> Dst: store i8 42, ptr %idx, align 1
; CHECK-NEXT:    da analyze - consistent output [0]!
; CHECK-NEXT:    Runtime Assumptions:
; CHECK-NEXT:    Compare predicate: %k ne) 0
;
entry:
  br label %loop

loop:
  %i = phi i64 [ 0, %entry ], [ %i.next, %loop ]
  %off = mul nsw i64 %i, %k
  %idx = getelementptr inbounds i8, ptr %A, i64 %off
  store i8 42, ptr %idx, align 1
  %i.next = add nsw i64 %i, 1
  %cmp = icmp slt i64 %i.next, 100
  br i1 %cmp, label %loop, label %exit

exit:
  ret void
}
