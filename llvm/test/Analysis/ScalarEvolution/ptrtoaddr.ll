; NOTE: Assertions have been autogenerated by utils/update_analyze_test_checks.py
; RUN: opt -passes='print<scalar-evolution>' -disable-output %s 2>&1 | FileCheck %s

; Address space 2 has unstable pointer representation.
; Address space 3 has external state but stable representation.
target datalayout="p:64:64:64:64-pu2:64:64:64:64-pe3:64:64:64:64"

define void @ptrtoaddr(ptr %in, ptr %out0, ptr %out1, ptr %out2, ptr %out3) {
; CHECK-LABEL: 'ptrtoaddr'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr
; CHECK-NEXT:    %p0 = ptrtoaddr ptr %in to i64
; CHECK-NEXT:    --> (ptrtoaddr ptr %in to i64) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr
;
  %p0 = ptrtoaddr ptr %in to i64
  store i64  %p0, ptr  %out0
  ret void
}

define void @ptrtoaddr_as1(ptr addrspace(1) %in, ptr %out0, ptr %out1, ptr %out2, ptr %out3) {
; CHECK-LABEL: 'ptrtoaddr_as1'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_as1
; CHECK-NEXT:    %p0 = ptrtoaddr ptr addrspace(1) %in to i64
; CHECK-NEXT:    --> (ptrtoaddr ptr addrspace(1) %in to i64) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_as1
;
  %p0 = ptrtoaddr ptr addrspace(1) %in to i64
  store i64  %p0, ptr  %out0
  ret void
}

define void @ptrtoaddr_of_bitcast(ptr %in, ptr %out0) {
; CHECK-LABEL: 'ptrtoaddr_of_bitcast'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_of_bitcast
; CHECK-NEXT:    %in_casted = bitcast ptr %in to ptr
; CHECK-NEXT:    --> %in U: full-set S: full-set
; CHECK-NEXT:    %p0 = ptrtoaddr ptr %in_casted to i64
; CHECK-NEXT:    --> (ptrtoaddr ptr %in to i64) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_of_bitcast
;
  %in_casted = bitcast ptr %in to ptr
  %p0 = ptrtoaddr ptr %in_casted to i64
  store i64 %p0, ptr %out0
  ret void
}

define void @ptrtoaddr_of_nullptr(ptr %out0) {
; CHECK-LABEL: 'ptrtoaddr_of_nullptr'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_of_nullptr
; CHECK-NEXT:    %p0 = ptrtoaddr ptr null to i64
; CHECK-NEXT:    --> 0 U: [0,1) S: [0,1)
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_of_nullptr
;
  %p0 = ptrtoaddr ptr null to i64
  store i64 %p0, ptr %out0
  ret void
}

define void @ptrtoaddr_of_gep(ptr %in, ptr %out0) {
; CHECK-LABEL: 'ptrtoaddr_of_gep'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_of_gep
; CHECK-NEXT:    %in_adj = getelementptr inbounds i8, ptr %in, i64 42
; CHECK-NEXT:    --> (42 + %in) U: full-set S: full-set
; CHECK-NEXT:    %p0 = ptrtoaddr ptr %in_adj to i64
; CHECK-NEXT:    --> (42 + (ptrtoaddr ptr %in to i64)) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_of_gep
;
  %in_adj = getelementptr inbounds i8, ptr %in, i64 42
  %p0 = ptrtoaddr ptr %in_adj to i64
  store i64  %p0, ptr  %out0
  ret void
}

define void @ptrtoaddr_of_gep_with_unknown_int(ptr %in, ptr %out0, ptr %offset) {
; CHECK-LABEL: 'ptrtoaddr_of_gep_with_unknown_int'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_of_gep_with_unknown_int
; CHECK-NEXT:    %l = load i64, ptr %offset, align 4
; CHECK-NEXT:    --> %l U: full-set S: full-set
; CHECK-NEXT:    %in_adj = getelementptr inbounds i8, ptr %in, i64 %l
; CHECK-NEXT:    --> (%l + %in) U: full-set S: full-set
; CHECK-NEXT:    %p0 = ptrtoaddr ptr %in_adj to i64
; CHECK-NEXT:    --> ((ptrtoaddr ptr %in to i64) + %l) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_of_gep_with_unknown_int
;
  %l = load i64, ptr %offset
  %in_adj = getelementptr inbounds i8, ptr %in, i64 %l
  %p0 = ptrtoaddr ptr %in_adj to i64
  store i64  %p0, ptr  %out0
  ret void
}

; ptrtoaddr of a pointer with unstable representation should return SCEVUnknown.
define void @ptrtoaddr_unstable(ptr addrspace(2) %in, ptr %out) {
; CHECK-LABEL: 'ptrtoaddr_unstable'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_unstable
; CHECK-NEXT:    %p = ptrtoaddr ptr addrspace(2) %in to i64
; CHECK-NEXT:    --> %p U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_unstable
;
  %p = ptrtoaddr ptr addrspace(2) %in to i64
  store i64 %p, ptr %out
  ret void
}

; ptrtoaddr of GEP on unstable pointer should return SCEVUnknown.
define void @ptrtoaddr_unstable_gep(ptr addrspace(2) %in, ptr %out) {
; CHECK-LABEL: 'ptrtoaddr_unstable_gep'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_unstable_gep
; CHECK-NEXT:    %gep = getelementptr inbounds i8, ptr addrspace(2) %in, i64 42
; CHECK-NEXT:    --> (42 + %in) U: full-set S: full-set
; CHECK-NEXT:    %p = ptrtoaddr ptr addrspace(2) %gep to i64
; CHECK-NEXT:    --> %p U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_unstable_gep
;
  %gep = getelementptr inbounds i8, ptr addrspace(2) %in, i64 42
  %p = ptrtoaddr ptr addrspace(2) %gep to i64
  store i64 %p, ptr %out
  ret void
}

; ptrtoaddr of nullptr in unstable address space should return SCEVUnknown.
define void @ptrtoaddr_unstable_null(ptr %out) {
; CHECK-LABEL: 'ptrtoaddr_unstable_null'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_unstable_null
; CHECK-NEXT:    %p = ptrtoaddr ptr addrspace(2) null to i64
; CHECK-NEXT:    --> %p U: [0,1) S: [0,1)
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_unstable_null
;
  %p = ptrtoaddr ptr addrspace(2) null to i64
  store i64 %p, ptr %out
  ret void
}

; Address space 3 is non-integral with external state but stable representation.
define void @ptrtoaddr_nonintegral_stable(ptr addrspace(3) %in, ptr %out) {
; CHECK-LABEL: 'ptrtoaddr_nonintegral_stable'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_nonintegral_stable
; CHECK-NEXT:    %p = ptrtoaddr ptr addrspace(3) %in to i64
; CHECK-NEXT:    --> (ptrtoaddr ptr addrspace(3) %in to i64) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_nonintegral_stable
;
  %p = ptrtoaddr ptr addrspace(3) %in to i64
  store i64 %p, ptr %out
  ret void
}

define void @ptrtoaddr_nonintegral_stable_gep(ptr addrspace(3) %in, ptr %out) {
; CHECK-LABEL: 'ptrtoaddr_nonintegral_stable_gep'
; CHECK-NEXT:  Classifying expressions for: @ptrtoaddr_nonintegral_stable_gep
; CHECK-NEXT:    %gep = getelementptr inbounds i8, ptr addrspace(3) %in, i64 42
; CHECK-NEXT:    --> (42 + %in) U: full-set S: full-set
; CHECK-NEXT:    %p = ptrtoaddr ptr addrspace(3) %gep to i64
; CHECK-NEXT:    --> (42 + (ptrtoaddr ptr addrspace(3) %in to i64)) U: full-set S: full-set
; CHECK-NEXT:  Determining loop execution counts for: @ptrtoaddr_nonintegral_stable_gep
;
  %gep = getelementptr inbounds i8, ptr addrspace(3) %in, i64 42
  %p = ptrtoaddr ptr addrspace(3) %gep to i64
  store i64 %p, ptr %out
  ret void
}
