## Test big archive recognition with same-named members (XCOFF format).
## Big archives can contain multiple members with the same name but different
## architectures. This test verifies llvm-symbolizer can disambiguate using
## architecture specification.

# RUN: rm -rf %t.dir && mkdir %t.dir && cd %t.dir

# RUN: yaml2obj --docnum=1 %s -o 32.o
# RUN: yaml2obj --docnum=2 %s -o 64.o

## Create archive with same-named members using different modes.
# RUN: cp 32.o test.o
# RUN: llvm-ar %if system-aix %{-X32%} crv archive.a test.o
# RUN: cp 64.o test.o
# RUN: llvm-ar %if system-aix %{-X64 rv%} %else %{qv%} archive.a test.o

## Test symbolization disambiguates between 32-bit and 64-bit members
## using architecture specified via --default-arch flag.
# RUN: llvm-symbolizer --default-arch=ppc --obj="archive.a(test.o)" 0x0 | FileCheck %s --check-prefix=CHECK-32
# RUN: llvm-symbolizer --default-arch=ppc64 --obj="archive.a(test.o)" 0x0 | FileCheck %s --check-prefix=CHECK-64

## Test architecture specified via :arch suffix notation.
# RUN: llvm-symbolizer --obj="archive.a(test.o):ppc" 0x0 | FileCheck %s --check-prefix=CHECK-32
# RUN: llvm-symbolizer --obj="archive.a(test.o):ppc64" 0x0 | FileCheck %s --check-prefix=CHECK-64

# CHECK-32: foo32
# CHECK-64: foo64

## Test error cases.
# RUN: not llvm-symbolizer --obj="archive.a(nonexistent.o)" 0x1000 2>&1 | FileCheck %s --check-prefix=CHECK-ERROR
# CHECK-ERROR: error: no matching member 'nonexistent.o' with arch {{.*}} in 'archive.a'

# RUN: not llvm-symbolizer --obj="test.o(test.o)" 0x1000 2>&1 | FileCheck %s --check-prefix=CHECK-NOTARCHIVE
# CHECK-NOTARCHIVE: error: 'test.o' is not a valid archive

# RUN: not llvm-symbolizer --obj="archive.a()" 0x1000 2>&1 | FileCheck %s --check-prefix=CHECK-NOSYMBOL
# CHECK-NOSYMBOL: error: no matching member '' with arch {{.*}} in 'archive.a'

## 32-bit XCOFF object.
--- !XCOFF
FileHeader:
  MagicNumber: 0x1DF
Sections:
  - Name:        .text
    Flags:       [ STYP_TEXT ]
    SectionData: 4E800020
Symbols:
  - Name:                .file
    Section:             N_DEBUG
    StorageClass:        C_FILE
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:            AUX_FILE
        FileNameOrString: foo.c
        FileStringType:  XFT_FN
  - Name:                .foo32
    Section:             .text
    StorageClass:        C_EXT
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:                   AUX_CSECT
        SymbolType:              XTY_LD
        StorageMappingClass:     XMC_PR
  - Name:                foo32
    Section:             .text
    StorageClass:        C_EXT
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:                   AUX_CSECT
        SymbolType:              XTY_SD
        StorageMappingClass:     XMC_PR

## 64-bit XCOFF object.
--- !XCOFF
FileHeader:
  MagicNumber: 0x1F7
Sections:
  - Name:        .text
    Flags:       [ STYP_TEXT ]
    SectionData: 4E800020
Symbols:
  - Name:                .file
    Section:             N_DEBUG
    StorageClass:        C_FILE
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:            AUX_FILE
        FileNameOrString: foo.c
        FileStringType:  XFT_FN
  - Name:                .foo64
    Section:             .text
    StorageClass:        C_EXT
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:                   AUX_CSECT
        SymbolType:              XTY_LD
        StorageMappingClass:     XMC_PR
  - Name:                foo64
    Section:             .text
    StorageClass:        C_EXT
    NumberOfAuxEntries:  1
    AuxEntries:
      - Type:                   AUX_CSECT
        SymbolType:              XTY_SD
        StorageMappingClass:     XMC_PR
