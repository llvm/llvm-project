## Bail out if a section consisting of symidx is invalid.
## It includes both: an unexpected format for patching section data and
## updating the checksum, as well as data validity.
## Essentially, the expected format is a definitive symbol with a zero offset
## linked to the section. Valid data consists of a sequence of symbol indices
## that remain in the symbol table even after stripping.

## In this case, the symbol .gfids$y is not present at all.

# RUN: yaml2obj %s --docnum=1 -o %t1.in.o
# RUN: not llvm-objcopy --strip-debug %t1.in.o %t1.out.o 2>&1 | FileCheck %s --check-prefix=ERROR-NOSYM

# ERROR-NOSYM: section '.gfids$y' does not have the corresponding symbol or the symbol has unexpected format

--- !COFF
header:
  Machine:         IMAGE_FILE_MACHINE_AMD64
  Characteristics: [  ]
sections:
  - Name:            .text
    Characteristics: [ IMAGE_SCN_CNT_CODE, IMAGE_SCN_MEM_EXECUTE, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     488D0500000000488D0D00000000488D0500000000488D0500000000
    SizeOfRawData:   28
    Relocations:
      - VirtualAddress:  3
        SymbolName:      foo
        Type:            IMAGE_REL_AMD64_REL32
  - Name:            '.gfids$y'
    Characteristics: [ IMAGE_SCN_CNT_INITIALIZED_DATA, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     '04000000'
    SizeOfRawData:   8
symbols:
  - Name:            .text
    Value:           0
    SectionNumber:   1
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          28
      NumberOfRelocations: 4
      NumberOfLinenumbers: 0
      CheckSum:        3583480811
      Number:          1
  - Name:            foo
    Value:           0
    SectionNumber:   0
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_EXTERNAL
...

## In this case, the symbol .giats$y has a non-zero offset.

# RUN: yaml2obj %s --docnum=2 -o %t2.in.o
# RUN: not llvm-objcopy --strip-debug %t2.in.o %t2.out.o 2>&1 | FileCheck %s --check-prefix=ERROR-OFFSET

# ERROR-OFFSET: section '.giats$y' does not have the corresponding symbol or the symbol has unexpected format

--- !COFF
header:
  Machine:         IMAGE_FILE_MACHINE_AMD64
  Characteristics: [  ]
sections:
  - Name:            .text
    Characteristics: [ IMAGE_SCN_CNT_CODE, IMAGE_SCN_MEM_EXECUTE, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     488D0500000000488D0D00000000488D0500000000488D0500000000
    SizeOfRawData:   28
    Relocations:
      - VirtualAddress:  3
        SymbolName:      foo
        Type:            IMAGE_REL_AMD64_REL32
  - Name:            '.giats$y'
    Characteristics: [ IMAGE_SCN_CNT_INITIALIZED_DATA, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     '0600000010000000'
    SizeOfRawData:   8
symbols:
  - Name:            .text
    Value:           0
    SectionNumber:   1
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          28
      NumberOfRelocations: 4
      NumberOfLinenumbers: 0
      CheckSum:        3583480811
      Number:          1
  - Name:            '.giats$y'
    Value:           42
    SectionNumber:   2
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          8
      NumberOfRelocations: 0
      NumberOfLinenumbers: 0
      CheckSum:        1167279533
      Number:          5
  - Name:            foo
    Value:           0
    SectionNumber:   0
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_EXTERNAL
...

## In this case, the symbol .gljmp$y has a non-static storage class.

# RUN: yaml2obj %s --docnum=3 -o %t3.in.o
# RUN: not llvm-objcopy --strip-debug %t3.in.o %t3.out.o 2>&1 | FileCheck %s --check-prefix=ERROR-EXTERNAL

# ERROR-EXTERNAL: section '.gljmp$y' does not have the corresponding symbol or the symbol has unexpected format

--- !COFF
header:
  Machine:         IMAGE_FILE_MACHINE_AMD64
  Characteristics: [  ]
sections:
  - Name:            .text
    Characteristics: [ IMAGE_SCN_CNT_CODE, IMAGE_SCN_MEM_EXECUTE, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     488D0500000000488D0D00000000488D0500000000488D0500000000
    SizeOfRawData:   28
    Relocations:
      - VirtualAddress:  3
        SymbolName:      foo
        Type:            IMAGE_REL_AMD64_REL32
  - Name:            '.gljmp$y'
    Characteristics: [ IMAGE_SCN_CNT_INITIALIZED_DATA, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     '0600000010000000'
    SizeOfRawData:   8
symbols:
  - Name:            .text
    Value:           0
    SectionNumber:   1
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          28
      NumberOfRelocations: 4
      NumberOfLinenumbers: 0
      CheckSum:        3583480811
      Number:          1
  - Name:            '.gljmp$y'
    Value:           0
    SectionNumber:   2
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_EXTERNAL
  - Name:            foo
    Value:           0
    SectionNumber:   0
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_EXTERNAL
...

## In this case, .gfids$y contains a symbol index that is not present in the
## symbol table. Generally the behavior should be the same for every section consisting
## of .symidx directives, e.g .giats$y, .gljmp$y and .gehcont$y.

# RUN: yaml2obj %s --docnum=4 -o %t4.in.o
# RUN: not llvm-objcopy --strip-debug %t4.in.o %t4.out.o 2>&1 | FileCheck %s --check-prefix=ERROR-SYMIDX

# ERROR-SYMIDX: section '.gfids$y' contains a .symidx (16) that is incorrect or was stripped
--- !COFF
header:
  Machine:         IMAGE_FILE_MACHINE_AMD64
  Characteristics: [  ]
sections:
  - Name:            .text
    Characteristics: [ IMAGE_SCN_CNT_CODE, IMAGE_SCN_MEM_EXECUTE, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     488D0500000000488D0D00000000488D0500000000488D0500000000
    SizeOfRawData:   28
    Relocations:
      - VirtualAddress:  3
        SymbolName:      foo
        Type:            IMAGE_REL_AMD64_REL32
  - Name:            '.gfids$y'
    Characteristics: [ IMAGE_SCN_CNT_INITIALIZED_DATA, IMAGE_SCN_MEM_READ ]
    Alignment:       4
    SectionData:     '0400000010000000'
    SizeOfRawData:   8
symbols:
  - Name:            .text
    Value:           0
    SectionNumber:   1
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          28
      NumberOfRelocations: 4
      NumberOfLinenumbers: 0
      CheckSum:        3583480811
      Number:          1
  - Name:            '.gfids$y'
    Value:           0
    SectionNumber:   2
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_STATIC
    SectionDefinition:
      Length:          8
      NumberOfRelocations: 0
      NumberOfLinenumbers: 0
      CheckSum:        1167279533
      Number:          5
  - Name:            foo
    Value:           0
    SectionNumber:   0
    SimpleType:      IMAGE_SYM_TYPE_NULL
    ComplexType:     IMAGE_SYM_DTYPE_NULL
    StorageClass:    IMAGE_SYM_CLASS_EXTERNAL
...
