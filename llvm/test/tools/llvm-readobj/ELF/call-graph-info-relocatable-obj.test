## Tests how --call-graph-info prints the call graph information.
# RUN: yaml2obj --docnum=1 %s -o %t
# RUN: llvm-readelf --call-graph-info %t 2>&1 | FileCheck %s --match-full-lines --allow-empty -DFILE=%t
# RUN: llvm-readelf --elf-output-style=LLVM --call-graph-info %t 2>&1 | FileCheck %s --match-full-lines --check-prefix=LLVM -DFILE=%t
# RUN: llvm-readelf --elf-output-style=JSON --pretty-print --call-graph-info %t 2>&1 | FileCheck %s --match-full-lines --check-prefix=JSON -DFILE=%t

## We do not support GNU format console output for --call-graph-info as it is an LLVM only info.
# CHECK-NOT: .

# LLVM:   CallGraph [
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: foo
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     IsIndirectTarget: Yes
# LLVM-NEXT:     TypeId: 0xF85C699BB8EF20A2
# LLVM-NEXT:     NumDirectCallees: 0
# LLVM-NEXT:     DirectCallees [
# LLVM-NEXT:     ]
# LLVM-NEXT:     NumIndirectTargetTypeIDs: 0
# LLVM-NEXT:     IndirectTypeIDs: []
# LLVM-NEXT:   }
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: bar
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     IsIndirectTarget: Yes
# LLVM-NEXT:     TypeId: 0xF85C699BB8EF20A2
# LLVM-NEXT:     NumDirectCallees: 0
# LLVM-NEXT:     DirectCallees [
# LLVM-NEXT:     ]
# LLVM-NEXT:     NumIndirectTargetTypeIDs: 0
# LLVM-NEXT:     IndirectTypeIDs: []
# LLVM-NEXT:   }
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: baz
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     IsIndirectTarget: Yes
# LLVM-NEXT:     TypeId: 0x308E4B8159BC8654
# LLVM-NEXT:     NumDirectCallees: 0
# LLVM-NEXT:     DirectCallees [
# LLVM-NEXT:     ]
# LLVM-NEXT:     NumIndirectTargetTypeIDs: 0
# LLVM-NEXT:     IndirectTypeIDs: []
# LLVM-NEXT:   }
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: caller
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     IsIndirectTarget: Yes
# LLVM-NEXT:     TypeId: 0xA9494DEF81A01DC
# LLVM-NEXT:     NumDirectCallees: 3
# LLVM-NEXT:     DirectCallees [
# LLVM-NEXT:       {
# LLVM-NEXT:         Name: foo
# LLVM-NEXT:       }
# LLVM-NEXT:       {
# LLVM-NEXT:         Name: bar
# LLVM-NEXT:       }
# LLVM-NEXT:       {
# LLVM-NEXT:         Name: baz
# LLVM-NEXT:       }
# LLVM-NEXT:     ]
# LLVM-NEXT:     NumIndirectTargetTypeIDs: 2
# LLVM-NEXT:     IndirectTypeIDs: [0xF85C699BB8EF20A2, 0x308E4B8159BC8654]
# LLVM-NEXT:   }
# LLVM-NEXT: ]

# JSON:     "CallGraph": [
# JSON-NEXT:      {
# JSON-NEXT:        "Function": {
# JSON-NEXT:          "Name": "foo",
# JSON-NEXT:          "Version": 0,
# JSON-NEXT:          "IsIndirectTarget": true,
# JSON-NEXT:          "TypeId": 17896295136807035042,
# JSON-NEXT:          "NumDirectCallees": 0,
# JSON-NEXT:          "DirectCallees": [],
# JSON-NEXT:          "NumIndirectTargetTypeIDs": 0,
# JSON-NEXT:          "IndirectTypeIDs": []
# JSON-NEXT:        }
# JSON-NEXT:      },
# JSON-NEXT:      {
# JSON-NEXT:        "Function": {
# JSON-NEXT:          "Name": "bar",
# JSON-NEXT:          "Version": 0,
# JSON-NEXT:          "IsIndirectTarget": true,
# JSON-NEXT:          "TypeId": 17896295136807035042,
# JSON-NEXT:          "NumDirectCallees": 0,
# JSON-NEXT:          "DirectCallees": [],
# JSON-NEXT:          "NumIndirectTargetTypeIDs": 0,
# JSON-NEXT:          "IndirectTypeIDs": []
# JSON-NEXT:        }
# JSON-NEXT:      },
# JSON-NEXT:      {
# JSON-NEXT:        "Function": {
# JSON-NEXT:          "Name": "baz",
# JSON-NEXT:          "Version": 0,
# JSON-NEXT:          "IsIndirectTarget": true,
# JSON-NEXT:          "TypeId": 3498816979441845844,
# JSON-NEXT:          "NumDirectCallees": 0,
# JSON-NEXT:          "DirectCallees": [],
# JSON-NEXT:          "NumIndirectTargetTypeIDs": 0,
# JSON-NEXT:          "IndirectTypeIDs": []
# JSON-NEXT:        }
# JSON-NEXT:      },
# JSON-NEXT:      {
# JSON-NEXT:        "Function": {
# JSON-NEXT:          "Name": "caller",
# JSON-NEXT:          "Version": 0,
# JSON-NEXT:          "IsIndirectTarget": true,
# JSON-NEXT:          "TypeId": 762397922298560988,
# JSON-NEXT:          "NumDirectCallees": 3,
# JSON-NEXT:          "DirectCallees": [
# JSON-NEXT:            {
# JSON-NEXT:              "Name": "foo"
# JSON-NEXT:            },
# JSON-NEXT:            {
# JSON-NEXT:              "Name": "bar"
# JSON-NEXT:            },
# JSON-NEXT:            {
# JSON-NEXT:              "Name": "baz"
# JSON-NEXT:            }
# JSON-NEXT:          ],
# JSON-NEXT:          "NumIndirectTargetTypeIDs": 2,
# JSON-NEXT:          "IndirectTypeIDs": [
# JSON-NEXT:            17896295136807035042,
# JSON-NEXT:            3498816979441845844
# JSON-NEXT:          ]
# JSON-NEXT:        }
# JSON-NEXT:      }
# JSON-NEXT:    ]

--- !ELF
FileHeader:
  Class:           ELFCLASS64
  Data:            ELFDATA2LSB
  Type:            ET_REL
  Machine:         EM_X86_64
Sections:
  - Name:            .text
    Type:            SHT_PROGBITS
    Size:            0x84
  - Name:            .llvm.callgraph
    Type:            SHT_LLVM_CALL_GRAPH
    Flags:           [ SHF_LINK_ORDER ]
    Link:            .text
    ContentArray: [
      # --- Entry 1: foo (foo) ---
      # Offset 0x0
      0x00, # Format Version
      0x01, # Flags
      # Offset 0x2 (Matches Reloc: foo)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Address of foo
      0xA2, 0x20, 0xEF, 0xB8, 0x9B, 0x69, 0x5C, 0xF8, # TypeID of foo

      # --- Entry 2: bar (bar) ---
      # Offset 0x12
      0x00, # Format Version
      0x01, # Flags
      # Offset 0x14 (Matches Reloc: bar)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Address of bar
      0xA2, 0x20, 0xEF, 0xB8, 0x9B, 0x69, 0x5C, 0xF8, # TypeID of bar

      # --- Entry 3: baz (baz) ---
      # Offset 0x24
      0x00, # Format Version
      0x01, # Flags
      # Offset 0x26 (Matches Reloc: baz)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Address of baz
      0x54, 0x86, 0xBC, 0x59, 0x81, 0x4B, 0x8E, 0x30, # TypeID of baz

      # --- Entry 4: caller (caller) ---
      # Offset 0x36
      0x00, # Format Version
      0x07, # Flags (HasDirectCallees | IsIndirectTarget | ...)
      # Offset 0x38 (Matches Reloc: caller)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Address of caller
      0xDC, 0x01, 0x1A, 0xF8, 0xDE, 0x94, 0x94, 0x0A, # TypeID of caller

      # Direct Callees List
      0x03, # NumDirectCallees (3)
      # Offset 0x49 (Matches Reloc: foo)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Callee 1: foo
      # Offset 0x51 (Matches Reloc: bar)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Callee 2: bar
      # Offset 0x59 (Matches Reloc: baz)
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, # Callee 3: baz

      # Indirect Callees List
      0x02, # NumIndirectTargetTypeIDs (2)
      0xA2, 0x20, 0xEF, 0xB8, 0x9B, 0x69, 0x5C, 0xF8, # Indirect TypeID 1 (matches foo/bar)
      0x54, 0x86, 0xBC, 0x59, 0x81, 0x4B, 0x8E, 0x30  # Indirect TypeID 2 (matches baz)
    ]
  - Name:            .rela.llvm.callgraph
    Type:            SHT_RELA
    Flags:           [ SHF_INFO_LINK ]
    Info:            .llvm.callgraph
    Relocations:
      - Offset:          0x2
        Symbol:          foo
        Type:            R_X86_64_64
      - Offset:          0x14
        Symbol:          bar
        Type:            R_X86_64_64
      - Offset:          0x26
        Symbol:          baz
        Type:            R_X86_64_64
      - Offset:          0x38
        Symbol:          caller
        Type:            R_X86_64_64
      - Offset:          0x49
        Symbol:          foo
        Type:            R_X86_64_64
      - Offset:          0x51
        Symbol:          bar
        Type:            R_X86_64_64
      - Offset:          0x59
        Symbol:          baz
        Type:            R_X86_64_64
Symbols:
  - Name:            foo
  - Name:            bar
  - Name:            baz
  - Name:            caller
...
