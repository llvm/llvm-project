## Tests --call-graph-info prints information from call graph section.

# REQUIRES: x86-registered-target

# RUN: llvm-mc %s -filetype=obj -triple=x86_64-pc-linux -o %t
# RUN: llvm-readelf --call-graph-info %t 2>&1 | FileCheck %s -DFILE=%t --match-full-lines
# RUN: llvm-readelf --elf-output-style=LLVM --call-graph-info %t 2>&1 | FileCheck %s --match-full-lines -DFILE=%t --check-prefix=LLVM
# RUN: llvm-readelf --elf-output-style=JSON --pretty-print --call-graph-info %t 2>&1 | FileCheck %s --match-full-lines -DFILE=%t --check-prefix=JSON

# CHECK: {{.*}}llvm-readelf{{.*}}: warning: '[[FILE]]': .callgraph section has unknown type id for 1 indirect targets.
# CHECK-NEXT: Per-function call graph information:: 
# CHECK-EMPTY: 
# CHECK-NEXT: Function:: foo
# CHECK-NEXT: Function PC:: 0x0
# CHECK-NEXT: FormatVersionNumber:: 0
# CHECK-NEXT: Function Kind:: NOT_INDIRECT
# CHECK-NEXT: Indirect callee count:: 0
# CHECK-NEXT: Direct callee count:: 1
# CHECK-NEXT: {
# CHECK-NEXT:   CalleePC:: 0x5
# CHECK-NEXT: }
# CHECK-EMPTY: 
# CHECK-NEXT: Function:: bar
# CHECK-NEXT: Function PC:: 0x6
# CHECK-NEXT: FormatVersionNumber:: 0
# CHECK-NEXT: Function Kind:: UNKNOWN_TID
# CHECK-NEXT: Indirect callee count:: 1
# CHECK-NEXT: {
# CHECK-NEXT:   callsite: 0x9
# CHECK-NEXT:   calleeTypeId: 0x10
# CHECK-NEXT: }
# CHECK-NEXT: Direct callee count:: 0
# CHECK-EMPTY: 
# CHECK-NEXT: Function:: baz
# CHECK-NEXT: Function PC:: 0xa
# CHECK-NEXT: FormatVersionNumber:: 0
# CHECK-NEXT: Function Kind:: KNOWN_TID
# CHECK-NEXT: Function Type ID:: 0x20
# CHECK-NEXT: Indirect callee count:: 0
# CHECK-NEXT: Direct callee count:: 0


# LLVM: {{.*}}llvm-readelf{{.*}}: warning: '[[FILE]]': .callgraph section has unknown type id for 1 indirect targets.
# LLVM: callgraph_info [
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: foo
# LLVM-NEXT:     Address: 0x0
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     KindStr: NOT_INDIRECT
# LLVM-NEXT:     Kind: 0
# LLVM-NEXT:     NumIndirectCallSites: 0
# LLVM-NEXT:     NumDirectCallSites: 1
# LLVM-NEXT:     DirectCallees [
# LLVM-NEXT:       Entry {
# LLVM-NEXT:         Address: 0x5
# LLVM-NEXT:       }
# LLVM-NEXT:     ]
# LLVM-NEXT:   }
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: bar
# LLVM-NEXT:     Address: 0x6
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     KindStr: UNKNOWN_TID
# LLVM-NEXT:     Kind: 1
# LLVM-NEXT:     NumIndirectCallSites: 1
# LLVM-NEXT:     IndirectCallsites [
# LLVM-NEXT:       IndirectCallsite {
# LLVM-NEXT:         Address: 0x9
# LLVM-NEXT:         TypeId: 0x10
# LLVM-NEXT:       }
# LLVM-NEXT:     ]
# LLVM-NEXT:     NumDirectCallSites: 0
# LLVM-NEXT:   }
# LLVM-NEXT:   Function {
# LLVM-NEXT:     Name: baz
# LLVM-NEXT:     Address: 0xA
# LLVM-NEXT:     Version: 0
# LLVM-NEXT:     KindStr: KNOWN_TID
# LLVM-NEXT:     Kind: 2
# LLVM-NEXT:     TypeId: 0x20
# LLVM-NEXT:     NumIndirectCallSites: 0
# LLVM-NEXT:     NumDirectCallSites: 0
# LLVM-NEXT:   }
# LLVM-NEXT: ]

# JSON: {{.*}}llvm-readelf{{.*}}: warning: '[[FILE]]': .callgraph section has unknown type id for 1 indirect targets.
# JSON:     "callgraph_info": [
# JSON-NEXT:       {
# JSON-NEXT:         "Function": {
# JSON-NEXT:           "Name": "foo",
# JSON-NEXT:           "Address": 0,
# JSON-NEXT:           "Version": 0,
# JSON-NEXT:           "KindStr": "NOT_INDIRECT",
# JSON-NEXT:           "Kind": 0,
# JSON-NEXT:           "NumIndirectCallSites": 0,
# JSON-NEXT:           "NumDirectCallSites": 1,
# JSON-NEXT:           "DirectCallees": [
# JSON-NEXT:             {
# JSON-NEXT:               "Entry": {
# JSON-NEXT:                 "Address": 5
# JSON-NEXT:               }
# JSON-NEXT:             }
# JSON-NEXT:           ]
# JSON-NEXT:         }
# JSON-NEXT:       },
# JSON-NEXT:       {
# JSON-NEXT:         "Function": {
# JSON-NEXT:           "Name": "bar",
# JSON-NEXT:           "Address": 6,
# JSON-NEXT:           "Version": 0,
# JSON-NEXT:           "KindStr": "UNKNOWN_TID",
# JSON-NEXT:           "Kind": 1,
# JSON-NEXT:           "NumIndirectCallSites": 1,
# JSON-NEXT:           "IndirectCallsites": [
# JSON-NEXT:             {
# JSON-NEXT:               "IndirectCallsite": {
# JSON-NEXT:                 "Address": 9,
# JSON-NEXT:                 "TypeId": 16
# JSON-NEXT:               }
# JSON-NEXT:             }
# JSON-NEXT:           ],
# JSON-NEXT:           "NumDirectCallSites": 0
# JSON-NEXT:         }
# JSON-NEXT:       },
# JSON-NEXT:       {
# JSON-NEXT:         "Function": {
# JSON-NEXT:           "Name": "baz",
# JSON-NEXT:           "Address": 10,
# JSON-NEXT:           "Version": 0,
# JSON-NEXT:           "KindStr": "KNOWN_TID",
# JSON-NEXT:           "Kind": 2,
# JSON-NEXT:           "TypeId": 32,
# JSON-NEXT:           "NumIndirectCallSites": 0,
# JSON-NEXT:           "NumDirectCallSites": 0
# JSON-NEXT:         }
# JSON-NEXT:       }
# JSON-NEXT:     ]


.text

.globl foo
.type foo,@function
foo:                  #< foo is at 0.
.Lfoo_begin:
 callq foo            #< direct call is at 5. target is foo (5).
 retq

.globl bar
.type bar,@function
bar:                  #< bar is at 6.
 callq	*-40(%rbp)    #< indirect call is at 9.
 retq

.globl baz
.type baz,@function
baz:                  #< baz is at 10 (a).
 retq

.globl qux
.type qux,@function
qux:                  #< qux is at 11 (b).
 retq

.section	.callgraph,"o",@progbits,.text
.byte	0       #< Format version number.
.byte	1       #< Flag IsIndirectTarget true
.quad	0       #< foo()'s entry address.
.quad	0       #< TypeID: unknown.
.long   1       #< Count of direct callees.
.long	0       #< Count of indirect target type IDs.
.quad   5       #< Direct callee foo's address>

.byte	0       #< Format version number.
.byte   1       #< Flag IsIndirectTarget true
.quad	6       #< bar()'s entry address.
.quad	0       #< TypeID: unknown.
.long   0       #< Count of direct callees
.long	1       #< Count of indirect target type IDs
.quad   16      #< Indirect call type id.


.byte	0       #< Format version number.
.byte   1       #< Flag IsIndirectTarget true
.quad	10      #< baz()'s entry address.
.quad   32      #< Indirect target type id.
.long	0       #< Count of direct callees
.long   0       #< Count of indirect call type ids

# No call graph section entry for qux. 
# Technically its "UNKNOWN" type id but will not be printed as such by llvm-readelf.  

.text
