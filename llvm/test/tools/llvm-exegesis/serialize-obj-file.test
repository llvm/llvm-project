# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --opcode-name=SH3ADD --benchmark-phase=assemble-measured-code --mode=latency --benchmarks-file=%t.yaml
# RUN: FileCheck --input-file=%t.yaml %s --check-prefixes=CHECK,SERIALIZE
# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --run-measurement=%t.yaml --mode=latency --benchmark-phase=dry-run-measurement --use-dummy-perf-counters \
# RUN:    --dump-object-to-disk=%t.o | FileCheck %s --check-prefixes=CHECK,DESERIALIZE
# RUN: llvm-objdump -d %t.o | FileCheck %s --check-prefix=OBJDUMP
# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --opcode-name=SH3ADD --mode=latency --benchmark-phase=dry-run-measurement --use-dummy-perf-counters | \
# RUN:    FileCheck %s --check-prefix=NO-SERIALIZE
# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --opcode-name=SH3ADD --mode=latency --benchmark-phase=assemble-measured-code --repetition-mode=min | \
# RUN:    FileCheck %s --check-prefix=NO-SERIALIZE
# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --opcode-name=SH3ADD --mode=latency --benchmark-phase=assemble-measured-code --repetition-mode=middle-half-loop | \
# RUN:    FileCheck %s --check-prefix=NO-SERIALIZE
# RUN: llvm-exegesis -mtriple=riscv64 -mcpu=sifive-p470 --opcode-name=SH3ADD --mode=latency --benchmark-phase=assemble-measured-code --repetition-mode=middle-half-duplicate | \
# RUN:    FileCheck %s --check-prefix=NO-SERIALIZE
# REQUIRES: riscv-registered-target && native-registered-exegesis-target
# REQUIRES: zlib || zstd

# A round-trip test for serialize/deserialize benchmarks.

# CHECK: mode: latency
# CHECK:  instructions:
# CHECK-NEXT: - 'SH3ADD X{{.*}} X{{.*}} X{{.*}}'
# CHECK: cpu_name:        sifive-p470
# CHECK-NEXT: llvm_triple:     riscv64
# CHECK-NEXT: min_instructions: 10000
# CHECK-NEXT: measurements:    []
# SERIALIZE: error: actual measurements skipped.
# DESERIALIZE: error:           ''
# CHECK: info:            Repeating a single explicitly serial instruction

# OBJDUMP: sh3add

# Negative tests: we shouldn't serialize object files in some scenarios.

# NO-SERIALIZE-NOT: object_file:
