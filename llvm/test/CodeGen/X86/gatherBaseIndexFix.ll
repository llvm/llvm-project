; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc  -mtriple=x86_64-unknown-unknown -mattr=+avx512f,+avx512bw,+avx512vl,+avx512dq -mcpu=znver5 < %s | FileCheck %s
; RUN: llc -update-baseIndex -mtriple=x86_64-unknown-unknown -mattr=+avx512f,+avx512bw,+avx512vl,+avx512dq -mcpu=znver5 < %s | FileCheck %s
; RUN: llc -update-baseIndex=false -mtriple=x86_64-unknown-unknown -mattr=+avx512f,+avx512bw,+avx512vl,+avx512dq -mcpu=znver5 < %s | FileCheck %s -check-prefix=OLD

%struct.pt = type { float, float, float, i32 }

define <16 x float> @test_gather_16f32_1(ptr %x, ptr %arr, <16 x i1> %mask, <16 x float> %src0)  {
; CHECK-LABEL: test_gather_16f32_1:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vpslld $4, (%rsi), %zmm2
; CHECK-NEXT:    vpsllw $7, %xmm0, %xmm0
; CHECK-NEXT:    vpmovb2m %xmm0, %k1
; CHECK-NEXT:    vgatherdps (%rdi,%zmm2), %zmm1 {%k1}
; CHECK-NEXT:    vmovaps %zmm1, %zmm0
; CHECK-NEXT:    retq
;
; OLD-LABEL: test_gather_16f32_1:
; OLD:       # %bb.0:
; OLD-NEXT:    vpsllw $7, %xmm0, %xmm0
; OLD-NEXT:    vmovdqu64 (%rsi), %zmm4
; OLD-NEXT:    vextractf64x4 $1, %zmm1, %ymm3
; OLD-NEXT:    vpmovb2m %xmm0, %k1
; OLD-NEXT:    vpandd {{\.?LCPI[0-9]+_[0-9]+}}(%rip){1to16}, %zmm4, %zmm0
; OLD-NEXT:    kshiftrw $8, %k1, %k2
; OLD-NEXT:    vextracti64x4 $1, %zmm0, %ymm2
; OLD-NEXT:    vpmovzxdq {{.*#+}} zmm0 = ymm0[0],zero,ymm0[1],zero,ymm0[2],zero,ymm0[3],zero,ymm0[4],zero,ymm0[5],zero,ymm0[6],zero,ymm0[7],zero
; OLD-NEXT:    vpmovzxdq {{.*#+}} zmm2 = ymm2[0],zero,ymm2[1],zero,ymm2[2],zero,ymm2[3],zero,ymm2[4],zero,ymm2[5],zero,ymm2[6],zero,ymm2[7],zero
; OLD-NEXT:    vpsllq $4, %zmm0, %zmm0
; OLD-NEXT:    vpsllq $4, %zmm2, %zmm2
; OLD-NEXT:    vgatherqps (%rdi,%zmm0), %ymm1 {%k1}
; OLD-NEXT:    vgatherqps (%rdi,%zmm2), %ymm3 {%k2}
; OLD-NEXT:    vinsertf64x4 $1, %ymm3, %zmm1, %zmm0
; OLD-NEXT:    retq
  %wide.load = load <16 x i32>, ptr %arr, align 4
  %4 = and <16 x i32> %wide.load, <i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911>
  %5 = zext <16 x i32> %4 to <16 x i64>
  %ptrs = getelementptr inbounds %struct.pt, ptr %x, <16 x i64> %5
  %res = call <16 x float> @llvm.masked.gather.v16f32.v16p0(<16 x ptr> %ptrs, i32 4, <16 x i1> %mask, <16 x float> %src0)
  ret <16 x float> %res
  }

define <16 x float> @test_gather_16f32_2(ptr %x, ptr %arr, <16 x i1> %mask, <16 x float> %src0)  {
; CHECK-LABEL: test_gather_16f32_2:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vpsllw $7, %xmm0, %xmm0
; CHECK-NEXT:    vpslld $4, (%rsi), %zmm2
; CHECK-NEXT:    vpmovb2m %xmm0, %k1
; CHECK-NEXT:    vpord {{\.?LCPI[0-9]+_[0-9]+}}(%rip){1to16}, %zmm2, %zmm0
; CHECK-NEXT:    vgatherdps (%rdi,%zmm0), %zmm1 {%k1}
; CHECK-NEXT:    vmovaps %zmm1, %zmm0
; CHECK-NEXT:    retq
;
; OLD-LABEL: test_gather_16f32_2:
; OLD:       # %bb.0:
; OLD-NEXT:    vpsllw $7, %xmm0, %xmm0
; OLD-NEXT:    vmovdqu64 (%rsi), %zmm4
; OLD-NEXT:    vextractf64x4 $1, %zmm1, %ymm3
; OLD-NEXT:    vpmovb2m %xmm0, %k1
; OLD-NEXT:    vpandd {{\.?LCPI[0-9]+_[0-9]+}}(%rip){1to16}, %zmm4, %zmm0
; OLD-NEXT:    kshiftrw $8, %k1, %k2
; OLD-NEXT:    vextracti64x4 $1, %zmm0, %ymm2
; OLD-NEXT:    vpmovzxdq {{.*#+}} zmm0 = ymm0[0],zero,ymm0[1],zero,ymm0[2],zero,ymm0[3],zero,ymm0[4],zero,ymm0[5],zero,ymm0[6],zero,ymm0[7],zero
; OLD-NEXT:    vpmovzxdq {{.*#+}} zmm2 = ymm2[0],zero,ymm2[1],zero,ymm2[2],zero,ymm2[3],zero,ymm2[4],zero,ymm2[5],zero,ymm2[6],zero,ymm2[7],zero
; OLD-NEXT:    vpsllq $4, %zmm0, %zmm0
; OLD-NEXT:    vpsllq $4, %zmm2, %zmm2
; OLD-NEXT:    vgatherqps 4(%rdi,%zmm0), %ymm1 {%k1}
; OLD-NEXT:    vgatherqps 4(%rdi,%zmm2), %ymm3 {%k2}
; OLD-NEXT:    vinsertf64x4 $1, %ymm3, %zmm1, %zmm0
; OLD-NEXT:    retq
  %wide.load = load <16 x i32>, ptr %arr, align 4
  %4 = and <16 x i32> %wide.load, <i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911, i32 536870911>
  %5 = zext <16 x i32> %4 to <16 x i64>
  %ptrs = getelementptr inbounds %struct.pt, ptr %x, <16 x i64> %5, i32 1
  %res = call <16 x float> @llvm.masked.gather.v16f32.v16p0(<16 x ptr> %ptrs, i32 4, <16 x i1> %mask, <16 x float> %src0)
  ret <16 x float> %res
  }
