; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=i686-unknown-unknown -mattr=+sse2     | FileCheck %s --check-prefixes=SSE,SSE2,X86-SSE,X86-SSE2
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+sse2   | FileCheck %s --check-prefixes=SSE,SSE2,X64-SSE,X64-SSE2
; RUN: llc < %s -mtriple=i686-unknown-unknown -mattr=+sse4.2   | FileCheck %s --check-prefixes=SSE,SSE4,X86-SSE,X86-SSE4
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+sse4.2 | FileCheck %s --check-prefixes=SSE,SSE4,X64-SSE,X64-SSE4
; RUN: llc < %s -mtriple=i686-unknown-unknown -mattr=+avx      | FileCheck %s --check-prefixes=AVX,AVX1,X86-AVX,X86-AVX1
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+avx    | FileCheck %s --check-prefixes=AVX,AVX1,X64-AVX,X64-AVX1
; RUN: llc < %s -mtriple=i686-unknown-unknown -mattr=+avx2     | FileCheck %s --check-prefixes=AVX,AVX2,X86-AVX,X86-AVX2
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+avx2   | FileCheck %s --check-prefixes=AVX,AVX2,X64-AVX,X64-AVX2
; RUN: llc < %s -mtriple=i686-unknown-unknown -mattr=+avx512bw,avx512vl   | FileCheck %s --check-prefixes=AVX,AVX512,X86-AVX512
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+avx512bw,avx512vl | FileCheck %s --check-prefixes=AVX,AVX512,X64-AVX512

define <4 x i32> @trunc_lshr_v4i64(<4 x i64> %a) nounwind {
; SSE2-LABEL: trunc_lshr_v4i64:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrlq $63, %xmm1
; SSE2-NEXT:    psrlq $63, %xmm0
; SSE2-NEXT:    packuswb %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: trunc_lshr_v4i64:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrlq $63, %xmm1
; SSE4-NEXT:    psrlq $63, %xmm0
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: trunc_lshr_v4i64:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; AVX1-NEXT:    vpsrlq $63, %xmm1, %xmm1
; AVX1-NEXT:    vpsrlq $63, %xmm0, %xmm0
; AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vzeroupper
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: trunc_lshr_v4i64:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpsrlq $63, %ymm0, %ymm0
; AVX2-NEXT:    vextracti128 $1, %ymm0, %xmm1
; AVX2-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    vzeroupper
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: trunc_lshr_v4i64:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpsrlq $63, %ymm0, %ymm0
; AVX512-NEXT:    vpmovqd %ymm0, %xmm0
; AVX512-NEXT:    vzeroupper
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = lshr <4 x i64> %a, <i64 63, i64 63, i64 63, i64 63>
  %2 = trunc <4 x i64> %1 to <4 x i32>
  ret <4 x i32> %2
}

define <8 x i16> @trunc_lshr_v4i64_bitcast(<4 x i64> %a0) {
; SSE2-LABEL: trunc_lshr_v4i64_bitcast:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrlq $49, %xmm1
; SSE2-NEXT:    psrlq $49, %xmm0
; SSE2-NEXT:    packssdw %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: trunc_lshr_v4i64_bitcast:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrlq $49, %xmm1
; SSE4-NEXT:    psrlq $49, %xmm0
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: trunc_lshr_v4i64_bitcast:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; AVX1-NEXT:    vpsrlq $49, %xmm1, %xmm1
; AVX1-NEXT:    vpsrlq $49, %xmm0, %xmm0
; AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vzeroupper
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: trunc_lshr_v4i64_bitcast:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpsrlq $49, %ymm0, %ymm0
; AVX2-NEXT:    vextracti128 $1, %ymm0, %xmm1
; AVX2-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    vzeroupper
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: trunc_lshr_v4i64_bitcast:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpsrlq $49, %ymm0, %ymm0
; AVX512-NEXT:    vpmovdw %ymm0, %xmm0
; AVX512-NEXT:    vzeroupper
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = lshr <4 x i64> %a0, <i64 49, i64 49, i64 49, i64 49>
  %2 = bitcast <4 x i64> %1 to <8 x i32>
  %3 = trunc <8 x i32> %2 to <8 x i16>
  ret <8 x i16> %3
}

define <8 x i16> @trunc_lshr_v8i32(<8 x i32> %a) nounwind {
; SSE2-LABEL: trunc_lshr_v8i32:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrld $31, %xmm1
; SSE2-NEXT:    psrld $31, %xmm0
; SSE2-NEXT:    packuswb %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: trunc_lshr_v8i32:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrld $31, %xmm1
; SSE4-NEXT:    psrld $31, %xmm0
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: trunc_lshr_v8i32:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; AVX1-NEXT:    vpsrld $31, %xmm1, %xmm1
; AVX1-NEXT:    vpsrld $31, %xmm0, %xmm0
; AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vzeroupper
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: trunc_lshr_v8i32:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpsrld $31, %ymm0, %ymm0
; AVX2-NEXT:    vextracti128 $1, %ymm0, %xmm1
; AVX2-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    vzeroupper
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: trunc_lshr_v8i32:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpsrld $31, %ymm0, %ymm0
; AVX512-NEXT:    vpmovdw %ymm0, %xmm0
; AVX512-NEXT:    vzeroupper
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = lshr <8 x i32> %a, <i32 31, i32 31, i32 31, i32 31, i32 31, i32 31, i32 31, i32 31>
  %2 = trunc <8 x i32> %1 to <8 x i16>
  ret <8 x i16> %2
}

define <8 x i16> @trunc_lshr_v4i64_demandedelts(<4 x i64> %a0) {
; SSE2-LABEL: trunc_lshr_v4i64_demandedelts:
; SSE2:       # %bb.0:
; SSE2-NEXT:    pshufd {{.*#+}} xmm1 = xmm1[0,0,0,0]
; SSE2-NEXT:    movdqa {{.*#+}} xmm2 = [1,1,1,1]
; SSE2-NEXT:    pand %xmm2, %xmm1
; SSE2-NEXT:    pshufd {{.*#+}} xmm0 = xmm0[0,0,0,0]
; SSE2-NEXT:    pand %xmm2, %xmm0
; SSE2-NEXT:    packuswb %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: trunc_lshr_v4i64_demandedelts:
; SSE4:       # %bb.0:
; SSE4-NEXT:    pshufd {{.*#+}} xmm1 = xmm1[0,0,0,0]
; SSE4-NEXT:    pmovsxbd {{.*#+}} xmm2 = [1,1,1,1]
; SSE4-NEXT:    pand %xmm2, %xmm1
; SSE4-NEXT:    pshufd {{.*#+}} xmm0 = xmm0[0,0,0,0]
; SSE4-NEXT:    pand %xmm2, %xmm0
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; X86-AVX1-LABEL: trunc_lshr_v4i64_demandedelts:
; X86-AVX1:       # %bb.0:
; X86-AVX1-NEXT:    vshufps {{.*#+}} ymm0 = ymm0[0,0,0,0,4,4,4,4]
; X86-AVX1-NEXT:    vandps {{\.?LCPI[0-9]+_[0-9]+}}, %ymm0, %ymm0
; X86-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X86-AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; X86-AVX1-NEXT:    vzeroupper
; X86-AVX1-NEXT:    retl
;
; X64-AVX1-LABEL: trunc_lshr_v4i64_demandedelts:
; X64-AVX1:       # %bb.0:
; X64-AVX1-NEXT:    vshufps {{.*#+}} ymm0 = ymm0[0,0,0,0,4,4,4,4]
; X64-AVX1-NEXT:    vandps {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %ymm0, %ymm0
; X64-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X64-AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; X64-AVX1-NEXT:    vzeroupper
; X64-AVX1-NEXT:    retq
;
; AVX2-LABEL: trunc_lshr_v4i64_demandedelts:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpshufd {{.*#+}} ymm0 = ymm0[0,0,0,0,4,4,4,4]
; AVX2-NEXT:    vpbroadcastd {{.*#+}} ymm1 = [1,1,1,1,1,1,1,1]
; AVX2-NEXT:    vpand %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    vextracti128 $1, %ymm0, %xmm1
; AVX2-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    vzeroupper
; AVX2-NEXT:    ret{{[l|q]}}
;
; X86-AVX512-LABEL: trunc_lshr_v4i64_demandedelts:
; X86-AVX512:       # %bb.0:
; X86-AVX512-NEXT:    vpshufd {{.*#+}} ymm0 = ymm0[0,0,0,0,4,4,4,4]
; X86-AVX512-NEXT:    vpandd {{\.?LCPI[0-9]+_[0-9]+}}{1to8}, %ymm0, %ymm0
; X86-AVX512-NEXT:    vpmovdw %ymm0, %xmm0
; X86-AVX512-NEXT:    vzeroupper
; X86-AVX512-NEXT:    retl
;
; X64-AVX512-LABEL: trunc_lshr_v4i64_demandedelts:
; X64-AVX512:       # %bb.0:
; X64-AVX512-NEXT:    vpshufd {{.*#+}} ymm0 = ymm0[0,0,0,0,4,4,4,4]
; X64-AVX512-NEXT:    vpandd {{\.?LCPI[0-9]+_[0-9]+}}(%rip){1to8}, %ymm0, %ymm0
; X64-AVX512-NEXT:    vpmovdw %ymm0, %xmm0
; X64-AVX512-NEXT:    vzeroupper
; X64-AVX512-NEXT:    retq
  %1 = shl <4 x i64> %a0, <i64 63, i64 0, i64 63, i64 0>
  %2 = lshr <4 x i64> %1, <i64 63, i64 0, i64 63, i64 0>
  %3 = bitcast <4 x i64> %2 to <8 x i32>
  %4 = shufflevector <8 x i32> %3, <8 x i32> undef, <8 x i32> <i32 0, i32 0, i32 0, i32 0, i32 4, i32 4, i32 4, i32 4>
  %5 = trunc <8 x i32> %4 to <8 x i16>
  ret <8 x i16> %5
}

define <16 x i8> @shuffle_lshr_2v8i16(<8 x i16> %a0, <8 x i16> %a1) {
; SSE-LABEL: shuffle_lshr_2v8i16:
; SSE:       # %bb.0:
; SSE-NEXT:    psrlw $15, %xmm0
; SSE-NEXT:    psrlw $15, %xmm1
; SSE-NEXT:    packuswb %xmm1, %xmm0
; SSE-NEXT:    ret{{[l|q]}}
;
; AVX-LABEL: shuffle_lshr_2v8i16:
; AVX:       # %bb.0:
; AVX-NEXT:    vpsrlw $15, %xmm0, %xmm0
; AVX-NEXT:    vpsrlw $15, %xmm1, %xmm1
; AVX-NEXT:    vpackuswb %xmm1, %xmm0, %xmm0
; AVX-NEXT:    ret{{[l|q]}}
  %lshr0 = lshr <8 x i16> %a0, <i16 15, i16 15, i16 15, i16 15, i16 15, i16 15, i16 15, i16 15>
  %lshr1 = lshr <8 x i16> %a1, <i16 15, i16 15, i16 15, i16 15, i16 15, i16 15, i16 15, i16 15>
  %bc0 = bitcast <8 x i16> %lshr0 to <16 x i8>
  %bc1 = bitcast <8 x i16> %lshr1 to <16 x i8>
  %res = shufflevector <16 x i8> %bc0, <16 x i8> %bc1, <16 x i32> <i32 0, i32 2, i32 4, i32 6, i32 8, i32 10, i32 12, i32 14, i32 16, i32 18, i32 20, i32 22, i32 24, i32 26, i32 28, i32 30>
  ret <16 x i8> %res
}

define <8 x i16> @shuffle_lshr_2v4i32(<4 x i32> %a0, <4 x i32> %a1) {
; SSE2-LABEL: shuffle_lshr_2v4i32:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrld $31, %xmm0
; SSE2-NEXT:    psrld $31, %xmm1
; SSE2-NEXT:    packssdw %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: shuffle_lshr_2v4i32:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrld $31, %xmm0
; SSE4-NEXT:    psrld $31, %xmm1
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX-LABEL: shuffle_lshr_2v4i32:
; AVX:       # %bb.0:
; AVX-NEXT:    vpsrld $31, %xmm0, %xmm0
; AVX-NEXT:    vpsrld $31, %xmm1, %xmm1
; AVX-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    ret{{[l|q]}}
  %lshr0 = lshr <4 x i32> %a0, <i32 31, i32 31, i32 31, i32 31>
  %lshr1 = lshr <4 x i32> %a1, <i32 31, i32 31, i32 31, i32 31>
  %bc0 = bitcast <4 x i32> %lshr0 to <8 x i16>
  %bc1 = bitcast <4 x i32> %lshr1 to <8 x i16>
  %res = shufflevector <8 x i16> %bc0, <8 x i16> %bc1, <8 x i32> <i32 0, i32 2, i32 4, i32 6, i32 8, i32 10, i32 12, i32 14>
  ret <8 x i16> %res
}

define <4 x i32> @shuffle_lshr_2v2i64(<2 x i64> %a0, <2 x i64> %a1) {
; SSE2-LABEL: shuffle_lshr_2v2i64:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrlq $63, %xmm0
; SSE2-NEXT:    psrlq $63, %xmm1
; SSE2-NEXT:    packuswb %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: shuffle_lshr_2v2i64:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrlq $63, %xmm0
; SSE4-NEXT:    psrlq $63, %xmm1
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX-LABEL: shuffle_lshr_2v2i64:
; AVX:       # %bb.0:
; AVX-NEXT:    vpsrlq $63, %xmm0, %xmm0
; AVX-NEXT:    vpsrlq $63, %xmm1, %xmm1
; AVX-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    ret{{[l|q]}}
  %lshr0 = lshr <2 x i64> %a0, <i64 63, i64 63>
  %lshr1 = lshr <2 x i64> %a1, <i64 63, i64 63>
  %bc0 = bitcast <2 x i64> %lshr0 to <4 x i32>
  %bc1 = bitcast <2 x i64> %lshr1 to <4 x i32>
  %res = shufflevector <4 x i32> %bc0, <4 x i32> %bc1, <4 x i32> <i32 0, i32 2, i32 4, i32 6>
  ret <4 x i32> %res
}

define <4 x float> @shuffle_lshr_2v2i64_bitcast(<2 x i64> %a0, <2 x i64> %a1) {
; SSE2-LABEL: shuffle_lshr_2v2i64_bitcast:
; SSE2:       # %bb.0:
; SSE2-NEXT:    psrlq $63, %xmm0
; SSE2-NEXT:    psrlq $63, %xmm1
; SSE2-NEXT:    packuswb %xmm1, %xmm0
; SSE2-NEXT:    ret{{[l|q]}}
;
; SSE4-LABEL: shuffle_lshr_2v2i64_bitcast:
; SSE4:       # %bb.0:
; SSE4-NEXT:    psrlq $63, %xmm0
; SSE4-NEXT:    psrlq $63, %xmm1
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX-LABEL: shuffle_lshr_2v2i64_bitcast:
; AVX:       # %bb.0:
; AVX-NEXT:    vpsrlq $63, %xmm0, %xmm0
; AVX-NEXT:    vpsrlq $63, %xmm1, %xmm1
; AVX-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    ret{{[l|q]}}
  %lshr0 = lshr <2 x i64> %a0, <i64 63, i64 63>
  %lshr1 = lshr <2 x i64> %a1, <i64 63, i64 63>
  %bc0 = bitcast <2 x i64> %lshr0 to <4 x float>
  %bc1 = bitcast <2 x i64> %lshr1 to <4 x float>
  %res = shufflevector <4 x float> %bc0, <4 x float> %bc1, <4 x i32> <i32 0, i32 2, i32 4, i32 6>
  ret <4 x float> %res
}

define <16 x i8> @packuswb_icmp_zero_128(<8 x i16> %a0) {
; X86-SSE-LABEL: packuswb_icmp_zero_128:
; X86-SSE:       # %bb.0:
; X86-SSE-NEXT:    pxor %xmm1, %xmm1
; X86-SSE-NEXT:    pcmpeqw %xmm0, %xmm1
; X86-SSE-NEXT:    packsswb %xmm1, %xmm1
; X86-SSE-NEXT:    pand {{\.?LCPI[0-9]+_[0-9]+}}, %xmm1
; X86-SSE-NEXT:    movq {{.*#+}} xmm0 = xmm1[0],zero
; X86-SSE-NEXT:    retl
;
; X64-SSE-LABEL: packuswb_icmp_zero_128:
; X64-SSE:       # %bb.0:
; X64-SSE-NEXT:    pxor %xmm1, %xmm1
; X64-SSE-NEXT:    pcmpeqw %xmm0, %xmm1
; X64-SSE-NEXT:    packsswb %xmm1, %xmm1
; X64-SSE-NEXT:    pand {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm1
; X64-SSE-NEXT:    movq {{.*#+}} xmm0 = xmm1[0],zero
; X64-SSE-NEXT:    retq
;
; X86-AVX-LABEL: packuswb_icmp_zero_128:
; X86-AVX:       # %bb.0:
; X86-AVX-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; X86-AVX-NEXT:    vpcmpeqw %xmm1, %xmm0, %xmm0
; X86-AVX-NEXT:    vpacksswb %xmm0, %xmm0, %xmm0
; X86-AVX-NEXT:    vpand {{\.?LCPI[0-9]+_[0-9]+}}, %xmm0, %xmm0
; X86-AVX-NEXT:    vmovq {{.*#+}} xmm0 = xmm0[0],zero
; X86-AVX-NEXT:    retl
;
; X64-AVX-LABEL: packuswb_icmp_zero_128:
; X64-AVX:       # %bb.0:
; X64-AVX-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; X64-AVX-NEXT:    vpcmpeqw %xmm1, %xmm0, %xmm0
; X64-AVX-NEXT:    vpacksswb %xmm0, %xmm0, %xmm0
; X64-AVX-NEXT:    vpand {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm0, %xmm0
; X64-AVX-NEXT:    vmovq {{.*#+}} xmm0 = xmm0[0],zero
; X64-AVX-NEXT:    retq
;
; AVX512-LABEL: packuswb_icmp_zero_128:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vptestnmw %xmm0, %xmm0, %k1
; AVX512-NEXT:    vmovdqu8 {{.*#+}} xmm0 {%k1} {z} = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
; AVX512-NEXT:    vmovq {{.*#+}} xmm0 = xmm0[0],zero
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = icmp eq <8 x i16> %a0, zeroinitializer
  %2 = zext <8 x i1> %1 to <8 x i8>
  %3 = shufflevector <8 x i8> %2, <8 x i8> zeroinitializer, <16 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15>
  ret <16 x i8> %3
}

define <16 x i8> @packuswb_icmp_zero_trunc_128(<8 x i16> %a0) {
; SSE-LABEL: packuswb_icmp_zero_trunc_128:
; SSE:       # %bb.0:
; SSE-NEXT:    pxor %xmm1, %xmm1
; SSE-NEXT:    pcmpeqw %xmm1, %xmm0
; SSE-NEXT:    psrlw $15, %xmm0
; SSE-NEXT:    packuswb %xmm1, %xmm0
; SSE-NEXT:    ret{{[l|q]}}
;
; AVX-LABEL: packuswb_icmp_zero_trunc_128:
; AVX:       # %bb.0:
; AVX-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX-NEXT:    vpcmpeqw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    vpsrlw $15, %xmm0, %xmm0
; AVX-NEXT:    vpackuswb %xmm1, %xmm0, %xmm0
; AVX-NEXT:    ret{{[l|q]}}
  %1 = icmp eq <8 x i16> %a0, zeroinitializer
  %2 = zext <8 x i1> %1 to <8 x i16>
  %3 = shufflevector <8 x i16> %2, <8 x i16> zeroinitializer, <16 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15>
  %4 = trunc <16 x i16> %3 to <16 x i8>
  ret <16 x i8> %4
}

define <32 x i8> @packuswb_icmp_zero_256(<16 x i16> %a0) {
; SSE-LABEL: packuswb_icmp_zero_256:
; SSE:       # %bb.0:
; SSE-NEXT:    pxor %xmm2, %xmm2
; SSE-NEXT:    pcmpeqw %xmm2, %xmm1
; SSE-NEXT:    psrlw $15, %xmm1
; SSE-NEXT:    pcmpeqw %xmm2, %xmm0
; SSE-NEXT:    psrlw $15, %xmm0
; SSE-NEXT:    pxor %xmm3, %xmm3
; SSE-NEXT:    packuswb %xmm0, %xmm3
; SSE-NEXT:    packuswb %xmm1, %xmm2
; SSE-NEXT:    movdqa %xmm3, %xmm0
; SSE-NEXT:    movdqa %xmm2, %xmm1
; SSE-NEXT:    ret{{[l|q]}}
;
; X86-AVX1-LABEL: packuswb_icmp_zero_256:
; X86-AVX1:       # %bb.0:
; X86-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X86-AVX1-NEXT:    vpxor %xmm2, %xmm2, %xmm2
; X86-AVX1-NEXT:    vpcmpeqw %xmm2, %xmm1, %xmm1
; X86-AVX1-NEXT:    vpcmpeqw %xmm2, %xmm0, %xmm0
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm1, %ymm0, %ymm0
; X86-AVX1-NEXT:    vandps {{\.?LCPI[0-9]+_[0-9]+}}, %ymm0, %ymm0
; X86-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X86-AVX1-NEXT:    vpackuswb %xmm1, %xmm2, %xmm1
; X86-AVX1-NEXT:    vpackuswb %xmm0, %xmm2, %xmm0
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm1, %ymm0, %ymm0
; X86-AVX1-NEXT:    retl
;
; X64-AVX1-LABEL: packuswb_icmp_zero_256:
; X64-AVX1:       # %bb.0:
; X64-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X64-AVX1-NEXT:    vpxor %xmm2, %xmm2, %xmm2
; X64-AVX1-NEXT:    vpcmpeqw %xmm2, %xmm1, %xmm1
; X64-AVX1-NEXT:    vpcmpeqw %xmm2, %xmm0, %xmm0
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm1, %ymm0, %ymm0
; X64-AVX1-NEXT:    vandps {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %ymm0, %ymm0
; X64-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; X64-AVX1-NEXT:    vpackuswb %xmm1, %xmm2, %xmm1
; X64-AVX1-NEXT:    vpackuswb %xmm0, %xmm2, %xmm0
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm1, %ymm0, %ymm0
; X64-AVX1-NEXT:    retq
;
; AVX2-LABEL: packuswb_icmp_zero_256:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX2-NEXT:    vpcmpeqw %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    vpsrlw $15, %ymm0, %ymm0
; AVX2-NEXT:    vpackuswb %ymm0, %ymm1, %ymm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: packuswb_icmp_zero_256:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpcmpeqw %ymm1, %ymm0, %ymm0
; AVX512-NEXT:    vpsrlw $15, %ymm0, %ymm0
; AVX512-NEXT:    vpackuswb %ymm0, %ymm1, %ymm0
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = icmp eq <16 x i16> %a0, zeroinitializer
  %2 = zext <16 x i1> %1 to <16 x i16>
  %3 = bitcast <16 x i16> %2 to <32 x i8>
  %4 = shufflevector <32 x i8> zeroinitializer, <32 x i8> %3, <32 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 32, i32 34, i32 36, i32 38, i32 40, i32 42, i32 44, i32 46, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15, i32 48, i32 50, i32 52, i32 54, i32 56, i32 58, i32 60, i32 62>
  ret <32 x i8> %4
}

define <32 x i8> @packuswb_icmp_zero_trunc_256(<16 x i16> %a0) {
; SSE-LABEL: packuswb_icmp_zero_trunc_256:
; SSE:       # %bb.0:
; SSE-NEXT:    pxor %xmm2, %xmm2
; SSE-NEXT:    pcmpeqw %xmm2, %xmm1
; SSE-NEXT:    psrlw $15, %xmm1
; SSE-NEXT:    pcmpeqw %xmm2, %xmm0
; SSE-NEXT:    psrlw $15, %xmm0
; SSE-NEXT:    pxor %xmm3, %xmm3
; SSE-NEXT:    packuswb %xmm0, %xmm3
; SSE-NEXT:    packuswb %xmm1, %xmm2
; SSE-NEXT:    movdqa %xmm3, %xmm0
; SSE-NEXT:    movdqa %xmm2, %xmm1
; SSE-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: packuswb_icmp_zero_trunc_256:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX1-NEXT:    vpcmpeqw %xmm1, %xmm0, %xmm2
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm0
; AVX1-NEXT:    vpcmpeqw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vpsrlw $15, %xmm0, %xmm0
; AVX1-NEXT:    vpackuswb %xmm0, %xmm1, %xmm0
; AVX1-NEXT:    vpsrlw $15, %xmm2, %xmm2
; AVX1-NEXT:    vpackuswb %xmm2, %xmm1, %xmm1
; AVX1-NEXT:    vinsertf128 $1, %xmm0, %ymm1, %ymm0
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: packuswb_icmp_zero_trunc_256:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX2-NEXT:    vpcmpeqw %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    vpsrlw $15, %ymm0, %ymm0
; AVX2-NEXT:    vpackuswb %ymm0, %ymm1, %ymm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: packuswb_icmp_zero_trunc_256:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpcmpeqw %ymm1, %ymm0, %ymm0
; AVX512-NEXT:    vpsrlw $15, %ymm0, %ymm0
; AVX512-NEXT:    movb $-52, %al
; AVX512-NEXT:    kmovd %eax, %k1
; AVX512-NEXT:    vpexpandq %zmm0, %zmm0 {%k1} {z}
; AVX512-NEXT:    vpmovwb %zmm0, %ymm0
; AVX512-NEXT:    ret{{[l|q]}}
  %1 = icmp eq <16 x i16> %a0, zeroinitializer
  %2 = zext <16 x i1> %1 to <16 x i16>
  %3 = shufflevector <16 x i16> zeroinitializer, <16 x i16> %2, <32 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 16, i32 17, i32 18, i32 19, i32 20, i32 21, i32 22, i32 23, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15, i32 24, i32 25, i32 26, i32 27, i32 28, i32 29, i32 30, i32 31>
  %4 = trunc <32 x i16> %3 to <32 x i8>
  ret <32 x i8> %4
}

define <16 x i8> @_mm_packus_epi16_manual(<8 x i16> %a, <8 x i16> %b) nounwind {
; SSE-LABEL: _mm_packus_epi16_manual:
; SSE:       # %bb.0:
; SSE-NEXT:    packuswb %xmm1, %xmm0
; SSE-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: _mm_packus_epi16_manual:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vpackuswb %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: _mm_packus_epi16_manual:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpackuswb %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: _mm_packus_epi16_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    # kill: def $xmm0 killed $xmm0 def $ymm0
; AVX512-NEXT:    vinserti128 $1, %xmm1, %ymm0, %ymm0
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpmaxsw %ymm1, %ymm0, %ymm0
; AVX512-NEXT:    vpmovuswb %ymm0, %xmm0
; AVX512-NEXT:    vzeroupper
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <8 x i16> %a, <8 x i16> %b, <16 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15>
  %minv = tail call <16 x i16> @llvm.smax.v16i16(<16 x i16> %sh, <16 x i16> splat (i16 0))
  %sat = tail call <16 x i16> @llvm.smin.v16i16(<16 x i16> %minv, <16 x i16> splat (i16 255))
  %tr  = trunc nuw <16 x i16> %sat to <16 x i8>
  ret <16 x i8> %tr
}

define <32 x i8> @_mm256_packus_epi16_manual(<16 x i16> %a, <16 x i16> %b) nounwind {
; X86-SSE-LABEL: _mm256_packus_epi16_manual:
; X86-SSE:       # %bb.0:
; X86-SSE-NEXT:    pushl %ebp
; X86-SSE-NEXT:    movl %esp, %ebp
; X86-SSE-NEXT:    andl $-16, %esp
; X86-SSE-NEXT:    subl $16, %esp
; X86-SSE-NEXT:    packuswb %xmm2, %xmm0
; X86-SSE-NEXT:    packuswb 8(%ebp), %xmm1
; X86-SSE-NEXT:    movl %ebp, %esp
; X86-SSE-NEXT:    popl %ebp
; X86-SSE-NEXT:    retl
;
; X64-SSE-LABEL: _mm256_packus_epi16_manual:
; X64-SSE:       # %bb.0:
; X64-SSE-NEXT:    packuswb %xmm2, %xmm0
; X64-SSE-NEXT:    packuswb %xmm3, %xmm1
; X64-SSE-NEXT:    retq
;
; AVX1-LABEL: _mm256_packus_epi16_manual:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm2
; AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm3
; AVX1-NEXT:    vpackuswb %xmm3, %xmm2, %xmm2
; AVX1-NEXT:    vpackuswb %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm0, %ymm0
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: _mm256_packus_epi16_manual:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpackuswb %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: _mm256_packus_epi16_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vperm2i128 {{.*#+}} ymm2 = ymm0[2,3],ymm1[2,3]
; AVX512-NEXT:    vinserti128 $1, %xmm1, %ymm0, %ymm0
; AVX512-NEXT:    vinserti64x4 $1, %ymm2, %zmm0, %zmm0
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpmaxsw %zmm1, %zmm0, %zmm0
; AVX512-NEXT:    vpmovuswb %zmm0, %ymm0
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <16 x i16> %a, <16 x i16> %b, <32 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 16, i32 17, i32 18, i32 19, i32 20, i32 21, i32 22, i32 23, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15, i32 24, i32 25, i32 26, i32 27, i32 28, i32 29, i32 30, i32 31>
  %minv = tail call <32 x i16> @llvm.smax.v32i16(<32 x i16> %sh, <32 x i16> splat (i16 0))
  %sat = tail call <32 x i16> @llvm.smin.v32i16(<32 x i16> %minv, <32 x i16> splat (i16 255))
  %tr  = trunc nuw <32 x i16> %sat to <32 x i8>
  ret <32 x i8> %tr
}

define <64 x i8> @_mm512_packus_epi16_manual(<32 x i16> %a, <32 x i16> %b) nounwind {
; X86-SSE-LABEL: _mm512_packus_epi16_manual:
; X86-SSE:       # %bb.0:
; X86-SSE-NEXT:    pushl %ebp
; X86-SSE-NEXT:    movl %esp, %ebp
; X86-SSE-NEXT:    andl $-16, %esp
; X86-SSE-NEXT:    subl $16, %esp
; X86-SSE-NEXT:    movdqa 8(%ebp), %xmm3
; X86-SSE-NEXT:    packuswb 24(%ebp), %xmm0
; X86-SSE-NEXT:    packuswb 40(%ebp), %xmm1
; X86-SSE-NEXT:    packuswb 56(%ebp), %xmm2
; X86-SSE-NEXT:    packuswb 72(%ebp), %xmm3
; X86-SSE-NEXT:    movl %ebp, %esp
; X86-SSE-NEXT:    popl %ebp
; X86-SSE-NEXT:    retl
;
; X64-SSE-LABEL: _mm512_packus_epi16_manual:
; X64-SSE:       # %bb.0:
; X64-SSE-NEXT:    packuswb %xmm4, %xmm0
; X64-SSE-NEXT:    packuswb %xmm5, %xmm1
; X64-SSE-NEXT:    packuswb %xmm6, %xmm2
; X64-SSE-NEXT:    packuswb %xmm7, %xmm3
; X64-SSE-NEXT:    retq
;
; X86-AVX1-LABEL: _mm512_packus_epi16_manual:
; X86-AVX1:       # %bb.0:
; X86-AVX1-NEXT:    pushl %ebp
; X86-AVX1-NEXT:    movl %esp, %ebp
; X86-AVX1-NEXT:    andl $-32, %esp
; X86-AVX1-NEXT:    subl $32, %esp
; X86-AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm3
; X86-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm4
; X86-AVX1-NEXT:    vextractf128 $1, %ymm2, %xmm5
; X86-AVX1-NEXT:    vpackuswb %xmm5, %xmm4, %xmm4
; X86-AVX1-NEXT:    vpackuswb %xmm2, %xmm0, %xmm0
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm4, %ymm0, %ymm0
; X86-AVX1-NEXT:    vpackuswb 8(%ebp), %xmm1, %xmm1
; X86-AVX1-NEXT:    vpackuswb 24(%ebp), %xmm3, %xmm2
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm1, %ymm1
; X86-AVX1-NEXT:    movl %ebp, %esp
; X86-AVX1-NEXT:    popl %ebp
; X86-AVX1-NEXT:    retl
;
; X64-AVX1-LABEL: _mm512_packus_epi16_manual:
; X64-AVX1:       # %bb.0:
; X64-AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm4
; X64-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm5
; X64-AVX1-NEXT:    vextractf128 $1, %ymm2, %xmm6
; X64-AVX1-NEXT:    vpackuswb %xmm6, %xmm5, %xmm5
; X64-AVX1-NEXT:    vpackuswb %xmm2, %xmm0, %xmm0
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm5, %ymm0, %ymm0
; X64-AVX1-NEXT:    vextractf128 $1, %ymm3, %xmm2
; X64-AVX1-NEXT:    vpackuswb %xmm2, %xmm4, %xmm2
; X64-AVX1-NEXT:    vpackuswb %xmm3, %xmm1, %xmm1
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm1, %ymm1
; X64-AVX1-NEXT:    retq
;
; X86-AVX2-LABEL: _mm512_packus_epi16_manual:
; X86-AVX2:       # %bb.0:
; X86-AVX2-NEXT:    pushl %ebp
; X86-AVX2-NEXT:    movl %esp, %ebp
; X86-AVX2-NEXT:    andl $-32, %esp
; X86-AVX2-NEXT:    subl $32, %esp
; X86-AVX2-NEXT:    vpackuswb %ymm2, %ymm0, %ymm0
; X86-AVX2-NEXT:    vpackuswb 8(%ebp), %ymm1, %ymm1
; X86-AVX2-NEXT:    movl %ebp, %esp
; X86-AVX2-NEXT:    popl %ebp
; X86-AVX2-NEXT:    retl
;
; X64-AVX2-LABEL: _mm512_packus_epi16_manual:
; X64-AVX2:       # %bb.0:
; X64-AVX2-NEXT:    vpackuswb %ymm2, %ymm0, %ymm0
; X64-AVX2-NEXT:    vpackuswb %ymm3, %ymm1, %ymm1
; X64-AVX2-NEXT:    retq
;
; AVX512-LABEL: _mm512_packus_epi16_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpmovsxbq {{.*#+}} zmm2 = [0,1,8,9,2,3,10,11]
; AVX512-NEXT:    vpermi2q %zmm1, %zmm0, %zmm2
; AVX512-NEXT:    vpmovsxbq {{.*#+}} zmm3 = [4,5,12,13,6,7,14,15]
; AVX512-NEXT:    vpermi2q %zmm1, %zmm0, %zmm3
; AVX512-NEXT:    vpxor %xmm0, %xmm0, %xmm0
; AVX512-NEXT:    vpmaxsw %zmm0, %zmm3, %zmm1
; AVX512-NEXT:    vpmaxsw %zmm0, %zmm2, %zmm0
; AVX512-NEXT:    vpmovuswb %zmm0, %ymm0
; AVX512-NEXT:    vpmovuswb %zmm1, %ymm1
; AVX512-NEXT:    vinserti64x4 $1, %ymm1, %zmm0, %zmm0
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <32 x i16> %a, <32 x i16> %b, <64 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 32, i32 33, i32 34, i32 35, i32 36, i32 37, i32 38, i32 39, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15, i32 40, i32 41, i32 42, i32 43, i32 44, i32 45, i32 46, i32 47, i32 16, i32 17, i32 18, i32 19, i32 20, i32 21, i32 22, i32 23, i32 48, i32 49, i32 50, i32 51, i32 52, i32 53, i32 54, i32 55, i32 24, i32 25, i32 26, i32 27, i32 28, i32 29, i32 30, i32 31, i32 56, i32 57, i32 58, i32 59, i32 60, i32 61, i32 62, i32 63>
  %minv = tail call <64 x i16> @llvm.smax.v64i16(<64 x i16> %sh, <64 x i16> splat (i16 0))
  %sat = tail call <64 x i16> @llvm.smin.v64i16(<64 x i16> %minv, <64 x i16> splat (i16 255))
  %tr  = trunc nuw <64 x i16> %sat to <64 x i8>
  ret <64 x i8> %tr
}

define <8 x i16> @_mm_packus_epi32_manual(<4 x i32> %a, <4 x i32> %b) nounwind {
; X86-SSE2-LABEL: _mm_packus_epi32_manual:
; X86-SSE2:       # %bb.0:
; X86-SSE2-NEXT:    pxor %xmm3, %xmm3
; X86-SSE2-NEXT:    movdqa %xmm1, %xmm2
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm2
; X86-SSE2-NEXT:    pand %xmm1, %xmm2
; X86-SSE2-NEXT:    movdqa %xmm0, %xmm1
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm1
; X86-SSE2-NEXT:    pand %xmm1, %xmm0
; X86-SSE2-NEXT:    pcmpeqd %xmm3, %xmm3
; X86-SSE2-NEXT:    movdqa {{.*#+}} xmm1 = [65535,65535,65535,65535]
; X86-SSE2-NEXT:    movdqa %xmm1, %xmm4
; X86-SSE2-NEXT:    pcmpgtd %xmm0, %xmm4
; X86-SSE2-NEXT:    pand %xmm4, %xmm0
; X86-SSE2-NEXT:    pxor %xmm3, %xmm4
; X86-SSE2-NEXT:    por %xmm4, %xmm0
; X86-SSE2-NEXT:    pcmpgtd %xmm2, %xmm1
; X86-SSE2-NEXT:    pand %xmm1, %xmm2
; X86-SSE2-NEXT:    pxor %xmm3, %xmm1
; X86-SSE2-NEXT:    por %xmm2, %xmm1
; X86-SSE2-NEXT:    pslld $16, %xmm1
; X86-SSE2-NEXT:    psrad $16, %xmm1
; X86-SSE2-NEXT:    pslld $16, %xmm0
; X86-SSE2-NEXT:    psrad $16, %xmm0
; X86-SSE2-NEXT:    packssdw %xmm1, %xmm0
; X86-SSE2-NEXT:    retl
;
; X64-SSE2-LABEL: _mm_packus_epi32_manual:
; X64-SSE2:       # %bb.0:
; X64-SSE2-NEXT:    pxor %xmm2, %xmm2
; X64-SSE2-NEXT:    movdqa %xmm1, %xmm3
; X64-SSE2-NEXT:    pcmpgtd %xmm2, %xmm3
; X64-SSE2-NEXT:    pand %xmm1, %xmm3
; X64-SSE2-NEXT:    movdqa %xmm0, %xmm1
; X64-SSE2-NEXT:    pcmpgtd %xmm2, %xmm1
; X64-SSE2-NEXT:    pand %xmm1, %xmm0
; X64-SSE2-NEXT:    pcmpeqd %xmm1, %xmm1
; X64-SSE2-NEXT:    movdqa {{.*#+}} xmm2 = [65535,65535,65535,65535]
; X64-SSE2-NEXT:    movdqa %xmm2, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm0, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm0
; X64-SSE2-NEXT:    pxor %xmm1, %xmm4
; X64-SSE2-NEXT:    por %xmm4, %xmm0
; X64-SSE2-NEXT:    pcmpgtd %xmm3, %xmm2
; X64-SSE2-NEXT:    pand %xmm2, %xmm3
; X64-SSE2-NEXT:    pxor %xmm1, %xmm2
; X64-SSE2-NEXT:    por %xmm3, %xmm2
; X64-SSE2-NEXT:    pslld $16, %xmm2
; X64-SSE2-NEXT:    psrad $16, %xmm2
; X64-SSE2-NEXT:    pslld $16, %xmm0
; X64-SSE2-NEXT:    psrad $16, %xmm0
; X64-SSE2-NEXT:    packssdw %xmm2, %xmm0
; X64-SSE2-NEXT:    retq
;
; SSE4-LABEL: _mm_packus_epi32_manual:
; SSE4:       # %bb.0:
; SSE4-NEXT:    packusdw %xmm1, %xmm0
; SSE4-NEXT:    ret{{[l|q]}}
;
; AVX1-LABEL: _mm_packus_epi32_manual:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: _mm_packus_epi32_manual:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: _mm_packus_epi32_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    # kill: def $xmm0 killed $xmm0 def $ymm0
; AVX512-NEXT:    vinserti128 $1, %xmm1, %ymm0, %ymm0
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpmaxsd %ymm1, %ymm0, %ymm0
; AVX512-NEXT:    vpmovusdw %ymm0, %xmm0
; AVX512-NEXT:    vzeroupper
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <4 x i32> %a, <4 x i32> %b, <8 x i32> <i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7>
  %minv = tail call <8 x i32> @llvm.smax.v32i32(<8 x i32> %sh, <8 x i32> splat (i32 0))
  %sat = tail call <8 x i32> @llvm.smin.v32i32(<8 x i32> %minv, <8 x i32> splat (i32 65535))
  %tr  = trunc nuw <8 x i32> %sat to <8 x i16>
  ret <8 x i16> %tr
}

define <16 x i16> @_mm256_packus_epi32_manual(<8 x i32> %a, <8 x i32> %b) nounwind {
; X86-SSE2-LABEL: _mm256_packus_epi32_manual:
; X86-SSE2:       # %bb.0:
; X86-SSE2-NEXT:    pushl %ebp
; X86-SSE2-NEXT:    movl %esp, %ebp
; X86-SSE2-NEXT:    andl $-16, %esp
; X86-SSE2-NEXT:    subl $16, %esp
; X86-SSE2-NEXT:    movdqa 8(%ebp), %xmm4
; X86-SSE2-NEXT:    pxor %xmm5, %xmm5
; X86-SSE2-NEXT:    movdqa %xmm2, %xmm3
; X86-SSE2-NEXT:    pcmpgtd %xmm5, %xmm3
; X86-SSE2-NEXT:    pand %xmm2, %xmm3
; X86-SSE2-NEXT:    movdqa %xmm0, %xmm2
; X86-SSE2-NEXT:    pcmpgtd %xmm5, %xmm2
; X86-SSE2-NEXT:    pand %xmm2, %xmm0
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm6
; X86-SSE2-NEXT:    pcmpgtd %xmm5, %xmm6
; X86-SSE2-NEXT:    pand %xmm4, %xmm6
; X86-SSE2-NEXT:    movdqa %xmm1, %xmm2
; X86-SSE2-NEXT:    pcmpgtd %xmm5, %xmm2
; X86-SSE2-NEXT:    pand %xmm2, %xmm1
; X86-SSE2-NEXT:    pcmpeqd %xmm5, %xmm5
; X86-SSE2-NEXT:    movdqa {{.*#+}} xmm4 = [65535,65535,65535,65535]
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm2
; X86-SSE2-NEXT:    pcmpgtd %xmm1, %xmm2
; X86-SSE2-NEXT:    pand %xmm2, %xmm1
; X86-SSE2-NEXT:    pxor %xmm5, %xmm2
; X86-SSE2-NEXT:    por %xmm2, %xmm1
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm2
; X86-SSE2-NEXT:    pcmpgtd %xmm6, %xmm2
; X86-SSE2-NEXT:    pand %xmm2, %xmm6
; X86-SSE2-NEXT:    pxor %xmm5, %xmm2
; X86-SSE2-NEXT:    por %xmm6, %xmm2
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm6
; X86-SSE2-NEXT:    pcmpgtd %xmm0, %xmm6
; X86-SSE2-NEXT:    pand %xmm6, %xmm0
; X86-SSE2-NEXT:    pxor %xmm5, %xmm6
; X86-SSE2-NEXT:    por %xmm6, %xmm0
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm4
; X86-SSE2-NEXT:    pand %xmm4, %xmm3
; X86-SSE2-NEXT:    pxor %xmm5, %xmm4
; X86-SSE2-NEXT:    por %xmm3, %xmm4
; X86-SSE2-NEXT:    pslld $16, %xmm4
; X86-SSE2-NEXT:    psrad $16, %xmm4
; X86-SSE2-NEXT:    pslld $16, %xmm0
; X86-SSE2-NEXT:    psrad $16, %xmm0
; X86-SSE2-NEXT:    packssdw %xmm4, %xmm0
; X86-SSE2-NEXT:    pslld $16, %xmm2
; X86-SSE2-NEXT:    psrad $16, %xmm2
; X86-SSE2-NEXT:    pslld $16, %xmm1
; X86-SSE2-NEXT:    psrad $16, %xmm1
; X86-SSE2-NEXT:    packssdw %xmm2, %xmm1
; X86-SSE2-NEXT:    movl %ebp, %esp
; X86-SSE2-NEXT:    popl %ebp
; X86-SSE2-NEXT:    retl
;
; X64-SSE2-LABEL: _mm256_packus_epi32_manual:
; X64-SSE2:       # %bb.0:
; X64-SSE2-NEXT:    pxor %xmm5, %xmm5
; X64-SSE2-NEXT:    movdqa %xmm2, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm5, %xmm4
; X64-SSE2-NEXT:    pand %xmm2, %xmm4
; X64-SSE2-NEXT:    movdqa %xmm0, %xmm2
; X64-SSE2-NEXT:    pcmpgtd %xmm5, %xmm2
; X64-SSE2-NEXT:    pand %xmm2, %xmm0
; X64-SSE2-NEXT:    movdqa %xmm3, %xmm6
; X64-SSE2-NEXT:    pcmpgtd %xmm5, %xmm6
; X64-SSE2-NEXT:    pand %xmm3, %xmm6
; X64-SSE2-NEXT:    movdqa %xmm1, %xmm2
; X64-SSE2-NEXT:    pcmpgtd %xmm5, %xmm2
; X64-SSE2-NEXT:    pand %xmm2, %xmm1
; X64-SSE2-NEXT:    pcmpeqd %xmm5, %xmm5
; X64-SSE2-NEXT:    movdqa {{.*#+}} xmm3 = [65535,65535,65535,65535]
; X64-SSE2-NEXT:    movdqa %xmm3, %xmm2
; X64-SSE2-NEXT:    pcmpgtd %xmm1, %xmm2
; X64-SSE2-NEXT:    pand %xmm2, %xmm1
; X64-SSE2-NEXT:    pxor %xmm5, %xmm2
; X64-SSE2-NEXT:    por %xmm2, %xmm1
; X64-SSE2-NEXT:    movdqa %xmm3, %xmm2
; X64-SSE2-NEXT:    pcmpgtd %xmm6, %xmm2
; X64-SSE2-NEXT:    pand %xmm2, %xmm6
; X64-SSE2-NEXT:    pxor %xmm5, %xmm2
; X64-SSE2-NEXT:    por %xmm6, %xmm2
; X64-SSE2-NEXT:    movdqa %xmm3, %xmm6
; X64-SSE2-NEXT:    pcmpgtd %xmm0, %xmm6
; X64-SSE2-NEXT:    pand %xmm6, %xmm0
; X64-SSE2-NEXT:    pxor %xmm5, %xmm6
; X64-SSE2-NEXT:    por %xmm6, %xmm0
; X64-SSE2-NEXT:    pcmpgtd %xmm4, %xmm3
; X64-SSE2-NEXT:    pand %xmm3, %xmm4
; X64-SSE2-NEXT:    pxor %xmm5, %xmm3
; X64-SSE2-NEXT:    por %xmm4, %xmm3
; X64-SSE2-NEXT:    pslld $16, %xmm3
; X64-SSE2-NEXT:    psrad $16, %xmm3
; X64-SSE2-NEXT:    pslld $16, %xmm0
; X64-SSE2-NEXT:    psrad $16, %xmm0
; X64-SSE2-NEXT:    packssdw %xmm3, %xmm0
; X64-SSE2-NEXT:    pslld $16, %xmm2
; X64-SSE2-NEXT:    psrad $16, %xmm2
; X64-SSE2-NEXT:    pslld $16, %xmm1
; X64-SSE2-NEXT:    psrad $16, %xmm1
; X64-SSE2-NEXT:    packssdw %xmm2, %xmm1
; X64-SSE2-NEXT:    retq
;
; X86-SSE4-LABEL: _mm256_packus_epi32_manual:
; X86-SSE4:       # %bb.0:
; X86-SSE4-NEXT:    pushl %ebp
; X86-SSE4-NEXT:    movl %esp, %ebp
; X86-SSE4-NEXT:    andl $-16, %esp
; X86-SSE4-NEXT:    subl $16, %esp
; X86-SSE4-NEXT:    packusdw %xmm2, %xmm0
; X86-SSE4-NEXT:    packusdw 8(%ebp), %xmm1
; X86-SSE4-NEXT:    movl %ebp, %esp
; X86-SSE4-NEXT:    popl %ebp
; X86-SSE4-NEXT:    retl
;
; X64-SSE4-LABEL: _mm256_packus_epi32_manual:
; X64-SSE4:       # %bb.0:
; X64-SSE4-NEXT:    packusdw %xmm2, %xmm0
; X64-SSE4-NEXT:    packusdw %xmm3, %xmm1
; X64-SSE4-NEXT:    retq
;
; AVX1-LABEL: _mm256_packus_epi32_manual:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm2
; AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm3
; AVX1-NEXT:    vpackusdw %xmm3, %xmm2, %xmm2
; AVX1-NEXT:    vpackusdw %xmm1, %xmm0, %xmm0
; AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm0, %ymm0
; AVX1-NEXT:    ret{{[l|q]}}
;
; AVX2-LABEL: _mm256_packus_epi32_manual:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpackusdw %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    ret{{[l|q]}}
;
; AVX512-LABEL: _mm256_packus_epi32_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vperm2i128 {{.*#+}} ymm2 = ymm0[2,3],ymm1[2,3]
; AVX512-NEXT:    vinserti128 $1, %xmm1, %ymm0, %ymm0
; AVX512-NEXT:    vinserti64x4 $1, %ymm2, %zmm0, %zmm0
; AVX512-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX512-NEXT:    vpmaxsd %zmm1, %zmm0, %zmm0
; AVX512-NEXT:    vpmovusdw %zmm0, %ymm0
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <8 x i32> %a, <8 x i32> %b, <16 x i32> <i32 0, i32 1, i32 2, i32 3, i32 8, i32 9, i32 10, i32 11, i32 4, i32 5, i32 6, i32 7, i32 12, i32 13, i32 14, i32 15>
  %minv = tail call <16 x i32> @llvm.smax.v32i32(<16 x i32> %sh, <16 x i32> splat (i32 0))
  %sat = tail call <16 x i32> @llvm.smin.v32i32(<16 x i32> %minv, <16 x i32> splat (i32 65535))
  %tr  = trunc nuw <16 x i32> %sat to <16 x i16>
  ret <16 x i16> %tr
}

define <32 x i16> @_mm512_packus_epi32_manual(<16 x i32> %a, <16 x i32> %b) nounwind {
; X86-SSE2-LABEL: _mm512_packus_epi32_manual:
; X86-SSE2:       # %bb.0:
; X86-SSE2-NEXT:    pushl %ebp
; X86-SSE2-NEXT:    movl %esp, %ebp
; X86-SSE2-NEXT:    andl $-16, %esp
; X86-SSE2-NEXT:    subl $64, %esp
; X86-SSE2-NEXT:    movdqa %xmm2, %xmm4
; X86-SSE2-NEXT:    movdqa %xmm1, %xmm6
; X86-SSE2-NEXT:    movdqa %xmm0, %xmm2
; X86-SSE2-NEXT:    movdqa 56(%ebp), %xmm0
; X86-SSE2-NEXT:    movdqa 40(%ebp), %xmm1
; X86-SSE2-NEXT:    movdqa 24(%ebp), %xmm5
; X86-SSE2-NEXT:    pxor %xmm3, %xmm3
; X86-SSE2-NEXT:    movdqa %xmm5, %xmm7
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm7
; X86-SSE2-NEXT:    pand %xmm5, %xmm7
; X86-SSE2-NEXT:    movdqa %xmm7, {{[-0-9]+}}(%e{{[sb]}}p) # 16-byte Spill
; X86-SSE2-NEXT:    movdqa %xmm2, %xmm5
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm5
; X86-SSE2-NEXT:    pand %xmm5, %xmm2
; X86-SSE2-NEXT:    movdqa %xmm1, %xmm5
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm5
; X86-SSE2-NEXT:    pand %xmm1, %xmm5
; X86-SSE2-NEXT:    movdqa %xmm5, {{[-0-9]+}}(%e{{[sb]}}p) # 16-byte Spill
; X86-SSE2-NEXT:    movdqa %xmm6, %xmm1
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm1
; X86-SSE2-NEXT:    pand %xmm1, %xmm6
; X86-SSE2-NEXT:    movdqa %xmm0, %xmm1
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm1
; X86-SSE2-NEXT:    pand %xmm0, %xmm1
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm0
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm0
; X86-SSE2-NEXT:    pand %xmm0, %xmm4
; X86-SSE2-NEXT:    movdqa %xmm4, (%esp) # 16-byte Spill
; X86-SSE2-NEXT:    movdqa 72(%ebp), %xmm5
; X86-SSE2-NEXT:    movdqa %xmm5, %xmm0
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm0
; X86-SSE2-NEXT:    pand %xmm5, %xmm0
; X86-SSE2-NEXT:    movdqa 8(%ebp), %xmm7
; X86-SSE2-NEXT:    movdqa %xmm7, %xmm5
; X86-SSE2-NEXT:    pcmpgtd %xmm3, %xmm5
; X86-SSE2-NEXT:    pand %xmm7, %xmm5
; X86-SSE2-NEXT:    movdqa {{.*#+}} xmm3 = [65535,65535,65535,65535]
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm4
; X86-SSE2-NEXT:    pcmpgtd %xmm5, %xmm4
; X86-SSE2-NEXT:    pand %xmm4, %xmm5
; X86-SSE2-NEXT:    pcmpeqd %xmm7, %xmm7
; X86-SSE2-NEXT:    pxor %xmm7, %xmm4
; X86-SSE2-NEXT:    por %xmm5, %xmm4
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm5
; X86-SSE2-NEXT:    pcmpgtd %xmm0, %xmm5
; X86-SSE2-NEXT:    pand %xmm5, %xmm0
; X86-SSE2-NEXT:    pxor %xmm7, %xmm5
; X86-SSE2-NEXT:    por %xmm0, %xmm5
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm0
; X86-SSE2-NEXT:    movdqa (%esp), %xmm7 # 16-byte Reload
; X86-SSE2-NEXT:    pcmpgtd %xmm7, %xmm0
; X86-SSE2-NEXT:    pand %xmm0, %xmm7
; X86-SSE2-NEXT:    pxor {{\.?LCPI[0-9]+_[0-9]+}}, %xmm0
; X86-SSE2-NEXT:    por %xmm0, %xmm7
; X86-SSE2-NEXT:    movdqa %xmm7, (%esp) # 16-byte Spill
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm0
; X86-SSE2-NEXT:    pcmpgtd %xmm1, %xmm0
; X86-SSE2-NEXT:    pand %xmm0, %xmm1
; X86-SSE2-NEXT:    pcmpeqd %xmm7, %xmm7
; X86-SSE2-NEXT:    pxor %xmm7, %xmm0
; X86-SSE2-NEXT:    por %xmm1, %xmm0
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm1
; X86-SSE2-NEXT:    pcmpgtd %xmm6, %xmm1
; X86-SSE2-NEXT:    pand %xmm1, %xmm6
; X86-SSE2-NEXT:    pxor %xmm7, %xmm1
; X86-SSE2-NEXT:    por %xmm1, %xmm6
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm1
; X86-SSE2-NEXT:    movdqa {{[-0-9]+}}(%e{{[sb]}}p), %xmm7 # 16-byte Reload
; X86-SSE2-NEXT:    pcmpgtd %xmm7, %xmm1
; X86-SSE2-NEXT:    pand %xmm1, %xmm7
; X86-SSE2-NEXT:    pxor {{\.?LCPI[0-9]+_[0-9]+}}, %xmm1
; X86-SSE2-NEXT:    por %xmm7, %xmm1
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm7
; X86-SSE2-NEXT:    pcmpgtd %xmm2, %xmm7
; X86-SSE2-NEXT:    pand %xmm7, %xmm2
; X86-SSE2-NEXT:    pxor {{\.?LCPI[0-9]+_[0-9]+}}, %xmm7
; X86-SSE2-NEXT:    por %xmm7, %xmm2
; X86-SSE2-NEXT:    movdqa {{[-0-9]+}}(%e{{[sb]}}p), %xmm7 # 16-byte Reload
; X86-SSE2-NEXT:    pcmpgtd %xmm7, %xmm3
; X86-SSE2-NEXT:    pand %xmm3, %xmm7
; X86-SSE2-NEXT:    pxor {{\.?LCPI[0-9]+_[0-9]+}}, %xmm3
; X86-SSE2-NEXT:    por %xmm7, %xmm3
; X86-SSE2-NEXT:    pslld $16, %xmm3
; X86-SSE2-NEXT:    psrad $16, %xmm3
; X86-SSE2-NEXT:    pslld $16, %xmm2
; X86-SSE2-NEXT:    psrad $16, %xmm2
; X86-SSE2-NEXT:    packssdw %xmm3, %xmm2
; X86-SSE2-NEXT:    pslld $16, %xmm1
; X86-SSE2-NEXT:    psrad $16, %xmm1
; X86-SSE2-NEXT:    pslld $16, %xmm6
; X86-SSE2-NEXT:    psrad $16, %xmm6
; X86-SSE2-NEXT:    packssdw %xmm1, %xmm6
; X86-SSE2-NEXT:    pslld $16, %xmm0
; X86-SSE2-NEXT:    psrad $16, %xmm0
; X86-SSE2-NEXT:    movdqa (%esp), %xmm3 # 16-byte Reload
; X86-SSE2-NEXT:    pslld $16, %xmm3
; X86-SSE2-NEXT:    psrad $16, %xmm3
; X86-SSE2-NEXT:    packssdw %xmm0, %xmm3
; X86-SSE2-NEXT:    pslld $16, %xmm5
; X86-SSE2-NEXT:    psrad $16, %xmm5
; X86-SSE2-NEXT:    pslld $16, %xmm4
; X86-SSE2-NEXT:    psrad $16, %xmm4
; X86-SSE2-NEXT:    packssdw %xmm5, %xmm4
; X86-SSE2-NEXT:    movdqa %xmm2, %xmm0
; X86-SSE2-NEXT:    movdqa %xmm6, %xmm1
; X86-SSE2-NEXT:    movdqa %xmm3, %xmm2
; X86-SSE2-NEXT:    movdqa %xmm4, %xmm3
; X86-SSE2-NEXT:    movl %ebp, %esp
; X86-SSE2-NEXT:    popl %ebp
; X86-SSE2-NEXT:    retl
;
; X64-SSE2-LABEL: _mm512_packus_epi32_manual:
; X64-SSE2:       # %bb.0:
; X64-SSE2-NEXT:    pxor %xmm11, %xmm11
; X64-SSE2-NEXT:    movdqa %xmm4, %xmm8
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm8
; X64-SSE2-NEXT:    pand %xmm4, %xmm8
; X64-SSE2-NEXT:    movdqa %xmm0, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm0
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm9
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm9
; X64-SSE2-NEXT:    pand %xmm5, %xmm9
; X64-SSE2-NEXT:    movdqa %xmm1, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm1
; X64-SSE2-NEXT:    movdqa %xmm6, %xmm10
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm10
; X64-SSE2-NEXT:    pand %xmm6, %xmm10
; X64-SSE2-NEXT:    movdqa %xmm2, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm2
; X64-SSE2-NEXT:    movdqa %xmm7, %xmm6
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm6
; X64-SSE2-NEXT:    pand %xmm7, %xmm6
; X64-SSE2-NEXT:    movdqa %xmm3, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm11, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm3
; X64-SSE2-NEXT:    pcmpeqd %xmm7, %xmm7
; X64-SSE2-NEXT:    movdqa {{.*#+}} xmm5 = [65535,65535,65535,65535]
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm3, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm3
; X64-SSE2-NEXT:    pxor %xmm7, %xmm4
; X64-SSE2-NEXT:    por %xmm4, %xmm3
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm4
; X64-SSE2-NEXT:    pcmpgtd %xmm6, %xmm4
; X64-SSE2-NEXT:    pand %xmm4, %xmm6
; X64-SSE2-NEXT:    pxor %xmm7, %xmm4
; X64-SSE2-NEXT:    por %xmm6, %xmm4
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm6
; X64-SSE2-NEXT:    pcmpgtd %xmm2, %xmm6
; X64-SSE2-NEXT:    pand %xmm6, %xmm2
; X64-SSE2-NEXT:    pxor %xmm7, %xmm6
; X64-SSE2-NEXT:    por %xmm6, %xmm2
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm6
; X64-SSE2-NEXT:    pcmpgtd %xmm10, %xmm6
; X64-SSE2-NEXT:    pand %xmm6, %xmm10
; X64-SSE2-NEXT:    pxor %xmm7, %xmm6
; X64-SSE2-NEXT:    por %xmm10, %xmm6
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm10
; X64-SSE2-NEXT:    pcmpgtd %xmm1, %xmm10
; X64-SSE2-NEXT:    pand %xmm10, %xmm1
; X64-SSE2-NEXT:    pxor %xmm7, %xmm10
; X64-SSE2-NEXT:    por %xmm10, %xmm1
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm10
; X64-SSE2-NEXT:    pcmpgtd %xmm9, %xmm10
; X64-SSE2-NEXT:    pand %xmm10, %xmm9
; X64-SSE2-NEXT:    pxor %xmm7, %xmm10
; X64-SSE2-NEXT:    por %xmm9, %xmm10
; X64-SSE2-NEXT:    movdqa %xmm5, %xmm9
; X64-SSE2-NEXT:    pcmpgtd %xmm0, %xmm9
; X64-SSE2-NEXT:    pand %xmm9, %xmm0
; X64-SSE2-NEXT:    pxor %xmm7, %xmm9
; X64-SSE2-NEXT:    por %xmm9, %xmm0
; X64-SSE2-NEXT:    pcmpgtd %xmm8, %xmm5
; X64-SSE2-NEXT:    pand %xmm5, %xmm8
; X64-SSE2-NEXT:    pxor %xmm7, %xmm5
; X64-SSE2-NEXT:    por %xmm8, %xmm5
; X64-SSE2-NEXT:    pslld $16, %xmm5
; X64-SSE2-NEXT:    psrad $16, %xmm5
; X64-SSE2-NEXT:    pslld $16, %xmm0
; X64-SSE2-NEXT:    psrad $16, %xmm0
; X64-SSE2-NEXT:    packssdw %xmm5, %xmm0
; X64-SSE2-NEXT:    pslld $16, %xmm10
; X64-SSE2-NEXT:    psrad $16, %xmm10
; X64-SSE2-NEXT:    pslld $16, %xmm1
; X64-SSE2-NEXT:    psrad $16, %xmm1
; X64-SSE2-NEXT:    packssdw %xmm10, %xmm1
; X64-SSE2-NEXT:    pslld $16, %xmm6
; X64-SSE2-NEXT:    psrad $16, %xmm6
; X64-SSE2-NEXT:    pslld $16, %xmm2
; X64-SSE2-NEXT:    psrad $16, %xmm2
; X64-SSE2-NEXT:    packssdw %xmm6, %xmm2
; X64-SSE2-NEXT:    pslld $16, %xmm4
; X64-SSE2-NEXT:    psrad $16, %xmm4
; X64-SSE2-NEXT:    pslld $16, %xmm3
; X64-SSE2-NEXT:    psrad $16, %xmm3
; X64-SSE2-NEXT:    packssdw %xmm4, %xmm3
; X64-SSE2-NEXT:    retq
;
; X86-SSE4-LABEL: _mm512_packus_epi32_manual:
; X86-SSE4:       # %bb.0:
; X86-SSE4-NEXT:    pushl %ebp
; X86-SSE4-NEXT:    movl %esp, %ebp
; X86-SSE4-NEXT:    andl $-16, %esp
; X86-SSE4-NEXT:    subl $16, %esp
; X86-SSE4-NEXT:    movdqa 8(%ebp), %xmm3
; X86-SSE4-NEXT:    packusdw 24(%ebp), %xmm0
; X86-SSE4-NEXT:    packusdw 40(%ebp), %xmm1
; X86-SSE4-NEXT:    packusdw 56(%ebp), %xmm2
; X86-SSE4-NEXT:    packusdw 72(%ebp), %xmm3
; X86-SSE4-NEXT:    movl %ebp, %esp
; X86-SSE4-NEXT:    popl %ebp
; X86-SSE4-NEXT:    retl
;
; X64-SSE4-LABEL: _mm512_packus_epi32_manual:
; X64-SSE4:       # %bb.0:
; X64-SSE4-NEXT:    packusdw %xmm4, %xmm0
; X64-SSE4-NEXT:    packusdw %xmm5, %xmm1
; X64-SSE4-NEXT:    packusdw %xmm6, %xmm2
; X64-SSE4-NEXT:    packusdw %xmm7, %xmm3
; X64-SSE4-NEXT:    retq
;
; X86-AVX1-LABEL: _mm512_packus_epi32_manual:
; X86-AVX1:       # %bb.0:
; X86-AVX1-NEXT:    pushl %ebp
; X86-AVX1-NEXT:    movl %esp, %ebp
; X86-AVX1-NEXT:    andl $-32, %esp
; X86-AVX1-NEXT:    subl $32, %esp
; X86-AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm3
; X86-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm4
; X86-AVX1-NEXT:    vextractf128 $1, %ymm2, %xmm5
; X86-AVX1-NEXT:    vpackusdw %xmm5, %xmm4, %xmm4
; X86-AVX1-NEXT:    vpackusdw %xmm2, %xmm0, %xmm0
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm4, %ymm0, %ymm0
; X86-AVX1-NEXT:    vpackusdw 8(%ebp), %xmm1, %xmm1
; X86-AVX1-NEXT:    vpackusdw 24(%ebp), %xmm3, %xmm2
; X86-AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm1, %ymm1
; X86-AVX1-NEXT:    movl %ebp, %esp
; X86-AVX1-NEXT:    popl %ebp
; X86-AVX1-NEXT:    retl
;
; X64-AVX1-LABEL: _mm512_packus_epi32_manual:
; X64-AVX1:       # %bb.0:
; X64-AVX1-NEXT:    vextractf128 $1, %ymm1, %xmm4
; X64-AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm5
; X64-AVX1-NEXT:    vextractf128 $1, %ymm2, %xmm6
; X64-AVX1-NEXT:    vpackusdw %xmm6, %xmm5, %xmm5
; X64-AVX1-NEXT:    vpackusdw %xmm2, %xmm0, %xmm0
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm5, %ymm0, %ymm0
; X64-AVX1-NEXT:    vextractf128 $1, %ymm3, %xmm2
; X64-AVX1-NEXT:    vpackusdw %xmm2, %xmm4, %xmm2
; X64-AVX1-NEXT:    vpackusdw %xmm3, %xmm1, %xmm1
; X64-AVX1-NEXT:    vinsertf128 $1, %xmm2, %ymm1, %ymm1
; X64-AVX1-NEXT:    retq
;
; X86-AVX2-LABEL: _mm512_packus_epi32_manual:
; X86-AVX2:       # %bb.0:
; X86-AVX2-NEXT:    pushl %ebp
; X86-AVX2-NEXT:    movl %esp, %ebp
; X86-AVX2-NEXT:    andl $-32, %esp
; X86-AVX2-NEXT:    subl $32, %esp
; X86-AVX2-NEXT:    vpackusdw %ymm2, %ymm0, %ymm0
; X86-AVX2-NEXT:    vpackusdw 8(%ebp), %ymm1, %ymm1
; X86-AVX2-NEXT:    movl %ebp, %esp
; X86-AVX2-NEXT:    popl %ebp
; X86-AVX2-NEXT:    retl
;
; X64-AVX2-LABEL: _mm512_packus_epi32_manual:
; X64-AVX2:       # %bb.0:
; X64-AVX2-NEXT:    vpackusdw %ymm2, %ymm0, %ymm0
; X64-AVX2-NEXT:    vpackusdw %ymm3, %ymm1, %ymm1
; X64-AVX2-NEXT:    retq
;
; AVX512-LABEL: _mm512_packus_epi32_manual:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpmovsxbq {{.*#+}} zmm2 = [0,1,8,9,2,3,10,11]
; AVX512-NEXT:    vpermi2q %zmm1, %zmm0, %zmm2
; AVX512-NEXT:    vpmovsxbq {{.*#+}} zmm3 = [4,5,12,13,6,7,14,15]
; AVX512-NEXT:    vpermi2q %zmm1, %zmm0, %zmm3
; AVX512-NEXT:    vpxor %xmm0, %xmm0, %xmm0
; AVX512-NEXT:    vpmaxsd %zmm0, %zmm3, %zmm1
; AVX512-NEXT:    vpmaxsd %zmm0, %zmm2, %zmm0
; AVX512-NEXT:    vpmovusdw %zmm0, %ymm0
; AVX512-NEXT:    vpmovusdw %zmm1, %ymm1
; AVX512-NEXT:    vinserti64x4 $1, %ymm1, %zmm0, %zmm0
; AVX512-NEXT:    ret{{[l|q]}}
  %sh  = shufflevector <16 x i32> %a, <16 x i32> %b, <32 x i32> <i32 0, i32 1, i32 2, i32 3, i32 16, i32 17, i32 18, i32 19, i32 4, i32 5, i32 6, i32 7, i32 20, i32 21, i32 22, i32 23, i32 8, i32 9, i32 10, i32 11, i32 24, i32 25, i32 26, i32 27, i32 12, i32 13, i32 14, i32 15, i32 28, i32 29, i32 30, i32 31>
  %minv = tail call <32 x i32> @llvm.smax.v32i32(<32 x i32> %sh, <32 x i32> splat (i32 0))
  %sat = tail call <32 x i32> @llvm.smin.v32i32(<32 x i32> %minv, <32 x i32> splat (i32 65535))
  %tr  = trunc nuw <32 x i32> %sat to <32 x i16>
  ret <32 x i16> %tr
}
