; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=x86_64-- -mattr=+avx512f,+avx512bw,+gfni | FileCheck %s

declare <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8>, <64 x i8>, i8)

define <64 x i8> @test_affine_xor_fold_512(<64 x i8> %src1, <64 x i8> %src2) nounwind {
;
; CHECK-LABEL: test_affine_xor_fold_512:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vgf2p8affineqb $255, %zmm1, %zmm0, %zmm0
; CHECK-NEXT:    retq
  %gfni = call <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8> %src1, <64 x i8> %src2, i8 0)
  %xor = xor <64 x i8> %gfni, splat(i8 -1)
  ret <64 x i8> %xor
}

define <64 x i8> @test_affine_xor_fold_512_nonzero_imm(<64 x i8> %src1, <64 x i8> %src2) nounwind {
;
; CHECK-LABEL: test_affine_xor_fold_512_nonzero_imm:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vgf2p8affineqb $175, %zmm1, %zmm0, %zmm0
; CHECK-NEXT:    retq
  %gfni = call <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8> %src1, <64 x i8> %src2, i8 5)
  %xor = xor <64 x i8> %gfni, splat(i8 -86)
  ret <64 x i8> %xor
}

define <64 x i8> @test_affine_xor_fold_512_commutative(<64 x i8> %src1, <64 x i8> %src2) nounwind {
;
; CHECK-LABEL: test_affine_xor_fold_512_commutative:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vgf2p8affineqb $255, %zmm1, %zmm0, %zmm0
; CHECK-NEXT:    retq
  %gfni = call <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8> %src1, <64 x i8> %src2, i8 0)
  %xor = xor <64 x i8> splat(i8 -1), %gfni
  ret <64 x i8> %xor
}

define <64 x i8> @test_affine_xor_no_fold_512_multi_use(<64 x i8> %src1, <64 x i8> %src2, ptr %out) nounwind {
;
; CHECK-LABEL: test_affine_xor_no_fold_512_multi_use:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vgf2p8affineqb $0, %zmm1, %zmm0, %zmm0
; CHECK-NEXT:    vmovdqa64 %zmm0, (%rdi)
; CHECK-NEXT:    vpternlogq {{.*#+}} zmm0 = ~zmm0
; CHECK-NEXT:    retq
  %gfni = call <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8> %src1, <64 x i8> %src2, i8 0)
  store <64 x i8> %gfni, ptr %out
  %xor = xor <64 x i8> %gfni, splat(i8 -1)
  ret <64 x i8> %xor
}

define <64 x i8> @test_affine_xor_no_fold_512_variable(<64 x i8> %src1, <64 x i8> %src2, <64 x i8> %var) nounwind {
;
; CHECK-LABEL: test_affine_xor_no_fold_512_variable:
; CHECK:       # %bb.0:
; CHECK-NEXT:    vgf2p8affineqb $0, %zmm1, %zmm0, %zmm0
; CHECK-NEXT:    vpxorq %zmm2, %zmm0, %zmm0
; CHECK-NEXT:    retq
  %gfni = call <64 x i8> @llvm.x86.vgf2p8affineqb.512(<64 x i8> %src1, <64 x i8> %src2, i8 0)
  %xor = xor <64 x i8> %gfni, %var
  ret <64 x i8> %xor
}
