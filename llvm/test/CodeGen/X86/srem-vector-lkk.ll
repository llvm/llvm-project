; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+sse2    | FileCheck %s --check-prefixes=SSE,SSE2
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+sse4.1  | FileCheck %s --check-prefixes=SSE,SSE4
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+avx     | FileCheck %s --check-prefixes=AVX,AVX1OR2,AVX1
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mattr=+avx2    | FileCheck %s --check-prefixes=AVX,AVX1OR2,AVX2
; RUN: llc < %s -mtriple=x86_64-unknown-unknown -mcpu=x86-64-v4 | FileCheck %s --check-prefixes=AVX,AVX512

define <4 x i16> @fold_srem_vec_1(<4 x i16> %x) {
; SSE-LABEL: fold_srem_vec_1:
; SSE:       # %bb.0:
; SSE-NEXT:    pextrw $3, %xmm0, %eax
; SSE-NEXT:    movswl %ax, %ecx
; SSE-NEXT:    imull $32081, %ecx, %ecx # imm = 0x7D51
; SSE-NEXT:    shrl $16, %ecx
; SSE-NEXT:    subl %eax, %ecx
; SSE-NEXT:    movzwl %cx, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    shrl $15, %ecx
; SSE-NEXT:    sarl $9, %edx
; SSE-NEXT:    addl %ecx, %edx
; SSE-NEXT:    imull $-1003, %edx, %ecx # imm = 0xFC15
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    movd %xmm0, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    imull $-21385, %edx, %edx # imm = 0xAC77
; SSE-NEXT:    shrl $16, %edx
; SSE-NEXT:    addl %ecx, %edx
; SSE-NEXT:    movzwl %dx, %edx
; SSE-NEXT:    movswl %dx, %esi
; SSE-NEXT:    shrl $15, %edx
; SSE-NEXT:    sarl $6, %esi
; SSE-NEXT:    addl %edx, %esi
; SSE-NEXT:    imull $95, %esi, %edx
; SSE-NEXT:    subl %edx, %ecx
; SSE-NEXT:    movd %ecx, %xmm1
; SSE-NEXT:    pextrw $1, %xmm0, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    imull $-16913, %edx, %edx # imm = 0xBDEF
; SSE-NEXT:    movl %edx, %esi
; SSE-NEXT:    shrl $31, %esi
; SSE-NEXT:    sarl $21, %edx
; SSE-NEXT:    addl %esi, %edx
; SSE-NEXT:    imull $-124, %edx, %edx
; SSE-NEXT:    subl %edx, %ecx
; SSE-NEXT:    pinsrw $1, %ecx, %xmm1
; SSE-NEXT:    pextrw $2, %xmm0, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    imull $2675, %edx, %edx # imm = 0xA73
; SSE-NEXT:    movl %edx, %esi
; SSE-NEXT:    shrl $31, %esi
; SSE-NEXT:    sarl $18, %edx
; SSE-NEXT:    addl %esi, %edx
; SSE-NEXT:    imull $98, %edx, %edx
; SSE-NEXT:    subl %edx, %ecx
; SSE-NEXT:    pinsrw $2, %ecx, %xmm1
; SSE-NEXT:    pinsrw $3, %eax, %xmm1
; SSE-NEXT:    movdqa %xmm1, %xmm0
; SSE-NEXT:    retq
;
; AVX1OR2-LABEL: fold_srem_vec_1:
; AVX1OR2:       # %bb.0:
; AVX1OR2-NEXT:    vpextrw $3, %xmm0, %eax
; AVX1OR2-NEXT:    movswl %ax, %ecx
; AVX1OR2-NEXT:    imull $32081, %ecx, %ecx # imm = 0x7D51
; AVX1OR2-NEXT:    shrl $16, %ecx
; AVX1OR2-NEXT:    subl %eax, %ecx
; AVX1OR2-NEXT:    movzwl %cx, %ecx
; AVX1OR2-NEXT:    movswl %cx, %edx
; AVX1OR2-NEXT:    shrl $15, %ecx
; AVX1OR2-NEXT:    sarl $9, %edx
; AVX1OR2-NEXT:    addl %ecx, %edx
; AVX1OR2-NEXT:    imull $-1003, %edx, %ecx # imm = 0xFC15
; AVX1OR2-NEXT:    subl %ecx, %eax
; AVX1OR2-NEXT:    vmovd %xmm0, %ecx
; AVX1OR2-NEXT:    movswl %cx, %edx
; AVX1OR2-NEXT:    imull $-21385, %edx, %edx # imm = 0xAC77
; AVX1OR2-NEXT:    shrl $16, %edx
; AVX1OR2-NEXT:    addl %ecx, %edx
; AVX1OR2-NEXT:    movzwl %dx, %edx
; AVX1OR2-NEXT:    movswl %dx, %esi
; AVX1OR2-NEXT:    shrl $15, %edx
; AVX1OR2-NEXT:    sarl $6, %esi
; AVX1OR2-NEXT:    addl %edx, %esi
; AVX1OR2-NEXT:    imull $95, %esi, %edx
; AVX1OR2-NEXT:    subl %edx, %ecx
; AVX1OR2-NEXT:    vmovd %ecx, %xmm1
; AVX1OR2-NEXT:    vpextrw $1, %xmm0, %ecx
; AVX1OR2-NEXT:    movswl %cx, %edx
; AVX1OR2-NEXT:    imull $-16913, %edx, %edx # imm = 0xBDEF
; AVX1OR2-NEXT:    movl %edx, %esi
; AVX1OR2-NEXT:    shrl $31, %esi
; AVX1OR2-NEXT:    sarl $21, %edx
; AVX1OR2-NEXT:    addl %esi, %edx
; AVX1OR2-NEXT:    imull $-124, %edx, %edx
; AVX1OR2-NEXT:    subl %edx, %ecx
; AVX1OR2-NEXT:    vpinsrw $1, %ecx, %xmm1, %xmm1
; AVX1OR2-NEXT:    vpextrw $2, %xmm0, %ecx
; AVX1OR2-NEXT:    movswl %cx, %edx
; AVX1OR2-NEXT:    imull $2675, %edx, %edx # imm = 0xA73
; AVX1OR2-NEXT:    movl %edx, %esi
; AVX1OR2-NEXT:    shrl $31, %esi
; AVX1OR2-NEXT:    sarl $18, %edx
; AVX1OR2-NEXT:    addl %esi, %edx
; AVX1OR2-NEXT:    imull $98, %edx, %edx
; AVX1OR2-NEXT:    subl %edx, %ecx
; AVX1OR2-NEXT:    vpinsrw $2, %ecx, %xmm1, %xmm0
; AVX1OR2-NEXT:    vpinsrw $3, %eax, %xmm0, %xmm0
; AVX1OR2-NEXT:    retq
;
; AVX512-LABEL: fold_srem_vec_1:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpextrw $3, %xmm0, %eax
; AVX512-NEXT:    movswl %ax, %ecx
; AVX512-NEXT:    imull $32081, %ecx, %ecx # imm = 0x7D51
; AVX512-NEXT:    shrl $16, %ecx
; AVX512-NEXT:    subl %eax, %ecx
; AVX512-NEXT:    movzwl %cx, %edx
; AVX512-NEXT:    movswl %dx, %ecx
; AVX512-NEXT:    shrl $15, %edx
; AVX512-NEXT:    sarl $9, %ecx
; AVX512-NEXT:    addl %edx, %ecx
; AVX512-NEXT:    vmovd %xmm0, %edx
; AVX512-NEXT:    movswl %dx, %esi
; AVX512-NEXT:    imull $-21385, %esi, %esi # imm = 0xAC77
; AVX512-NEXT:    shrl $16, %esi
; AVX512-NEXT:    addl %edx, %esi
; AVX512-NEXT:    movzwl %si, %esi
; AVX512-NEXT:    movswl %si, %edi
; AVX512-NEXT:    shrl $15, %esi
; AVX512-NEXT:    sarl $6, %edi
; AVX512-NEXT:    addl %esi, %edi
; AVX512-NEXT:    imull $95, %edi, %esi
; AVX512-NEXT:    subl %esi, %edx
; AVX512-NEXT:    vmovd %edx, %xmm1
; AVX512-NEXT:    vpextrw $1, %xmm0, %edx
; AVX512-NEXT:    movswl %dx, %esi
; AVX512-NEXT:    imull $-16913, %esi, %esi # imm = 0xBDEF
; AVX512-NEXT:    movl %esi, %edi
; AVX512-NEXT:    shrl $31, %edi
; AVX512-NEXT:    sarl $21, %esi
; AVX512-NEXT:    addl %edi, %esi
; AVX512-NEXT:    imull $-1003, %ecx, %ecx # imm = 0xFC15
; AVX512-NEXT:    imull $-124, %esi, %esi
; AVX512-NEXT:    subl %esi, %edx
; AVX512-NEXT:    vpinsrw $1, %edx, %xmm1, %xmm1
; AVX512-NEXT:    vpextrw $2, %xmm0, %edx
; AVX512-NEXT:    subl %ecx, %eax
; AVX512-NEXT:    movswl %dx, %ecx
; AVX512-NEXT:    imull $2675, %ecx, %ecx # imm = 0xA73
; AVX512-NEXT:    movl %ecx, %esi
; AVX512-NEXT:    shrl $31, %esi
; AVX512-NEXT:    sarl $18, %ecx
; AVX512-NEXT:    addl %esi, %ecx
; AVX512-NEXT:    imull $98, %ecx, %ecx
; AVX512-NEXT:    subl %ecx, %edx
; AVX512-NEXT:    vpinsrw $2, %edx, %xmm1, %xmm0
; AVX512-NEXT:    vpinsrw $3, %eax, %xmm0, %xmm0
; AVX512-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 95, i16 -124, i16 98, i16 -1003>
  ret <4 x i16> %1
}

define <4 x i16> @fold_srem_vec_2(<4 x i16> %x) {
; SSE-LABEL: fold_srem_vec_2:
; SSE:       # %bb.0:
; SSE-NEXT:    movdqa {{.*#+}} xmm1 = [44151,44151,44151,44151,44151,44151,44151,44151]
; SSE-NEXT:    pmulhw %xmm0, %xmm1
; SSE-NEXT:    paddw %xmm0, %xmm1
; SSE-NEXT:    movdqa %xmm1, %xmm2
; SSE-NEXT:    psrlw $15, %xmm2
; SSE-NEXT:    psraw $6, %xmm1
; SSE-NEXT:    paddw %xmm2, %xmm1
; SSE-NEXT:    pmullw {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm1 # [95,95,95,95,95,95,95,95]
; SSE-NEXT:    psubw %xmm1, %xmm0
; SSE-NEXT:    retq
;
; AVX-LABEL: fold_srem_vec_2:
; AVX:       # %bb.0:
; AVX-NEXT:    vpmulhw {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm0, %xmm1 # [44151,44151,44151,44151,44151,44151,44151,44151]
; AVX-NEXT:    vpaddw %xmm0, %xmm1, %xmm1
; AVX-NEXT:    vpsrlw $15, %xmm1, %xmm2
; AVX-NEXT:    vpsraw $6, %xmm1, %xmm1
; AVX-NEXT:    vpaddw %xmm2, %xmm1, %xmm1
; AVX-NEXT:    vpmullw {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm1, %xmm1 # [95,95,95,95,95,95,95,95]
; AVX-NEXT:    vpsubw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 95, i16 95, i16 95, i16 95>
  ret <4 x i16> %1
}


; Don't fold if we can combine srem with sdiv.
define <4 x i16> @combine_srem_sdiv(<4 x i16> %x) {
; SSE2-LABEL: combine_srem_sdiv:
; SSE2:       # %bb.0:
; SSE2-NEXT:    movdqa {{.*#+}} xmm1 = [44151,44151,44151,44151,44151,44151,44151,44151]
; SSE2-NEXT:    pmulhw %xmm0, %xmm1
; SSE2-NEXT:    paddw %xmm0, %xmm1
; SSE2-NEXT:    movdqa %xmm1, %xmm2
; SSE2-NEXT:    psrlw $15, %xmm2
; SSE2-NEXT:    psraw $6, %xmm1
; SSE2-NEXT:    paddw %xmm2, %xmm1
; SSE2-NEXT:    movdqa {{.*#+}} xmm2 = [95,95,95,95,95,95,95,95]
; SSE2-NEXT:    pmullw %xmm1, %xmm2
; SSE2-NEXT:    psubw %xmm2, %xmm0
; SSE2-NEXT:    paddw %xmm1, %xmm0
; SSE2-NEXT:    retq
;
; SSE4-LABEL: combine_srem_sdiv:
; SSE4:       # %bb.0:
; SSE4-NEXT:    movdqa {{.*#+}} xmm1 = [44151,44151,44151,44151,44151,44151,44151,44151]
; SSE4-NEXT:    pmulhw %xmm0, %xmm1
; SSE4-NEXT:    paddw %xmm0, %xmm1
; SSE4-NEXT:    movdqa %xmm1, %xmm2
; SSE4-NEXT:    psrlw $15, %xmm2
; SSE4-NEXT:    psraw $6, %xmm1
; SSE4-NEXT:    paddw %xmm2, %xmm1
; SSE4-NEXT:    pmovsxbw {{.*#+}} xmm2 = [95,95,95,95,95,95,95,95]
; SSE4-NEXT:    pmullw %xmm1, %xmm2
; SSE4-NEXT:    psubw %xmm2, %xmm0
; SSE4-NEXT:    paddw %xmm1, %xmm0
; SSE4-NEXT:    retq
;
; AVX-LABEL: combine_srem_sdiv:
; AVX:       # %bb.0:
; AVX-NEXT:    vpmulhw {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm0, %xmm1 # [44151,44151,44151,44151,44151,44151,44151,44151]
; AVX-NEXT:    vpaddw %xmm0, %xmm1, %xmm1
; AVX-NEXT:    vpsrlw $15, %xmm1, %xmm2
; AVX-NEXT:    vpsraw $6, %xmm1, %xmm1
; AVX-NEXT:    vpaddw %xmm2, %xmm1, %xmm1
; AVX-NEXT:    vpmullw {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %xmm1, %xmm2 # [95,95,95,95,95,95,95,95]
; AVX-NEXT:    vpsubw %xmm2, %xmm0, %xmm0
; AVX-NEXT:    vpaddw %xmm1, %xmm0, %xmm0
; AVX-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 95, i16 95, i16 95, i16 95>
  %2 = sdiv <4 x i16> %x, <i16 95, i16 95, i16 95, i16 95>
  %3 = add <4 x i16> %1, %2
  ret <4 x i16> %3
}

; Don't fold for divisors that are a power of two.
define <4 x i16> @dont_fold_srem_power_of_two(<4 x i16> %x) {
; SSE-LABEL: dont_fold_srem_power_of_two:
; SSE:       # %bb.0:
; SSE-NEXT:    movdqa %xmm0, %xmm1
; SSE-NEXT:    pextrw $1, %xmm0, %eax
; SSE-NEXT:    leal 31(%rax), %ecx
; SSE-NEXT:    testw %ax, %ax
; SSE-NEXT:    cmovnsl %eax, %ecx
; SSE-NEXT:    andl $-32, %ecx
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    movd %xmm0, %ecx
; SSE-NEXT:    leal 63(%rcx), %edx
; SSE-NEXT:    testw %cx, %cx
; SSE-NEXT:    cmovnsl %ecx, %edx
; SSE-NEXT:    andl $-64, %edx
; SSE-NEXT:    subl %edx, %ecx
; SSE-NEXT:    movd %ecx, %xmm0
; SSE-NEXT:    pinsrw $1, %eax, %xmm0
; SSE-NEXT:    pextrw $2, %xmm1, %eax
; SSE-NEXT:    leal 7(%rax), %ecx
; SSE-NEXT:    testw %ax, %ax
; SSE-NEXT:    cmovnsl %eax, %ecx
; SSE-NEXT:    andl $-8, %ecx
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    pinsrw $2, %eax, %xmm0
; SSE-NEXT:    pextrw $3, %xmm1, %eax
; SSE-NEXT:    movswl %ax, %ecx
; SSE-NEXT:    imull $-21385, %ecx, %ecx # imm = 0xAC77
; SSE-NEXT:    shrl $16, %ecx
; SSE-NEXT:    addl %eax, %ecx
; SSE-NEXT:    movzwl %cx, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    shrl $15, %ecx
; SSE-NEXT:    sarl $6, %edx
; SSE-NEXT:    addl %ecx, %edx
; SSE-NEXT:    imull $95, %edx, %ecx
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    pinsrw $3, %eax, %xmm0
; SSE-NEXT:    retq
;
; AVX-LABEL: dont_fold_srem_power_of_two:
; AVX:       # %bb.0:
; AVX-NEXT:    vpextrw $1, %xmm0, %eax
; AVX-NEXT:    leal 31(%rax), %ecx
; AVX-NEXT:    testw %ax, %ax
; AVX-NEXT:    cmovnsl %eax, %ecx
; AVX-NEXT:    andl $-32, %ecx
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vmovd %xmm0, %ecx
; AVX-NEXT:    leal 63(%rcx), %edx
; AVX-NEXT:    testw %cx, %cx
; AVX-NEXT:    cmovnsl %ecx, %edx
; AVX-NEXT:    andl $-64, %edx
; AVX-NEXT:    subl %edx, %ecx
; AVX-NEXT:    vmovd %ecx, %xmm1
; AVX-NEXT:    vpinsrw $1, %eax, %xmm1, %xmm1
; AVX-NEXT:    vpextrw $2, %xmm0, %eax
; AVX-NEXT:    leal 7(%rax), %ecx
; AVX-NEXT:    testw %ax, %ax
; AVX-NEXT:    cmovnsl %eax, %ecx
; AVX-NEXT:    andl $-8, %ecx
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vpinsrw $2, %eax, %xmm1, %xmm1
; AVX-NEXT:    vpextrw $3, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $-21385, %ecx, %ecx # imm = 0xAC77
; AVX-NEXT:    shrl $16, %ecx
; AVX-NEXT:    addl %eax, %ecx
; AVX-NEXT:    movzwl %cx, %ecx
; AVX-NEXT:    movswl %cx, %edx
; AVX-NEXT:    shrl $15, %ecx
; AVX-NEXT:    sarl $6, %edx
; AVX-NEXT:    addl %ecx, %edx
; AVX-NEXT:    imull $95, %edx, %ecx
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vpinsrw $3, %eax, %xmm1, %xmm0
; AVX-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 64, i16 32, i16 8, i16 95>
  ret <4 x i16> %1
}

; Don't fold if the divisor is one.
define <4 x i16> @dont_fold_srem_one(<4 x i16> %x) {
; SSE-LABEL: dont_fold_srem_one:
; SSE:       # %bb.0:
; SSE-NEXT:    pextrw $2, %xmm0, %ecx
; SSE-NEXT:    movswl %cx, %eax
; SSE-NEXT:    imull $-19945, %eax, %eax # imm = 0xB217
; SSE-NEXT:    shrl $16, %eax
; SSE-NEXT:    addl %ecx, %eax
; SSE-NEXT:    movzwl %ax, %edx
; SSE-NEXT:    movswl %dx, %eax
; SSE-NEXT:    shrl $15, %edx
; SSE-NEXT:    sarl $4, %eax
; SSE-NEXT:    addl %edx, %eax
; SSE-NEXT:    leal (%rax,%rax,2), %edx
; SSE-NEXT:    shll $3, %edx
; SSE-NEXT:    subl %edx, %eax
; SSE-NEXT:    addl %ecx, %eax
; SSE-NEXT:    pextrw $1, %xmm0, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    imull $12827, %edx, %edx # imm = 0x321B
; SSE-NEXT:    movl %edx, %esi
; SSE-NEXT:    shrl $31, %esi
; SSE-NEXT:    sarl $23, %edx
; SSE-NEXT:    addl %esi, %edx
; SSE-NEXT:    imull $654, %edx, %edx # imm = 0x28E
; SSE-NEXT:    subl %edx, %ecx
; SSE-NEXT:    pxor %xmm1, %xmm1
; SSE-NEXT:    pinsrw $1, %ecx, %xmm1
; SSE-NEXT:    pinsrw $2, %eax, %xmm1
; SSE-NEXT:    pextrw $3, %xmm0, %eax
; SSE-NEXT:    movswl %ax, %ecx
; SSE-NEXT:    imull $12375, %ecx, %ecx # imm = 0x3057
; SSE-NEXT:    movl %ecx, %edx
; SSE-NEXT:    shrl $31, %edx
; SSE-NEXT:    sarl $26, %ecx
; SSE-NEXT:    addl %edx, %ecx
; SSE-NEXT:    imull $5423, %ecx, %ecx # imm = 0x152F
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    pinsrw $3, %eax, %xmm1
; SSE-NEXT:    movdqa %xmm1, %xmm0
; SSE-NEXT:    retq
;
; AVX-LABEL: dont_fold_srem_one:
; AVX:       # %bb.0:
; AVX-NEXT:    vpextrw $2, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $-19945, %ecx, %ecx # imm = 0xB217
; AVX-NEXT:    shrl $16, %ecx
; AVX-NEXT:    addl %eax, %ecx
; AVX-NEXT:    movzwl %cx, %ecx
; AVX-NEXT:    movswl %cx, %edx
; AVX-NEXT:    shrl $15, %ecx
; AVX-NEXT:    sarl $4, %edx
; AVX-NEXT:    addl %ecx, %edx
; AVX-NEXT:    leal (%rdx,%rdx,2), %ecx
; AVX-NEXT:    shll $3, %ecx
; AVX-NEXT:    subl %ecx, %edx
; AVX-NEXT:    addl %eax, %edx
; AVX-NEXT:    vpextrw $1, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $12827, %ecx, %ecx # imm = 0x321B
; AVX-NEXT:    movl %ecx, %esi
; AVX-NEXT:    shrl $31, %esi
; AVX-NEXT:    sarl $23, %ecx
; AVX-NEXT:    addl %esi, %ecx
; AVX-NEXT:    imull $654, %ecx, %ecx # imm = 0x28E
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX-NEXT:    vpinsrw $1, %eax, %xmm1, %xmm1
; AVX-NEXT:    vpinsrw $2, %edx, %xmm1, %xmm1
; AVX-NEXT:    vpextrw $3, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $12375, %ecx, %ecx # imm = 0x3057
; AVX-NEXT:    movl %ecx, %edx
; AVX-NEXT:    shrl $31, %edx
; AVX-NEXT:    sarl $26, %ecx
; AVX-NEXT:    addl %edx, %ecx
; AVX-NEXT:    imull $5423, %ecx, %ecx # imm = 0x152F
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vpinsrw $3, %eax, %xmm1, %xmm0
; AVX-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 1, i16 654, i16 23, i16 5423>
  ret <4 x i16> %1
}

; Don't fold if the divisor is 2^15.
define <4 x i16> @dont_fold_urem_i16_smax(<4 x i16> %x) {
; SSE-LABEL: dont_fold_urem_i16_smax:
; SSE:       # %bb.0:
; SSE-NEXT:    pextrw $2, %xmm0, %eax
; SSE-NEXT:    movswl %ax, %ecx
; SSE-NEXT:    imull $-19945, %ecx, %ecx # imm = 0xB217
; SSE-NEXT:    shrl $16, %ecx
; SSE-NEXT:    addl %eax, %ecx
; SSE-NEXT:    movzwl %cx, %ecx
; SSE-NEXT:    movswl %cx, %edx
; SSE-NEXT:    shrl $15, %ecx
; SSE-NEXT:    sarl $4, %edx
; SSE-NEXT:    addl %ecx, %edx
; SSE-NEXT:    leal (%rdx,%rdx,2), %ecx
; SSE-NEXT:    shll $3, %ecx
; SSE-NEXT:    subl %ecx, %edx
; SSE-NEXT:    addl %eax, %edx
; SSE-NEXT:    pextrw $1, %xmm0, %eax
; SSE-NEXT:    leal 32767(%rax), %ecx
; SSE-NEXT:    testw %ax, %ax
; SSE-NEXT:    cmovnsl %eax, %ecx
; SSE-NEXT:    andl $-32768, %ecx # imm = 0x8000
; SSE-NEXT:    addl %eax, %ecx
; SSE-NEXT:    pxor %xmm1, %xmm1
; SSE-NEXT:    pinsrw $1, %ecx, %xmm1
; SSE-NEXT:    pinsrw $2, %edx, %xmm1
; SSE-NEXT:    pextrw $3, %xmm0, %eax
; SSE-NEXT:    movswl %ax, %ecx
; SSE-NEXT:    imull $12375, %ecx, %ecx # imm = 0x3057
; SSE-NEXT:    movl %ecx, %edx
; SSE-NEXT:    shrl $31, %edx
; SSE-NEXT:    sarl $26, %ecx
; SSE-NEXT:    addl %edx, %ecx
; SSE-NEXT:    imull $5423, %ecx, %ecx # imm = 0x152F
; SSE-NEXT:    subl %ecx, %eax
; SSE-NEXT:    pinsrw $3, %eax, %xmm1
; SSE-NEXT:    movdqa %xmm1, %xmm0
; SSE-NEXT:    retq
;
; AVX-LABEL: dont_fold_urem_i16_smax:
; AVX:       # %bb.0:
; AVX-NEXT:    vpextrw $2, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $-19945, %ecx, %ecx # imm = 0xB217
; AVX-NEXT:    shrl $16, %ecx
; AVX-NEXT:    addl %eax, %ecx
; AVX-NEXT:    movzwl %cx, %ecx
; AVX-NEXT:    movswl %cx, %edx
; AVX-NEXT:    shrl $15, %ecx
; AVX-NEXT:    sarl $4, %edx
; AVX-NEXT:    addl %ecx, %edx
; AVX-NEXT:    leal (%rdx,%rdx,2), %ecx
; AVX-NEXT:    shll $3, %ecx
; AVX-NEXT:    subl %ecx, %edx
; AVX-NEXT:    addl %eax, %edx
; AVX-NEXT:    vpextrw $1, %xmm0, %eax
; AVX-NEXT:    leal 32767(%rax), %ecx
; AVX-NEXT:    testw %ax, %ax
; AVX-NEXT:    cmovnsl %eax, %ecx
; AVX-NEXT:    andl $-32768, %ecx # imm = 0x8000
; AVX-NEXT:    addl %eax, %ecx
; AVX-NEXT:    vpxor %xmm1, %xmm1, %xmm1
; AVX-NEXT:    vpinsrw $1, %ecx, %xmm1, %xmm1
; AVX-NEXT:    vpinsrw $2, %edx, %xmm1, %xmm1
; AVX-NEXT:    vpextrw $3, %xmm0, %eax
; AVX-NEXT:    movswl %ax, %ecx
; AVX-NEXT:    imull $12375, %ecx, %ecx # imm = 0x3057
; AVX-NEXT:    movl %ecx, %edx
; AVX-NEXT:    shrl $31, %edx
; AVX-NEXT:    sarl $26, %ecx
; AVX-NEXT:    addl %edx, %ecx
; AVX-NEXT:    imull $5423, %ecx, %ecx # imm = 0x152F
; AVX-NEXT:    subl %ecx, %eax
; AVX-NEXT:    vpinsrw $3, %eax, %xmm1, %xmm0
; AVX-NEXT:    retq
  %1 = srem <4 x i16> %x, <i16 1, i16 32768, i16 23, i16 5423>
  ret <4 x i16> %1
}

; Don't fold i64 srem.
define <4 x i64> @dont_fold_srem_i64(<4 x i64> %x) {
; SSE2-LABEL: dont_fold_srem_i64:
; SSE2:       # %bb.0:
; SSE2-NEXT:    movdqa %xmm1, %xmm2
; SSE2-NEXT:    movq %xmm1, %rcx
; SSE2-NEXT:    movabsq $-5614226457215950491, %rdx # imm = 0xB21642C8590B2165
; SSE2-NEXT:    movq %rcx, %rax
; SSE2-NEXT:    imulq %rdx
; SSE2-NEXT:    addq %rcx, %rdx
; SSE2-NEXT:    movq %rdx, %rax
; SSE2-NEXT:    shrq $63, %rax
; SSE2-NEXT:    sarq $4, %rdx
; SSE2-NEXT:    addq %rax, %rdx
; SSE2-NEXT:    leaq (%rdx,%rdx,2), %rax
; SSE2-NEXT:    shlq $3, %rax
; SSE2-NEXT:    subq %rax, %rdx
; SSE2-NEXT:    addq %rcx, %rdx
; SSE2-NEXT:    movq %rdx, %xmm1
; SSE2-NEXT:    pshufd {{.*#+}} xmm2 = xmm2[2,3,2,3]
; SSE2-NEXT:    movq %xmm2, %rcx
; SSE2-NEXT:    movabsq $6966426675817289639, %rdx # imm = 0x60ADB826E5E517A7
; SSE2-NEXT:    movq %rcx, %rax
; SSE2-NEXT:    imulq %rdx
; SSE2-NEXT:    movq %rdx, %rax
; SSE2-NEXT:    shrq $63, %rax
; SSE2-NEXT:    sarq $11, %rdx
; SSE2-NEXT:    addq %rax, %rdx
; SSE2-NEXT:    imulq $5423, %rdx, %rax # imm = 0x152F
; SSE2-NEXT:    subq %rax, %rcx
; SSE2-NEXT:    movq %rcx, %xmm2
; SSE2-NEXT:    punpcklqdq {{.*#+}} xmm1 = xmm1[0],xmm2[0]
; SSE2-NEXT:    pshufd {{.*#+}} xmm0 = xmm0[2,3,2,3]
; SSE2-NEXT:    movq %xmm0, %rcx
; SSE2-NEXT:    movabsq $7220743857598845893, %rdx # imm = 0x64353C48064353C5
; SSE2-NEXT:    movq %rcx, %rax
; SSE2-NEXT:    imulq %rdx
; SSE2-NEXT:    movq %rdx, %rax
; SSE2-NEXT:    shrq $63, %rax
; SSE2-NEXT:    sarq $8, %rdx
; SSE2-NEXT:    addq %rax, %rdx
; SSE2-NEXT:    imulq $654, %rdx, %rax # imm = 0x28E
; SSE2-NEXT:    subq %rax, %rcx
; SSE2-NEXT:    movq %rcx, %xmm0
; SSE2-NEXT:    pslldq {{.*#+}} xmm0 = zero,zero,zero,zero,zero,zero,zero,zero,xmm0[0,1,2,3,4,5,6,7]
; SSE2-NEXT:    retq
;
; SSE4-LABEL: dont_fold_srem_i64:
; SSE4:       # %bb.0:
; SSE4-NEXT:    movdqa %xmm1, %xmm2
; SSE4-NEXT:    movq %xmm1, %rcx
; SSE4-NEXT:    movabsq $-5614226457215950491, %rdx # imm = 0xB21642C8590B2165
; SSE4-NEXT:    movq %rcx, %rax
; SSE4-NEXT:    imulq %rdx
; SSE4-NEXT:    addq %rcx, %rdx
; SSE4-NEXT:    movq %rdx, %rax
; SSE4-NEXT:    shrq $63, %rax
; SSE4-NEXT:    sarq $4, %rdx
; SSE4-NEXT:    addq %rax, %rdx
; SSE4-NEXT:    leaq (%rdx,%rdx,2), %rax
; SSE4-NEXT:    shlq $3, %rax
; SSE4-NEXT:    subq %rax, %rdx
; SSE4-NEXT:    addq %rcx, %rdx
; SSE4-NEXT:    movq %rdx, %xmm1
; SSE4-NEXT:    pextrq $1, %xmm2, %rcx
; SSE4-NEXT:    movabsq $6966426675817289639, %rdx # imm = 0x60ADB826E5E517A7
; SSE4-NEXT:    movq %rcx, %rax
; SSE4-NEXT:    imulq %rdx
; SSE4-NEXT:    movq %rdx, %rax
; SSE4-NEXT:    shrq $63, %rax
; SSE4-NEXT:    sarq $11, %rdx
; SSE4-NEXT:    addq %rax, %rdx
; SSE4-NEXT:    imulq $5423, %rdx, %rax # imm = 0x152F
; SSE4-NEXT:    subq %rax, %rcx
; SSE4-NEXT:    movq %rcx, %xmm2
; SSE4-NEXT:    punpcklqdq {{.*#+}} xmm1 = xmm1[0],xmm2[0]
; SSE4-NEXT:    pextrq $1, %xmm0, %rcx
; SSE4-NEXT:    movabsq $7220743857598845893, %rdx # imm = 0x64353C48064353C5
; SSE4-NEXT:    movq %rcx, %rax
; SSE4-NEXT:    imulq %rdx
; SSE4-NEXT:    movq %rdx, %rax
; SSE4-NEXT:    shrq $63, %rax
; SSE4-NEXT:    sarq $8, %rdx
; SSE4-NEXT:    addq %rax, %rdx
; SSE4-NEXT:    imulq $654, %rdx, %rax # imm = 0x28E
; SSE4-NEXT:    subq %rax, %rcx
; SSE4-NEXT:    movq %rcx, %xmm0
; SSE4-NEXT:    pslldq {{.*#+}} xmm0 = zero,zero,zero,zero,zero,zero,zero,zero,xmm0[0,1,2,3,4,5,6,7]
; SSE4-NEXT:    retq
;
; AVX1-LABEL: dont_fold_srem_i64:
; AVX1:       # %bb.0:
; AVX1-NEXT:    vextractf128 $1, %ymm0, %xmm1
; AVX1-NEXT:    vmovq %xmm1, %rcx
; AVX1-NEXT:    movabsq $-5614226457215950491, %rdx # imm = 0xB21642C8590B2165
; AVX1-NEXT:    movq %rcx, %rax
; AVX1-NEXT:    imulq %rdx
; AVX1-NEXT:    addq %rcx, %rdx
; AVX1-NEXT:    movq %rdx, %rax
; AVX1-NEXT:    shrq $63, %rax
; AVX1-NEXT:    sarq $4, %rdx
; AVX1-NEXT:    addq %rax, %rdx
; AVX1-NEXT:    leaq (%rdx,%rdx,2), %rax
; AVX1-NEXT:    shlq $3, %rax
; AVX1-NEXT:    subq %rax, %rdx
; AVX1-NEXT:    addq %rcx, %rdx
; AVX1-NEXT:    vmovq %rdx, %xmm2
; AVX1-NEXT:    vpextrq $1, %xmm1, %rcx
; AVX1-NEXT:    movabsq $6966426675817289639, %rdx # imm = 0x60ADB826E5E517A7
; AVX1-NEXT:    movq %rcx, %rax
; AVX1-NEXT:    imulq %rdx
; AVX1-NEXT:    movq %rdx, %rax
; AVX1-NEXT:    shrq $63, %rax
; AVX1-NEXT:    sarq $11, %rdx
; AVX1-NEXT:    addq %rax, %rdx
; AVX1-NEXT:    imulq $5423, %rdx, %rax # imm = 0x152F
; AVX1-NEXT:    subq %rax, %rcx
; AVX1-NEXT:    vmovq %rcx, %xmm1
; AVX1-NEXT:    vpunpcklqdq {{.*#+}} xmm1 = xmm2[0],xmm1[0]
; AVX1-NEXT:    vpextrq $1, %xmm0, %rcx
; AVX1-NEXT:    movabsq $7220743857598845893, %rdx # imm = 0x64353C48064353C5
; AVX1-NEXT:    movq %rcx, %rax
; AVX1-NEXT:    imulq %rdx
; AVX1-NEXT:    movq %rdx, %rax
; AVX1-NEXT:    shrq $63, %rax
; AVX1-NEXT:    sarq $8, %rdx
; AVX1-NEXT:    addq %rax, %rdx
; AVX1-NEXT:    imulq $654, %rdx, %rax # imm = 0x28E
; AVX1-NEXT:    subq %rax, %rcx
; AVX1-NEXT:    vmovq %rcx, %xmm0
; AVX1-NEXT:    vpslldq {{.*#+}} xmm0 = zero,zero,zero,zero,zero,zero,zero,zero,xmm0[0,1,2,3,4,5,6,7]
; AVX1-NEXT:    vinsertf128 $1, %xmm1, %ymm0, %ymm0
; AVX1-NEXT:    retq
;
; AVX2-LABEL: dont_fold_srem_i64:
; AVX2:       # %bb.0:
; AVX2-NEXT:    vpmovsxdq {{.*#+}} ymm1 = [0,1681210440,18446744072402387656,1621997606]
; AVX2-NEXT:    vpmuludq %ymm1, %ymm0, %ymm2
; AVX2-NEXT:    vpmovsxbd {{.*#+}} ymm3 = [0,0,0,0,4294967295,0,0,0]
; AVX2-NEXT:    vpmuludq %ymm3, %ymm0, %ymm4
; AVX2-NEXT:    vpsllq $32, %ymm4, %ymm4
; AVX2-NEXT:    vpaddq %ymm4, %ymm2, %ymm2
; AVX2-NEXT:    vpshufd {{.*#+}} ymm4 = ymm0[1,1,3,3,5,5,7,7]
; AVX2-NEXT:    vpmovzxdq {{.*#+}} ymm5 = [0,105075653,1493901669,3856996263]
; AVX2-NEXT:    vpmuludq %ymm5, %ymm4, %ymm6
; AVX2-NEXT:    vpsrad $31, %ymm0, %ymm7
; AVX2-NEXT:    vpsrlq $32, %ymm7, %ymm7
; AVX2-NEXT:    vpmuludq %ymm5, %ymm7, %ymm8
; AVX2-NEXT:    vpsllq $32, %ymm8, %ymm8
; AVX2-NEXT:    vpaddq %ymm6, %ymm8, %ymm6
; AVX2-NEXT:    vpmuludq %ymm5, %ymm0, %ymm5
; AVX2-NEXT:    vpsrlq $32, %ymm5, %ymm5
; AVX2-NEXT:    vpaddq %ymm5, %ymm6, %ymm5
; AVX2-NEXT:    vpxor %xmm6, %xmm6, %xmm6
; AVX2-NEXT:    vpblendd {{.*#+}} ymm8 = ymm5[0],ymm6[1],ymm5[2],ymm6[3],ymm5[4],ymm6[5],ymm5[6],ymm6[7]
; AVX2-NEXT:    vpaddq %ymm2, %ymm8, %ymm2
; AVX2-NEXT:    vpsrad $31, %ymm2, %ymm8
; AVX2-NEXT:    vpshufd {{.*#+}} ymm2 = ymm2[1,1,3,3,5,5,7,7]
; AVX2-NEXT:    vpblendd {{.*#+}} ymm2 = ymm2[0],ymm8[1],ymm2[2],ymm8[3],ymm2[4],ymm8[5],ymm2[6],ymm8[7]
; AVX2-NEXT:    vpsrad $31, %ymm5, %ymm8
; AVX2-NEXT:    vpshufd {{.*#+}} ymm5 = ymm5[1,1,3,3,5,5,7,7]
; AVX2-NEXT:    vpblendd {{.*#+}} ymm5 = ymm5[0],ymm8[1],ymm5[2],ymm8[3],ymm5[4],ymm8[5],ymm5[6],ymm8[7]
; AVX2-NEXT:    vpaddq %ymm2, %ymm5, %ymm2
; AVX2-NEXT:    vpmuludq %ymm3, %ymm4, %ymm3
; AVX2-NEXT:    vpmuludq %ymm1, %ymm7, %ymm5
; AVX2-NEXT:    vpaddq %ymm5, %ymm3, %ymm3
; AVX2-NEXT:    vpsllq $32, %ymm3, %ymm3
; AVX2-NEXT:    vpmuludq %ymm1, %ymm4, %ymm1
; AVX2-NEXT:    vpaddq %ymm3, %ymm1, %ymm1
; AVX2-NEXT:    vpblendd {{.*#+}} ymm3 = ymm0[0,1],ymm6[2,3],ymm0[4,5],ymm6[6,7]
; AVX2-NEXT:    vpaddq %ymm3, %ymm1, %ymm1
; AVX2-NEXT:    vpaddq %ymm2, %ymm1, %ymm1
; AVX2-NEXT:    vpsrlq $63, %ymm1, %ymm2
; AVX2-NEXT:    vpblendd {{.*#+}} ymm2 = ymm6[0,1],ymm2[2,3,4,5,6,7]
; AVX2-NEXT:    vpsrlvq {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %ymm1, %ymm1
; AVX2-NEXT:    vmovdqa {{.*#+}} ymm3 = [9223372036854775808,36028797018963968,576460752303423488,4503599627370496]
; AVX2-NEXT:    vpxor %ymm3, %ymm1, %ymm1
; AVX2-NEXT:    vpaddq %ymm2, %ymm1, %ymm1
; AVX2-NEXT:    vpsubq %ymm3, %ymm1, %ymm1
; AVX2-NEXT:    vpmovsxwq {{.*#+}} ymm2 = [1,654,23,5423]
; AVX2-NEXT:    vpmuludq %ymm2, %ymm1, %ymm3
; AVX2-NEXT:    vpsrlq $32, %ymm1, %ymm1
; AVX2-NEXT:    vpmuludq %ymm2, %ymm1, %ymm1
; AVX2-NEXT:    vpsllq $32, %ymm1, %ymm1
; AVX2-NEXT:    vpaddq %ymm1, %ymm3, %ymm1
; AVX2-NEXT:    vpsubq %ymm1, %ymm0, %ymm0
; AVX2-NEXT:    retq
;
; AVX512-LABEL: dont_fold_srem_i64:
; AVX512:       # %bb.0:
; AVX512-NEXT:    vpsraq $32, %ymm0, %ymm1
; AVX512-NEXT:    vmovdqa {{.*#+}} ymm2 = [0,105075653,1493901669,3856996263]
; AVX512-NEXT:    vpmullq %ymm2, %ymm1, %ymm3
; AVX512-NEXT:    vpmuludq %ymm2, %ymm0, %ymm2
; AVX512-NEXT:    vpsrlq $32, %ymm2, %ymm2
; AVX512-NEXT:    vpaddq %ymm2, %ymm3, %ymm2
; AVX512-NEXT:    vpsraq $32, %ymm2, %ymm3
; AVX512-NEXT:    vpxor %xmm4, %xmm4, %xmm4
; AVX512-NEXT:    vpblendd {{.*#+}} ymm5 = ymm0[0],ymm4[1],ymm0[2],ymm4[3],ymm0[4],ymm4[5],ymm0[6],ymm4[7]
; AVX512-NEXT:    vmovdqa {{.*#+}} ymm6 = [0,1681210440,18446744072402387656,1621997606]
; AVX512-NEXT:    vpmullq %ymm6, %ymm5, %ymm5
; AVX512-NEXT:    vpblendd {{.*#+}} ymm2 = ymm2[0],ymm4[1],ymm2[2],ymm4[3],ymm2[4],ymm4[5],ymm2[6],ymm4[7]
; AVX512-NEXT:    vpaddq %ymm2, %ymm5, %ymm2
; AVX512-NEXT:    vpsraq $32, %ymm2, %ymm2
; AVX512-NEXT:    vpmuldq %ymm6, %ymm1, %ymm1
; AVX512-NEXT:    vpaddq %ymm3, %ymm1, %ymm1
; AVX512-NEXT:    vpblendd {{.*#+}} ymm3 = ymm0[0,1],ymm4[2,3],ymm0[4,5],ymm4[6,7]
; AVX512-NEXT:    vpaddq %ymm3, %ymm1, %ymm1
; AVX512-NEXT:    vpaddq %ymm2, %ymm1, %ymm1
; AVX512-NEXT:    vpsrlq $63, %ymm1, %ymm2
; AVX512-NEXT:    vpblendd {{.*#+}} ymm2 = ymm4[0,1],ymm2[2,3,4,5,6,7]
; AVX512-NEXT:    vpsravq {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %ymm1, %ymm1
; AVX512-NEXT:    vpaddq %ymm2, %ymm1, %ymm1
; AVX512-NEXT:    vpmullq {{\.?LCPI[0-9]+_[0-9]+}}(%rip), %ymm1, %ymm1 # [1,654,23,5423]
; AVX512-NEXT:    vpsubq %ymm1, %ymm0, %ymm0
; AVX512-NEXT:    retq
  %1 = srem <4 x i64> %x, <i64 1, i64 654, i64 23, i64 5423>
  ret <4 x i64> %1
}
