; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc < %s --mtriple=wasm32-unknown-unknown -fast-isel=0 -mattr=+reference-types | FileCheck %s --check-prefixes=WASM32
; RUN: llc < %s --mtriple=wasm32-unknown-unknown -fast-isel=1 -mattr=+reference-types | FileCheck %s --check-prefixes=WASM32
; RUN: llc < %s --mtriple=wasm64-unknown-unknown -fast-isel=0 -mattr=+reference-types | FileCheck %s --check-prefixes=WASM64
; RUN: llc < %s --mtriple=wasm64-unknown-unknown -fast-isel=1 -mattr=+reference-types | FileCheck %s --check-prefixes=WASM64

%funcref = type ptr addrspace(20) ;; addrspace 20 is nonintegral

; CHECK: .tabletype __funcref_call_table, funcref, 1

define void @call_funcref(%funcref %ref) {
; WASM32-LABEL: call_funcref:
; WASM32:         .functype call_funcref (funcref) -> ()
; WASM32-NEXT:  # %bb.0:
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    local.get 0
; WASM32-NEXT:    table.set __funcref_call_table
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    call_indirect __funcref_call_table, () -> ()
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    ref.null_func
; WASM32-NEXT:    table.set __funcref_call_table
; WASM32-NEXT:    # fallthrough-return
;
; WASM64-LABEL: call_funcref:
; WASM64:         .functype call_funcref (funcref) -> ()
; WASM64-NEXT:  # %bb.0:
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    local.get 0
; WASM64-NEXT:    table.set __funcref_call_table
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    call_indirect __funcref_call_table, () -> ()
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    ref.null_func
; WASM64-NEXT:    table.set __funcref_call_table
; WASM64-NEXT:    # fallthrough-return
  call addrspace(20) void %ref()
  ret void
}

define float @call_funcref_with_args(%funcref %ref) {
; WASM32-LABEL: call_funcref_with_args:
; WASM32:         .functype call_funcref_with_args (funcref) -> (f32)
; WASM32-NEXT:    .local f32
; WASM32-NEXT:  # %bb.0:
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    local.get 0
; WASM32-NEXT:    table.set __funcref_call_table
; WASM32-NEXT:    f64.const 0x1p0
; WASM32-NEXT:    i32.const 2
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    call_indirect __funcref_call_table, (f64, i32) -> (f32)
; WASM32-NEXT:    local.set 1
; WASM32-NEXT:    i32.const 0
; WASM32-NEXT:    ref.null_func
; WASM32-NEXT:    table.set __funcref_call_table
; WASM32-NEXT:    local.get 1
; WASM32-NEXT:    # fallthrough-return
;
; WASM64-LABEL: call_funcref_with_args:
; WASM64:         .functype call_funcref_with_args (funcref) -> (f32)
; WASM64-NEXT:    .local f32
; WASM64-NEXT:  # %bb.0:
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    local.get 0
; WASM64-NEXT:    table.set __funcref_call_table
; WASM64-NEXT:    f64.const 0x1p0
; WASM64-NEXT:    i32.const 2
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    call_indirect __funcref_call_table, (f64, i32) -> (f32)
; WASM64-NEXT:    local.set 1
; WASM64-NEXT:    i64.const 0
; WASM64-NEXT:    ref.null_func
; WASM64-NEXT:    table.set __funcref_call_table
; WASM64-NEXT:    local.get 1
; WASM64-NEXT:    # fallthrough-return
  %ret = call addrspace(20) float %ref(double 1.0, i32 2)
  ret float %ret
}
