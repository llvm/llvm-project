; RUN: split-file %s %t
; RUN: opt -passes=dxil-refine-types -S -mtriple=dxil-pc-shadermodel6.0-library < %t/explicit-64.ll | FileCheck %s
; RUN: opt -passes='instcombine,dxil-refine-types' -S -mtriple=dxil-pc-shadermodel6.0-library < %t/generated-64.ll | FileCheck %s
; RUN: opt -passes=dxil-refine-types -S -mtriple=dxil-pc-shadermodel6.0-library < %t/explicit-32.ll | FileCheck %s
; RUN: opt -passes='instcombine,dxil-refine-types' -S -mtriple=dxil-pc-shadermodel6.0-library < %t/generated-32.ll | FileCheck %s

; RUN: opt -passes='instcombine,dxil-refine-types' -S -mtriple=dxil-pc-shadermodel6.0-library < %t/folded.ll | FileCheck %s --check-prefix=FOLDED

; Tests that dxil-refine-types will catch the access pattern generated by inst-combine

; CHECK-LABEL: @test(
; CHECK: %[[#FROM:]] = load %struct.PromotedStruct, ptr %get_access
; CHECK: store %struct.PromotedStruct %[[#FROM]], ptr %param
; CHECK: call void @external_barrier(ptr{{.*}}%param)
; CHECK: %[[#TO:]] = load %struct.PromotedStruct, ptr %param
; CHECK: store %struct.PromotedStruct %[[#TO]], ptr %set_access
; CHECK:    ret void

;--- explicit-64.ll

%"StructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%"RWStructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%struct.PromotedStruct = type { i32, float }

@src = external constant %"StructuredBuffer<struct.PromotedStruct>"
@dest = external constant %"RWStructuredBuffer<struct.PromotedStruct>"

define void @test(i32 %idx) {
  %param = alloca %struct.PromotedStruct, align 1
  %src = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @src, align 4
  %get_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %src, i32 %idx)
  %1 = load i64, ptr %get_access, align 1
  store i64 %1, ptr %param, align 1

  call void @external_barrier(ptr %param)

  %dest = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @dest, align 4
  %set_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %dest, i32 %idx)
  %2 = load i64, ptr %param, align 1
  store i64 %2, ptr %set_access, align 1
  ret void
}

declare void @external_barrier(ptr)

;--- generated-64.ll

%"StructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%"RWStructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%struct.PromotedStruct = type { i32, float }

@src = external constant %"StructuredBuffer<struct.PromotedStruct>"
@dest = external constant %"RWStructuredBuffer<struct.PromotedStruct>"

define void @test(i32 %idx) {
  %param = alloca %struct.PromotedStruct, align 1
  %src = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @src, align 4
  %get_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %src, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %param, ptr align 1 %get_access, i32 8, i1 false)

  call void @external_barrier(ptr %param)

  %dest = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @dest, align 4
  %set_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %dest, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %set_access, ptr align 1 %param, i32 8, i1 false)
  ret void
}

declare void @external_barrier(ptr)

;--- explicit-32.ll

%"StructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%"RWStructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%struct.PromotedStruct = type { i16, half }

@src = external constant %"StructuredBuffer<struct.PromotedStruct>"
@dest = external constant %"RWStructuredBuffer<struct.PromotedStruct>"

define void @test(i32 %idx) {
  %param = alloca %struct.PromotedStruct, align 1
  %src = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @src, align 4
  %get_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %src, i32 %idx)
  %1 = load i32, ptr %get_access, align 1
  store i32 %1, ptr %param, align 1

  call void @external_barrier(ptr %param)

  %dest = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @dest, align 4
  %set_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %dest, i32 %idx)
  %2 = load i32, ptr %param, align 1
  store i32 %2, ptr %set_access, align 1
  ret void
}

declare void @external_barrier(ptr)

;--- generated-32.ll

%"StructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%"RWStructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%struct.PromotedStruct = type { i32, i32 }

@src = external constant %"StructuredBuffer<struct.PromotedStruct>"
@dest = external constant %"RWStructuredBuffer<struct.PromotedStruct>"

define void @test(i32 %idx) {
  %param = alloca %struct.PromotedStruct, align 1
  %src = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @src, align 4
  %get_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %src, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %param, ptr align 1 %get_access, i32 8, i1 false)

  call void @external_barrier(ptr %param)

  %dest = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @dest, align 4
  %set_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %dest, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %set_access, ptr align 1 %param, i32 8, i1 false)
  ret void
}

declare void @external_barrier(ptr)

;--- folded.ll

; This tests that when there is no function call to prevent folding, the type
; will still successfully be replaced.

; FOLDED-LABEL: @test_folded(
; FOLDED: %[[#TO:]] = load %struct.PromotedStruct, ptr %get_access
; FOLDED: store %struct.PromotedStruct %[[#TO]], ptr %set_access
; FOLDED:    ret void

%"StructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%"RWStructuredBuffer<struct.PromotedStruct>" = type { %struct.PromotedStruct }
%struct.PromotedStruct = type { i32, float }

@src = external constant %"StructuredBuffer<struct.PromotedStruct>"
@dest = external constant %"RWStructuredBuffer<struct.PromotedStruct>"

define void @test_folded(i32 %idx) {
  %param = alloca %struct.PromotedStruct, align 1
  %src = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @src, align 4
  %get_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %src, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %param, ptr align 1 %get_access, i32 8, i1 false)

  %dest = load target("dx.RawBuffer", %struct.PromotedStruct, 1, 0), ptr @dest, align 4
  %set_access = call noundef nonnull align 1 dereferenceable(8) ptr @llvm.dx.resource.getpointer.p0.tdx.RawBuffer_s_struct.PromotedStructs_1_0t(target("dx.RawBuffer", %struct.PromotedStruct, 1, 0) %dest, i32 %idx)
  call void @llvm.memcpy.p0.p0.i32(ptr align 1 %set_access, ptr align 1 %param, i32 8, i1 false)
  ret void
}
