; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc --mtriple=loongarch32 -mattr=+d --code-model=small < %s | \
; RUN:    FileCheck --check-prefix=LA32-SMALL %s
; RUN: llc --mtriple=loongarch32 -mattr=+d --code-model=medium < %s | \
; RUN:    FileCheck --check-prefix=LA32-MEDIUM %s
; RUN: llc --mtriple=loongarch64 -mattr=+d --code-model=small < %s | \
; RUN:    FileCheck --check-prefix=LA64-SMALL %s
; RUN: llc --mtriple=loongarch64 -mattr=+d --code-model=medium < %s | \
; RUN:    FileCheck --check-prefix=LA64-MEDIUM %s
; RUN: llc --mtriple=loongarch64 -mattr=+d --code-model=large < %s | \
; RUN:    FileCheck --check-prefix=LA64-LARGE %s

declare void @llvm.memset.p0.i64(ptr, i8, i64, i1)
declare i32 @callee(i32)

define i32 @call_globaladdress(i32 %a) nounwind {
; LA32-SMALL-LABEL: call_globaladdress:
; LA32-SMALL:       # %bb.0:
; LA32-SMALL-NEXT:    addi.w $sp, $sp, -16
; LA32-SMALL-NEXT:    st.w $ra, $sp, 12 # 4-byte Folded Spill
; LA32-SMALL-NEXT:    bl callee
; LA32-SMALL-NEXT:    ld.w $ra, $sp, 12 # 4-byte Folded Reload
; LA32-SMALL-NEXT:    addi.w $sp, $sp, 16
; LA32-SMALL-NEXT:    ret
;
; LA32-MEDIUM-LABEL: call_globaladdress:
; LA32-MEDIUM:       # %bb.0:
; LA32-MEDIUM-NEXT:    addi.w $sp, $sp, -16
; LA32-MEDIUM-NEXT:    st.w $ra, $sp, 12 # 4-byte Folded Spill
; LA32-MEDIUM-NEXT:    pcaddu12i $ra, %call30(callee)
; LA32-MEDIUM-NEXT:    jirl $ra, $ra, 0
; LA32-MEDIUM-NEXT:    ld.w $ra, $sp, 12 # 4-byte Folded Reload
; LA32-MEDIUM-NEXT:    addi.w $sp, $sp, 16
; LA32-MEDIUM-NEXT:    ret
;
; LA64-SMALL-LABEL: call_globaladdress:
; LA64-SMALL:       # %bb.0:
; LA64-SMALL-NEXT:    addi.d $sp, $sp, -16
; LA64-SMALL-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-SMALL-NEXT:    bl callee
; LA64-SMALL-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-SMALL-NEXT:    addi.d $sp, $sp, 16
; LA64-SMALL-NEXT:    ret
;
; LA64-MEDIUM-LABEL: call_globaladdress:
; LA64-MEDIUM:       # %bb.0:
; LA64-MEDIUM-NEXT:    addi.d $sp, $sp, -16
; LA64-MEDIUM-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-MEDIUM-NEXT:    pcaddu18i $ra, %call36(callee)
; LA64-MEDIUM-NEXT:    jirl $ra, $ra, 0
; LA64-MEDIUM-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-MEDIUM-NEXT:    addi.d $sp, $sp, 16
; LA64-MEDIUM-NEXT:    ret
;
; LA64-LARGE-LABEL: call_globaladdress:
; LA64-LARGE:       # %bb.0:
; LA64-LARGE-NEXT:    addi.d $sp, $sp, -16
; LA64-LARGE-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-LARGE-NEXT:    pcalau12i $a1, %got_pc_hi20(callee)
; LA64-LARGE-NEXT:    addi.d $ra, $zero, %got_pc_lo12(callee)
; LA64-LARGE-NEXT:    lu32i.d $ra, %got64_pc_lo20(callee)
; LA64-LARGE-NEXT:    lu52i.d $ra, $ra, %got64_pc_hi12(callee)
; LA64-LARGE-NEXT:    ldx.d $ra, $ra, $a1
; LA64-LARGE-NEXT:    jirl $ra, $ra, 0
; LA64-LARGE-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-LARGE-NEXT:    addi.d $sp, $sp, 16
; LA64-LARGE-NEXT:    ret
  %1 = call i32 @callee(i32 %a)
  ret i32 %1
}

define void @call_external_sym(ptr %dst) {
; LA32-SMALL-LABEL: call_external_sym:
; LA32-SMALL:       # %bb.0: # %entry
; LA32-SMALL-NEXT:    addi.w $sp, $sp, -16
; LA32-SMALL-NEXT:    .cfi_def_cfa_offset 16
; LA32-SMALL-NEXT:    st.w $ra, $sp, 12 # 4-byte Folded Spill
; LA32-SMALL-NEXT:    .cfi_offset 1, -4
; LA32-SMALL-NEXT:    ori $a2, $zero, 1000
; LA32-SMALL-NEXT:    move $a1, $zero
; LA32-SMALL-NEXT:    bl memset
; LA32-SMALL-NEXT:    ld.w $ra, $sp, 12 # 4-byte Folded Reload
; LA32-SMALL-NEXT:    addi.w $sp, $sp, 16
; LA32-SMALL-NEXT:    ret
;
; LA32-MEDIUM-LABEL: call_external_sym:
; LA32-MEDIUM:       # %bb.0: # %entry
; LA32-MEDIUM-NEXT:    addi.w $sp, $sp, -16
; LA32-MEDIUM-NEXT:    .cfi_def_cfa_offset 16
; LA32-MEDIUM-NEXT:    st.w $ra, $sp, 12 # 4-byte Folded Spill
; LA32-MEDIUM-NEXT:    .cfi_offset 1, -4
; LA32-MEDIUM-NEXT:    ori $a2, $zero, 1000
; LA32-MEDIUM-NEXT:    move $a1, $zero
; LA32-MEDIUM-NEXT:    pcaddu12i $ra, %call30(memset)
; LA32-MEDIUM-NEXT:    jirl $ra, $ra, 0
; LA32-MEDIUM-NEXT:    ld.w $ra, $sp, 12 # 4-byte Folded Reload
; LA32-MEDIUM-NEXT:    addi.w $sp, $sp, 16
; LA32-MEDIUM-NEXT:    ret
;
; LA64-SMALL-LABEL: call_external_sym:
; LA64-SMALL:       # %bb.0: # %entry
; LA64-SMALL-NEXT:    addi.d $sp, $sp, -16
; LA64-SMALL-NEXT:    .cfi_def_cfa_offset 16
; LA64-SMALL-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-SMALL-NEXT:    .cfi_offset 1, -8
; LA64-SMALL-NEXT:    ori $a2, $zero, 1000
; LA64-SMALL-NEXT:    move $a1, $zero
; LA64-SMALL-NEXT:    bl memset
; LA64-SMALL-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-SMALL-NEXT:    addi.d $sp, $sp, 16
; LA64-SMALL-NEXT:    ret
;
; LA64-MEDIUM-LABEL: call_external_sym:
; LA64-MEDIUM:       # %bb.0: # %entry
; LA64-MEDIUM-NEXT:    addi.d $sp, $sp, -16
; LA64-MEDIUM-NEXT:    .cfi_def_cfa_offset 16
; LA64-MEDIUM-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-MEDIUM-NEXT:    .cfi_offset 1, -8
; LA64-MEDIUM-NEXT:    ori $a2, $zero, 1000
; LA64-MEDIUM-NEXT:    move $a1, $zero
; LA64-MEDIUM-NEXT:    pcaddu18i $ra, %call36(memset)
; LA64-MEDIUM-NEXT:    jirl $ra, $ra, 0
; LA64-MEDIUM-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-MEDIUM-NEXT:    addi.d $sp, $sp, 16
; LA64-MEDIUM-NEXT:    ret
;
; LA64-LARGE-LABEL: call_external_sym:
; LA64-LARGE:       # %bb.0: # %entry
; LA64-LARGE-NEXT:    addi.d $sp, $sp, -16
; LA64-LARGE-NEXT:    .cfi_def_cfa_offset 16
; LA64-LARGE-NEXT:    st.d $ra, $sp, 8 # 8-byte Folded Spill
; LA64-LARGE-NEXT:    .cfi_offset 1, -8
; LA64-LARGE-NEXT:    ori $a2, $zero, 1000
; LA64-LARGE-NEXT:    move $a1, $zero
; LA64-LARGE-NEXT:    pcalau12i $a3, %got_pc_hi20(memset)
; LA64-LARGE-NEXT:    addi.d $ra, $zero, %got_pc_lo12(memset)
; LA64-LARGE-NEXT:    lu32i.d $ra, %got64_pc_lo20(memset)
; LA64-LARGE-NEXT:    lu52i.d $ra, $ra, %got64_pc_hi12(memset)
; LA64-LARGE-NEXT:    ldx.d $ra, $ra, $a3
; LA64-LARGE-NEXT:    jirl $ra, $ra, 0
; LA64-LARGE-NEXT:    ld.d $ra, $sp, 8 # 8-byte Folded Reload
; LA64-LARGE-NEXT:    addi.d $sp, $sp, 16
; LA64-LARGE-NEXT:    ret
entry:
  call void @llvm.memset.p0.i64(ptr %dst, i8 0, i64 1000, i1 false)
  ret void
}

;; Tail call with different codemodel.
declare i32 @callee_tail(i32 %i)
define i32 @caller_tail(i32 %i) nounwind {
; LA32-SMALL-LABEL: caller_tail:
; LA32-SMALL:       # %bb.0: # %entry
; LA32-SMALL-NEXT:    b callee_tail
;
; LA32-MEDIUM-LABEL: caller_tail:
; LA32-MEDIUM:       # %bb.0: # %entry
; LA32-MEDIUM-NEXT:    pcaddu12i $t8, %call30(callee_tail)
; LA32-MEDIUM-NEXT:    jr $t8
;
; LA64-SMALL-LABEL: caller_tail:
; LA64-SMALL:       # %bb.0: # %entry
; LA64-SMALL-NEXT:    b callee_tail
;
; LA64-MEDIUM-LABEL: caller_tail:
; LA64-MEDIUM:       # %bb.0: # %entry
; LA64-MEDIUM-NEXT:    pcaddu18i $t8, %call36(callee_tail)
; LA64-MEDIUM-NEXT:    jr $t8
;
; LA64-LARGE-LABEL: caller_tail:
; LA64-LARGE:       # %bb.0: # %entry
; LA64-LARGE-NEXT:    pcalau12i $a1, %got_pc_hi20(callee_tail)
; LA64-LARGE-NEXT:    addi.d $a2, $zero, %got_pc_lo12(callee_tail)
; LA64-LARGE-NEXT:    lu32i.d $a2, %got64_pc_lo20(callee_tail)
; LA64-LARGE-NEXT:    lu52i.d $a2, $a2, %got64_pc_hi12(callee_tail)
; LA64-LARGE-NEXT:    ldx.d $a1, $a2, $a1
; LA64-LARGE-NEXT:    jr $a1
entry:
  %r = tail call i32 @callee_tail(i32 %i)
  ret i32 %r
}
