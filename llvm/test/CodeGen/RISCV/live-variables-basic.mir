# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py
# RUN: llc -mtriple=riscv64 -riscv-enable-live-variables -verify-machineinstrs -o - %s | FileCheck %s
#
# Test basic live variable analysis with simple control flow and basic blocks

# REQUIRES: Assertions

--- |
  define i64 @test_simple_add(i64 %a, i64 %b) {
  entry:
    %sum = add i64 %a, %b
    ret i64 %sum
  }

  define i64 @test_if_then_else(i64 %a, i64 %b) {
  entry:
    %cmp = icmp sgt i64 %a, %b
    br i1 %cmp, label %then, label %else

  then:
    %mul = mul i64 %a, %b
    br label %end

  else:
    %sub = sub i64 %a, %b
    br label %end

  end:
    %result = phi i64 [ %mul, %then ], [ %sub, %else ]
    ret i64 %result
  }

  define i64 @test_multiple_uses(i64 %a, i64 %b, i64 %c) {
  entry:
    %t1 = add i64 %a, %b
    %t2 = mul i64 %t1, %c
    %t3 = sub i64 %t2, %a
    %t4 = add i64 %t3, %b
    ret i64 %t4
  }

  define i64 @test_gen_kill(i64 %a, i64 %b, i64 %c) {
  entry:
    %t1 = add i64 %a, %b
    %t2 = mul i64 %t1, %c
    %t3 = sub i64 %t2, %a
    %t4 = add i64 %t3, %b
    ret i64 %t4
  }

...
---
name:            test_simple_add
alignment:       4
tracksRegLiveness: true
registers:
  - { id: 0, class: gpr }
  - { id: 1, class: gpr }
  - { id: 2, class: gpr }
liveins:
  - { reg: '$x10', virtual-reg: '%0' }
  - { reg: '$x11', virtual-reg: '%1' }
body:             |
  bb.0.entry:
    liveins: $x10, $x11
    ; CHECK-LABEL: name: test_simple_add
    ; CHECK: bb.0.entry:
    ; CHECK-NEXT: liveins: $x10, $x11
    ; Test that %0 and %1 are live-in, used once, and %2 is defined

    %0:gpr = COPY $x10
    %1:gpr = COPY $x11
    %2:gpr = ADD %0, %1
    $x10 = COPY %2
    PseudoRET implicit $x10
...
---
name:            test_if_then_else
alignment:       4
tracksRegLiveness: true
registers:
  - { id: 0, class: gpr }
  - { id: 1, class: gpr }
  - { id: 2, class: gpr }
  - { id: 3, class: gpr }
  - { id: 4, class: gpr }
liveins:
  - { reg: '$x10', virtual-reg: '%0' }
  - { reg: '$x11', virtual-reg: '%1' }
body:             |
  bb.0.entry:
    liveins: $x10, $x11
    ; CHECK-LABEL: name: test_if_then_else
    ; CHECK: bb.0.entry:
    ; CHECK-NEXT: successors
    ; CHECK-NEXT: liveins: $x10, $x11
    ; Test that %0 and %1 are live across multiple blocks

    %0:gpr = COPY $x10
    %1:gpr = COPY $x11
    %2:gpr = SLT %1, %0
    BEQ %2, $x0, %bb.2

  bb.1.then:
    ; CHECK: bb.1.then:
    ; %0 and %1 should be live-in here
    %3:gpr = MUL %0, %1
    PseudoBR %bb.3

  bb.2.else:
    ; CHECK: bb.2.else:
    ; %0 and %1 should be live-in here
    %4:gpr = SUB %0, %1
    PseudoBR %bb.3

  bb.3.end:
    ; CHECK: bb.3.end:
    ; Either %3 or %4 should be live-in (phi sources)
    %5:gpr = PHI %3, %bb.1, %4, %bb.2
    $x10 = COPY %5
    PseudoRET implicit $x10
...
---
name:            test_multiple_uses
alignment:       4
tracksRegLiveness: true
registers:
  - { id: 0, class: gpr }
  - { id: 1, class: gpr }
  - { id: 2, class: gpr }
  - { id: 3, class: gpr }
  - { id: 4, class: gpr }
  - { id: 5, class: gpr }
  - { id: 6, class: gpr }
liveins:
  - { reg: '$x10', virtual-reg: '%0' }
  - { reg: '$x11', virtual-reg: '%1' }
  - { reg: '$x12', virtual-reg: '%2' }
body:             |
  bb.0.entry:
    liveins: $x10, $x11, $x12
    ; CHECK-LABEL: name: test_multiple_uses
    ; CHECK: bb.0.entry:
    ; CHECK-NEXT: liveins: $x10, $x11, $x12
    ; Test that variables with multiple uses have correct liveness ranges

    %0:gpr = COPY $x10
    %1:gpr = COPY $x11
    %2:gpr = COPY $x12
    ; %0 used here and later
    %3:gpr = ADD %0, %1
    ; %3 used in next instruction
    %4:gpr = MUL %3, %2
    ; %0 used again here (should still be live)
    %5:gpr = SUB %4, %0
    ; %1 used again here
    %6:gpr = ADD %5, %1
    $x10 = COPY %6
    PseudoRET implicit $x10
...
