; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 6
; RUN: llc -mtriple=aarch64-linux-gnu -mattr=+sme2 -O3 -verify-machineinstrs < %s | FileCheck %s

declare void @inout_za_zt0() "aarch64_inout_za" "aarch64_inout_zt0"

define void @new_za_zt0() "aarch64_new_za" "aarch64_new_zt0" {
; CHECK-LABEL: new_za_zt0:
; CHECK:       // %bb.0: // %entry
; CHECK-NEXT:    mrs x8, TPIDR2_EL0
; CHECK-NEXT:    cbz x8, .LBB0_2
; CHECK-NEXT:  // %bb.1: // %entry
; CHECK-NEXT:    bl __arm_tpidr2_save
; CHECK-NEXT:    msr TPIDR2_EL0, xzr
; CHECK-NEXT:    zero {za}
; CHECK-NEXT:    zero { zt0 }
; CHECK-NEXT:  .LBB0_2: // %entry
; CHECK-NEXT:    smstart za
; CHECK-NEXT:    smstop za
; CHECK-NEXT:    b inout_za_zt0
entry:
  tail call void @inout_za_zt0()
  ret void
}

declare void @inout_za() "aarch64_inout_za"

define void @new_za() "aarch64_new_za" {
; CHECK-LABEL: new_za:
; CHECK:       // %bb.0: // %entry
; CHECK-NEXT:    mrs x8, TPIDR2_EL0
; CHECK-NEXT:    cbz x8, .LBB1_2
; CHECK-NEXT:  // %bb.1: // %entry
; CHECK-NEXT:    bl __arm_tpidr2_save
; CHECK-NEXT:    msr TPIDR2_EL0, xzr
; CHECK-NEXT:    zero {za}
; CHECK-NEXT:  .LBB1_2: // %entry
; CHECK-NEXT:    smstart za
; CHECK-NEXT:    smstop za
; CHECK-NEXT:    b inout_za
entry:
  tail call void @inout_za()
  ret void
}

declare void @inout_zt0() "aarch64_inout_zt0"

define void @new_zt0() "aarch64_new_zt0" {
; CHECK-LABEL: new_zt0:
; CHECK:       // %bb.0: // %entry
; CHECK-NEXT:    mrs x8, TPIDR2_EL0
; CHECK-NEXT:    cbz x8, .LBB2_2
; CHECK-NEXT:  // %bb.1: // %entry
; CHECK-NEXT:    bl __arm_tpidr2_save
; CHECK-NEXT:    msr TPIDR2_EL0, xzr
; CHECK-NEXT:    zero { zt0 }
; CHECK-NEXT:  .LBB2_2: // %entry
; CHECK-NEXT:    smstart za
; CHECK-NEXT:    smstop za
; CHECK-NEXT:    b inout_zt0
entry:
  tail call void @inout_zt0()
  ret void
}
