; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 6
; RUN: llc -mtriple=aarch64-pc-windows-msvc < %s | FileCheck %s

declare void @func()

; Make sure that we do not end up with a dangling EH pad reference.

define void @test(ptr %p) personality ptr @__CxxFrameHandler3 {
; CHECK-LABEL: test:
; CHECK:       .seh_proc "?dtor$1@?0?test@4HA"
; CHECK-LABEL: $stateUnwindMap$test:
; CHECK:       .word -1                           // ToState
; CHECK:       .word "?dtor$1@?0?test@4HA"@IMGREL // Action

  %v0 = load i32, ptr %p
  %v1 = load i32, ptr %p
  %xor = xor i32 %v0, %v1
  %cmp = icmp eq i32 %xor, 0
  br i1 %cmp, label %exit, label %bb

bb:
  invoke void @func()
          to label %exit unwind label %unwind

unwind:
  %cp = cleanuppad within none []
  store volatile i32 0, ptr %p
  cleanupret from %cp unwind to caller

exit:
  ret void
}

declare i32 @__CxxFrameHandler3(...)
