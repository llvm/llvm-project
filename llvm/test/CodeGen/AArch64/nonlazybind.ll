; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 4
; RUN: llc -mtriple=aarch64-apple-ios %s -o - -aarch64-enable-nonlazybind | FileCheck %s --check-prefix=MACHO
; RUN: llc -mtriple=aarch64-apple-ios %s -o - | FileCheck %s --check-prefix=MACHO-NORMAL
; RUN: llc -mtriple=aarch64 -fast-isel %s -o - | FileCheck %s --check-prefixes=ELF,ELF-FI
; RUN: llc -mtriple=aarch64 -global-isel %s -o - | FileCheck %s --check-prefixes=ELF,ELF-GI
; RUN: llc -mtriple=aarch64 %s -o - | FileCheck %s --check-prefixes=ELF,ELF-SDAG

define dso_preemptable void @preemptable() nonlazybind {
; MACHO-LABEL: preemptable:
; MACHO:       ; %bb.0:
; MACHO-NEXT:    ret
;
; MACHO-NORMAL-LABEL: preemptable:
; MACHO-NORMAL:       ; %bb.0:
; MACHO-NORMAL-NEXT:    ret
;
; ELF-LABEL: preemptable:
; ELF:       // %bb.0:
; ELF-NEXT:    ret
  ret void
}

define dso_local void @local() nonlazybind {
; MACHO-LABEL: local:
; MACHO:       ; %bb.0:
; MACHO-NEXT:    ret
;
; MACHO-NORMAL-LABEL: local:
; MACHO-NORMAL:       ; %bb.0:
; MACHO-NORMAL-NEXT:    ret
;
; ELF-LABEL: local:
; ELF:       // %bb.0:
; ELF-NEXT:    ret
  ret void
}

declare void @external() nonlazybind

define void @test_laziness() nounwind {
;
; MACHO-LABEL: test_laziness:
; MACHO:       ; %bb.0:
; MACHO-NEXT:    stp x29, x30, [sp, #-16]! ; 16-byte Folded Spill
; MACHO-NEXT:    bl _preemptable
; MACHO-NEXT:    bl _local
; MACHO-NEXT:  Lloh0:
; MACHO-NEXT:    adrp x8, _external@GOTPAGE
; MACHO-NEXT:  Lloh1:
; MACHO-NEXT:    ldr x8, [x8, _external@GOTPAGEOFF]
; MACHO-NEXT:    blr x8
; MACHO-NEXT:    ldp x29, x30, [sp], #16 ; 16-byte Folded Reload
; MACHO-NEXT:    ret
; MACHO-NEXT:    .loh AdrpLdrGot Lloh0, Lloh1
;
; MACHO-NORMAL-LABEL: test_laziness:
; MACHO-NORMAL:       ; %bb.0:
; MACHO-NORMAL-NEXT:    stp x29, x30, [sp, #-16]! ; 16-byte Folded Spill
; MACHO-NORMAL-NEXT:    bl _preemptable
; MACHO-NORMAL-NEXT:    bl _local
; MACHO-NORMAL-NEXT:    bl _external
; MACHO-NORMAL-NEXT:    ldp x29, x30, [sp], #16 ; 16-byte Folded Reload
; MACHO-NORMAL-NEXT:    ret
;
; ELF-LABEL: test_laziness:
; ELF:       // %bb.0:
; ELF-NEXT:    str x30, [sp, #-16]! // 8-byte Folded Spill
; ELF-NEXT:    bl preemptable
; ELF-NEXT:    bl local
; ELF-NEXT:    bl external
; ELF-NEXT:    ldr x30, [sp], #16 // 8-byte Folded Reload
; ELF-NEXT:    ret
  call void @preemptable()
  call void @local()
  call void @external()
  ret void
}

define void @test_laziness_tail() nounwind {
; MACHO-LABEL: test_laziness_tail:
; MACHO:       ; %bb.0:
; MACHO-NEXT:  Lloh2:
; MACHO-NEXT:    adrp x0, _external@GOTPAGE
; MACHO-NEXT:  Lloh3:
; MACHO-NEXT:    ldr x0, [x0, _external@GOTPAGEOFF]
; MACHO-NEXT:    br x0
; MACHO-NEXT:    .loh AdrpLdrGot Lloh2, Lloh3
;
; MACHO-NORMAL-LABEL: test_laziness_tail:
; MACHO-NORMAL:       ; %bb.0:
; MACHO-NORMAL-NEXT:    b _external
;
; ELF-LABEL: test_laziness_tail:
; ELF:       // %bb.0:
; ELF-NEXT:    b external
  tail call void @external()
  ret void
}
;; NOTE: These prefixes are unused and the list is autogenerated. Do not add tests below this line:
; ELF-FI: {{.*}}
; ELF-GI: {{.*}}
; ELF-SDAG: {{.*}}
