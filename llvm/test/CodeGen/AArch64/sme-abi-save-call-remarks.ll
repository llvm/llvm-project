; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py
; RUN: llc -mtriple=aarch64 -mattr=+sme2 --aarch64-new-sme-abi=false --pass-remarks-analysis=sme -o /dev/null < %s 2>&1 | FileCheck %s  --check-prefix=CHECK-SDAG
; RUN: llc -mtriple=aarch64 -mattr=+sme2 --pass-remarks-analysis=sme -o /dev/null < %s 2>&1 | FileCheck %s

declare void @private_za_callee()
declare void @private_za_callee_a()
declare void @private_za_callee_b()
declare void @private_za_callee_c()

declare void @shared_za_callee() "aarch64_inout_za"
declare void @shared_za_zt0_callee() "aarch64_inout_za" "aarch64_inout_zt0"

; Note: These remarks are more useful with source debug info (which gives line numbers for `<unknown>:0:0`).

define void @test_lazy_save_1_callee() nounwind "aarch64_inout_za" {
; CHECK-SDAG: remark: <unknown>:0:0: call from 'test_lazy_save_1_callee' to 'private_za_callee' sets up a lazy save for ZA

; CHECK:      remark: <unknown>:0:0: lazy save of ZA emitted in 'test_lazy_save_1_callee'
; CHECK-NEXT: remark: <unknown>:0:0: call to 'private_za_callee' requires ZA save
  call void @private_za_callee()
  ret void
}

define void @test_lazy_save_2_callees() nounwind "aarch64_inout_za" {
; CHECK-SDAG: remark: <unknown>:0:0: call from 'test_lazy_save_2_callees' to 'private_za_callee' sets up a lazy save for ZA
; CHECK-SDAG: remark: <unknown>:0:0: call from 'test_lazy_save_2_callees' to 'private_za_callee' sets up a lazy save for ZA

; CHECK:      remark: <unknown>:0:0: lazy save of ZA emitted in 'test_lazy_save_2_callees'
; CHECK-NEXT: remark: <unknown>:0:0: call to 'private_za_callee' requires ZA save
  call void @private_za_callee()
  call void @private_za_callee()
  ret void
}

define float @test_lazy_save_expanded_intrinsic(float %a) nounwind "aarch64_inout_za" {
; CHECK-SDAG: remark: <unknown>:0:0: call from 'test_lazy_save_expanded_intrinsic' to 'cosf' sets up a lazy save for ZA

; CHECK:      remark: <unknown>:0:0: lazy save of ZA emitted in 'test_lazy_save_expanded_intrinsic'
; CHECK-NEXT: remark: <unknown>:0:0: call to 'cosf' requires ZA save
  %res = call float @llvm.cos.f32(float %a)
  ret float %res
}
