; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc -verify-machineinstrs -mcpu=pwr7 -mtriple=powerpc64-unknown-linux-gnu -mattr=-vsx < %s | FileCheck %s
; RUN: llc -verify-machineinstrs -mcpu=pwr7 -mtriple=powerpc64-unknown-linux-gnu -mattr=+vsx < %s | FileCheck %s -check-prefix=CHECK-VSX
target datalayout = "E-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-f128:128:128-v128:128:128-n32:64"
target triple = "powerpc64-unknown-linux-gnu"

define double @foo_d_ll(ppc_fp128 %a, ppc_fp128 %b) #0 {
; CHECK-LABEL: foo_d_ll:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    fcpsgn 1, 3, 1
; CHECK-NEXT:    blr
;
; CHECK-VSX-LABEL: foo_d_ll:
; CHECK-VSX:       # %bb.0: # %entry
; CHECK-VSX-NEXT:    xscpsgndp 1, 3, 1
; CHECK-VSX-NEXT:    blr
entry:
  %call = tail call ppc_fp128 @copysignl(ppc_fp128 %a, ppc_fp128 %b) #0
  %conv = fptrunc ppc_fp128 %call to double
  ret double %conv
}

declare ppc_fp128 @copysignl(ppc_fp128, ppc_fp128) #0

define double @foo_dl(double %a, ppc_fp128 %b) #0 {
; CHECK-LABEL: foo_dl:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    fcpsgn 1, 2, 1
; CHECK-NEXT:    blr
;
; CHECK-VSX-LABEL: foo_dl:
; CHECK-VSX:       # %bb.0: # %entry
; CHECK-VSX-NEXT:    xscpsgndp 1, 2, 1
; CHECK-VSX-NEXT:    blr
entry:
  %conv = fptrunc ppc_fp128 %b to double
  %call = tail call double @copysign(double %a, double %conv) #0
  ret double %call
}

declare double @copysign(double, double) #0

define ppc_fp128 @foo_ll(double %a, ppc_fp128 %b) #0 {
; CHECK-LABEL: foo_ll:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    fcpsgn 0, 2, 1
; CHECK-NEXT:    li 3, 8
; CHECK-NEXT:    addis 4, 2, .LCPI2_0@toc@ha
; CHECK-NEXT:    addi 4, 4, .LCPI2_0@toc@l
; CHECK-NEXT:    fcmpu 0, 1, 0
; CHECK-NEXT:    fmr 1, 0
; CHECK-NEXT:    crnor 20, 2, 3
; CHECK-NEXT:    isel 3, 0, 3, 20
; CHECK-NEXT:    lfdx 2, 4, 3
; CHECK-NEXT:    blr
;
; CHECK-VSX-LABEL: foo_ll:
; CHECK-VSX:       # %bb.0: # %entry
; CHECK-VSX-NEXT:    fmr 0, 1
; CHECK-VSX-NEXT:    xscpsgndp 1, 2, 1
; CHECK-VSX-NEXT:    xxlxor 2, 2, 2
; CHECK-VSX-NEXT:    fcmpu 0, 0, 1
; CHECK-VSX-NEXT:    cror 20, 2, 3
; CHECK-VSX-NEXT:    bclr 12, 20, 0
; CHECK-VSX-NEXT:  # %bb.1: # %entry
; CHECK-VSX-NEXT:    xsnegdp 2, 2
; CHECK-VSX-NEXT:    blr
entry:
  %conv = fpext double %a to ppc_fp128
  %call = tail call ppc_fp128 @copysignl(ppc_fp128 %conv, ppc_fp128 %b) #0
  ret ppc_fp128 %call
}

define ppc_fp128 @foo_ld(double %a, double %b) #0 {
; CHECK-LABEL: foo_ld:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    fcpsgn 0, 2, 1
; CHECK-NEXT:    li 3, 8
; CHECK-NEXT:    addis 4, 2, .LCPI3_0@toc@ha
; CHECK-NEXT:    addi 4, 4, .LCPI3_0@toc@l
; CHECK-NEXT:    fcmpu 0, 1, 0
; CHECK-NEXT:    fmr 1, 0
; CHECK-NEXT:    crnor 20, 2, 3
; CHECK-NEXT:    isel 3, 0, 3, 20
; CHECK-NEXT:    lfdx 2, 4, 3
; CHECK-NEXT:    blr
;
; CHECK-VSX-LABEL: foo_ld:
; CHECK-VSX:       # %bb.0: # %entry
; CHECK-VSX-NEXT:    fmr 0, 1
; CHECK-VSX-NEXT:    xscpsgndp 1, 2, 1
; CHECK-VSX-NEXT:    xxlxor 2, 2, 2
; CHECK-VSX-NEXT:    fcmpu 0, 0, 1
; CHECK-VSX-NEXT:    cror 20, 2, 3
; CHECK-VSX-NEXT:    bclr 12, 20, 0
; CHECK-VSX-NEXT:  # %bb.1: # %entry
; CHECK-VSX-NEXT:    xsnegdp 2, 2
; CHECK-VSX-NEXT:    blr
entry:
  %conv = fpext double %a to ppc_fp128
  %conv1 = fpext double %b to ppc_fp128
  %call = tail call ppc_fp128 @copysignl(ppc_fp128 %conv, ppc_fp128 %conv1) #0
  ret ppc_fp128 %call
}

define ppc_fp128 @foo_lf(double %a, float %b) #0 {
; CHECK-LABEL: foo_lf:
; CHECK:       # %bb.0: # %entry
; CHECK-NEXT:    fcpsgn 0, 2, 1
; CHECK-NEXT:    li 3, 8
; CHECK-NEXT:    addis 4, 2, .LCPI4_0@toc@ha
; CHECK-NEXT:    addi 4, 4, .LCPI4_0@toc@l
; CHECK-NEXT:    fcmpu 0, 1, 0
; CHECK-NEXT:    fmr 1, 0
; CHECK-NEXT:    crnor 20, 2, 3
; CHECK-NEXT:    isel 3, 0, 3, 20
; CHECK-NEXT:    lfdx 2, 4, 3
; CHECK-NEXT:    blr
;
; CHECK-VSX-LABEL: foo_lf:
; CHECK-VSX:       # %bb.0: # %entry
; CHECK-VSX-NEXT:    fmr 0, 1
; CHECK-VSX-NEXT:    fcpsgn 1, 2, 1
; CHECK-VSX-NEXT:    xxlxor 2, 2, 2
; CHECK-VSX-NEXT:    fcmpu 0, 0, 1
; CHECK-VSX-NEXT:    cror 20, 2, 3
; CHECK-VSX-NEXT:    bclr 12, 20, 0
; CHECK-VSX-NEXT:  # %bb.1: # %entry
; CHECK-VSX-NEXT:    xsnegdp 2, 2
; CHECK-VSX-NEXT:    blr
entry:
  %conv = fpext double %a to ppc_fp128
  %conv1 = fpext float %b to ppc_fp128
  %call = tail call ppc_fp128 @copysignl(ppc_fp128 %conv, ppc_fp128 %conv1) #0
  ret ppc_fp128 %call
}

attributes #0 = { nounwind readnone }

