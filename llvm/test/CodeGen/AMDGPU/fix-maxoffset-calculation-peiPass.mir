# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py UTC_ARGS: --version 4
# RUN: llc -mtriple=amdgcn-amd-amdhsa -mcpu=gfx950 -verify-machineinstrs -simplify-mir -amdgpu-spill-vgpr-to-agpr=0 -run-pass=prologepilog -o - %s | FileCheck %s

# Test that the PEI pass does correct calculations for Maxoffset in case of
# spill instructions. Must emit offset within 13 bit signed number range.

---
name:            fix_maxoffset_PEI_pass
tracksRegLiveness: true
fixedStack:
  - { id: 0, type: spill-slot, offset: 4084, size: 24, alignment: 4,
      stack-id: default, callee-saved-register: '', callee-saved-restored: true,
      debug-info-variable: '', debug-info-expression: '', debug-info-location: '' }
stack:           []
machineFunctionInfo:
  hasSpilledVGPRs: true
  stackPtrOffsetReg: '$sgpr32'
body:             |
  ; CHECK-LABEL: name: fix_maxoffset_PEI_pass
  ; CHECK: bb.0:
  ; CHECK-NEXT:   liveins: $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167
  ; CHECK-NEXT: {{  $}}
  ; CHECK-NEXT: bb.1:
  ; CHECK-NEXT:   $sgpr0 = S_ADD_I32 $sgpr32, 4084, implicit-def dead $scc
  ; CHECK-NEXT:   SCRATCH_STORE_DWORDX4_SADDR $vgpr162_vgpr163_vgpr164_vgpr165, $sgpr0, 0, 0, implicit $exec, implicit $flat_scr, implicit-def $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167, implicit $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167 :: (store (s128) into %fixed-stack.0, align 4, addrspace 5)
  ; CHECK-NEXT:   SCRATCH_STORE_DWORDX2_SADDR $vgpr166_vgpr167, killed $sgpr0, 16, 0, implicit $exec, implicit $flat_scr, implicit $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167 :: (store (s64) into %fixed-stack.0 + 16, align 4, addrspace 5)
  ; CHECK-NEXT:   S_ENDPGM 0
  bb.0:
    liveins: $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167
  bb.1:
    SI_SPILL_AV192_SAVE $vgpr162_vgpr163_vgpr164_vgpr165_vgpr166_vgpr167, %fixed-stack.0, $sgpr32, 0, implicit $exec :: (store (s192) into %fixed-stack.0, align 4, addrspace 5)
    S_ENDPGM 0

...
