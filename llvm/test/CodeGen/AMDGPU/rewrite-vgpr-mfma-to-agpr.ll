; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc -mcpu=gfx942 -amdgpu-mfma-vgpr-form < %s | FileCheck %s

target triple = "amdgcn-amd-amdhsa"

define amdgpu_kernel void @test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma(ptr addrspace(1) %arg) #0 {
; CHECK-LABEL: test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma:
; CHECK:       ; %bb.0: ; %bb
; CHECK-NEXT:    s_load_dwordx2 s[0:1], s[4:5], 0x0
; CHECK-NEXT:    v_and_b32_e32 v0, 0x3ff, v0
; CHECK-NEXT:    v_lshlrev_b32_e32 v0, 7, v0
; CHECK-NEXT:    v_mov_b32_e32 v32, 1.0
; CHECK-NEXT:    v_mov_b32_e32 v33, 2.0
; CHECK-NEXT:    s_waitcnt lgkmcnt(0)
; CHECK-NEXT:    global_load_dwordx4 v[28:31], v0, s[0:1] offset:112
; CHECK-NEXT:    global_load_dwordx4 v[24:27], v0, s[0:1] offset:96
; CHECK-NEXT:    global_load_dwordx4 v[20:23], v0, s[0:1] offset:80
; CHECK-NEXT:    global_load_dwordx4 v[16:19], v0, s[0:1] offset:64
; CHECK-NEXT:    global_load_dwordx4 v[12:15], v0, s[0:1] offset:48
; CHECK-NEXT:    global_load_dwordx4 v[8:11], v0, s[0:1] offset:32
; CHECK-NEXT:    global_load_dwordx4 v[4:7], v0, s[0:1] offset:16
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    global_load_dwordx4 v[0:3], v0, s[0:1]
; CHECK-NEXT:    v_accvgpr_write_b32 a0, 1.0
; CHECK-NEXT:    v_accvgpr_write_b32 a1, 2.0
; CHECK-NEXT:    s_waitcnt vmcnt(0)
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[32:63], a0, a1, v[0:31]
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 1
; CHECK-NEXT:    v_mov_b32_e32 v2, v32
; CHECK-NEXT:    v_mov_b32_e32 v3, v33
; CHECK-NEXT:    v_mov_b32_e32 v4, v34
; CHECK-NEXT:    v_mov_b32_e32 v5, v35
; CHECK-NEXT:    v_mov_b32_e32 v6, v36
; CHECK-NEXT:    v_mov_b32_e32 v7, v37
; CHECK-NEXT:    v_mov_b32_e32 v8, v38
; CHECK-NEXT:    v_mov_b32_e32 v9, v39
; CHECK-NEXT:    v_mov_b32_e32 v10, v40
; CHECK-NEXT:    v_mov_b32_e32 v11, v41
; CHECK-NEXT:    v_mov_b32_e32 v12, v42
; CHECK-NEXT:    v_mov_b32_e32 v13, v43
; CHECK-NEXT:    v_mov_b32_e32 v14, v44
; CHECK-NEXT:    v_mov_b32_e32 v15, v45
; CHECK-NEXT:    v_mov_b32_e32 v16, v46
; CHECK-NEXT:    v_mov_b32_e32 v17, v47
; CHECK-NEXT:    v_mov_b32_e32 v18, v48
; CHECK-NEXT:    v_mov_b32_e32 v19, v49
; CHECK-NEXT:    v_mov_b32_e32 v20, v50
; CHECK-NEXT:    v_mov_b32_e32 v21, v51
; CHECK-NEXT:    v_mov_b32_e32 v22, v52
; CHECK-NEXT:    v_mov_b32_e32 v23, v53
; CHECK-NEXT:    v_mov_b32_e32 v24, v54
; CHECK-NEXT:    v_mov_b32_e32 v25, v55
; CHECK-NEXT:    v_mov_b32_e32 v26, v56
; CHECK-NEXT:    v_mov_b32_e32 v27, v57
; CHECK-NEXT:    v_mov_b32_e32 v28, v58
; CHECK-NEXT:    v_mov_b32_e32 v29, v59
; CHECK-NEXT:    v_mov_b32_e32 v30, v60
; CHECK-NEXT:    v_mov_b32_e32 v31, v61
; CHECK-NEXT:    v_mov_b32_e32 v32, 0
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], a0, a1, v[0:31]
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 1
; CHECK-NEXT:    global_store_dwordx4 v32, v[24:27], s[0:1] offset:96
; CHECK-NEXT:    global_store_dwordx4 v32, v[28:31], s[0:1] offset:112
; CHECK-NEXT:    global_store_dwordx4 v32, v[16:19], s[0:1] offset:64
; CHECK-NEXT:    global_store_dwordx4 v32, v[20:23], s[0:1] offset:80
; CHECK-NEXT:    global_store_dwordx4 v32, v[8:11], s[0:1] offset:32
; CHECK-NEXT:    global_store_dwordx4 v32, v[12:15], s[0:1] offset:48
; CHECK-NEXT:    global_store_dwordx4 v32, v[0:3], s[0:1]
; CHECK-NEXT:    global_store_dwordx4 v32, v[4:7], s[0:1] offset:16
; CHECK-NEXT:    s_endpgm
bb:
  %id = call i32 @llvm.amdgcn.workitem.id.x()
  %gep = getelementptr <32 x float>, ptr addrspace(1) %arg, i32 %id
  %in.1 = load <32 x float>, ptr addrspace(1) %gep, align 128
  %mai.1 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %in.1, i32 0, i32 0, i32 0)
  %mai.2 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.1, i32 0, i32 0, i32 0)
  %tmp.1 = shufflevector <32 x float> %mai.2, <32 x float> %mai.1, <32 x i32> <i32 32, i32 33, i32 0, i32 1, i32 2, i32 3, i32 4, i32 5, i32 6, i32 7, i32 8, i32 9, i32 10, i32 11, i32 12, i32 13, i32 14, i32 15, i32 16, i32 17, i32 18, i32 19, i32 20, i32 21, i32 22, i32 23, i32 24, i32 25, i32 26, i32 27, i32 28, i32 29>
  %mai.3 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %tmp.1, i32 0, i32 0, i32 0)
  store <32 x float> %mai.3, ptr addrspace(1) %arg, align 128
  ret void
}

define amdgpu_kernel void @test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_noshuffle(ptr addrspace(1) %arg) #0 {
; CHECK-LABEL: test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_noshuffle:
; CHECK:       ; %bb.0: ; %bb
; CHECK-NEXT:    s_load_dwordx2 s[0:1], s[4:5], 0x0
; CHECK-NEXT:    v_and_b32_e32 v0, 0x3ff, v0
; CHECK-NEXT:    v_lshlrev_b32_e32 v0, 7, v0
; CHECK-NEXT:    v_mov_b32_e32 v32, 1.0
; CHECK-NEXT:    v_mov_b32_e32 v33, 2.0
; CHECK-NEXT:    s_waitcnt lgkmcnt(0)
; CHECK-NEXT:    global_load_dwordx4 v[28:31], v0, s[0:1] offset:112
; CHECK-NEXT:    global_load_dwordx4 v[24:27], v0, s[0:1] offset:96
; CHECK-NEXT:    global_load_dwordx4 v[20:23], v0, s[0:1] offset:80
; CHECK-NEXT:    global_load_dwordx4 v[16:19], v0, s[0:1] offset:64
; CHECK-NEXT:    global_load_dwordx4 v[12:15], v0, s[0:1] offset:48
; CHECK-NEXT:    global_load_dwordx4 v[8:11], v0, s[0:1] offset:32
; CHECK-NEXT:    global_load_dwordx4 v[4:7], v0, s[0:1] offset:16
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    global_load_dwordx4 v[0:3], v0, s[0:1]
; CHECK-NEXT:    s_waitcnt vmcnt(0)
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mov_b32_e32 v32, 0
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    global_store_dwordx4 v32, v[24:27], s[0:1] offset:96
; CHECK-NEXT:    global_store_dwordx4 v32, v[28:31], s[0:1] offset:112
; CHECK-NEXT:    global_store_dwordx4 v32, v[16:19], s[0:1] offset:64
; CHECK-NEXT:    global_store_dwordx4 v32, v[20:23], s[0:1] offset:80
; CHECK-NEXT:    global_store_dwordx4 v32, v[8:11], s[0:1] offset:32
; CHECK-NEXT:    global_store_dwordx4 v32, v[12:15], s[0:1] offset:48
; CHECK-NEXT:    global_store_dwordx4 v32, v[0:3], s[0:1]
; CHECK-NEXT:    global_store_dwordx4 v32, v[4:7], s[0:1] offset:16
; CHECK-NEXT:    s_endpgm
bb:
  %id = call i32 @llvm.amdgcn.workitem.id.x()
  %gep = getelementptr <32 x float>, ptr addrspace(1) %arg, i32 %id
  %in.1 = load <32 x float>, ptr addrspace(1) %gep, align 128
  %mai.1 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %in.1, i32 0, i32 0, i32 0)
  %mai.2 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.1, i32 0, i32 0, i32 0)
  %mai.3 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.2, i32 0, i32 0, i32 0)
  store <32 x float> %mai.3, ptr addrspace(1) %arg, align 128
  ret void
}

define amdgpu_kernel void @test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_imm0_src2(ptr addrspace(1) %arg) #0 {
; CHECK-LABEL: test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_imm0_src2:
; CHECK:       ; %bb.0: ; %bb
; CHECK-NEXT:    v_mov_b32_e32 v32, 1.0
; CHECK-NEXT:    v_mov_b32_e32 v33, 2.0
; CHECK-NEXT:    s_load_dwordx2 s[0:1], s[4:5], 0x0
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, 0
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mov_b32_e32 v32, 0
; CHECK-NEXT:    s_waitcnt lgkmcnt(0)
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    global_store_dwordx4 v32, v[28:31], s[0:1] offset:112
; CHECK-NEXT:    global_store_dwordx4 v32, v[24:27], s[0:1] offset:96
; CHECK-NEXT:    global_store_dwordx4 v32, v[20:23], s[0:1] offset:80
; CHECK-NEXT:    global_store_dwordx4 v32, v[16:19], s[0:1] offset:64
; CHECK-NEXT:    global_store_dwordx4 v32, v[12:15], s[0:1] offset:48
; CHECK-NEXT:    global_store_dwordx4 v32, v[8:11], s[0:1] offset:32
; CHECK-NEXT:    global_store_dwordx4 v32, v[4:7], s[0:1] offset:16
; CHECK-NEXT:    global_store_dwordx4 v32, v[0:3], s[0:1]
; CHECK-NEXT:    s_endpgm
bb:
  %id = call i32 @llvm.amdgcn.workitem.id.x()
  %gep = getelementptr <32 x float>, ptr addrspace(1) %arg, i32 %id
  %in.1 = load <32 x float>, ptr addrspace(1) %gep, align 128
  %mai.1 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> zeroinitializer, i32 0, i32 0, i32 0)
  %mai.2 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.1, i32 0, i32 0, i32 0)
  %mai.3 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.2, i32 0, i32 0, i32 0)
  store <32 x float> %mai.3, ptr addrspace(1) %arg, align 128
  ret void
}

define amdgpu_kernel void @test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_imm1_src2(ptr addrspace(1) %arg) #0 {
; CHECK-LABEL: test_mfma_f32_32x32x1f32_rewrite_vgpr_mfma_imm1_src2:
; CHECK:       ; %bb.0: ; %bb
; CHECK-NEXT:    v_mov_b32_e32 v32, 1.0
; CHECK-NEXT:    v_mov_b32_e32 v33, 2.0
; CHECK-NEXT:    s_load_dwordx2 s[0:1], s[4:5], 0x0
; CHECK-NEXT:    s_nop 0
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, 1.0
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mfma_f32_32x32x1_2b_f32 v[0:31], v32, v33, v[0:31]
; CHECK-NEXT:    v_mov_b32_e32 v32, 0
; CHECK-NEXT:    s_waitcnt lgkmcnt(0)
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    s_nop 7
; CHECK-NEXT:    global_store_dwordx4 v32, v[28:31], s[0:1] offset:112
; CHECK-NEXT:    global_store_dwordx4 v32, v[24:27], s[0:1] offset:96
; CHECK-NEXT:    global_store_dwordx4 v32, v[20:23], s[0:1] offset:80
; CHECK-NEXT:    global_store_dwordx4 v32, v[16:19], s[0:1] offset:64
; CHECK-NEXT:    global_store_dwordx4 v32, v[12:15], s[0:1] offset:48
; CHECK-NEXT:    global_store_dwordx4 v32, v[8:11], s[0:1] offset:32
; CHECK-NEXT:    global_store_dwordx4 v32, v[4:7], s[0:1] offset:16
; CHECK-NEXT:    global_store_dwordx4 v32, v[0:3], s[0:1]
; CHECK-NEXT:    s_endpgm
bb:
  %id = call i32 @llvm.amdgcn.workitem.id.x()
  %gep = getelementptr <32 x float>, ptr addrspace(1) %arg, i32 %id
  %in.1 = load <32 x float>, ptr addrspace(1) %gep, align 128
  %mai.1 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> splat (float 1.0), i32 0, i32 0, i32 0)
  %mai.2 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.1, i32 0, i32 0, i32 0)
  %mai.3 = call <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float 1.0, float 2.0, <32 x float> %mai.2, i32 0, i32 0, i32 0)
  store <32 x float> %mai.3, ptr addrspace(1) %arg, align 128
  ret void
}

declare <32 x float> @llvm.amdgcn.mfma.f32.32x32x1f32(float, float, <32 x float>, i32 immarg, i32 immarg, i32 immarg) #1
declare noundef i32 @llvm.amdgcn.workitem.id.x() #2

attributes #0 = { nounwind "amdgpu-flat-work-group-size"="1,256" "amdgpu-waves-per-eu"="4,4" }
attributes #1 = { convergent nocallback nofree nosync nounwind willreturn memory(none) }
attributes #2 = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }
