# REQUIRES: asserts
# RUN: llc -march=amdgcn -mcpu=gfx1010 -verify-machineinstrs -amdgpu-late-wave-transform=1 -run-pass=amdgpu-wave-transform -amdgpu-wave-transform-print-final=1 -o - %S%{fs-sep}wavetransform-natural-loops.mir 2>&1 | FileCheck -check-prefixes=CFG %s

# TODO: Test some of the generated MIR. This is currently not done because
#       of high fluctuations in the MIR.

# CFG-LABEL: Wave CFG for simple_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.1(*) bb.2(*) [LatestPostDom: bb.2] [divergent]
# CFG-NEXT:    bb.2 (#4) [secondary]

# CFG-LABEL: Wave CFG for two_backedges_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) <flow-3>(bb.1) [LatestPostDom: <flow-3>] [divergent]
# CFG-NEXT:    bb.2 (#3) -> <flow-3>(bb.1,bb.3) [divergent]
# CFG-NEXT:    <flow-3> (#4) -> bb.1(*) bb.3(*) [LatestPostDom: bb.3] [divergent] [secondary]
# CFG-NEXT:    bb.3 (#5) [secondary]

# CFG-LABEL: Wave CFG for two_backedges_uniform_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) bb.1(*)
# CFG-NEXT:    bb.2 (#3) -> bb.1(*) bb.3(*) [LatestPostDom: bb.3] [divergent]
# CFG-NEXT:    bb.3 (#5) [secondary]

# CFG-LABEL: Wave CFG for two_backedges_divergent_uniform:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) <flow-3>(bb.1) [LatestPostDom: <flow-3>] [divergent]
# CFG-NEXT:    bb.2 (#3) -> <flow-3>(bb.1,bb.3)
# CFG-NEXT:    <flow-3> (#4) -> bb.1(*) bb.3(*) [LatestPostDom: bb.3] [divergent] [secondary]
# CFG-NEXT:    bb.3 (#5) [secondary]

#
#         0
#         |
#    v---<1<--\
#    |    |   |
#    | v-<2<\ |
#    | |  | | |
#    | |  3-^ |
#    |/   \   |
#    4     ---^
#

# CFG-LABEL: Wave CFG for nested_uniform:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.4(*) bb.2(*)
# CFG-NEXT:    bb.2 (#4) -> bb.3(*) bb.4(*)
# CFG-NEXT:    bb.3 (#5) -> bb.2(*) bb.1(*)
# CFG-NEXT:    bb.4 (#9)

#
#         0
#         |
#    v---<1<--\
#    |    |   |
#    | v-<2<\ |
#    | |  | | |
#    | |  3-^ |
#    |/   \   |
#    4     ---^
#

# CFG-LABEL: Wave CFG for nested_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) bb.4(*) [LatestPostDom: bb.4] [divergent]
# CFG-NEXT:    bb.2 (#4) -> bb.3(*) <flow-6>(bb.4) [divergent]
# CFG-NEXT:    bb.3 (#5) -> bb.2(*) <flow-6>(bb.1) [LatestPostDom: <flow-6>] [divergent]
# CFG-NEXT:    <flow-6> (#7) -> bb.1(*) bb.4(*) [LatestPostDom: bb.4] [divergent] [secondary]
# CFG-NEXT:    bb.4 (#9) [secondary]

#
#         0
#         |
#      /->1
#      |  |
#      | [2
#      |  |
#      ^-<3
#         |
#         4
#

# CFG-LABEL: Wave CFG for nested2_uniform_uniform:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*)
# CFG-NEXT:    bb.2 (#4) -> bb.3(*) bb.2(*)
# CFG-NEXT:    bb.3 (#6) -> bb.4(*) bb.1(*)
# CFG-NEXT:    bb.4 (#8)

#
#         0
#         |
#      /->1
#      |  |
#      | [2
#      |  |
#      ^-<3
#         |
#         4
#

# CFG-LABEL: Wave CFG for nested2_divergent_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*)
# CFG-NEXT:    bb.2 (#4) -> bb.2(*) bb.3(*) [LatestPostDom: bb.3] [divergent]
# CFG-NEXT:    bb.3 (#6) -> bb.1(*) bb.4(*) [LatestPostDom: bb.4] [divergent] [secondary]
# CFG-NEXT:    bb.4 (#8) [secondary]

#
#         0
#         |
#     /-->1<--\
#     |  / \  |
#     ^-2   3-^
#       |   |
#       4   5
#        \ /
#         6
#

# CFG-LABEL: Wave CFG for multi_backedge_exits_divergent_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) <flow-3>(bb.3) [LatestPostDom: <flow-4>] [divergent]
# CFG-NEXT:    bb.2 (#3) -> <flow-3>(bb.1,bb.4) [divergent]
# CFG-NEXT:    <flow-3> (#4) -> bb.3(*) <flow-4>(bb.4,bb.1) [LatestPostDom: <flow-4>] [divergent] [secondary]
# CFG-NEXT:    bb.3 (#4) -> <flow-4>(bb.1,bb.5) [divergent]
# CFG-NEXT:    <flow-4> (#5) -> bb.1(*) <flow-5>(bb.4,bb.5) [LatestPostDom: <flow-5>] [divergent] [secondary]
# CFG-NEXT:    <flow-5> (#6) -> bb.5(*) <flow-6>(bb.4) [LatestPostDom: <flow-6>] [divergent] [secondary]
# CFG-NEXT:    bb.5 (#6) -> <flow-6>(bb.6)
# CFG-NEXT:    <flow-6> (#7) -> bb.4(*) bb.6(*) [LatestPostDom: bb.6] [divergent] [secondary]
# CFG-NEXT:    bb.4 (#7) -> bb.6(*)
# CFG-NEXT:    bb.6 (#8) [secondary]

#
#         0
#         |
#     /-->1<--\
#     |  / \  |
#     ^-2   3-^
#       |   |
#       4   5
#        \ /
#         6
#

# CFG-LABEL: Wave CFG for multi_backedge_exits_uniform_divergent:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) bb.3(*)
# CFG-NEXT:    bb.2 (#3) -> bb.1(*) <flow-3>(bb.4) [divergent]
# CFG-NEXT:    bb.3 (#4) -> bb.1(*) <flow-3>(bb.5) [LatestPostDom: <flow-3>] [divergent]
# CFG-NEXT:    <flow-3> (#6) -> bb.5(*) <flow-4>(bb.4) [LatestPostDom: <flow-4>] [divergent] [secondary]
# CFG-NEXT:    bb.5 (#6) -> <flow-4>(bb.6)
# CFG-NEXT:    <flow-4> (#7) -> bb.4(*) bb.6(*) [LatestPostDom: bb.6] [divergent] [secondary]
# CFG-NEXT:    bb.4 (#7) -> bb.6(*)
# CFG-NEXT:    bb.6 (#8) [secondary]

#
#         0
#         |
#     /-->1<--\
#     |  / \  |
#     ^-2   3-^
#       |   |
#       4   5
#        \ /
#         6
#

# CFG-LABEL: Wave CFG for multi_backedge_exits_divergent_uniform:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) <flow-3>(bb.3) [LatestPostDom: <flow-4>] [divergent]
# CFG-NEXT:    bb.2 (#3) -> <flow-3>(bb.1,bb.4)
# CFG-NEXT:    <flow-3> (#4) -> bb.3(*) <flow-4>(bb.4,bb.1) [LatestPostDom: <flow-4>] [divergent] [secondary]
# CFG-NEXT:    bb.3 (#4) -> <flow-4>(bb.1,bb.5)
# CFG-NEXT:    <flow-4> (#5) -> bb.1(*) <flow-5>(bb.4,bb.5) [LatestPostDom: <flow-5>] [divergent] [secondary]
# CFG-NEXT:    <flow-5> (#6) -> bb.5(*) <flow-6>(bb.4) [LatestPostDom: <flow-6>] [divergent] [secondary]
# CFG-NEXT:    bb.5 (#6) -> <flow-6>(bb.6)
# CFG-NEXT:    <flow-6> (#7) -> bb.4(*) bb.6(*) [LatestPostDom: bb.6] [divergent] [secondary]
# CFG-NEXT:    bb.4 (#7) -> bb.6(*)
# CFG-NEXT:    bb.6 (#8) [secondary]

#
#         0
#         |
#     /-->1<--\
#     |  / \  |
#     ^-2   3-^
#       |   |
#       4   5
#        \ /
#         6
#

# CFG-LABEL: Wave CFG for multi_backedge_exits_uniform_uniform:
# CFG-NEXT:    bb.0 (#0) -> bb.1(*)
# CFG-NEXT:    bb.1 (#2) -> bb.2(*) bb.3(*)
# CFG-NEXT:    bb.2 (#3) -> bb.4(*) bb.1(*)
# CFG-NEXT:    bb.3 (#4) -> bb.5(*) bb.1(*)
# CFG-NEXT:    bb.5 (#6) -> bb.6(*)
# CFG-NEXT:    bb.4 (#7) -> bb.6(*)
# CFG-NEXT:    bb.6 (#8)
