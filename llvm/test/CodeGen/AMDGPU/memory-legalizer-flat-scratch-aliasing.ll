; RUN: llc -mtriple=amdgcn-amd-amdhsa -O3 -mcpu=gfx1250 < %s | FileCheck --check-prefixes=GFX1250 %s

; GFX1250 specific test to check we don't force SCOPE_SE on flat stores that are known to never touch
; scratch.
;
; This test is not autogenerated because we must write the CHECK lines in a way that makes them
; fail if SCOPE_SE is added. The script would generate CHECK lines that would accept a SCOPE_SE at the end of the instruction.

; GFX1250: local_or_global_flat_store:
; GFX1250:    flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}} scope:SCOPE_SE
define amdgpu_kernel void @local_or_global_flat_store(i1 %cond, ptr addrspace(1) %gptr, ptr addrspace(3) %lptr, i32 %val) {
entry:
  %a = addrspacecast ptr addrspace(1) %gptr to ptr
  %b = addrspacecast ptr addrspace(3) %lptr to ptr
  %ptr = select i1 %cond, ptr %a, ptr %b
  store i32 %val, ptr %ptr
  ret void
}

; GFX1250: local_or_global_flat_atomic_store:
; GFX1250:    flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}} scope:SCOPE_SE
define amdgpu_kernel void @local_or_global_flat_atomic_store(i1 %cond, ptr addrspace(1) %gptr, ptr addrspace(3) %lptr, i32 %val) {
entry:
  %a = addrspacecast ptr addrspace(1) %gptr to ptr
  %b = addrspacecast ptr addrspace(3) %lptr to ptr
  %ptr = select i1 %cond, ptr %a, ptr %b
  store atomic i32 %val, ptr %ptr syncscope("workgroup") unordered, align 4
  ret void
}

; GFX1250: local_or_global_flat_store_no_flat_scratch_init:
; GFX1250-NOT:  flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}} scope:SCOPE_SE
; GFX1250:      flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}}
define amdgpu_kernel void @local_or_global_flat_store_no_flat_scratch_init(i1 %cond, ptr addrspace(1) %gptr, ptr addrspace(3) %lptr, i32 %val) #0 {
entry:
  %a = addrspacecast ptr addrspace(1) %gptr to ptr
  %b = addrspacecast ptr addrspace(3) %lptr to ptr
  %ptr = select i1 %cond, ptr %a, ptr %b
  store i32 %val, ptr %ptr
  ret void
}

; GFX1250: local_or_global_flat_atomic_store_no_flat_scratch_init:
; GFX1250-NOT:  flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}} scope:SCOPE_SE
; GFX1250:      flat_store_b32 v{{.*}}, v{{.*}}, s{{.*}}
define amdgpu_kernel void @local_or_global_flat_atomic_store_no_flat_scratch_init(i1 %cond, ptr addrspace(1) %gptr, ptr addrspace(3) %lptr, i32 %val) #0 {
entry:
  %a = addrspacecast ptr addrspace(1) %gptr to ptr
  %b = addrspacecast ptr addrspace(3) %lptr to ptr
  %ptr = select i1 %cond, ptr %a, ptr %b
  store atomic i32 %val, ptr %ptr syncscope("workgroup") unordered, align 4
  ret void
}

attributes #0 = { "amdgpu-no-flat-scratch-init"="true" }
