# NOTE: Basic next-use distance calculation test
# RUN: llc -mtriple=amdgcn -mcpu=gfx900 -run-pass=amdgpu-next-use -debug-only=amdgpu-next-use %s -o /dev/null 2>&1 | FileCheck %s

---
name:            basic_distances
alignment:       1
tracksRegLiveness: true
registers:
  - { id: 0, class: vgpr_32 }
  - { id: 1, class: vgpr_32 }
  - { id: 2, class: vgpr_32 }
  - { id: 3, class: vgpr_32 }
body: |
  bb.0:
    ; Test basic distance calculation
    ; %0 is used 2 instructions later, then %1 is used immediately, etc.
    %0:vgpr_32 = V_MOV_B32_e32 42, implicit $exec
    %1:vgpr_32 = V_MOV_B32_e32 100, implicit $exec
    %2:vgpr_32 = V_ADD_F32_e32 %1, %1, implicit $exec, implicit $mode
    %3:vgpr_32 = V_ADD_F32_e32 %0, %2, implicit $exec, implicit $mode
    S_ENDPGM 0

# CHECK: === NextUseAnalysis Results for basic_distances ===
# CHECK: --- MBB_0 ---

# First instruction: %0 definition - no incoming register uses
# CHECK: Instr: %0:vgpr_32 = V_MOV_B32_e32 42, implicit $exec
# CHECK-NEXT: Next-use distances:
# CHECK-NEXT: (no register uses)

# Second instruction: %1 definition - %0 will be used in 2 instructions
# CHECK: Instr: %1:vgpr_32 = V_MOV_B32_e32 100, implicit $exec  
# CHECK-NEXT: Next-use distances:
# CHECK-NEXT: %0 -> 2 instructions

# Third instruction: %2 definition using %1 twice - %0 in 1 instruction, %1 immediate use
# CHECK: Instr: %2:vgpr_32 = V_ADD_F32_e32 %1, %1, implicit $exec, implicit $mode
# CHECK-NEXT: Next-use distances:
# CHECK-NEXT: %0 -> 1 instructions
# CHECK-NEXT: %1 -> 0 instructions

# Fourth instruction: %3 definition using %0 and %2 - both immediate use
# CHECK: Instr: %3:vgpr_32 = V_ADD_F32_e32 %0, %2, implicit $exec, implicit $mode
# CHECK-NEXT: Next-use distances:
# CHECK-NEXT: %0 -> 0 instructions
# CHECK-NEXT: %2 -> 0 instructions

# Final instruction: no register uses
# CHECK: Instr: S_ENDPGM 0
# CHECK-NEXT: Next-use distances:
# CHECK-NEXT: (no register uses)

# Block end: no live registers
# CHECK: Block End Distances:
# CHECK-NEXT: (no registers live at block end)

# CHECK: === End NextUseAnalysis Results ===
...
