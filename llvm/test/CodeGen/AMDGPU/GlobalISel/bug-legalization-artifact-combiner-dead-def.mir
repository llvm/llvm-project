# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py
# RUN: llc -mtriple=amdgcn-mesa-mesa3d -mcpu=gfx1010 -O0 -run-pass=legalizer %s -o - | FileCheck %s --check-prefix=GFX10

--- |

  define void @value_finder_bug() { ret void }
  define void @value_finder_bug_before_artifact_combine() { ret void }

  !0 = distinct !DICompileUnit(language: DW_LANG_C99, file: !1, producer: "llvm", isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug, enums: !2)
  !1 = !DIFile(filename: "bug-legalization-artifact-combiner-dead-def", directory: "/tmp")
  !2 = !{}
  !3 = !{i32 2, !"Dwarf Version", i32 4}
  !4 = !{i32 2, !"Debug Info Version", i32 3}
  !5 = distinct !DISubprogram(name: "value_finder_bug_before_artifact_combine_dbg_use", scope: !1, file: !1, line: 1, type: !6, isLocal: false, isDefinition: true, scopeLine: 1, flags: DIFlagPrototyped, isOptimized: false, unit: !0, retainedNodes: !2)
  !6 = !DISubroutineType(types: !2)
  !7 = !DILocalVariable(name: "in", arg: 1, scope: !5, file: !1, line: 1, type: !8)
  !8 = !DIBasicType(name: "int", size: 32, encoding: DW_ATE_signed)
  !9 = !DILocation(line: 1, column: 1, scope: !5)
...

---
name: value_finder_bug
body: |
  bb.0:
    liveins: $vgpr0, $vgpr1, $vgpr2

    ; GFX10-LABEL: name: value_finder_bug
    ; GFX10: liveins: $vgpr0, $vgpr1, $vgpr2
    ; GFX10-NEXT: {{  $}}
    ; GFX10-NEXT: [[COPY:%[0-9]+]]:_(p5) = COPY $vgpr0
    ; GFX10-NEXT: [[COPY1:%[0-9]+]]:_(i32) = COPY $vgpr1
    ; GFX10-NEXT: [[COPY2:%[0-9]+]]:_(i32) = COPY $vgpr2
    ; GFX10-NEXT: [[MV:%[0-9]+]]:_(p4) = G_MERGE_VALUES [[COPY1]](i32), [[COPY2]](i32)
    ; GFX10-NEXT: [[LOAD:%[0-9]+]]:_(<4 x i32>) = G_LOAD [[MV]](p4) :: (load (<4 x i32>), align 4, addrspace 4)
    ; GFX10-NEXT: [[UV:%[0-9]+]]:_(i32), [[UV1:%[0-9]+]]:_(i32), [[UV2:%[0-9]+]]:_(i32), [[UV3:%[0-9]+]]:_(i32) = G_UNMERGE_VALUES [[LOAD]](<4 x i32>)
    ; GFX10-NEXT: [[COPY3:%[0-9]+]]:_(i32) = COPY [[UV3]](i32)
    ; GFX10-NEXT: [[UV4:%[0-9]+]]:_(i32), [[UV5:%[0-9]+]]:_(i32), [[UV6:%[0-9]+]]:_(i32), [[UV7:%[0-9]+]]:_(i32) = G_UNMERGE_VALUES [[LOAD]](<4 x i32>)
    ; GFX10-NEXT: [[COPY4:%[0-9]+]]:_(i32) = COPY [[UV6]](i32)
    ; GFX10-NEXT: G_STORE [[COPY4]](i32), [[COPY]](p5) :: (store (i32), align 8, addrspace 5)
    ; GFX10-NEXT: [[C:%[0-9]+]]:_(i32) = G_CONSTANT i32 4
    ; GFX10-NEXT: [[PTR_ADD:%[0-9]+]]:_(p5) = G_PTR_ADD [[COPY]], [[C]](i32)
    ; GFX10-NEXT: G_STORE [[COPY3]](i32), [[PTR_ADD]](p5) :: (store (i32) into unknown-address + 4, addrspace 5)
    %0:_(p5) = COPY $vgpr0
    %1:_(i32) = COPY $vgpr1
    %2:_(i32) = COPY $vgpr2
    %3:_(p4) = G_MERGE_VALUES %1(i32), %2(i32)
    %4:_(<4 x i32>) = G_IMPLICIT_DEF
    %5:_(<4 x i32>) = G_LOAD %3(p4) :: (load (<4 x i32>), align 4, addrspace 4)
    %6:_(i32) = G_CONSTANT i32 3
    %7:_(i32) = G_EXTRACT_VECTOR_ELT %5(<4 x i32>), %6(i32)
    %8:_(<2 x i32>) = G_SHUFFLE_VECTOR %5(<4 x i32>), %4, shufflemask(2, undef)
    %9:_(i32) = G_CONSTANT i32 1
    %10:_(<2 x i32>) = G_INSERT_VECTOR_ELT %8, %7(i32), %9(i32)
    G_STORE %10(<2 x i32>), %0(p5) :: (store (<2 x i32>), addrspace 5)
...

---
name: value_finder_bug_before_artifact_combine
body: |
  bb.0:
    liveins: $vgpr0, $vgpr1, $vgpr2

    ; GFX10-LABEL: name: value_finder_bug_before_artifact_combine
    ; GFX10: liveins: $vgpr0, $vgpr1, $vgpr2
    ; GFX10-NEXT: {{  $}}
    ; GFX10-NEXT: [[COPY:%[0-9]+]]:_(p5) = COPY $vgpr0
    ; GFX10-NEXT: [[COPY1:%[0-9]+]]:_(i32) = COPY $vgpr1
    ; GFX10-NEXT: [[COPY2:%[0-9]+]]:_(i32) = COPY $vgpr2
    ; GFX10-NEXT: [[MV:%[0-9]+]]:_(p4) = G_MERGE_VALUES [[COPY1]](i32), [[COPY2]](i32)
    ; GFX10-NEXT: [[LOAD:%[0-9]+]]:_(<4 x i32>) = G_LOAD [[MV]](p4) :: (load (<4 x i32>), align 4, addrspace 4)
    ; GFX10-NEXT: [[UV:%[0-9]+]]:_(i32), [[UV1:%[0-9]+]]:_(i32), [[UV2:%[0-9]+]]:_(i32), [[UV3:%[0-9]+]]:_(i32) = G_UNMERGE_VALUES [[LOAD]](<4 x i32>)
    ; GFX10-NEXT: [[COPY3:%[0-9]+]]:_(i32) = COPY [[UV3]](i32)
    ; GFX10-NEXT: [[UV4:%[0-9]+]]:_(i32), [[UV5:%[0-9]+]]:_(i32), [[UV6:%[0-9]+]]:_(i32), [[UV7:%[0-9]+]]:_(i32) = G_UNMERGE_VALUES [[LOAD]](<4 x i32>)
    ; GFX10-NEXT: [[COPY4:%[0-9]+]]:_(i32) = COPY [[UV6]](i32)
    ; GFX10-NEXT: G_STORE [[COPY4]](i32), [[COPY]](p5) :: (store (i32), align 8, addrspace 5)
    ; GFX10-NEXT: [[C:%[0-9]+]]:_(i32) = G_CONSTANT i32 4
    ; GFX10-NEXT: [[PTR_ADD:%[0-9]+]]:_(p5) = G_PTR_ADD [[COPY]], [[C]](i32)
    ; GFX10-NEXT: G_STORE [[COPY3]](i32), [[PTR_ADD]](p5) :: (store (i32) into unknown-address + 4, addrspace 5)
    %0:_(p5) = COPY $vgpr0
    %1:_(i32) = COPY $vgpr1
    %2:_(i32) = COPY $vgpr2
    %3:_(p4) = G_MERGE_VALUES %1(i32), %2(i32)
    %4:_(<4 x i32>) = G_LOAD %3(p4) :: (load (<4 x i32>), align 4, addrspace 4)
    %5:_(i32) = G_EXTRACT %4(<4 x i32>), 96
    %6:_(i32) = G_EXTRACT %4(<4 x i32>), 64
    %7:_(i32) = G_IMPLICIT_DEF
    %8:_(<2 x i32>) = G_BUILD_VECTOR %6(i32), %7(i32)
    %9:_(<2 x i32>) = G_INSERT %8, %5(i32), 32
    %deaf_def:_(i32), %11:_(i32) = G_UNMERGE_VALUES %9(<2 x i32>)
    G_STORE %6(i32), %0(p5) :: (store (i32), align 8, addrspace 5)
    %12:_(i32) = G_CONSTANT i32 4
    %13:_(p5) = G_PTR_ADD %0, %12(i32)
    G_STORE %11(i32), %13(p5) :: (store (i32) into unknown-address + 4, addrspace 5)

...
