# RUN: llc -march=amdgcn -mcpu=gfx1200 -verify-machineinstrs -amdgpu-software-hazard-mode -run-pass si-insert-waitcnts %s -o - | FileCheck -check-prefix=GCN %s

---
# GCN-LABEL: name: raw_exp
# GCN:       bb.0
# GCN:       S_WAITCNT_DEPCTR 4095
# GCN-NEXT   EXP_DONE

name:            raw_exp
body:             |
  bb.0:
    $vgpr0 = V_MOV_B32_e32 1082130432, implicit $exec
    $vgpr1 = V_MOV_B32_e32 1073741824, implicit $exec
    $vgpr2 = V_MOV_B32_e32 1065353216, implicit $exec
    $vgpr3 = V_MOV_B32_e32 1056964608, implicit $exec
    EXP_DONE 15, $vgpr3, $vgpr2, $vgpr1, $vgpr0, 0, 0, 1, implicit $exec
    S_ENDPGM 0

...

---
# GCN-LABEL: name: raw_vmem
# GCN:       bb.0
# GCN:       $vgpr0 = nofpexcept V_ADD_F32_e32
# GCN-NEXT:  S_WAITCNT_DEPCTR 4095
# GCN-NEXT:  IMAGE_STORE_V4_V1_gfx12

name:            raw_vmem
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0

    $vgpr4 = V_MOV_B32_e32 $vgpr0, implicit $exec, implicit $exec
    $vgpr0_vgpr1_vgpr2_vgpr3 = IMAGE_LOAD_V4_V1_gfx12 $vgpr0, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    $vgpr3 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr3, implicit $mode, implicit $exec
    $vgpr2 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr2, implicit $mode, implicit $exec
    $vgpr1 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr1, implicit $mode, implicit $exec
    $vgpr0 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr0, implicit $mode, implicit $exec
    IMAGE_STORE_V4_V1_gfx12 $vgpr0_vgpr1_vgpr2_vgpr3, $vgpr4, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable store (s128), addrspace 8)
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: war_lds
# GCN:       bb.0
# GCN:       IMAGE_LOAD_V4_V1
# GCN-NEXT:  S_WAITCNT_DEPCTR 65507
# GCN-NEXT   DS_READ_B128

name:            war_lds
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0, $vgpr1

    $vgpr5_vgpr6_vgpr7_vgpr8 = IMAGE_LOAD_V4_V1_gfx12 $vgpr0, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    $vgpr0_vgpr1_vgpr2_vgpr3 = DS_READ_B128_gfx9 $vgpr1, 0, 0, implicit $exec :: (load (s128), addrspace 3)
    $vgpr0 = nofpexcept V_ADD_F32_e32 $vgpr5, $vgpr0, implicit $mode, implicit $exec
    $vgpr1 = nofpexcept V_ADD_F32_e32 $vgpr6, $vgpr1, implicit $mode, implicit $exec
    $vgpr2 = nofpexcept V_ADD_F32_e32 $vgpr7, $vgpr2, implicit $mode, implicit $exec
    $vgpr3 = nofpexcept V_ADD_F32_e32 $vgpr8, $vgpr3, implicit $mode, implicit $exec
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: war_tex
# GCN:       bb.0
# GCN:       DS_WRITE_B128
# GCN-NEXT:  S_WAITCNT_DEPCTR 65507
# GCN-NEXT:  IMAGE_LOAD_V4_V1

name:            war_tex
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0, $vgpr1, $vgpr2

    $vgpr4 = V_MOV_B32_e32 $vgpr0, implicit $exec, implicit $exec
    $vgpr5 = V_MOV_B32_e32 $vgpr2, implicit $exec, implicit $exec
    $vgpr0_vgpr1_vgpr2_vgpr3 = DS_READ_B128_gfx9 $vgpr1, 0, 0, implicit $exec :: (load (s128), addrspace 3)
    DS_WRITE_B128_gfx9 $vgpr5, $vgpr0_vgpr1_vgpr2_vgpr3, 0, 0, implicit $exec :: (store (s128), addrspace 3)
    $vgpr0_vgpr1_vgpr2_vgpr3 = IMAGE_LOAD_V4_V1_gfx12 $vgpr4, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: war_valu
# GCN:       bb.0
# GCN:       S_WAITCNT_DEPCTR 65507
# GCN-NEXT:  V_MOV_B32_e32

name:            war_valu
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0

    $vgpr5_vgpr6_vgpr7_vgpr8 = IMAGE_LOAD_V4_V1_gfx12 $vgpr0, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    $vgpr4 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr5, implicit $mode, implicit $exec
    $vgpr1 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr6, implicit $mode, implicit $exec
    $vgpr2 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr7, implicit $mode, implicit $exec
    $vgpr3 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr8, implicit $mode, implicit $exec
    IMAGE_STORE_V4_V1_gfx12 $vgpr5_vgpr6_vgpr7_vgpr8, $vgpr0, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable store (s128), addrspace 8)
    $vgpr0 = V_MOV_B32_e32 $vgpr4, implicit $exec, implicit $exec
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: war_vmem
# GCN:       bb.0
# GCN:       V_MOV_B32_e32
# GCN-NEXT:  S_WAITCNT_DEPCTR 4095
# GCN-NEXT:  IMAGE_LOAD_V4_V1_gfx12
# GCN:       $vgpr0 = nofpexcept V_ADD_F32_e32
# GCN-NEXT:  S_WAITCNT_DEPCTR 4095
# GCN-NEXT:  IMAGE_STORE_V4_V1_gfx12

name:            war_vmem
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0

    $vgpr4 = V_MOV_B32_e32 $vgpr0, implicit $exec, implicit $exec
    $vgpr0_vgpr1_vgpr2_vgpr3 = IMAGE_LOAD_V4_V1_gfx12 $vgpr4, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    $vgpr3 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr3, implicit $mode, implicit $exec
    $vgpr2 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr2, implicit $mode, implicit $exec
    $vgpr1 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr1, implicit $mode, implicit $exec
    $vgpr0 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr0, implicit $mode, implicit $exec
    IMAGE_STORE_V4_V1_gfx12 $vgpr0_vgpr1_vgpr2_vgpr3, $vgpr4, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable store (s128), addrspace 8)
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: waw_vmem
# GCN:       bb.0
# GCN:       V_MOV_B32_e32
# GCN-NEXT:  S_WAITCNT_DEPCTR 4095
# GCN-NEXT:  IMAGE_LOAD_V4_V1_gfx12

name:            waw_vmem
body:             |
  bb.0:
    liveins: $sgpr0, $sgpr1, $sgpr2, $sgpr3, $sgpr4, $sgpr5, $sgpr6, $sgpr7, $vgpr0

    $vgpr4 = V_MOV_B32_e32 $vgpr0, implicit $exec, implicit $exec
    $vgpr4_vgpr5_vgpr6_vgpr7 = IMAGE_LOAD_V4_V1_gfx12 $vgpr0, $sgpr0_sgpr1_sgpr2_sgpr3_sgpr4_sgpr5_sgpr6_sgpr7, 15, 0, 0, 0, 0, 0, 0, implicit $exec :: (dereferenceable load (s128), addrspace 8)
    $vgpr3 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr7, implicit $mode, implicit $exec
    $vgpr2 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr6, implicit $mode, implicit $exec
    $vgpr1 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr5, implicit $mode, implicit $exec
    $vgpr0 = nofpexcept V_ADD_F32_e32 1065353216, $vgpr4, implicit $mode, implicit $exec
    SI_RETURN_TO_EPILOG $vgpr0, $vgpr1, $vgpr2, $vgpr3

...

---
# GCN-LABEL: name: raw_valu_scratch
# GCN: S_WAIT_LOADCNT_DSCNT 0
# GCN-NEXT: S_WAIT_EXPCNT 0
# GCN-NEXT: S_WAIT_STORECNT 0
# GCN-NEXT: S_WAIT_SAMPLECNT 0
# GCN-NEXT: S_WAIT_BVHCNT 0
# GCN-NEXT: S_WAIT_KMCNT 0
# GCN-NEXT: S_WAITCNT_DEPCTR 4095
# GCN-NEXT: $vgpr1 = V_MOV_B32_e32 $vgpr0, implicit $exec
# GCN-NEXT: $vgpr2 = V_MOV_B32_e32 $vgpr0, implicit $exec
# GCN-NEXT: $vgpr3 = V_MOV_B32_e32 $vgpr1, implicit $exec
# GCN-NEXT: S_WAITCNT_DEPCTR 8191
# GCN-NEXT: $vgpr4 = SCRATCH_LOAD_UBYTE_SVS $vgpr2, $sgpr0, 0, 0, implicit $exec, implicit $flat_scr

name: raw_valu_scratch
body: |
  bb.0:
    $vgpr1 = V_MOV_B32_e32 $vgpr0, implicit $exec
    $vgpr2 = V_MOV_B32_e32 $vgpr0, implicit $exec
    $vgpr3 = V_MOV_B32_e32 $vgpr1, implicit $exec
    $vgpr4 = SCRATCH_LOAD_UBYTE_SVS $vgpr2, $sgpr0, 0, 0, implicit $exec, implicit $flat_scr
...

---
# This pre-existing S_WAITCNT_DEPCTR should not be updated.

# GCN-LABEL: name: valu_depctr_valu
# GCN: $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
# GCN: S_WAITCNT_DEPCTR 4071
# GCN: $vgpr1 = V_MOV_B32_e32 $vgpr0, implicit $exec

name: valu_depctr_valu
body: |
  bb.0:
    $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
    S_WAITCNT_DEPCTR 8167
    $vgpr1 = V_MOV_B32_e32 $vgpr0, implicit $exec
...
