; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc -mtriple=amdgcn -mcpu=gfx950 < %s | FileCheck %s

; This is a regression test for a bug where SIFixSGPRCopies would incorrectly
; keep the value as VGPR when it should be converted to SGPR for inline asm.

define <4 x float> @test_sgpr_constraint_bug(ptr addrspace(5) %buf_desc_ptr) {
; CHECK-LABEL: test_sgpr_constraint_bug:
; CHECK:       ; %bb.0:
; CHECK-NEXT:    s_waitcnt vmcnt(0) expcnt(0) lgkmcnt(0)
; CHECK-NEXT:    scratch_load_dwordx4 v[4:7], v0, off
; CHECK-NEXT:    v_mov_b32_e32 v0, 0
; CHECK-NEXT:    v_mov_b32_e32 v1, v0
; CHECK-NEXT:    v_mov_b32_e32 v2, v0
; CHECK-NEXT:    v_mov_b32_e32 v3, v0
; CHECK-NEXT:    s_mov_b64 s[4:5], exec
; CHECK-NEXT:    v_mov_b32_e32 v8, 1
; CHECK-NEXT:    s_waitcnt vmcnt(0)
; CHECK-NEXT:    v_readfirstlane_b32 s0, v4
; CHECK-NEXT:    v_readfirstlane_b32 s1, v5
; CHECK-NEXT:    v_readfirstlane_b32 s2, v6
; CHECK-NEXT:    v_readfirstlane_b32 s3, v7
; CHECK-NEXT:    ;;#ASMSTART
; CHECK-NEXT:    v_cmpx_le_u32 exec, 1, v8
; CHECK-NEXT:  buffer_load_dwordx4 v[0:3], v0, s[0:3], 0 offen offset:0
; CHECK-NEXT:  s_mov_b64 exec s[4:5]
; CHECK-NEXT:    ;;#ASMEND
; CHECK-NEXT:    s_setpc_b64 s[30:31]
  %rsrc = load <4 x i32>, ptr addrspace(5) %buf_desc_ptr, align 16

  %exec = call i64 @llvm.amdgcn.ballot.i64(i1 true)

  %result = call <4 x float> asm sideeffect
    "v_cmpx_le_u32 exec, 1, $4\0Abuffer_load_dwordx4 $0, $1, $2, 0 offen offset:$3\0As_mov_b64 exec $5",
    "=v,v,s,n,v,s,0,~{memory}"
    (i32 0, <4 x i32> %rsrc, i32 0, i32 1, i64 %exec, <4 x float> zeroinitializer)

  ret <4 x float> %result
}
