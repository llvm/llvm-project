# RUN: llc -mtriple=amdgcn -verify-machineinstrs=1 -start-before=postrapseudos -stop-after=postrapseudos -O0 -o - %s | FileCheck -check-prefix=GCN %s

# This testcase shows the necessity of removing the killed flag from the $sgpr source when
# creating a V_WRITELANE_B32.  The SI_SPILL_S32_TO_VGPR will be converted in postrapseudos from:
#
#   $X = SI_SPILL_S32_TO_VGPR killed $sgpr0, 6, $X, implicit-def $sgpr0_sgpr1
#
# to:
#
#   $X = V_WRITELANE_B32 $sgpr0, 6, $X(tied-def 0)
#
# The killed flag must be removed since $sgpr0 is no longer an implicit-def and
# will be subsequently used in the S_MOV_B64.

# GCN-LABEL: name: non_uniform_loop
---
name:            non_uniform_loop
tracksRegLiveness: true
machineFunctionInfo:
  wwmReservedRegs:
    - '$vgpr63'
body:             |
  bb.0:
    successors: %bb.1(0x80000000)
    liveins: $vgpr0
  
    S_BRANCH %bb.1
  
  bb.1:
    successors: %bb.2(0x40000000), %bb.3(0x40000000)
  
    $sgpr0 = SI_RESTORE_S32_FROM_VGPR $vgpr63, 2, implicit-def $sgpr0_sgpr1
    $vgpr63 = SI_SPILL_S32_TO_VGPR killed $sgpr0, 6, $vgpr63, implicit-def $sgpr0_sgpr1
    $exec = S_MOV_B64_term killed renamable $sgpr0_sgpr1
    S_CBRANCH_EXECZ %bb.3, implicit $exec
    S_BRANCH %bb.2
  
  bb.2:
    successors: %bb.3(0x80000000)
  
    S_BRANCH %bb.3
  
  bb.3:
    successors: %bb.4(0x40000000), %bb.1(0x40000000)
  
    $exec = S_ANDN2_B64_term $exec, killed undef renamable $sgpr0_sgpr1, implicit-def dead $scc
    S_CBRANCH_EXECNZ %bb.1, implicit $exec
    S_BRANCH %bb.4
  
  bb.4:
    successors: %bb.5(0x80000000)
  
    $exec = S_OR_B64_term $exec, killed undef renamable $sgpr0_sgpr1, implicit-def dead $scc
  
  bb.5:
    S_ENDPGM 0
...
