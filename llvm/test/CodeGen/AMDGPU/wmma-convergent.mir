# machine-sink must not sink WMMA* instructions.
# Ensure that WMMA instructions are marked as convergent to prevent
# machine-sink from sinking them.

# RUN: llc -mtriple=amdgcn-amd-amdhsa -mcpu=gfx12-generic   -run-pass=machine-sink -filetype=null -mattr=+wavefrontsize64 %s -stats 2>&1 | \
# RUN:   not grep "Number of machine instructions sunk"

---
name:            wmma_test_V_WMMA_F32_16X16X16_F16_twoaddr_w32
tracksRegLiveness: true
body:             |
  bb.0:
    %vsrc:vreg_256 = IMPLICIT_DEF
    %ssrc:sreg_64 = IMPLICIT_DEF
    early-clobber %vdst:vreg_256 = V_WMMA_F32_16X16X16_F16_twoaddr_w32 8, %vsrc, 8, %vsrc, 8, %vsrc, 0, 0, implicit $exec    
    %sdst:sreg_64 = SI_IF %ssrc:sreg_64, %bb.2, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_BRANCH %bb.1
  bb.1:
    %vcopy:vgpr_32 = COPY %vdst.sub0
  bb.2:
    SI_END_CF %sdst:sreg_64, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_ENDPGM 0
...

---
name:            wmma_test_V_WMMA_I32_16X16X16_IU8_twoaddr_w32
tracksRegLiveness: true
body:             |
  bb.0:
    %vsrc:vreg_128 = IMPLICIT_DEF
    %vsrc2:vreg_256 = IMPLICIT_DEF    
    %ssrc:sreg_64 = IMPLICIT_DEF
    early-clobber %vdst:vreg_256 = V_WMMA_I32_16X16X16_IU8_twoaddr_w32 8, %vsrc, 8, %vsrc, 8, %vsrc2, 0, 0, 0, implicit $exec
    %sdst:sreg_64 = SI_IF %ssrc:sreg_64, %bb.2, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_BRANCH %bb.1
  bb.1:
    %vcopy:vgpr_32 = COPY %vdst.sub0
  bb.2:
    SI_END_CF %sdst:sreg_64, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_ENDPGM 0
...

---
name:            wmma_test_V_WMMA_BF16_16X16X16_BF16_threeaddr_w32
tracksRegLiveness: true
body:             |
  bb.0:
    %vsrc:vreg_256 = IMPLICIT_DEF
    %ssrc:sreg_64 = IMPLICIT_DEF
    early-clobber %vdst:vreg_256 = V_WMMA_BF16_16X16X16_BF16_threeaddr_w32 8, %vsrc, 8, %vsrc, 8, %vsrc, 0, 0, 0, 0, implicit $exec
    %sdst:sreg_64 = SI_IF %ssrc:sreg_64, %bb.2, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_BRANCH %bb.1
  bb.1:
    %vcopy:vgpr_32 = COPY %vdst.sub0
  bb.2:
    SI_END_CF %sdst:sreg_64, implicit-def dead $exec, implicit-def dead $scc, implicit $exec
    S_ENDPGM 0
...
