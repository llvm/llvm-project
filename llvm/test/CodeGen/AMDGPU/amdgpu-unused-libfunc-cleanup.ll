; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 2
; RUN: opt -S -passes=amdgpu-unused-libfunc-cleanup -mtriple=amdgcn-- < %s | FileCheck %s

; Test that AMDGPUUnusedLibFuncCleanupPass removes __ocml_sincos_f{32,64}
; from @llvm.compiler.used and erases them when they have no call-site users.
; These functions may have been injected before device-library linking to
; enable the sin/cos → sincos optimisation; this pass cleans up those that
; went unused.

declare float @__ocml_sincos_f32(float, ptr addrspace(5) writeonly)
declare double @__ocml_sincos_f64(double, ptr addrspace(5) writeonly)

; A function that is NOT sincos — should survive the cleanup.
declare void @other_func()

@llvm.compiler.used = appending global [3 x ptr] [
  ptr @__ocml_sincos_f32,
  ptr @__ocml_sincos_f64,
  ptr @other_func
], section "llvm.metadata"

; Neither sincos function is called — both should be removed.
; @llvm.compiler.used should only contain @other_func afterwards.

; CHECK: @llvm.compiler.used = appending {{.*}}global [1 x ptr] [ptr @other_func], section "llvm.metadata"
; CHECK-NOT: @__ocml_sincos_f32
; CHECK-NOT: @__ocml_sincos_f64

define void @kernel() {
  call void @other_func()
  ret void
}
