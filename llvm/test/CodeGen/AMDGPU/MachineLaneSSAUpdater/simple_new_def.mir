# RUN: llc -mtriple=amdgcn-amd-amdhsa -mcpu=gfx900 -run-pass=test-machine-lane-ssa-updater -verify-machineinstrs %s -o - | FileCheck %s

# Test simple new definition SSA reconstruction
# - Original vreg %0 defined in bb.0
# - New definition inserted in bb.1
# - Uses in bb.2 should be rewritten to new vreg
# - PHI should be inserted at join points if control flow diverges

--- |
  define amdgpu_kernel void @simple_new_def() {
    ret void
  }
...
---
name: simple_new_def
tracksRegLiveness: true
body: |
  bb.0:
    liveins: $sgpr0
    ; CHECK-LABEL: bb.0:
    ; CHECK: %0:vgpr_32 = IMPLICIT_DEF
    %0:vgpr_32 = IMPLICIT_DEF
    
    ; Original use - should still reference %0
    ; CHECK: S_NOP 0, implicit %0
    S_NOP 0, implicit %0
    
  bb.1:
    ; CHECK-LABEL: bb.1:
    ; New definition will be inserted here by test pass
    ; CHECK: %[[NEWREG:[0-9]+]]:vgpr_32 = V_MOV_B32_e32 42
    ; The test pass will insert: %1:vgpr_32 = V_MOV_B32_e32 42
    ; and call addDefAndRepairNewDef
    
  bb.2:
    ; CHECK-LABEL: bb.2:
    ; This use should be rewritten to new vreg
    ; CHECK: S_NOP 0, implicit %[[NEWREG]]
    S_NOP 0, implicit %0
    
    ; Multiple uses should all be rewritten
    ; CHECK: S_NOP 1, implicit %[[NEWREG]]
    S_NOP 1, implicit %0
    
    S_ENDPGM 0
...

