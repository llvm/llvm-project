# RUN: llc -mtriple=amdgcn -verify-machineinstrs --run-pass=postrapseudos -o - %s | FileCheck -check-prefix=GCN %s

# This test shows the necessity of adding an undef flag to the $sgpr source when
# creating a V_WRITELANE_B32.
#
# The prologepilog creates:
#
#   $exec = S_MOV_B64 killed $sgpr4_sgpr5
#
# but $sgpr5 will be spilled by a:
#
#   $vgpr1 = SI_SPILL_S32_TO_VGPR $sgpr5, 1, killed $vgpr1(tied-def 0), implicit $sgpr4_sgpr5
#
# The SI_SPILL_S32_TO_VGPR will be converted in postrapseudos to:
#
#   $vgpr1 = V_WRITELANE_B32 undef $sgpr5, 1, killed $vgpr1(tied-def 0)
#
# The undef flag is necessary to satisfy the MachineVerifier since $sgpr5 is used after a kill.
# This testcase was derived from function bitcast_v32i16_to_v64i8_scalar in amdgcn.bitcast.512bit.ll.

# GCN-LABEL: name: bitcast_v32i16_to_v64i8_scalar
---
name:            bitcast_v32i16_to_v64i8_scalar
tracksRegLiveness: true
machineFunctionInfo:
  scratchRSrcReg:  '$sgpr0_sgpr1_sgpr2_sgpr3'
  stackPtrOffsetReg: '$sgpr32'
  wwmReservedRegs:
    - '$vgpr62'
body:             |
  bb.0:
    $sgpr4_sgpr5 = S_XOR_SAVEEXEC_B64 -1, implicit-def $exec, implicit-def dead $scc, implicit $exec
    $exec = S_MOV_B64 killed $sgpr4_sgpr5
    renamable $sgpr4 = IMPLICIT_DEF
    $vgpr62 = SI_SPILL_S32_TO_VGPR $sgpr5, 1, killed $vgpr62, implicit $sgpr4_sgpr5
    SI_RETURN
...

