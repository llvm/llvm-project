# NOTE: Assertions have been autogenerated by utils/update_mir_test_checks.py UTC_ARGS: --version 5
# RUN: llc -march=amdgcn -mcpu=gfx1300 -verify-machineinstrs -run-pass=bundle-indexed-load-store -o - %s | FileCheck -check-prefixes=GCN %s
# RUN: llc -march=amdgcn -mcpu=gfx1300 -verify-machineinstrs -start-before=bundle-indexed-load-store -stop-after=amdgpu-idx-reg-alloc -o - %s | FileCheck -check-prefixes=ALLOC %s
# RUN: llc -march=amdgcn -mcpu=gfx1300 -verify-machineinstrs -start-before=bundle-indexed-load-store -stop-after=amdgpu-lower-vgpr-encoding -o - %s | FileCheck -check-prefixes=LOWERED %s

---
name:            same-bb-load-trivial
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-trivial
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def %2, implicit [[S_LSHL_B32_]], implicit $exec {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-trivial
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def %2, implicit $idx1, implicit $exec {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-trivial
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 4
    ; LOWERED-NEXT: renamable $vgpr0 = V_MAX_U32_e64 12345, undef $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
...

---
name:            same-bb-store-trivial
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-store-trivial
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[COPY:%[0-9]+]]:vgpr_32 = COPY [[S_LSHL_B32_]]
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[COPY]], implicit $exec, implicit [[S_LSHL_B32_]] {
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[COPY]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-store-trivial
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit $idx1, implicit $exec, implicit [[S_LSHL_B32_]] {
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-store-trivial
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, killed $sgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = COPY %0:sreg_32_xexec_hi
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    V_STORE_IDX %2:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-store-out-of-order
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-store-out-of-order
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[COPY:%[0-9]+]]:vgpr_32 = COPY [[S_LSHL_B32_]]
    ; GCN-NEXT: [[S_ADD_I32_:%[0-9]+]]:sreg_32_xexec_hi = S_ADD_I32 [[S_LSHL_B32_]], 429496640, implicit-def dead $scc
    ; GCN-NEXT: [[S_ADD_I32_1:%[0-9]+]]:sreg_32_xexec_hi = S_ADD_I32 [[S_LSHL_B32_]], 5, implicit-def dead $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[COPY]], implicit $exec, implicit [[S_ADD_I32_]] {
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[COPY]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_ADD_I32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-store-out-of-order
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: [[S_ADD_I32_:%[0-9]+]]:sreg_32_xexec_hi = S_ADD_I32 [[S_LSHL_B32_]], 429496640, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_ADD_I32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[S_LSHL_B32_]], implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-store-out-of-order
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_ADD_I32 renamable $sgpr0, 429496640, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, killed $sgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = COPY %0:sreg_32_xexec_hi
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    %4:sreg_32_xexec_hi = S_ADD_I32 %0, 429496640, implicit-def dead $scc
    %5:sreg_32_xexec_hi = S_ADD_I32 %0, 5, implicit-def dead $scc
    V_STORE_IDX %2:vgpr_32, %4, 0, implicit $exec :: (store (s32), addrspace 10)
...

# Bundling would introduce impossible cycles in the dataflow.
---
name:            same-bb-store-cannot-bundle
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-store-cannot-bundle
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[COPY:%[0-9]+]]:vgpr_32 = COPY [[S_LSHL_B32_]]
    ; GCN-NEXT: [[V_ADD_CO_U32_e64_:%[0-9]+]]:vgpr_32, [[V_ADD_CO_U32_e64_1:%[0-9]+]]:sreg_32_xm0_xexec = V_ADD_CO_U32_e64 12345, [[COPY]], 0, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[V_ADD_CO_U32_e64_]], [[V_ADD_CO_U32_e64_1]], 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: same-bb-store-cannot-bundle
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: [[V_ADD_CO_U32_e64_:%[0-9]+]]:vgpr_32, [[V_ADD_CO_U32_e64_1:%[0-9]+]]:sreg_32_xm0_xexec = V_ADD_CO_U32_e64 12345, [[S_LSHL_B32_]], 0, implicit $exec
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[V_ADD_CO_U32_e64_1]]
    ; ALLOC-NEXT: V_STORE_IDX [[V_ADD_CO_U32_e64_]], $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: same-bb-store-cannot-bundle
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $vgpr0, renamable $sgpr0 = V_ADD_CO_U32_e64 12345, killed $sgpr0, 0, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = COPY %0:sreg_32_xexec_hi
    %2:vgpr_32, %3:sreg_32_xm0_xexec = V_ADD_CO_U32_e64 12345, %1, 0, implicit $exec
    V_STORE_IDX %2:vgpr_32, %3, 0, implicit $exec :: (store (s32), addrspace 10)
...

# TODO-GFX13 Support multi-def instructions.
---
name:            same-bb-store-carryout
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-store-carryout
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[COPY:%[0-9]+]]:vgpr_32 = COPY [[S_LSHL_B32_]]
    ; GCN-NEXT: [[V_ADD_CO_U32_e64_:%[0-9]+]]:vgpr_32, [[V_ADD_CO_U32_e64_1:%[0-9]+]]:sreg_32_xm0_xexec = V_ADD_CO_U32_e64 12345, [[COPY]], 0, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[V_ADD_CO_U32_e64_]], [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: same-bb-store-carryout
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: %2:vgpr_32, $sgpr_null = V_ADD_CO_U32_e64 12345, [[S_LSHL_B32_]], 0, implicit $exec
    ; ALLOC-NEXT: V_STORE_IDX %2, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: same-bb-store-carryout
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $vgpr0, $sgpr_null = V_ADD_CO_U32_e64 12345, $sgpr0, 0, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = COPY %0:sreg_32_xexec_hi
    %2:vgpr_32, %3:sreg_32_xm0_xexec = V_ADD_CO_U32_e64 12345, %1, 0, implicit $exec
    V_STORE_IDX %2:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-load-store-trivial
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-trivial
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHL_B32_]], implicit $exec {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-trivial
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx1, implicit $exec {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-trivial
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 68
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, undef $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    V_STORE_IDX %2:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

---

name:            same-bb-load-store-fmac
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-fmac
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[DEF:%[0-9]+]]:vgpr_32 = IMPLICIT_DEF
    ; GCN-NEXT: [[V_FMAC_F32_e64_:%[0-9]+]]:vgpr_32 = V_FMAC_F32_e64 0, 12345, 0, [[V_LOAD_IDX]], 0, [[DEF]], 0, 0, implicit $mode, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[V_FMAC_F32_e64_]], [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-fmac
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[DEF:%[0-9]+]]:vgpr_32 = IMPLICIT_DEF
    ; ALLOC-NEXT: [[V_FMAC_F32_e32_:%[0-9]+]]:vgpr_32 = V_FMAC_F32_e32 12345, [[V_LOAD_IDX]], [[DEF]], implicit $mode, implicit $exec
    ; ALLOC-NEXT: V_STORE_IDX [[V_FMAC_F32_e32_]], $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-fmac
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr0, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr0 = V_FMAC_F32_e32 12345, killed $vgpr0, undef $vgpr0, implicit $mode, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = IMPLICIT_DEF
    %3:vgpr_32 = V_FMAC_F32_e64 0, 12345, 0, %1, 0, %2, 0, 0, implicit $mode, implicit $exec
    V_STORE_IDX %3:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-load-store-different-idx
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-different-idx
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHL_B32_]], implicit $exec, implicit [[S_LSHR_B32_]] {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-different-idx
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-different-idx
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 72
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, undef $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %3:vgpr_32 = V_MAX_U32_e64 12345, %2, implicit $exec
    V_STORE_IDX %3:vgpr_32, %1, 0, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-load-store-different-idx-out-of-order
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-different-idx-out-of-order
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]] {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHR_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-different-idx-out-of-order
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-different-idx-out-of-order
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 72
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, undef $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:vgpr_32 = V_LOAD_IDX %1, 0, implicit $exec :: (load (s32), addrspace 10)
    %3:vgpr_32 = V_MAX_U32_e64 12345, %2, implicit $exec
    %4:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %3:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-multi-use-coremi
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-multi-use-coremi
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def %2, implicit [[S_LSHL_B32_]], implicit $exec {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; GCN-NEXT: }
    ; GCN-NEXT: [[V_MIN_U32_e64_:%[0-9]+]]:vgpr_32 = V_MIN_U32_e64 12345, [[V_MAX_U32_e64_]], implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[V_MAX_U32_e64_]], [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: same-bb-multi-use-coremi
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def %2, implicit $idx1, implicit $exec {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, internal $stg_srca, implicit $exec
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: V_STORE_IDX [[V_MAX_U32_e64_]], $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: same-bb-multi-use-coremi
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 4
    ; LOWERED-NEXT: renamable $vgpr0 = V_MAX_U32_e64 12345, undef $vgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    %3:vgpr_32 = V_MIN_U32_e64 12345, %2, implicit $exec
    V_STORE_IDX %2:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...

# TODO-GFX13 Should be able to duplicate load and bundle
---
name:            same-bb-multi-use-load-coremi
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-multi-use-load-coremi
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT: [[V_MIN_U32_e64_:%[0-9]+]]:vgpr_32 = V_MIN_U32_e64 12345, [[V_MAX_U32_e64_]], implicit $exec
    ; GCN-NEXT: [[S_MOV_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 5
    ; GCN-NEXT: V_STORE_IDX [[V_MAX_U32_e64_]], [[S_MOV_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX]], implicit $exec, implicit [[S_LSHL_B32_]] {
    ; GCN-NEXT:   $stg_dsta = V_MIN_U32_e64 12345, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 16, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-multi-use-load-coremi
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_MAX_U32_e32_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e32 12345, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 0
    ; ALLOC-NEXT: V_STORE_IDX [[V_MAX_U32_e32_]], $idx2, 5, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX]], implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = V_MIN_U32_e64 12345, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 16, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-multi-use-load-coremi
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr0, implicit $exec
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 0
    ; LOWERED-NEXT: renamable $vgpr1 = V_MAX_U32_e32 12345, $vgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 128
    ; LOWERED-NEXT: $vgpr5 = V_MOV_B32_e32 $vgpr1, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: undef $vgpr16 = V_MIN_U32_e64 12345, killed $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    %3:vgpr_32 = V_MIN_U32_e64 12345, %1, implicit $exec
    %4:vgpr_32 = V_MIN_U32_e64 12345, %2, implicit $exec
    %5:sreg_32_xexec_hi = S_MOV_B32 5
    V_STORE_IDX %2:vgpr_32, %5, 0, implicit $exec :: (store (s32), addrspace 10)
    V_STORE_IDX %3:vgpr_32, %0, 16, implicit $exec :: (store (s32), addrspace 10)
...

# TODO-GFX13 Should be able to duplicate and bundle load
---
name:            same-bb-multi-use-load
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-multi-use-load
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MIN_U32_e64_:%[0-9]+]]:vgpr_32 = V_MIN_U32_e64 65432, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX]], implicit $exec, implicit [[S_LSHL_B32_]] {
    ; GCN-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ; GCN-NEXT: V_STORE_IDX [[V_MIN_U32_e64_]], [[S_LSHL_B32_]], 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: same-bb-multi-use-load
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_MIN_U32_e32_:%[0-9]+]]:vgpr_32 = V_MIN_U32_e32 65432, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX]], implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = V_MAX_U32_e64 12345, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: V_STORE_IDX [[V_MIN_U32_e32_]], $idx1, 0, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: same-bb-multi-use-load
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: undef $vgpr0 = V_MAX_U32_e64 12345, $vgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 0
    ; LOWERED-NEXT: renamable $vgpr1 = V_MIN_U32_e32 65432, killed $vgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 $vgpr1, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    %2:vgpr_32 = V_MAX_U32_e64 12345, %1, implicit $exec
    %3:vgpr_32 = V_MIN_U32_e64 65432, %1, implicit $exec
    V_STORE_IDX %2:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
    V_STORE_IDX %3:vgpr_32, %0, 0, implicit $exec :: (store (s32), addrspace 10)
...
---
name:            same-bb-load-store-vop2
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-vop2
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[S_LSHL_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-vop2
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-vop2
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef $vgpr20 = V_ADD_U32_e64 undef $vgpr5, undef $vgpr10, 0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_ADD_U32_e64 %3, %4, 0, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
...

# TODO-GFX13 Support using and restoring idx0 to Bundle and lower VOP3 instructions.
---
name:            same-bb-load-store-vop3
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-vop3
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_1]], 15, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[V_LOAD_IDX]], implicit [[S_LSHR_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-vop3
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 15, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_1]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit [[V_LOAD_IDX]], implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-vop3
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHR_B32 killed renamable $sgpr1, 4, implicit-def dead $scc
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr15, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef $vgpr20 = V_LSHL_ADD_U32_e64 undef $vgpr5, undef $vgpr10, killed $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:sreg_32_xexec_hi = S_LSHR_B32 %1, 4, implicit-def dead $scc
    %4:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %6:vgpr_32 = V_LOAD_IDX %2, 15, implicit $exec :: (load (s32), addrspace 10)
    %7:vgpr_32 = V_LSHL_ADD_U32_e64 %4, %5, %6, implicit $exec
    %8:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %7:vgpr_32, %3, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-load-store-vop3-two-unique-idx
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-vop3-two-unique-idx
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcc, implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]] {
    ; GCN-NEXT:   $stg_srcc = V_LOAD_IDX [[S_LSHR_B32_]], 15, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHL_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, internal $stg_srcc, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-vop3-two-unique-idx
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcc, implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx1, implicit $exec, implicit $idx2 {
    ; ALLOC-NEXT:   $stg_srcc = V_LOAD_IDX $idx1, 15, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, internal $stg_srcc, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-vop3-two-unique-idx
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 90
    ; LOWERED-NEXT: undef $vgpr20 = V_LSHL_ADD_U32_e64 undef $vgpr5, undef $vgpr10, undef $vgpr15, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %3:vgpr_32 = V_LOAD_IDX %0, 10, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 15, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_LSHL_ADD_U32_e64 %2, %3, %4, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %1, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            insert-set-gpr-idx-after-bundle
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: insert-set-gpr-idx-after-bundle
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[S_LSHL_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ; GCN-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 3, implicit-def $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_2]], 1, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 4, implicit-def $scc
    ; GCN-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_3]], 2, implicit $exec :: (load (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: insert-set-gpr-idx-after-bundle
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 3, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_2]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 1, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 4, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_3]]
    ; ALLOC-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 2, implicit $exec :: (load (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: insert-set-gpr-idx-after-bundle
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHL_B32 1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 renamable $sgpr2, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef $vgpr20 = V_ADD_U32_e64 undef $vgpr5, undef $vgpr10, 0, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 4, implicit-def dead $scc
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr1, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr2, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_ADD_U32_e64 %3, %4, 0, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
    %7:sreg_32_xexec_hi = S_LSHL_B32 1, 3, implicit-def $scc
    %8:vgpr_32 = V_LOAD_IDX %7, 1, implicit $exec :: (load (s32), addrspace 10)
    %9:sreg_32_xexec_hi = S_LSHL_B32 1, 4, implicit-def $scc
    %10:vgpr_32 = V_LOAD_IDX %9, 2, implicit $exec :: (load (s32), addrspace 10)
...

---
name:            two-bundles-vop3-vop2
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: two-bundles-vop3-vop2
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_1]], 15, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[V_LOAD_IDX]], implicit [[S_LSHR_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ; GCN-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 12, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 13, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_2]], implicit $exec, implicit [[S_LSHL_B32_2]], implicit [[S_LSHL_B32_3]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_2]], 11, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_2]], 6, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_3]], 21, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: two-bundles-vop3-vop2
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 15, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_1]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit [[V_LOAD_IDX]], implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_2]]
    ; ALLOC-NEXT: [[S_LSHR_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 12, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_2]]
    ; ALLOC-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 13, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_3]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 11, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 6, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 21, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: two-bundles-vop3-vop2
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr3 = S_LSHL_B32 1, 12, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHR_B32 renamable $sgpr1, 4, implicit-def dead $scc
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr15, implicit $exec
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHR_B32 killed renamable $sgpr0, 12, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef $vgpr20 = V_LSHL_ADD_U32_e64 undef $vgpr5, undef $vgpr10, killed $vgpr0, implicit $exec
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr3
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHL_B32 killed renamable $sgpr1, 13, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: undef $vgpr21 = V_ADD_U32_e64 undef $vgpr6, undef $vgpr11, 0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:sreg_32_xexec_hi = S_LSHR_B32 %1, 4, implicit-def dead $scc
    %4:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %6:vgpr_32 = V_LOAD_IDX %2, 15, implicit $exec :: (load (s32), addrspace 10)
    %7:vgpr_32 = V_LSHL_ADD_U32_e64 %4, %5, %6, implicit $exec
    %8:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %7:vgpr_32, %3, 20, implicit $exec :: (store (s32), addrspace 10)
    %9:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    %10:sreg_32_xexec_hi = S_LSHR_B32 %0, 12, implicit-def dead $scc
    %11:sreg_32_xexec_hi = S_LSHL_B32 %1, 13, implicit-def dead $scc
    %12:vgpr_32 = V_LOAD_IDX %9, 6, implicit $exec :: (load (s32), addrspace 10)
    %13:vgpr_32 = V_LOAD_IDX %10, 11, implicit $exec :: (load (s32), addrspace 10)
    %14:vgpr_32 = V_ADD_U32_e64 %12, %13, 0, implicit $exec
    %15:vgpr_32 = V_MAX_U32_e64 54, %0, implicit $exec
    V_STORE_IDX %14:vgpr_32, %11, 21, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            two-bundles-same-idx
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: two-bundles-same-idx
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[S_LSHL_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[S_LSHL_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 11, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 6, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_1]], 21, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: two-bundles-same-idx
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 11, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 6, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 21, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: two-bundles-same-idx
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef $vgpr20 = V_ADD_U32_e64 undef $vgpr5, undef $vgpr10, 0, implicit $exec
    ; LOWERED-NEXT: undef $vgpr21 = V_ADD_U32_e64 undef $vgpr6, undef $vgpr11, 0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_ADD_U32_e64 %3, %4, 0, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
    %7:vgpr_32 = V_LOAD_IDX %0, 6, implicit $exec :: (load (s32), addrspace 10)
    %8:vgpr_32 = V_LOAD_IDX %1, 11, implicit $exec :: (load (s32), addrspace 10)
    %9:vgpr_32 = V_ADD_U32_e64 %7, %8, 0, implicit $exec
    %10:vgpr_32 = V_MAX_U32_e64 54, %0, implicit $exec
    V_STORE_IDX %9:vgpr_32, %2, 21, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-wide-load-store
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-wide-load-store
    ; GCN: [[S_MOV_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 48
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_MOV_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_MOV_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 32
    ; GCN-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_MOV_B32_1]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_MOV_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 0
    ; GCN-NEXT: [[S_LSHR_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_MOV_B32_2]], 2, implicit-def dead $scc
    ; GCN-NEXT: BUNDLE implicit-def dead $stg_srcb, implicit-def dead $stg_srca, implicit-def early-clobber $stg_dsta, implicit [[S_LSHR_B32_1]], implicit $exec, implicit [[S_LSHR_B32_]], implicit [[S_LSHR_B32_2]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_1]], 0, implicit $exec :: (load (s128), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHR_B32_]], 0, implicit $exec :: (load (s128), addrspace 10)
    ; GCN-NEXT:   early-clobber $stg_dsta = contract V_WMMA_F32_16X16X16_F16_w32_threeaddr 8, internal killed $stg_srca, 8, internal killed $stg_srcb, 8, 0, 0, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_2]], 0, implicit $exec :: (store (s256), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-wide-load-store
    ; ALLOC: $idx2 = S_SET_GPR_IDX_U32 12
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 8
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 0
    ; ALLOC-NEXT: BUNDLE implicit-def dead $stg_srcb, implicit-def dead $stg_srca, implicit-def early-clobber $stg_dsta, implicit $idx3, implicit $exec, implicit $idx2, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx3, 0, implicit $exec :: (load (s128), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 0, implicit $exec :: (load (s128), addrspace 10)
    ; ALLOC-NEXT:   early-clobber $stg_dsta = contract V_WMMA_F32_16X16X16_F16_w32_threeaddr 8, internal killed $stg_srca, 8, internal killed $stg_srcb, 8, 0, 0, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 0, implicit $exec :: (store (s256), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-wide-load-store
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 12
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 8
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 78
    ; LOWERED-NEXT: undef early-clobber $vgpr0_vgpr1_vgpr2_vgpr3_vgpr4_vgpr5_vgpr6_vgpr7 = contract V_WMMA_F32_16X16X16_F16_w32_threeaddr 8, killed undef $vgpr0_vgpr1_vgpr2_vgpr3, 8, killed undef $vgpr0_vgpr1_vgpr2_vgpr3, 8, 0, 0, 0, implicit $exec
    %0:sreg_32_xexec_hi = S_MOV_B32 48
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:vreg_128_align2 = V_LOAD_IDX %1, 0, implicit $exec :: (load (s128), addrspace 10)
    %3:sreg_32_xexec_hi = S_MOV_B32 32
    %4:sreg_32_xexec_hi = S_LSHR_B32 %3, 2, implicit-def dead $scc
    %5:vreg_128_align2 = V_LOAD_IDX %4, 0, implicit $exec :: (load (s128), addrspace 10)
    %6:vreg_256_align2 = contract V_WMMA_F32_16X16X16_F16_w32_threeaddr 8, killed %2, 8, killed %5, 8, 0, 0, 0, implicit $exec
    %7:sreg_32_xexec_hi = S_MOV_B32 0
    %8:sreg_32_xexec_hi = S_LSHR_B32 %7, 2, implicit-def dead $scc
    V_STORE_IDX %6, %8, 0, implicit $exec :: (store (s256), addrspace 10)
...

---
name:            unsafe-load-past-store
# We do not currently analyze index and offset values to optimize potentially aliasing loads and stores.
# Therefore we should not bundle %12:vgpr_32 = V_LOAD_IDX %9, 6 with %14:vgpr_32 = V_ADD_U32_e64 %12, %13 as that would move it past a potentially aliasing store
# We never move stores in the current bundling algorithm so will never do an unsafe move of store past a load, but when updating the test in the future ensure that
# V_STORE_IDX %7:vgpr_32, %3, 20 does not happen before %12:vgpr_32 = V_LOAD_IDX %9, 6
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: unsafe-load-past-store
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_1]], 15, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 12, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 13, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_2]], 6, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_]], implicit $exec, implicit [[S_LSHL_B32_]], implicit [[V_LOAD_IDX]], implicit [[S_LSHR_B32_1]] {
    ; GCN-NEXT:   $stg_srcb = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHR_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit [[S_LSHR_B32_2]], implicit $exec, implicit [[V_LOAD_IDX1]], implicit [[S_LSHL_B32_3]] {
    ; GCN-NEXT:   $stg_srca = V_LOAD_IDX [[S_LSHR_B32_2]], 11, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   $stg_dsta = V_ADD_U32_e64 [[V_LOAD_IDX1]], internal $stg_srca, 0, implicit $exec
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_3]], 21, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: unsafe-load-past-store
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[S_LSHR_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHR_B32_]], 4, implicit-def dead $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_1]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 15, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[S_LSHL_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_2]]
    ; ALLOC-NEXT: [[S_LSHR_B32_2:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 12, implicit-def dead $scc
    ; ALLOC-NEXT: [[S_LSHL_B32_3:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 13, implicit-def dead $scc
    ; ALLOC-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx1, 6, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srcb, implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit $idx1, implicit [[V_LOAD_IDX]], implicit $idx3 {
    ; ALLOC-NEXT:   $stg_srcb = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx1, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_LSHL_ADD_U32_e64 internal $stg_srca, internal $stg_srcb, [[V_LOAD_IDX]], implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx3, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_2]]
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_3]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_srca, implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit [[V_LOAD_IDX1]], implicit $idx1 {
    ; ALLOC-NEXT:   $stg_srca = V_LOAD_IDX $idx2, 11, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   $stg_dsta = V_ADD_U32_e64 [[V_LOAD_IDX1]], internal $stg_srca, 0, implicit $exec
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 21, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: unsafe-load-past-store
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 1, 12, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr3 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 renamable $sgpr1
    ; LOWERED-NEXT: renamable $sgpr4 = S_LSHR_B32 renamable $sgpr1, 4, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr3
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 killed renamable $sgpr4
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 1
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr15, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHR_B32 renamable $sgpr0, 12, implicit-def dead $scc
    ; LOWERED-NEXT: $vgpr1 = V_MOV_B32_e32 undef $vgpr6, implicit $exec
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHL_B32 killed renamable $sgpr1, 13, implicit-def dead $scc
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 201
    ; LOWERED-NEXT: undef $vgpr20 = V_LSHL_ADD_U32_e64 undef $vgpr5, undef $vgpr10, killed $vgpr0, implicit $exec
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 72
    ; LOWERED-NEXT: undef $vgpr21 = V_ADD_U32_e64 killed $vgpr1, undef $vgpr11, 0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:sreg_32_xexec_hi = S_LSHR_B32 %1, 4, implicit-def dead $scc
    %4:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %6:vgpr_32 = V_LOAD_IDX %2, 15, implicit $exec :: (load (s32), addrspace 10)
    %7:vgpr_32 = V_LSHL_ADD_U32_e64 %4, %5, %6, implicit $exec
    %8:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    %9:sreg_32_xexec_hi = S_LSHL_B32 1, 12, implicit-def $scc
    %10:sreg_32_xexec_hi = S_LSHR_B32 %0, 12, implicit-def dead $scc
    %11:sreg_32_xexec_hi = S_LSHL_B32 %1, 13, implicit-def dead $scc
    %12:vgpr_32 = V_LOAD_IDX %9, 6, implicit $exec :: (load (s32), addrspace 10)
    V_STORE_IDX %7:vgpr_32, %3, 20, implicit $exec :: (store (s32), addrspace 10)
    %13:vgpr_32 = V_LOAD_IDX %10, 11, implicit $exec :: (load (s32), addrspace 10)
    %14:vgpr_32 = V_ADD_U32_e64 %12, %13, 0, implicit $exec
    %15:vgpr_32 = V_MAX_U32_e64 54, %0, implicit $exec
    V_STORE_IDX %14:vgpr_32, %11, 21, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            tied-operand
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: tied-operand
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN:%[0-9]+]]:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN [[V_LOAD_IDX1]], [[V_LOAD_IDX]], undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN1:%[0-9]+]]:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN]], [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: tied-operand
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx3, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN:%[0-9]+]]:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN [[V_LOAD_IDX1]], [[V_LOAD_IDX]], undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    ; ALLOC-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN1:%[0-9]+]]:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    ; ALLOC-NEXT: V_STORE_IDX [[BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN]], $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: tied-operand
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 3
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr5, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 2
    ; LOWERED-NEXT: $vgpr1 = V_MOV_B32_e32 undef $vgpr10, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr2 = V_MAX_U32_e64 54321, $sgpr0, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr3 = V_MAX_U32_e64 12345, killed $sgpr0, implicit $exec
    ; LOWERED-NEXT: GLOBAL_WB 24, implicit $exec
    ; LOWERED-NEXT: S_WAIT_STORECNT 0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 0
    ; LOWERED-NEXT: renamable $vgpr1 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN killed renamable $vgpr1, killed renamable $vgpr0, undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 24, implicit $exec
    ; LOWERED-NEXT: S_WAIT_LOADCNT 0
    ; LOWERED-NEXT: GLOBAL_INV 24, implicit $exec
    ; LOWERED-NEXT: GLOBAL_WB 24, implicit $exec
    ; LOWERED-NEXT: dead renamable $vgpr3 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN killed renamable $vgpr3, killed renamable $vgpr2, undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 24, implicit $exec
    ; LOWERED-NEXT: S_WAIT_LOADCNT 0
    ; LOWERED-NEXT: GLOBAL_INV 24, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr20 = V_MOV_B32_e32 $vgpr1, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN %4, %3, undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    %7:vgpr_32 = V_MAX_U32_e64 12345, %0, implicit $exec
    %8:vgpr_32 = BUFFER_ATOMIC_ADD_F32_VBUFFER_OFFEN_RTN %7, %6, undef $sgpr0_sgpr1_sgpr2_sgpr3, undef $sgpr3, 0, 0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            coremi-load-store
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: coremi-load-store
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[DS_READ_B32_gfx9_:%[0-9]+]]:vgpr_32 = DS_READ_B32_gfx9 [[V_LOAD_IDX]], 0, 0, implicit $exec
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: DS_WRITE_B32_gfx9 [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], 0, 0, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[DS_READ_B32_gfx9_]], [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: coremi-load-store
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[DS_READ_B32_gfx9_:%[0-9]+]]:vgpr_32 = DS_READ_B32_gfx9 [[V_LOAD_IDX]], 0, 0, implicit $exec
    ; ALLOC-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: DS_WRITE_B32_gfx9 [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], 0, 0, implicit $exec
    ; ALLOC-NEXT: V_STORE_IDX [[DS_READ_B32_gfx9_]], $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: coremi-load-store
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $vgpr1 = V_MAX_U32_e64 54321, $sgpr0, implicit $exec
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 2
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr10, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr2 = V_MAX_U32_e64 12345, killed $sgpr0, implicit $exec
    ; LOWERED-NEXT: S_WAIT_STORECNT 0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 0
    ; LOWERED-NEXT: renamable $vgpr0 = DS_READ_B32_gfx9 killed renamable $vgpr0, 0, 0, implicit $exec
    ; LOWERED-NEXT: S_WAIT_DSCNT 0
    ; LOWERED-NEXT: GLOBAL_INV 24, implicit $exec
    ; LOWERED-NEXT: GLOBAL_WB 24, implicit $exec
    ; LOWERED-NEXT: DS_WRITE_B32_gfx9 killed renamable $vgpr2, killed renamable $vgpr1, 0, 0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr20 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = DS_READ_B32_gfx9 %4, 0, 0, implicit $exec
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    %7:vgpr_32 = V_MAX_U32_e64 12345, %0, implicit $exec
    DS_WRITE_B32_gfx9 %7, %6, 0, 0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            coremi-store-store
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: coremi-store-store
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[DS_SUB_RTN_U32_:%[0-9]+]]:vgpr_32 = DS_SUB_RTN_U32 [[V_LOAD_IDX1]], [[V_LOAD_IDX]], 0, 0, implicit $exec, implicit $m0
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: DS_WRITE_B32_gfx9 [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], 0, 0, implicit $exec
    ; GCN-NEXT: V_STORE_IDX [[DS_SUB_RTN_U32_]], [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; ALLOC-LABEL: name: coremi-store-store
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx3, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[DS_SUB_RTN_U32_:%[0-9]+]]:vgpr_32 = DS_SUB_RTN_U32 [[V_LOAD_IDX1]], [[V_LOAD_IDX]], 0, 0, implicit $exec, implicit $m0
    ; ALLOC-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: [[V_MAX_U32_e64_1:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: DS_WRITE_B32_gfx9 [[V_MAX_U32_e64_1]], [[V_MAX_U32_e64_]], 0, 0, implicit $exec
    ; ALLOC-NEXT: V_STORE_IDX [[DS_SUB_RTN_U32_]], $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ;
    ; LOWERED-LABEL: name: coremi-store-store
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 3
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr5, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 2
    ; LOWERED-NEXT: $vgpr1 = V_MOV_B32_e32 undef $vgpr10, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr2 = V_MAX_U32_e64 12345, $sgpr0, implicit $exec
    ; LOWERED-NEXT: GLOBAL_WB 24, implicit $exec
    ; LOWERED-NEXT: S_WAIT_STORECNT 0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 0
    ; LOWERED-NEXT: renamable $vgpr0 = DS_SUB_RTN_U32 killed renamable $vgpr1, killed renamable $vgpr0, 0, 0, implicit $exec, implicit $m0
    ; LOWERED-NEXT: S_WAIT_DSCNT 0
    ; LOWERED-NEXT: GLOBAL_INV 24, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr1 = V_MAX_U32_e64 54321, killed $sgpr0, implicit $exec
    ; LOWERED-NEXT: GLOBAL_WB 24, implicit $exec
    ; LOWERED-NEXT: DS_WRITE_B32_gfx9 killed renamable $vgpr2, killed renamable $vgpr1, 0, 0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: $vgpr20 = V_MOV_B32_e32 $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = DS_SUB_RTN_U32 %4, %3, 0, 0, implicit $exec, implicit $m0
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    %7:vgpr_32 = V_MAX_U32_e64 12345, %0, implicit $exec
    DS_WRITE_B32_gfx9 %7, %6, 0, 0, implicit $exec
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            coremi-store-store-trivially-distinct
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: coremi-store-store-trivially-distinct
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; GCN-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; GCN-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHL_B32_]], 5, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX [[S_LSHR_B32_]], 10, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; GCN-NEXT: DS_WRITE_B32_gfx9 [[V_LOAD_IDX1]], [[V_MAX_U32_e64_]], 4, 0, implicit $exec :: (store (s32), addrspace 3)
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX1]], implicit $exec, implicit [[S_LSHL_B32_1]] {
    ; GCN-NEXT:   $stg_dsta = DS_READ_B32_gfx9 [[V_LOAD_IDX1]], 0, 0, implicit $exec :: (load (s32), addrspace 3)
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_1]], 20, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: coremi-store-store-trivially-distinct
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx3 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: [[S_LSHR_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHR_B32 [[S_LSHL_B32_]], 2, implicit-def dead $scc
    ; ALLOC-NEXT: $idx2 = S_SET_GPR_IDX_U32 [[S_LSHR_B32_]]
    ; ALLOC-NEXT: [[S_LSHL_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 [[S_LSHR_B32_]], 3, implicit-def dead $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_1]]
    ; ALLOC-NEXT: [[V_LOAD_IDX:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx3, 5, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_LOAD_IDX1:%[0-9]+]]:vgpr_32 = V_LOAD_IDX $idx2, 10, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 54321, [[S_LSHL_B32_]], implicit $exec
    ; ALLOC-NEXT: DS_WRITE_B32_gfx9 [[V_LOAD_IDX1]], [[V_MAX_U32_e64_]], 4, 0, implicit $exec :: (store (s32), addrspace 3)
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[V_LOAD_IDX1]], implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = DS_READ_B32_gfx9 [[V_LOAD_IDX1]], 0, 0, implicit $exec :: (load (s32), addrspace 3)
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 20, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: coremi-store-store-trivially-distinct
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: renamable $sgpr1 = S_LSHR_B32 renamable $sgpr0, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx3 = S_SET_GPR_IDX_U32 renamable $sgpr0
    ; LOWERED-NEXT: renamable $sgpr2 = S_LSHL_B32 renamable $sgpr1, 3, implicit-def dead $scc
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 killed renamable $sgpr1
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr2
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 3
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr5, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 2
    ; LOWERED-NEXT: $vgpr0 = V_MOV_B32_e32 undef $vgpr10, implicit $exec
    ; LOWERED-NEXT: renamable $vgpr1 = V_MAX_U32_e64 54321, killed $sgpr0, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 64
    ; LOWERED-NEXT: DS_WRITE_B32_gfx9 renamable $vgpr0, killed renamable $vgpr1, 4, 0, implicit $exec :: (store (s32), addrspace 3)
    ; LOWERED-NEXT: undef $vgpr20 = DS_READ_B32_gfx9 killed renamable $vgpr0, 0, 0, implicit $exec :: (load (s32), addrspace 3)
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:sreg_32_xexec_hi = S_LSHR_B32 %0, 2, implicit-def dead $scc
    %2:sreg_32_xexec_hi = S_LSHL_B32 %1, 3, implicit-def dead $scc
    %3:vgpr_32 = V_LOAD_IDX %0, 5, implicit $exec :: (load (s32), addrspace 10)
    %4:vgpr_32 = V_LOAD_IDX %1, 10, implicit $exec :: (load (s32), addrspace 10)
    %5:vgpr_32 = DS_READ_B32_gfx9 %4, 0, 0, implicit $exec :: (load (s32), addrspace 3)
    %6:vgpr_32 = V_MAX_U32_e64 54321, %0, implicit $exec
    DS_WRITE_B32_gfx9 %4, %6, 4, 0, implicit $exec :: (store (s32), addrspace 3)
    V_STORE_IDX %5:vgpr_32, %2, 20, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-load-store-no-core
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-load-store-no-core
    ; GCN: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[S_LSHL_B32_]], implicit $exec {
    ; GCN-NEXT:   $stg_dsta = V_LOAD_IDX [[S_LSHL_B32_]], 0, implicit $exec :: (load (s32), addrspace 10)
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_LSHL_B32_]], 1, implicit $exec :: (store (s32), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-load-store-no-core
    ; ALLOC: [[S_LSHL_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 [[S_LSHL_B32_]]
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit $idx1, implicit $exec {
    ; ALLOC-NEXT:   $stg_dsta = V_LOAD_IDX $idx1, 0, implicit $exec :: (load (s32), addrspace 10)
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 1, implicit $exec :: (store (s32), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-load-store-no-core
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: renamable $sgpr0 = S_LSHL_B32 1, 2, implicit-def dead $scc
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 killed renamable $sgpr0
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 65
    ; LOWERED-NEXT: $vgpr1 = V_MOV_B32_e32 undef $vgpr0, implicit $exec
    %0:sreg_32_xexec_hi = S_LSHL_B32 1, 2, implicit-def $scc
    %1:vgpr_32 = V_LOAD_IDX %0, 0, implicit $exec :: (load (s32), addrspace 10)
    V_STORE_IDX %1:vgpr_32, %0, 1, implicit $exec :: (store (s32), addrspace 10)
...

---
name:            same-bb-wide-no-core
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: same-bb-wide-no-core
    ; GCN: [[S_MOV_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 48
    ; GCN-NEXT: [[S_MOV_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 16
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_MOV_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[S_MOV_B32_]], implicit $exec, implicit [[S_MOV_B32_1]] {
    ; GCN-NEXT:   $stg_dsta = V_LOAD_IDX [[S_MOV_B32_]], 8, implicit $exec :: (load (s128), addrspace 10)
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_MOV_B32_1]], 4, implicit $exec :: (store (s128), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: same-bb-wide-no-core
    ; ALLOC: $idx2 = S_SET_GPR_IDX_U32 48
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 16
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = V_LOAD_IDX $idx2, 8, implicit $exec :: (load (s128), addrspace 10)
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 4, implicit $exec :: (store (s128), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: same-bb-wide-no-core
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 48
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 16
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 66
    ; LOWERED-NEXT: $vgpr4 = V_MOV_B32_e32 undef $vgpr8, implicit $exec
    ; LOWERED-NEXT: $vgpr5 = V_MOV_B32_e32 undef $vgpr9, implicit $exec
    ; LOWERED-NEXT: $vgpr6 = V_MOV_B32_e32 undef $vgpr10, implicit $exec
    ; LOWERED-NEXT: $vgpr7 = V_MOV_B32_e32 undef $vgpr11, implicit $exec
    %0:sreg_32_xexec_hi = S_MOV_B32 48
    %1:vreg_128_align2 = V_LOAD_IDX %0, 8, implicit $exec :: (load (s128), addrspace 10)
    %2:sreg_32_xexec_hi = S_MOV_B32 16
    %3:vgpr_32 = V_MAX_U32_e64 12345, %0, implicit $exec
    V_STORE_IDX %1, %2, 4, implicit $exec :: (store (s128), addrspace 10)
...

---
name:            wide-no-core-regno-wrap
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: wide-no-core-regno-wrap
    ; GCN: [[S_MOV_B32_:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 48
    ; GCN-NEXT: [[S_MOV_B32_1:%[0-9]+]]:sreg_32_xexec_hi = S_MOV_B32 16
    ; GCN-NEXT: [[V_MAX_U32_e64_:%[0-9]+]]:vgpr_32 = V_MAX_U32_e64 12345, [[S_MOV_B32_]], implicit $exec
    ; GCN-NEXT: BUNDLE implicit-def $stg_dsta, implicit [[S_MOV_B32_]], implicit $exec, implicit [[S_MOV_B32_1]] {
    ; GCN-NEXT:   $stg_dsta = V_LOAD_IDX [[S_MOV_B32_]], 1022, implicit $exec :: (load (s128), addrspace 10)
    ; GCN-NEXT:   V_STORE_IDX internal $stg_dsta, [[S_MOV_B32_1]], 1020, implicit $exec :: (store (s128), addrspace 10)
    ; GCN-NEXT: }
    ;
    ; ALLOC-LABEL: name: wide-no-core-regno-wrap
    ; ALLOC: $idx2 = S_SET_GPR_IDX_U32 48
    ; ALLOC-NEXT: $idx1 = S_SET_GPR_IDX_U32 16
    ; ALLOC-NEXT: BUNDLE implicit-def $stg_dsta, implicit $idx2, implicit $exec, implicit $idx1 {
    ; ALLOC-NEXT:   $stg_dsta = V_LOAD_IDX $idx2, 1022, implicit $exec :: (load (s128), addrspace 10)
    ; ALLOC-NEXT:   V_STORE_IDX internal $stg_dsta, $idx1, 1020, implicit $exec :: (store (s128), addrspace 10)
    ; ALLOC-NEXT: }
    ;
    ; LOWERED-LABEL: name: wide-no-core-regno-wrap
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    ; LOWERED-NEXT: $idx2 = S_SET_GPR_IDX_U32 48
    ; LOWERED-NEXT: $idx1 = S_SET_GPR_IDX_U32 16
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 49986
    ; LOWERED-NEXT: $vgpr1020 = V_MOV_B32_e32 undef $vgpr1022, implicit $exec
    ; LOWERED-NEXT: $vgpr1021 = V_MOV_B32_e32 undef $vgpr1023, implicit $exec
    ; LOWERED-NEXT: S_SET_VGPR_FRAMES 49218
    ; LOWERED-NEXT: $vgpr1022 = V_MOV_B32_e32 undef $vgpr0, implicit $exec
    ; LOWERED-NEXT: $vgpr1023 = V_MOV_B32_e32 undef $vgpr1, implicit $exec
    %0:sreg_32_xexec_hi = S_MOV_B32 48
    %1:vreg_128_align2 = V_LOAD_IDX %0, 1022, implicit $exec :: (load (s128), addrspace 10)
    %2:sreg_32_xexec_hi = S_MOV_B32 16
    %3:vgpr_32 = V_MAX_U32_e64 12345, %0, implicit $exec
    V_STORE_IDX %1, %2, 1020, implicit $exec :: (store (s128), addrspace 10)
...

---
name:            debug-instr
machineFunctionInfo:
  laneSharedVGPRSize: 1000
  stackPtrOffsetReg: '$sgpr32'
  frameOffsetReg: '$sgpr33'
tracksRegLiveness: true
body:             |

  bb.0:
    ; GCN-LABEL: name: debug-instr
    ; GCN: DBG_VALUE %0:sreg_32, $noreg
    ;
    ; ALLOC-LABEL: name: debug-instr
    ; ALLOC: DBG_VALUE %0:sreg_32, $noreg
    ;
    ; LOWERED-LABEL: name: debug-instr
    ; LOWERED: S_WAIT_LOADCNT_DSCNT 0
    ; LOWERED-NEXT: S_WAIT_EXPCNT 0
    ; LOWERED-NEXT: S_WAIT_SAMPLECNT 0
    ; LOWERED-NEXT: S_WAIT_BVHCNT 0
    ; LOWERED-NEXT: S_WAIT_KMCNT 0
    DBG_VALUE %0:sreg_32, $noreg
...
