; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 5
; RUN: llc -mtriple=amdgcn-- -mcpu=gfx1300 -amdgpu-promote-private=true -verify-machineinstrs -o - %s | FileCheck %s
; RUN: llc -mtriple=amdgcn-- -mcpu=gfx1300 -amdgpu-promote-private=true -verify-machineinstrs -stop-after=amdgpu-private-object-vgrps -o - %s | FileCheck --check-prefix=LIVEINS %s

; LIVEINS-LABEL: name: _Z3foov
; LIVEINS: body:
; LIVEINS-NEXT: bb.0.entry:
; LIVEINS-NEXT: successors:
; LIVEINS-NEXT: liveins: $sgpr4_sgpr5, $vgpr0, $vgpr1, $vgpr2, $vgpr3, $vgpr4, $vgpr5, $vgpr6, $vgpr7, $vgpr8, $vgpr9, $vgpr10, $vgpr11, $vgpr12, $vgpr13, $vgpr14, $vgpr15, $vgpr16, $vgpr17, $vgpr18, $vgpr19, $vgpr20, $vgpr21, $vgpr22, $vgpr23, $vgpr24, $vgpr25, $vgpr26, $vgpr27, $vgpr28, $vgpr29
;
; LIVEINS: bb.1.bb:
; LIVEINS-NEXT: successors:
; LIVEINS-NEXT: liveins: $vgpr0, $vgpr1, $vgpr2, $vgpr3, $vgpr4, $vgpr5, $vgpr6, $vgpr7, $vgpr8, $vgpr9, $vgpr10, $vgpr11, $vgpr12, $vgpr13, $vgpr14, $vgpr15, $vgpr16, $vgpr17, $vgpr18, $vgpr19, $vgpr20, $vgpr21, $vgpr22, $vgpr23, $vgpr24, $vgpr25, $vgpr26, $vgpr27, $vgpr28, $vgpr29
;
; LIVEINS: bb.2.bb2:
; LIVEINS-NEXT: successors:
; LIVEINS-NEXT: liveins: $vgpr0, $vgpr1, $vgpr2, $vgpr3, $vgpr4, $vgpr5, $vgpr6, $vgpr7, $vgpr8, $vgpr9, $vgpr10, $vgpr11, $vgpr12, $vgpr13, $vgpr14, $vgpr15, $vgpr16, $vgpr17, $vgpr18, $vgpr19, $vgpr20, $vgpr21, $vgpr22, $vgpr23, $vgpr24, $vgpr25, $vgpr26, $vgpr27, $vgpr28, $vgpr29

define amdgpu_kernel void @_Z3foov(ptr addrspace(5) %out) {
; CHECK-LABEL: _Z3foov:
; CHECK:       ; %bb.0: ; %entry
; CHECK-NEXT:    s_load_b32 s0, s[4:5], 0x24
; CHECK-NEXT:    v_mov_b32_e32 v30, 5
; CHECK-NEXT:    s_wait_kmcnt 0x0
; CHECK-NEXT:    scratch_store_b32 off, v30, s0 offset:20
; CHECK-NEXT:    s_cbranch_scc1 .LBB0_3
; CHECK-NEXT:  ; %bb.1: ; %bb
; CHECK-NEXT:    s_cbranch_scc1 .LBB0_3
; CHECK-NEXT:  ; %bb.2: ; %bb2
; CHECK-NEXT:    s_set_gpr_idx_u32 idx1, 0
; CHECK-NEXT:    s_set_vgpr_frames 1 ; vsrc0_idx=1 vsrc1_idx=0 vsrc2_idx=0 vdst_idx=0 vsrc0_msb=0 vsrc1_msb=0 vsrc2_msb=0 vdst_msb=0
; CHECK-NEXT:    v_mov_b32_e32 v30, v1
; CHECK-NEXT:    s_set_vgpr_frames 0 ; vsrc0_idx=0 vsrc1_idx=0 vsrc2_idx=0 vdst_idx=0 vsrc0_msb=0 vsrc1_msb=0 vsrc2_msb=0 vdst_msb=0
; CHECK-NEXT:    s_delay_alu instid0(VALU_DEP_1) | instskip(SKIP_1) | instid1(VALU_DEP_1)
; CHECK-NEXT:    v_mul_f32_e32 v30, v30, v30
; CHECK-NEXT:    s_set_vgpr_frames 64 ; vsrc0_idx=0 vsrc1_idx=0 vsrc2_idx=0 vdst_idx=1 vsrc0_msb=0 vsrc1_msb=0 vsrc2_msb=0 vdst_msb=0
; CHECK-NEXT:    v_add_f32_e64 v2, v30, 2.0
; CHECK-NEXT:    s_set_vgpr_frames 0 ; vsrc0_idx=0 vsrc1_idx=0 vsrc2_idx=0 vdst_idx=0 vsrc0_msb=0 vsrc1_msb=0 vsrc2_msb=0 vdst_msb=0
; CHECK-NEXT:    scratch_load_b32 v0, off, s0 offset:28
; CHECK-NEXT:    s_wait_loadcnt 0x0
; CHECK-NEXT:    v_add_nc_u32_e32 v0, 7, v0
; CHECK-NEXT:    scratch_store_b32 off, v0, s0 offset:28
; CHECK-NEXT:  .LBB0_3: ; %exit
; CHECK-NEXT:    s_endpgm
entry:
  ; Give VGPR0 some use.
  ; TODO: This won't be VGPR0 if we use live-ins to initially define the
  ; allocated registers.
  %out.5 = getelementptr i32, ptr addrspace(5) %out, i32 5
  store i32 5, ptr addrspace(5) %out.5

  ; The private object starts to live, so VGPR0 and other registers
  ; allocated to the object are not available to the main register
  ; allocator beginning this point.
  %p = alloca [30 x float], align 4, addrspace(5)
  br i1 undef, label %bb, label %exit

bb:
  ; Have a basic block where the private object is live but is not
  ; accessed, to test that such blocks still get the allocated VGPRs as
  ; their live-ins.
  br i1 undef, label %bb2, label %exit

bb2:
  %p.1 = getelementptr [30 x float], ptr addrspace(5) %p, i64 0, i64 1
  %v = load float, ptr addrspace(5) %p.1, align 4

  %mul = fmul float %v, %v
  %add = fadd float %mul, 2.0

  %p.2 = getelementptr [30 x float], ptr addrspace(5) %p, i64 0, i64 2
  store float %add, ptr addrspace(5) %p.2, align 4

  ; The private object is not live anymore, so VGPR0 is available for
  ; allocation again.
  %out.7 = getelementptr i32, ptr addrspace(5) %out, i32 7
  %v7 = load i32, ptr addrspace(5) %out.7
  %add7 = add i32 %v7, 7
  store i32 %add7, ptr addrspace(5) %out.7
  br label %exit

exit:
  ret void
}
;; NOTE: These prefixes are unused and the list is autogenerated. Do not add tests below this line:
; LIVEINS: {{.*}}
