; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -p hexagon-loop-idiom -S < %s | FileCheck %s

target triple = "hexagon"

; There need to be two pmpy instructions.
define zeroext i16 @pmpy_trunc(i8 zeroext %a0, i16 zeroext %a1) local_unnamed_addr {
; CHECK-LABEL: define zeroext i16 @pmpy_trunc(
; CHECK-SAME: i8 zeroext [[A0:%.*]], i16 zeroext [[A1:%.*]]) local_unnamed_addr {
; CHECK-NEXT:  [[B1:.*]]:
; CHECK-NEXT:    br label %[[B2:.*]]
; CHECK:       [[B2]]:
; CHECK-NEXT:    [[PHI1:%.*]] = phi i8 [ 0, %[[B1]] ], [ [[ADD:%.*]], %[[B2]] ]
; CHECK-NEXT:    [[PHI2:%.*]] = phi i16 [ [[A1]], %[[B1]] ], [ [[SELECT:%.*]], %[[B2]] ]
; CHECK-NEXT:    [[PHI3:%.*]] = phi i8 [ [[A0]], %[[B1]] ], [ [[LSHR1:%.*]], %[[B2]] ]
; CHECK-NEXT:    [[TRUNC1:%.*]] = trunc i16 [[PHI2]] to i8
; CHECK-NEXT:    [[XOR1:%.*]] = xor i8 [[PHI3]], [[TRUNC1]]
; CHECK-NEXT:    [[LSHR1]] = lshr i8 [[PHI3]], 1
; CHECK-NEXT:    [[TRUNC2:%.*]] = trunc i8 [[XOR1]] to i1
; CHECK-NEXT:    [[LSHR2:%.*]] = lshr i16 [[PHI2]], 1
; CHECK-NEXT:    [[XOR2:%.*]] = xor i16 [[LSHR2]], -24575
; CHECK-NEXT:    [[SELECT]] = select i1 [[TRUNC2]], i16 [[XOR2]], i16 [[LSHR2]]
; CHECK-NEXT:    [[ADD]] = add nuw nsw i8 [[PHI1]], 1
; CHECK-NEXT:    [[ICMP:%.*]] = icmp samesign ult i8 [[PHI1]], 7
; CHECK-NEXT:    br i1 [[ICMP]], label %[[B2]], label %[[B3:.*]]
; CHECK:       [[B3]]:
; CHECK-NEXT:    [[TMP18:%.*]] = phi i16 [ [[SELECT]], %[[B2]] ]
; CHECK-NEXT:    ret i16 [[TMP18]]
;
b1:
  br label %b2

b2:                                               ; preds = %b1, %b2
  %phi1 = phi i8 [ 0, %b1 ], [ %add, %b2 ]
  %phi2 = phi i16 [ %a1, %b1 ], [ %select, %b2 ]
  %phi3 = phi i8 [ %a0, %b1 ], [ %lshr1, %b2 ]
  %trunc1 = trunc i16 %phi2 to i8
  %xor1 = xor i8 %phi3, %trunc1
  %lshr1 = lshr i8 %phi3, 1
  %trunc2 = trunc i8 %xor1 to i1
  %lshr2 = lshr i16 %phi2, 1
  %xor2 = xor i16 %lshr2, -24575
  %select = select i1 %trunc2, i16 %xor2, i16 %lshr2
  %add = add nuw nsw i8 %phi1, 1
  %icmp = icmp samesign ult i8 %phi1, 7
  br i1 %icmp, label %b2, label %b3

b3:                                              ; preds = %b2
  %select.lcssa = phi i16 [ %select, %b2 ]
  ret i16 %select.lcssa
}

