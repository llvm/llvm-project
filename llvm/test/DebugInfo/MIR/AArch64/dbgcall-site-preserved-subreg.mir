# RUN: llc -mtriple aarch64-linux-gnu -emit-call-site-info -start-after=livedebugvalues -filetype=obj -o - %s \
# RUN:     | llvm-dwarfdump - | FileCheck %s

--- |
  target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i8:8:32-i16:16:32-i64:64-i128:128-n32:64-S128-Fn32"
  target triple = "aarch64"

  define dso_local noundef i64 @foo(i64 noundef returned %p) local_unnamed_addr #0 !dbg !13 {
  entry:
      #dbg_value(i64 %p, !19, !DIExpression(), !20)
    %conv = trunc i64 %p to i32, !dbg !21
    tail call void @bar(i32 noundef %conv), !dbg !22
    ret i64 %p, !dbg !23
  }

  declare !dbg !24 dso_local void @bar(i32 noundef) local_unnamed_addr

  attributes #0 = { "frame-pointer"="non-leaf-no-reserve" }

  !llvm.dbg.cu = !{!0}
  !llvm.module.flags = !{!2, !3, !4, !5, !6, !7}
  !llvm.ident = !{!8}
  !llvm.errno.tbaa = !{!9}

  !0 = distinct !DICompileUnit(language: DW_LANG_C11, file: !1, producer: "clang version 22.0.0git", isOptimized: true, runtimeVersion: 0, emissionKind: FullDebug, splitDebugInlining: false, nameTableKind: None)
  !1 = !DIFile(filename: "c1.i", directory: "/")
  !2 = !{i32 7, !"Dwarf Version", i32 5}
  !3 = !{i32 2, !"Debug Info Version", i32 3}
  !4 = !{i32 1, !"wchar_size", i32 4}
  !5 = !{i32 7, !"uwtable", i32 2}
  !6 = !{i32 7, !"frame-pointer", i32 4}
  !7 = !{i32 7, !"debug-info-assignment-tracking", i1 true}
  !8 = !{!"clang version 22.0.0git"}
  !9 = !{!10, !10, i64 0}
  !10 = !{!"int", !11, i64 0}
  !11 = !{!"omnipotent char", !12, i64 0}
  !12 = !{!"Simple C/C++ TBAA"}
  !13 = distinct !DISubprogram(name: "foo", scope: !14, file: !14, line: 2, type: !15, scopeLine: 2, flags: DIFlagPrototyped | DIFlagAllCallsDescribed, spFlags: DISPFlagDefinition | DISPFlagOptimized, unit: !0, retainedNodes: !18, keyInstructions: true)
  !14 = !DIFile(filename: "c1.i", directory: "/", checksumkind: CSK_MD5, checksum: "d6df8546b35604f19079ca89d49a7275")
  !15 = !DISubroutineType(types: !16)
  !16 = !{!17, !17}
  !17 = !DIBasicType(name: "long", size: 64, encoding: DW_ATE_signed)
  !18 = !{!19}
  !19 = !DILocalVariable(name: "p", arg: 1, scope: !13, file: !14, line: 2, type: !17)
  !20 = !DILocation(line: 0, scope: !13)
  !21 = !DILocation(line: 3, column: 7, scope: !13)
  !22 = !DILocation(line: 3, column: 3, scope: !13)
  !23 = !DILocation(line: 4, column: 3, scope: !13, atomGroup: 1, atomRank: 1)
  !24 = !DISubprogram(name: "bar", scope: !14, file: !14, line: 1, type: !25, flags: DIFlagPrototyped, spFlags: DISPFlagOptimized)
  !25 = !DISubroutineType(types: !26)
  !26 = !{null, !27}
  !27 = !DIBasicType(name: "int", size: 32, encoding: DW_ATE_signed)
...
---
name:            foo
liveins:
  - { reg: '$x0' }
stack:
  - { id: 0, type: spill-slot, offset: -16, size: 8, alignment: 16, callee-saved-register: '$x19' }
  - { id: 1, type: spill-slot, offset: -24, size: 8, alignment: 8, callee-saved-register: '$lr' }
  - { id: 2, type: spill-slot, offset: -32, size: 8, alignment: 8, callee-saved-register: '$fp' }
callSites:
  - { bb: 0, offset: 11, fwdArgRegs:
      - { arg: 0, reg: '$w0' } }
body:             |
  bb.0.entry:
    liveins: $x0, $lr, $x19

    DBG_VALUE $x0, $noreg, !19, !DIExpression(), debug-location !20
    early-clobber $sp = frame-setup STPXpre $fp, killed $lr, $sp, -4 :: (store (s64) into %stack.2), (store (s64) into %stack.1)
    frame-setup CFI_INSTRUCTION def_cfa_offset 32
    frame-setup STRXui killed $x19, $sp, 2 :: (store (s64) into %stack.0)
    $fp = frame-setup ADDXri $sp, 0, 0
    frame-setup CFI_INSTRUCTION def_cfa $w29, 32
    frame-setup CFI_INSTRUCTION offset $w19, -16
    frame-setup CFI_INSTRUCTION offset $w30, -24
    frame-setup CFI_INSTRUCTION offset $w29, -32
    $x19 = ORRXrs $xzr, $x0, 0
    DBG_VALUE $x19, $noreg, !19, !DIExpression(), debug-location !20
    BL @bar, csr_aarch64_aapcs, implicit-def dead $lr, implicit $sp, implicit killed $w0, implicit-def $sp, debug-location !22
    $x0 = ORRXrs $xzr, killed $x19, 0, debug-location !23
    frame-destroy CFI_INSTRUCTION def_cfa $wsp, 32
    $x19 = frame-destroy LDRXui $sp, 2, debug-location !23 :: (load (s64) from %stack.0)
    DBG_VALUE $x0, $noreg, !19, !DIExpression(DW_OP_LLVM_entry_value, 1), debug-location !20
    early-clobber $sp, $fp, $lr = frame-destroy LDPXpost $sp, 4, debug-location !23 :: (load (s64) from %stack.2), (load (s64) from %stack.1)
    frame-destroy CFI_INSTRUCTION def_cfa_offset 0
    frame-destroy CFI_INSTRUCTION restore $w19
    frame-destroy CFI_INSTRUCTION restore $w30
    frame-destroy CFI_INSTRUCTION restore $w29
    RET undef $lr, implicit killed $x0, debug-location !23
...

# Generated from the following C reproducer:
#
# void bar(int);
# long foo(long p) {
#   bar(p);
#   return p;
# }
#
# Verify that we are able to emit a call site value for the 32-bit W0 parameter
# using a subreg of the preserved register storing the 64-bit value of p.

# CHECK: DW_TAG_call_site_parameter
# CHECK-NEXT: DW_AT_location (DW_OP_reg0 W0)
# CHECK-NEXT: DW_AT_call_value (DW_OP_breg19 W19+0)
