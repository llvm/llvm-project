;; Test that AMDGPU targets use contiguous counter allocation with CUID-based naming.
;; This avoids linker reordering issues where individual __profc_* symbols could be
;; placed in any order within the section.

; RUN: opt %s -mtriple=amdgcn-amd-amdhsa -passes=instrprof -S | FileCheck %s

;; Simulate a module with CUID (as generated by HIP compilation)
@__hip_cuid_abc123 = addrspace(1) global i8 0

@__profn_kernel1 = private constant [7 x i8] c"kernel1"
@__profn_kernel2 = private constant [7 x i8] c"kernel2"

;; Check that contiguous counter array is created with CUID suffix
; CHECK: @__llvm_prf_c_abc123 = protected addrspace(1) global [{{[0-9]+}} x i64] zeroinitializer, section "__llvm_prf_cnts_abc123", align 8

;; Check that contiguous uniform counter array is created for divergence tracking
; CHECK: @__profu_all_abc123 = protected addrspace(1) global [{{[0-9]+}} x i64] zeroinitializer, section "__llvm_prf_ucnts_abc123", align 8

;; Check that contiguous data array is created with CUID suffix
; CHECK: @__llvm_prf_d_abc123 = protected addrspace(1) global

;; Check that individual __profc_kernel* symbols are NOT created (contiguous mode)
; CHECK-NOT: @__profc_kernel1
; CHECK-NOT: @__profc_kernel2

define amdgpu_kernel void @kernel1() {
  call void @llvm.instrprof.increment(ptr @__profn_kernel1, i64 12345, i32 2, i32 0)
  call void @llvm.instrprof.increment(ptr @__profn_kernel1, i64 12345, i32 2, i32 1)
  ret void
}

define amdgpu_kernel void @kernel2() {
  call void @llvm.instrprof.increment(ptr @__profn_kernel2, i64 67890, i32 1, i32 0)
  ret void
}

declare void @llvm.instrprof.increment(ptr, i64, i32, i32)

;; Check that __llvm_offload_prf_<CUID> structure is created with 8 pointers
; CHECK: @__llvm_offload_prf_abc123 = addrspace(1) constant { ptr addrspace(1), ptr addrspace(1), ptr addrspace(1), ptr addrspace(1), ptr addrspace(1), ptr addrspace(1), ptr addrspace(1), ptr addrspace(1) }

;; Per-function data symbols are aliases into the contiguous __profd_all array
; CHECK: @__profd_kernel1 = protected alias
; CHECK: @__profd_kernel2 = protected alias
