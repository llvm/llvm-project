; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -S -passes=gvn < %s | FileCheck %s

declare i32 @setjmp() returns_twice
declare void @longjmp()
declare ptr @malloc(i64)

; FIXME: This is a miscompile.
define i32 @test() {
; CHECK-LABEL: define i32 @test() {
; CHECK-NEXT:    [[MALLOC:%.*]] = call noalias ptr @malloc(i64 4)
; CHECK-NEXT:    store i32 10, ptr [[MALLOC]], align 4
; CHECK-NEXT:    [[SJ:%.*]] = call i32 @setjmp()
; CHECK-NEXT:    [[CMP:%.*]] = icmp eq i32 [[SJ]], 0
; CHECK-NEXT:    br i1 [[CMP]], label %[[IF_THEN:.*]], label %[[IF_END:.*]]
; CHECK:       [[IF_THEN]]:
; CHECK-NEXT:    store i32 20, ptr [[MALLOC]], align 4
; CHECK-NEXT:    call void @longjmp()
; CHECK-NEXT:    unreachable
; CHECK:       [[IF_END]]:
; CHECK-NEXT:    ret i32 10
;
  %malloc = call noalias ptr @malloc(i64 4)
  store i32 10, ptr %malloc, align 4
  %sj = call i32 @setjmp()
  %cmp = icmp eq i32 %sj, 0
  br i1 %cmp, label %if.then, label %if.end

if.then:
  store i32 20, ptr %malloc
  call void @longjmp()
  unreachable

if.end:
  %res = load i32, ptr %malloc
  ret i32 %res
}
