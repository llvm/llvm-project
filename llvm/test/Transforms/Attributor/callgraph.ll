; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --check-globals
; RUN: opt -passes=attributor -S < %s | FileCheck %s --check-prefixes=CHECK,UPTO2,UNLIM
; RUN: opt -passes=attributor -attributor-print-call-graph -S -disable-output < %s | FileCheck %s --check-prefixes=DOT
; RUN: opt -passes=attributor --attributor-max-specializations-per-call-base=2 -S < %s | FileCheck %s --check-prefixes=CHECK,UPTO2,LIMI2
; RUN: opt -passes=attributor --attributor-max-specializations-per-call-base=0 -S < %s | FileCheck %s --check-prefixes=CHECK,LIMI0

define dso_local void @func1() {
; CHECK-LABEL: @func1(
; CHECK-NEXT:    br label [[TMP2:%.*]]
; CHECK:       1:
; CHECK-NEXT:    unreachable
; CHECK:       2:
; CHECK-NEXT:    call void @func3()
; CHECK-NEXT:    ret void
;
  %1 = icmp ne i32 0, 0
  br i1 %1, label %2, label %3

2:                                                ; preds = %0
  call void @func2()
  br label %3

3:                                                ; preds = %2, %0
  call void () @func3()
  ret void
}

declare void @func3()
declare void @func4()

define dso_local void @func2() {
; CHECK-LABEL: @func2(
; CHECK-NEXT:    call void @func4()
; CHECK-NEXT:    ret void
;
  call void @func4()
  ret void
}


define void @func5(i32 %0) {
; UPTO2-LABEL: @func5(
; UPTO2-NEXT:    [[TMP2:%.*]] = icmp ne i32 [[TMP0:%.*]], 0
; UPTO2-NEXT:    [[TMP3:%.*]] = select i1 [[TMP2]], ptr @func4, ptr @func3
; UPTO2-NEXT:    [[TMP4:%.*]] = icmp eq ptr [[TMP3]], @func3
; UPTO2-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP6:%.*]]
; UPTO2:       5:
; UPTO2-NEXT:    call void @func3()
; UPTO2-NEXT:    br label [[TMP9:%.*]]
; UPTO2:       6:
; UPTO2-NEXT:    br i1 true, label [[TMP7:%.*]], label [[TMP8:%.*]]
; UPTO2:       7:
; UPTO2-NEXT:    call void @func4()
; UPTO2-NEXT:    br label [[TMP9]]
; UPTO2:       8:
; UPTO2-NEXT:    unreachable
; UPTO2:       9:
; UPTO2-NEXT:    ret void
;
; LIMI0-LABEL: @func5(
; LIMI0-NEXT:    [[TMP2:%.*]] = icmp ne i32 [[TMP0:%.*]], 0
; LIMI0-NEXT:    [[TMP3:%.*]] = select i1 [[TMP2]], ptr @func4, ptr @func3
; LIMI0-NEXT:    call void [[TMP3]](), !callees !0
; LIMI0-NEXT:    ret void
;
  %2 = icmp ne i32 %0, 0
  %3 = select i1 %2, ptr @func4, ptr @func3
  call void () %3()
  ret void
}

define i32 @musttailCall(i32 %0) {
; CHECK-LABEL: @musttailCall(
; CHECK-NEXT:    [[TMP2:%.*]] = icmp ne i32 [[TMP0:%.*]], 0
; CHECK-NEXT:    [[TMP3:%.*]] = select i1 [[TMP2]], ptr @func4, ptr @func3
; CHECK-NEXT:    [[C:%.*]] = musttail call i32 [[TMP3]](i32 0)
; CHECK-NEXT:    ret i32 [[C]]
;
  %2 = icmp ne i32 %0, 0
  %3 = select i1 %2, ptr @func4, ptr @func3
  %c = musttail call i32 (i32) %3(i32 0)
  ret i32 %c
}

declare i32 @retI32()
declare void @takeI32(i32)
declare float @retFloatTakeFloat(float)
declare void @void()

define i32 @non_matching_fp1(i1 %c1, i1 %c2, i1 %c) {
; UNLIM-LABEL: @non_matching_fp1(
; UNLIM-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; UNLIM-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr @void
; UNLIM-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; UNLIM-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[FP]], @takeI32
; UNLIM-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; UNLIM:       2:
; UNLIM-NEXT:    [[CALL1:%.*]] = call i32 @takeI32(i32 42)
; UNLIM-NEXT:    br label [[TMP15:%.*]]
; UNLIM:       3:
; UNLIM-NEXT:    [[TMP4:%.*]] = icmp eq ptr [[FP]], @retI32
; UNLIM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP6:%.*]]
; UNLIM:       5:
; UNLIM-NEXT:    [[CALL2:%.*]] = call i32 @retI32(i32 42)
; UNLIM-NEXT:    br label [[TMP15]]
; UNLIM:       6:
; UNLIM-NEXT:    [[TMP7:%.*]] = icmp eq ptr [[FP]], @void
; UNLIM-NEXT:    br i1 [[TMP7]], label [[TMP8:%.*]], label [[TMP9:%.*]]
; UNLIM:       8:
; UNLIM-NEXT:    [[CALL3:%.*]] = call i32 @void(i32 42)
; UNLIM-NEXT:    br label [[TMP15]]
; UNLIM:       9:
; UNLIM-NEXT:    br i1 true, label [[TMP10:%.*]], label [[TMP14:%.*]]
; UNLIM:       10:
; UNLIM-NEXT:    [[TMP11:%.*]] = bitcast i32 42 to float
; UNLIM-NEXT:    [[TMP12:%.*]] = call float @retFloatTakeFloat(float [[TMP11]])
; UNLIM-NEXT:    [[TMP13:%.*]] = bitcast float [[TMP12]] to i32
; UNLIM-NEXT:    br label [[TMP15]]
; UNLIM:       14:
; UNLIM-NEXT:    unreachable
; UNLIM:       15:
; UNLIM-NEXT:    [[CALL_PHI:%.*]] = phi i32 [ [[CALL1]], [[TMP2]] ], [ [[CALL2]], [[TMP5]] ], [ [[CALL3]], [[TMP8]] ], [ [[TMP13]], [[TMP10]] ]
; UNLIM-NEXT:    ret i32 [[CALL_PHI]]
;
; LIMI2-LABEL: @non_matching_fp1(
; LIMI2-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; LIMI2-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr @void
; LIMI2-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; LIMI2-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[FP]], @takeI32
; LIMI2-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; LIMI2:       2:
; LIMI2-NEXT:    [[CALL1:%.*]] = call i32 @takeI32(i32 42)
; LIMI2-NEXT:    br label [[TMP7:%.*]]
; LIMI2:       3:
; LIMI2-NEXT:    [[TMP4:%.*]] = icmp eq ptr [[FP]], @retI32
; LIMI2-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP6:%.*]]
; LIMI2:       5:
; LIMI2-NEXT:    [[CALL2:%.*]] = call i32 @retI32(i32 42)
; LIMI2-NEXT:    br label [[TMP7]]
; LIMI2:       6:
; LIMI2-NEXT:    [[CALL3:%.*]] = call i32 [[FP]](i32 42), !callees !0
; LIMI2-NEXT:    br label [[TMP7]]
; LIMI2:       7:
; LIMI2-NEXT:    [[CALL_PHI:%.*]] = phi i32 [ [[CALL1]], [[TMP2]] ], [ [[CALL2]], [[TMP5]] ], [ [[CALL3]], [[TMP6]] ]
; LIMI2-NEXT:    ret i32 [[CALL_PHI]]
;
; LIMI0-LABEL: @non_matching_fp1(
; LIMI0-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; LIMI0-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr @void
; LIMI0-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; LIMI0-NEXT:    [[CALL:%.*]] = call i32 [[FP]](i32 42), !callees !1
; LIMI0-NEXT:    ret i32 [[CALL]]
;
  %fp1 = select i1 %c1, ptr @retI32, ptr @takeI32
  %fp2 = select i1 %c2, ptr @retFloatTakeFloat, ptr @void
  %fp = select i1 %c, ptr %fp1, ptr %fp2
  %call = call i32 %fp(i32 42)
  ret i32 %call
}

define void @non_matching_fp2(i1 %c1, i1 %c2, i1 %c, ptr %unknown) {
; UNLIM-LABEL: @non_matching_fp2(
; UNLIM-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; UNLIM-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr [[UNKNOWN:%.*]]
; UNLIM-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; UNLIM-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[FP]], @takeI32
; UNLIM-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; UNLIM:       2:
; UNLIM-NEXT:    call void @takeI32()
; UNLIM-NEXT:    br label [[TMP10:%.*]]
; UNLIM:       3:
; UNLIM-NEXT:    [[TMP4:%.*]] = icmp eq ptr [[FP]], @retI32
; UNLIM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP6:%.*]]
; UNLIM:       5:
; UNLIM-NEXT:    call void @retI32()
; UNLIM-NEXT:    br label [[TMP10]]
; UNLIM:       6:
; UNLIM-NEXT:    [[TMP7:%.*]] = icmp eq ptr [[FP]], @retFloatTakeFloat
; UNLIM-NEXT:    br i1 [[TMP7]], label [[TMP8:%.*]], label [[TMP9:%.*]]
; UNLIM:       8:
; UNLIM-NEXT:    call void @retFloatTakeFloat()
; UNLIM-NEXT:    br label [[TMP10]]
; UNLIM:       9:
; UNLIM-NEXT:    call void [[FP]]()
; UNLIM-NEXT:    br label [[TMP10]]
; UNLIM:       10:
; UNLIM-NEXT:    ret void
;
; LIMI2-LABEL: @non_matching_fp2(
; LIMI2-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; LIMI2-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr [[UNKNOWN:%.*]]
; LIMI2-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; LIMI2-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[FP]], @takeI32
; LIMI2-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; LIMI2:       2:
; LIMI2-NEXT:    call void @takeI32()
; LIMI2-NEXT:    br label [[TMP7:%.*]]
; LIMI2:       3:
; LIMI2-NEXT:    [[TMP4:%.*]] = icmp eq ptr [[FP]], @retI32
; LIMI2-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP6:%.*]]
; LIMI2:       5:
; LIMI2-NEXT:    call void @retI32()
; LIMI2-NEXT:    br label [[TMP7]]
; LIMI2:       6:
; LIMI2-NEXT:    call void [[FP]]()
; LIMI2-NEXT:    br label [[TMP7]]
; LIMI2:       7:
; LIMI2-NEXT:    ret void
;
; LIMI0-LABEL: @non_matching_fp2(
; LIMI0-NEXT:    [[FP1:%.*]] = select i1 [[C1:%.*]], ptr @retI32, ptr @takeI32
; LIMI0-NEXT:    [[FP2:%.*]] = select i1 [[C2:%.*]], ptr @retFloatTakeFloat, ptr [[UNKNOWN:%.*]]
; LIMI0-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr [[FP1]], ptr [[FP2]]
; LIMI0-NEXT:    call void [[FP]]()
; LIMI0-NEXT:    ret void
;
  %fp1 = select i1 %c1, ptr @retI32, ptr @takeI32
  %fp2 = select i1 %c2, ptr @retFloatTakeFloat, ptr %unknown
  %fp = select i1 %c, ptr %fp1, ptr %fp2
  call void %fp()
  ret void
}

define i32 @non_matching_unknown(i1 %c, ptr %fn) {
; UPTO2-LABEL: @non_matching_unknown(
; UPTO2-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr @retI32, ptr [[FN:%.*]]
; UPTO2-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[FP]], @retI32
; UPTO2-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; UPTO2:       2:
; UPTO2-NEXT:    [[CALL1:%.*]] = call i32 @retI32(i32 42)
; UPTO2-NEXT:    br label [[TMP4:%.*]]
; UPTO2:       3:
; UPTO2-NEXT:    [[CALL2:%.*]] = call i32 [[FP]](i32 42)
; UPTO2-NEXT:    br label [[TMP4]]
; UPTO2:       4:
; UPTO2-NEXT:    [[CALL_PHI:%.*]] = phi i32 [ [[CALL1]], [[TMP2]] ], [ [[CALL2]], [[TMP3]] ]
; UPTO2-NEXT:    ret i32 [[CALL_PHI]]
;
; LIMI0-LABEL: @non_matching_unknown(
; LIMI0-NEXT:    [[FP:%.*]] = select i1 [[C:%.*]], ptr @retI32, ptr [[FN:%.*]]
; LIMI0-NEXT:    [[CALL:%.*]] = call i32 [[FP]](i32 42)
; LIMI0-NEXT:    ret i32 [[CALL]]
;
  %fp = select i1 %c, ptr @retI32, ptr %fn
  %call = call i32 %fp(i32 42)
  ret i32 %call
}

define void @broker(ptr %unknown) !callback !0 {
; CHECK-LABEL: @broker(
; CHECK-NEXT:    call void [[UNKNOWN:%.*]]()
; CHECK-NEXT:    ret void
;
  call void %unknown()
  ret void
}

define void @func6() {
; CHECK-LABEL: @func6(
; CHECK-NEXT:    call void @broker(ptr nocapture nofree noundef nonnull @func3)
; CHECK-NEXT:    ret void
;
  call void @broker(ptr @func3)
  ret void
}

define void @func7(ptr %unknown) {
; UPTO2-LABEL: @func7(
; UPTO2-NEXT:    [[TMP1:%.*]] = icmp eq ptr [[UNKNOWN:%.*]], @func3
; UPTO2-NEXT:    br i1 [[TMP1]], label [[TMP2:%.*]], label [[TMP3:%.*]]
; UPTO2:       2:
; UPTO2-NEXT:    call void @func3()
; UPTO2-NEXT:    br label [[TMP6:%.*]]
; UPTO2:       3:
; UPTO2-NEXT:    br i1 true, label [[TMP4:%.*]], label [[TMP5:%.*]]
; UPTO2:       4:
; UPTO2-NEXT:    call void @func4()
; UPTO2-NEXT:    br label [[TMP6]]
; UPTO2:       5:
; UPTO2-NEXT:    unreachable
; UPTO2:       6:
; UPTO2-NEXT:    ret void
;
; LIMI0-LABEL: @func7(
; LIMI0-NEXT:    call void [[UNKNOWN:%.*]](), !callees !0
; LIMI0-NEXT:    ret void
;
  call void %unknown(), !callees !2
  ret void
}

; Check there's no crash if something that isn't a function appears in !callees
define void @undef_in_callees() {
; UNLIM-LABEL: @undef_in_callees(
; UNLIM-NEXT:  cond.end.i:
; UNLIM-NEXT:    call void undef(ptr undef, i32 undef, ptr undef), !callees !2
; UNLIM-NEXT:    ret void
;
; LIMI2-LABEL: @undef_in_callees(
; LIMI2-NEXT:  cond.end.i:
; LIMI2-NEXT:    call void undef(ptr undef, i32 undef, ptr undef), !callees !3
; LIMI2-NEXT:    ret void
;
; LIMI0-LABEL: @undef_in_callees(
; LIMI0-NEXT:  cond.end.i:
; LIMI0-NEXT:    call void undef(ptr undef, i32 undef, ptr undef), !callees !4
; LIMI0-NEXT:    ret void
;
cond.end.i:
  call void undef(ptr undef, i32 undef, ptr undef), !callees !3
  ret void
}

!0 = !{!1}
!1 = !{i64 0, i1 false}
!2 = !{ptr @func3, ptr @func4}
!3 = distinct !{ptr undef, ptr null}

; UTC_ARGS: --disable

; DOT-DAG: Node[[FUNC1:0x[a-z0-9]+]] [shape=record,label="{func1}"];
; DOT-DAG: Node[[FUNC2:0x[a-z0-9]+]] [shape=record,label="{func2}"];
; DOT-DAG: Node[[FUNC3:0x[a-z0-9]+]] [shape=record,label="{func3}"];
; DOT-DAG: Node[[FUNC4:0x[a-z0-9]+]] [shape=record,label="{func4}"];
; DOT-DAG: Node[[FUNC5:0x[a-z0-9]+]] [shape=record,label="{func5}"];
; DOT-DAG: Node[[FUNC6:0x[a-z0-9]+]] [shape=record,label="{func6}"];
; DOT-DAG: Node[[FUNC7:0x[a-z0-9]+]] [shape=record,label="{func7}"];

; DOT-DAG: Node[[BROKER:0x[a-z0-9]+]] [shape=record,label="{broker}"];

; DOT-DAG: Node[[FUNC1]] -> Node[[FUNC3]];
; DOT-DAG: Node[[FUNC2]] -> Node[[FUNC4]];
; DOT-DAG: Node[[FUNC5]] -> Node[[FUNC3]];
; DOT-DAG: Node[[FUNC5]] -> Node[[FUNC4]];

; DOT-DAG: Node[[FUNC6]] -> Node[[BROKER]];

; This one gets added because of the callback metadata.
; DOT-DAG: Node[[FUNC6]] -> Node[[FUNC3]];

; These ones are added because of the callees metadata.
; DOT-DAG: Node[[FUNC7]] -> Node[[FUNC3]];
; DOT-DAG: Node[[FUNC7]] -> Node[[FUNC4]];
;.
; UNLIM: [[META0:![0-9]+]] = !{!1}
; UNLIM: [[META1:![0-9]+]] = !{i64 0, i1 false}
; UNLIM: [[META2:![0-9]+]] = distinct !{ptr undef, ptr null}
;.
; LIMI2: [[META0:![0-9]+]] = !{ptr @void, ptr @retFloatTakeFloat}
; LIMI2: [[META1:![0-9]+]] = !{!2}
; LIMI2: [[META2:![0-9]+]] = !{i64 0, i1 false}
; LIMI2: [[META3:![0-9]+]] = distinct !{ptr undef, ptr null}
;.
; LIMI0: [[META0:![0-9]+]] = !{ptr @func3, ptr @func4}
; LIMI0: [[META1:![0-9]+]] = !{ptr @takeI32, ptr @retI32, ptr @void, ptr @retFloatTakeFloat}
; LIMI0: [[META2:![0-9]+]] = !{!3}
; LIMI0: [[META3:![0-9]+]] = !{i64 0, i1 false}
; LIMI0: [[META4:![0-9]+]] = distinct !{ptr undef, ptr null}
;.
;; NOTE: These prefixes are unused and the list is autogenerated. Do not add tests below this line:
; DOT: {{.*}}
