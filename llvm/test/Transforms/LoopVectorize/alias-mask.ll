; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --filter-out-after "^scalar.ph:" --version 5
; RUN: opt -S -force-partial-aliasing-vectorization -prefer-predicate-over-epilogue=predicate-dont-vectorize -force-vector-width=2 -passes=loop-vectorize  %s | FileCheck %s
; RUN: opt -S -force-partial-aliasing-vectorization -prefer-predicate-over-epilogue=predicate-dont-vectorize -force-vector-interleave=2 -force-vector-width=2 -passes=loop-vectorize  %s | FileCheck %s
; RUN: opt -S -force-partial-aliasing-vectorization -prefer-predicate-over-epilogue=predicate-dont-vectorize -epilogue-vectorization-force-VF=2 -force-vector-interleave=2 -force-vector-width=2 -passes=loop-vectorize  %s | FileCheck %s

; Note: -force-vector-interleave and -epilogue-vectorization-force-VF does not
; change the results as alias-masking is not supported with interleaving or
; epilogue vectorization.

define void @alias_mask(ptr noalias %a, ptr %b, ptr %c, i64 %n) {
; CHECK-LABEL: define void @alias_mask(
; CHECK-SAME: ptr noalias [[A:%.*]], ptr [[B:%.*]], ptr [[C:%.*]], i64 [[N:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[B3:%.*]] = ptrtoaddr ptr [[B]] to i64
; CHECK-NEXT:    [[C2:%.*]] = ptrtoaddr ptr [[C]] to i64
; CHECK-NEXT:    [[CMP11:%.*]] = icmp sgt i64 [[N]], 0
; CHECK-NEXT:    br i1 [[CMP11]], label %[[FOR_BODY_PREHEADER:.*]], [[EXIT:label %.*]]
; CHECK:       [[FOR_BODY_PREHEADER]]:
; CHECK-NEXT:    br label %[[VECTOR_MIN_VF_CHECK:.*]]
; CHECK:       [[VECTOR_MIN_VF_CHECK]]:
; CHECK-NEXT:    [[TMP12:%.*]] = inttoptr i64 [[B3]] to ptr
; CHECK-NEXT:    [[TMP9:%.*]] = inttoptr i64 [[C2]] to ptr
; CHECK-NEXT:    [[ALIAS_MASK:%.*]] = call <2 x i1> @llvm.loop.dependence.war.mask.v2i1(ptr [[TMP12]], ptr [[TMP9]], i64 1)
; CHECK-NEXT:    [[TMP3:%.*]] = zext <2 x i1> [[ALIAS_MASK]] to <2 x i32>
; CHECK-NEXT:    [[TMP11:%.*]] = call i32 @llvm.vector.reduce.add.v2i32(<2 x i32> [[TMP3]])
; CHECK-NEXT:    [[NUM_ACTIVE_LANES:%.*]] = zext i32 [[TMP11]] to i64
; CHECK-NEXT:    [[CMP_VF:%.*]] = icmp ult i64 [[NUM_ACTIVE_LANES]], 2
; CHECK-NEXT:    br i1 [[CMP_VF]], label %[[SCALAR_PH:.*]], label %[[VECTOR_PH:.*]]
; CHECK:       [[VECTOR_PH]]:
; CHECK-NEXT:    [[TMP5:%.*]] = sub i64 [[NUM_ACTIVE_LANES]], 1
; CHECK-NEXT:    [[N_RND_UP:%.*]] = add i64 [[N]], [[TMP5]]
; CHECK-NEXT:    [[N_MOD_VF:%.*]] = urem i64 [[N_RND_UP]], [[NUM_ACTIVE_LANES]]
; CHECK-NEXT:    [[N_VEC:%.*]] = sub i64 [[N_RND_UP]], [[N_MOD_VF]]
; CHECK-NEXT:    [[TRIP_COUNT_MINUS_1:%.*]] = sub i64 [[N]], 1
; CHECK-NEXT:    [[BROADCAST_SPLATINSERT:%.*]] = insertelement <2 x i64> poison, i64 [[TRIP_COUNT_MINUS_1]], i64 0
; CHECK-NEXT:    [[BROADCAST_SPLAT:%.*]] = shufflevector <2 x i64> [[BROADCAST_SPLATINSERT]], <2 x i64> poison, <2 x i32> zeroinitializer
; CHECK-NEXT:    [[BROADCAST_SPLATINSERT3:%.*]] = insertelement <2 x i64> poison, i64 [[NUM_ACTIVE_LANES]], i64 0
; CHECK-NEXT:    [[BROADCAST_SPLAT4:%.*]] = shufflevector <2 x i64> [[BROADCAST_SPLATINSERT3]], <2 x i64> poison, <2 x i32> zeroinitializer
; CHECK-NEXT:    br label %[[VECTOR_BODY:.*]]
; CHECK:       [[VECTOR_BODY]]:
; CHECK-NEXT:    [[INDEX1:%.*]] = phi i64 [ 0, %[[VECTOR_PH]] ], [ [[INDEX_NEXT:%.*]], %[[PRED_STORE_CONTINUE6:.*]] ]
; CHECK-NEXT:    [[VEC_IND:%.*]] = phi <2 x i64> [ <i64 0, i64 1>, %[[VECTOR_PH]] ], [ [[VEC_IND_NEXT:%.*]], %[[PRED_STORE_CONTINUE6]] ]
; CHECK-NEXT:    [[INDEX:%.*]] = add i64 [[INDEX1]], 0
; CHECK-NEXT:    [[TMP6:%.*]] = add i64 [[INDEX1]], 1
; CHECK-NEXT:    [[LANE_MASK:%.*]] = icmp ule <2 x i64> [[VEC_IND]], [[BROADCAST_SPLAT]]
; CHECK-NEXT:    [[MASK:%.*]] = and <2 x i1> [[LANE_MASK]], [[ALIAS_MASK]]
; CHECK-NEXT:    [[TMP8:%.*]] = extractelement <2 x i1> [[MASK]], i32 0
; CHECK-NEXT:    br i1 [[TMP8]], label %[[PRED_LOAD_IF:.*]], label %[[PRED_LOAD_CONTINUE:.*]]
; CHECK:       [[PRED_LOAD_IF]]:
; CHECK-NEXT:    [[TMP7:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 [[INDEX]]
; CHECK-NEXT:    [[ALIAS_MASK8:%.*]] = load i8, ptr [[TMP7]], align 1
; CHECK-NEXT:    [[TMP10:%.*]] = insertelement <2 x i8> poison, i8 [[ALIAS_MASK8]], i32 0
; CHECK-NEXT:    [[TMP13:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 [[INDEX]]
; CHECK-NEXT:    [[TMP33:%.*]] = load i8, ptr [[TMP13]], align 1
; CHECK-NEXT:    [[TMP34:%.*]] = insertelement <2 x i8> poison, i8 [[TMP33]], i32 0
; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE]]
; CHECK:       [[PRED_LOAD_CONTINUE]]:
; CHECK-NEXT:    [[TMP14:%.*]] = phi <2 x i8> [ poison, %[[VECTOR_BODY]] ], [ [[TMP10]], %[[PRED_LOAD_IF]] ]
; CHECK-NEXT:    [[TMP35:%.*]] = phi <2 x i8> [ poison, %[[VECTOR_BODY]] ], [ [[TMP34]], %[[PRED_LOAD_IF]] ]
; CHECK-NEXT:    [[TMP36:%.*]] = extractelement <2 x i1> [[MASK]], i32 1
; CHECK-NEXT:    br i1 [[TMP36]], label %[[PRED_LOAD_IF3:.*]], label %[[PRED_LOAD_CONTINUE4:.*]]
; CHECK:       [[PRED_LOAD_IF3]]:
; CHECK-NEXT:    [[TMP17:%.*]] = getelementptr inbounds i8, ptr [[A]], i64 [[TMP6]]
; CHECK-NEXT:    [[TMP18:%.*]] = load i8, ptr [[TMP17]], align 1
; CHECK-NEXT:    [[TMP19:%.*]] = insertelement <2 x i8> [[TMP14]], i8 [[TMP18]], i32 1
; CHECK-NEXT:    [[ALIAS_MASK0:%.*]] = getelementptr inbounds i8, ptr [[B]], i64 [[TMP6]]
; CHECK-NEXT:    [[ALIAS_MASK1:%.*]] = load i8, ptr [[ALIAS_MASK0]], align 1
; CHECK-NEXT:    [[ALIAS_MASK2:%.*]] = insertelement <2 x i8> [[TMP35]], i8 [[ALIAS_MASK1]], i32 1
; CHECK-NEXT:    br label %[[PRED_LOAD_CONTINUE4]]
; CHECK:       [[PRED_LOAD_CONTINUE4]]:
; CHECK-NEXT:    [[TMP38:%.*]] = phi <2 x i8> [ [[TMP14]], %[[PRED_LOAD_CONTINUE]] ], [ [[TMP19]], %[[PRED_LOAD_IF3]] ]
; CHECK-NEXT:    [[ALIAS_MASK4:%.*]] = phi <2 x i8> [ [[TMP35]], %[[PRED_LOAD_CONTINUE]] ], [ [[ALIAS_MASK2]], %[[PRED_LOAD_IF3]] ]
; CHECK-NEXT:    [[ALIAS_MASK5:%.*]] = select <2 x i1> [[MASK]], <2 x i8> [[TMP38]], <2 x i8> splat (i8 1)
; CHECK-NEXT:    [[ALIAS_MASK6:%.*]] = sdiv <2 x i8> [[ALIAS_MASK4]], [[ALIAS_MASK5]]
; CHECK-NEXT:    [[ALIAS_MASK7:%.*]] = extractelement <2 x i1> [[MASK]], i32 0
; CHECK-NEXT:    br i1 [[ALIAS_MASK7]], label %[[PRED_STORE_IF:.*]], label %[[PRED_STORE_CONTINUE:.*]]
; CHECK:       [[PRED_STORE_IF]]:
; CHECK-NEXT:    [[TMP15:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 [[INDEX]]
; CHECK-NEXT:    [[ALIAS_MASK9:%.*]] = extractelement <2 x i8> [[ALIAS_MASK6]], i32 0
; CHECK-NEXT:    store i8 [[ALIAS_MASK9]], ptr [[TMP15]], align 1
; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE]]
; CHECK:       [[PRED_STORE_CONTINUE]]:
; CHECK-NEXT:    [[TMP30:%.*]] = extractelement <2 x i1> [[MASK]], i32 1
; CHECK-NEXT:    br i1 [[TMP30]], label %[[PRED_STORE_IF5:.*]], label %[[PRED_STORE_CONTINUE6]]
; CHECK:       [[PRED_STORE_IF5]]:
; CHECK-NEXT:    [[TMP31:%.*]] = getelementptr inbounds i8, ptr [[C]], i64 [[TMP6]]
; CHECK-NEXT:    [[TMP32:%.*]] = extractelement <2 x i8> [[ALIAS_MASK6]], i32 1
; CHECK-NEXT:    store i8 [[TMP32]], ptr [[TMP31]], align 1
; CHECK-NEXT:    br label %[[PRED_STORE_CONTINUE6]]
; CHECK:       [[PRED_STORE_CONTINUE6]]:
; CHECK-NEXT:    [[INDEX_NEXT]] = add i64 [[INDEX1]], [[NUM_ACTIVE_LANES]]
; CHECK-NEXT:    [[VEC_IND_NEXT]] = add <2 x i64> [[VEC_IND]], [[BROADCAST_SPLAT4]]
; CHECK-NEXT:    [[TMP16:%.*]] = icmp eq i64 [[INDEX_NEXT]], [[N_VEC]]
; CHECK-NEXT:    br i1 [[TMP16]], label %[[MIDDLE_BLOCK:.*]], label %[[VECTOR_BODY]], !llvm.loop [[LOOP0:![0-9]+]]
; CHECK:       [[MIDDLE_BLOCK]]:
; CHECK-NEXT:    br [[EXIT_LOOPEXIT:label %.*]]
; CHECK:       [[SCALAR_PH]]:
;

entry:
  %cmp11 = icmp sgt i64 %n, 0
  br i1 %cmp11, label %for.body, label %exit

for.body:                                         ; preds = %for.body.preheader, %for.body
  %iv = phi i64 [ 0, %entry ], [ %iv.next, %for.body ]
  %gep.a = getelementptr inbounds i8, ptr %a, i64 %iv
  %load.a = load i8, ptr %gep.a, align 1
  %gep.b = getelementptr inbounds i8, ptr %b, i64 %iv
  %load.b = load i8, ptr %gep.b, align 1
  %div = sdiv i8 %load.b, %load.a
  %gep.c = getelementptr inbounds i8, ptr %c, i64 %iv
  store i8 %div, ptr %gep.c, align 1
  %iv.next = add nuw nsw i64 %iv, 1
  %exitcond.not = icmp eq i64 %iv.next, %n
  br i1 %exitcond.not, label %exit, label %for.body

exit:                                 ; preds = %for.body, %entry
  ret void
}

;.
; CHECK: [[LOOP0]] = distinct !{[[LOOP0]], [[META1:![0-9]+]], [[META2:![0-9]+]]}
; CHECK: [[META1]] = !{!"llvm.loop.isvectorized", i32 1}
; CHECK: [[META2]] = !{!"llvm.loop.unroll.runtime.disable"}
;.
