; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt < %s -passes=loop-vectorize -mtriple=aarch64-unknown-linux-gnu -S | FileCheck %s --check-prefix=AARCH64
; RUN: opt < %s -passes=loop-vectorize -mtriple=x86_64-unknown-linux-gnu -S | FileCheck %s --check-prefix=X86_64

; Testcase extraÃ­do de ElemAttribute.cpp
; Foca no loop while.body que copia elementos i16

target datalayout = "e-m:e-p:64:64-i64:64-i128:128-n32:64-S128"

define void @test_copy_loop(ptr %theFirst, ptr %theLast, ptr %dest_base, ptr %m_size_ptr) {
; AARCH64-LABEL: define void @test_copy_loop(
; AARCH64-SAME: ptr [[THEFIRST:%.*]], ptr [[THELAST:%.*]], ptr [[DEST_BASE:%.*]], ptr [[M_SIZE_PTR:%.*]]) {
; AARCH64:       vector.body:
; AARCH64:         [[INDEX:%.*]] = phi i64 [ 0, %vector.ph ], [ [[INDEX_NEXT:%.*]], %vector.body ]
; AARCH64:         [[WIDE_LOAD0:%.*]] = load <8 x i16>, ptr
; AARCH64:         [[WIDE_LOAD1:%.*]] = load <8 x i16>, ptr
; AARCH64:         store <8 x i16> [[WIDE_LOAD0]], ptr
; AARCH64:         store <8 x i16> [[WIDE_LOAD1]], ptr
; AARCH64:         [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 16
; AARCH64:         br i1 {{.*}}, label %middle.block, label %vector.body
;
; X86_64-LABEL: define void @test_copy_loop(
; X86_64-SAME: ptr [[THEFIRST:%.*]], ptr [[THELAST:%.*]], ptr [[DEST_BASE:%.*]], ptr [[M_SIZE_PTR:%.*]]) {
; X86_64:       vector.body:
; X86_64:         [[INDEX:%.*]] = phi i64 [ 0, %vector.ph ], [ [[INDEX_NEXT:%.*]], %vector.body ]
; X86_64:         [[WIDE_LOAD0:%.*]] = load <2 x i16>, ptr
; X86_64:         [[WIDE_LOAD1:%.*]] = load <2 x i16>, ptr
; X86_64:         store <2 x i16> [[WIDE_LOAD0]], ptr
; X86_64:         store <2 x i16> [[WIDE_LOAD1]], ptr
; X86_64:         [[INDEX_NEXT]] = add nuw i64 [[INDEX]], 4
; X86_64:         br i1 {{.*}}, label %middle.block, label %vector.body

entry:
  %0 = load i64, ptr %m_size_ptr, align 8
  %add.ptr.i = getelementptr inbounds nuw i16, ptr %dest_base, i64 %0
  %cmp.not = icmp eq ptr %theFirst, %theLast
  br i1 %cmp.not, label %cleanup, label %while.body.preheader

while.body.preheader:
  br label %while.body

while.body:
  %theFirst.addr.0112 = phi ptr [ %incdec.ptr9, %while.body ], [ %theFirst, %while.body.preheader ]
  %thePointer.0111 = phi ptr [ %incdec.ptr, %while.body ], [ %add.ptr.i, %while.body.preheader ]
  %1 = load i16, ptr %theFirst.addr.0112, align 2
  store i16 %1, ptr %thePointer.0111, align 2
  %incdec.ptr = getelementptr inbounds nuw i8, ptr %thePointer.0111, i64 2
  %2 = load i64, ptr %m_size_ptr, align 8
  %inc = add i64 %2, 1
  store i64 %inc, ptr %m_size_ptr, align 8
  %incdec.ptr9 = getelementptr inbounds nuw i8, ptr %theFirst.addr.0112, i64 2
  %cmp7.not = icmp eq ptr %incdec.ptr9, %theLast
  br i1 %cmp7.not, label %cleanup.loopexit, label %while.body

cleanup.loopexit:
  br label %cleanup

cleanup:
  ret void
}
