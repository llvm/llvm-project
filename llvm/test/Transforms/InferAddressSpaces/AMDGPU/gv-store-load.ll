; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -S -mtriple=amdgcn-amd-amdhsa -passes=infer-address-spaces %s | FileCheck %s

@WGCopy = internal unnamed_addr addrspace(3) global ptr poison, align 16

; Function Attrs: nounwind
define void @gv_store_load() {
; CHECK-LABEL: define void @gv_store_load() {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[AGG_TMP1617:%.*]] = alloca i64, align 8, addrspace(5)
; CHECK-NEXT:    [[IS:%.*]] = call i1 @is_leader()
; CHECK-NEXT:    br i1 [[IS]], label %[[LEADER:.*]], label %[[MERGE:.*]]
; CHECK:       [[LEADER]]:
; CHECK-NEXT:    br label %[[MERGE]]
; CHECK:       [[MERGE]]:
; CHECK-NEXT:    [[AGG_TMP_I_SROA_0_0:%.*]] = phi ptr addrspace(5) [ [[AGG_TMP1617]], %[[LEADER]] ], [ undef, %[[ENTRY]] ]
; CHECK-NEXT:    [[TMP0:%.*]] = addrspacecast ptr addrspace(5) [[AGG_TMP_I_SROA_0_0]] to ptr
; CHECK-NEXT:    br i1 [[IS]], label %[[LEADER_I:.*]], label %[[EXIT:.*]]
; CHECK:       [[LEADER_I]]:
; CHECK-NEXT:    store ptr [[TMP0]], ptr addrspace(3) @WGCopy, align 16
; CHECK-NEXT:    br label %[[EXIT]]
; CHECK:       [[EXIT]]:
; CHECK-NEXT:    [[TMP1:%.*]] = load ptr, ptr addrspace(3) @WGCopy, align 16
; CHECK-NEXT:    [[AGG_TMP_I_SROA_0_0_COPYLOAD:%.*]] = addrspacecast ptr [[TMP1]] to ptr addrspace(5)
; CHECK-NEXT:    [[TMP2:%.*]] = load i64, ptr addrspace(5) [[AGG_TMP_I_SROA_0_0_COPYLOAD]], align 8
; CHECK-NEXT:    ret void
;
entry:
  %agg.tmp1617 = alloca i64, align 8, addrspace(5)
  %is = call i1 @is_leader()
  br i1 %is, label %leader, label %merge

leader:                                      ; preds = %entry
  %group.ascast.i = addrspacecast ptr addrspace(5) %agg.tmp1617 to ptr
  br label %merge

merge:                                          ; preds = %leader, %entry
  %agg.tmp.i.sroa.0.0 = phi ptr [ %group.ascast.i, %leader ], [ undef, %entry ]
  br i1 %is, label %leader.i, label %exit

leader.i:                                        ; preds = %merge
  store ptr %agg.tmp.i.sroa.0.0, ptr addrspace(3) @WGCopy, align 16
  br label %exit

exit: ; preds = %leader.i, %merge
  %agg.tmp.i.sroa.0.0.copyload = load ptr, ptr addrspace(3) @WGCopy, align 16
  %15 = load i64, ptr %agg.tmp.i.sroa.0.0.copyload, align 8
  ret void
}

declare i1 @is_leader()
