; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; Test case for foldBinopOfReductions with Add operator
; RUN: opt -S -passes=vector-combine %s | FileCheck %s

define i32 @test_add_add_reduction(i32 %a, <4 x i32> %b, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_add_add_reduction(
; CHECK-SAME: i32 [[A:%.*]], <4 x i32> [[B:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add <4 x i32> [[B]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[ADD2:%.*]] = add i32 [[TMP2]], [[A]]
; CHECK-NEXT:    ret i32 [[ADD2]]
;
  ; Test case 1: add (add (vector_reduce_add b, a), vector_reduce_add c)
  %reduce_b = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %b)
  %add1 = add i32 %reduce_b, %a
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  %add2 = add i32 %add1, %reduce_c
  ret i32 %add2
}

define i32 @test_add_add_reduction_reverse(i32 %a, <4 x i32> %b, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_add_add_reduction_reverse(
; CHECK-SAME: i32 [[A:%.*]], <4 x i32> [[B:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add <4 x i32> [[B]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[ADD2:%.*]] = add i32 [[TMP2]], [[A]]
; CHECK-NEXT:    ret i32 [[ADD2]]
;
  ; Test case 2: add (add (a, vector_reduce_add b), vector_reduce_add c)
  %reduce_b = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %b)
  %add1 = add i32 %a, %reduce_b
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  %add2 = add i32 %add1, %reduce_c
  ret i32 %add2
}

define i32 @test_add_reduction_add(i32 %c, <4 x i32> %a, <4 x i32> %b) {
; CHECK-LABEL: define i32 @test_add_reduction_add(
; CHECK-SAME: i32 [[C:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[B:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add <4 x i32> [[B]], [[A]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[ADD2:%.*]] = add i32 [[TMP2]], [[C]]
; CHECK-NEXT:    ret i32 [[ADD2]]
;
  ; Test case 3: add (vector_reduce_add a, add (vector_reduce_add b, c))
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_b = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %b)
  %add1 = add i32 %reduce_b, %c
  %add2 = add i32 %reduce_a, %add1
  ret i32 %add2
}

; Declare the vector reduce add intrinsic
declare i32 @llvm.vector.reduce.add.v4i32(<4 x i32>)
