; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -S -passes=vector-combine %s | FileCheck %s

define i32 @test_sub_add_reduction_1(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_add_reduction_1(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[A]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = add i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; (ReduceA + B) - ReduceC
  %add = add i32 %reduce_a, %b
  %sub = sub i32 %add, %reduce_c
  ret i32 %sub
}

define i32 @test_sub_add_reduction_2(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_add_reduction_2(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[A]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = add i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; (B + ReduceA) - ReduceC
  %add = add i32 %b, %reduce_a
  %sub = sub i32 %add, %reduce_c
  ret i32 %sub
}

define i32 @test_sub_sub_reduction_1(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_sub_reduction_1(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[A]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = sub i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; (ReduceA - B) - ReduceC
  %op0 = sub i32 %reduce_a, %b
  %sub = sub i32 %op0, %reduce_c
  ret i32 %sub
}

define i32 @test_sub_sub_reduction_2(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_sub_reduction_2(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add <4 x i32> [[A]], [[C]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = sub i32 [[B]], [[TMP2]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; (B - ReduceA) - ReduceC
  %op0 = sub i32 %b, %reduce_a
  %sub = sub i32 %op0, %reduce_c
  ret i32 %sub
}

define i32 @test_sub_add_reduction_3(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_add_reduction_3(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[C]], [[A]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = sub i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; ReduceC - (ReduceA + B)
  %op0 = add i32 %reduce_a, %b
  %sub = sub i32 %reduce_c, %op0
  ret i32 %sub
}

define i32 @test_sub_add_reduction_4(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_add_reduction_4(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[C]], [[A]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = sub i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; ReduceC - (B + ReduceA)
  %op0 = add i32 %b, %reduce_a
  %sub = sub i32 %reduce_c, %op0
  ret i32 %sub
}

define i32 @test_sub_sub_reduction_3(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_sub_reduction_3(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = sub <4 x i32> [[C]], [[A]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = add i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; ReduceC - (ReduceA - B)
  %op0 = sub i32 %reduce_a, %b
  %sub = sub i32 %reduce_c, %op0
  ret i32 %sub
}

define i32 @test_sub_sub_reduction_4(i32 %b, <4 x i32> %a, <4 x i32> %c) {
; CHECK-LABEL: define i32 @test_sub_sub_reduction_4(
; CHECK-SAME: i32 [[B:%.*]], <4 x i32> [[A:%.*]], <4 x i32> [[C:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = add <4 x i32> [[C]], [[A]]
; CHECK-NEXT:    [[TMP2:%.*]] = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> [[TMP1]])
; CHECK-NEXT:    [[SUB:%.*]] = sub i32 [[TMP2]], [[B]]
; CHECK-NEXT:    ret i32 [[SUB]]
;
  %reduce_a = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %a)
  %reduce_c = call i32 @llvm.vector.reduce.add.v4i32(<4 x i32> %c)
  ; ReduceC - (B - ReduceA)
  %op0 = sub i32 %b, %reduce_a
  %sub = sub i32 %reduce_c, %op0
  ret i32 %sub
}

declare i32 @llvm.vector.reduce.add.v4i32(<4 x i32>)
