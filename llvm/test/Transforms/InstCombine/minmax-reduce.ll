; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -S -passes=instcombine < %s | FileCheck %s

declare i8 @llvm.umax.i8(i8, i8)
declare i8 @llvm.umin.i8(i8, i8)
declare i8 @llvm.smax.i8(i8, i8)
declare i8 @llvm.smin.i8(i8, i8)

declare void @use(i8)  ; helper to make multi-use tests

; ============================================================================
; umax(umax(X, C1) + C2, C3)  →  umax(X + C2, C4)
; C1 = 10, C2 = 3, C3 = 5 → C1+C2=13, umax(13,5)=13 → C4 = 13
; ============================================================================

; positive test

define i8 @umax_add_nuw(i8 %x) {
; CHECK-LABEL: @umax_add_nuw(
; CHECK:       [[ADD:%.*]] = add nuw i8 [[X:%.*]], 3
; CHECK:       [[R:%.*]] = call i8 @llvm.umax.i8(i8 [[ADD]], i8 13)
; CHECK:       ret i8 [[R]]

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 10)
  %add   = add nuw i8 %inner, 3
  %outer = call i8 @llvm.umax.i8(i8 %add, i8 5)
  ret i8 %outer
}

; negative test

define i8 @umax_add_no_nuw(i8 %x) {
; CHECK-LABEL: @umax_add_no_nuw(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umax.i8(i8 [[X:%.*]], i8 10)
; CHECK:       [[ADD:%.*]] = add i8 [[INNER]], 3
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umax.i8(i8 [[ADD]], i8 5)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 10)
  %add   = add i8 %inner, 3
  %outer = call i8 @llvm.umax.i8(i8 %add, i8 5)
  ret i8 %outer
}

; positive test

; C1 = 4, C2 = 2, C3 = 7 → 4*2=8, umax(8,7)=8 → C4 = 8
define i8 @umax_mul_nuw(i8 %x) {
; CHECK-LABEL: @umax_mul_nuw(
; CHECK:       [[MUL:%.*]] = mul nuw i8 [[X:%.*]], 2
; CHECK:       call i8 @llvm.umax.i8(i8 [[MUL]], i8 8)
; CHECK:       ret i8

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 4)
  %mul   = mul nuw i8 %inner, 2
  %outer = call i8 @llvm.umax.i8(i8 %mul, i8 7)
  ret i8 %outer
}


; negative test

define i8 @umax_mul_no_nuw(i8 %x) {
; CHECK-LABEL: @umax_mul_no_nuw(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umax.i8(i8 [[X:%.*]], i8 4)
; CHECK:       [[MUL:%.*]] = mul i8 [[INNER]], 2
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umax.i8(i8 [[MUL]], i8 7)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 4)
  %mul   = mul i8 %inner, 2
  %outer = call i8 @llvm.umax.i8(i8 %mul, i8 7)
  ret i8 %outer
}


; positive test

; C1 = 10, C2 = 3, C3 = 4 → 10-3=7, umin(7,4)=4 → C4 = 4
define i8 @umin_sub_nuw(i8 %x) {
; CHECK-LABEL: @umin_sub_nuw(
; CHECK:       [[SUB:%.*]] = sub nuw i8 [[X:%.*]], 3
; CHECK:       call i8 @llvm.umin.i8(i8 [[SUB]], i8 4)
; CHECK:       ret i8

entry:
  %inner = call i8 @llvm.umin.i8(i8 %x, i8 10)
  %sub   = sub nuw i8 %inner, 3
  %outer = call i8 @llvm.umin.i8(i8 %sub, i8 4)
  ret i8 %outer
}

; negative test

define i8 @umin_sub_no_nuw(i8 %x) {
; CHECK-LABEL: @umin_sub_no_nuw(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umin.i8(i8 [[X:%.*]], i8 10)
; CHECK:       [[SUB:%.*]] = sub i8 [[INNER]], 3
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umin.i8(i8 [[SUB]], i8 4)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umin.i8(i8 %x, i8 10)
  %sub   = sub i8 %inner, 3
  %outer = call i8 @llvm.umin.i8(i8 %sub, i8 4)
  ret i8 %outer
}




; multi-use test

define i8 @umax_add_inner_multi_use(i8 %x) {
; CHECK-LABEL: @umax_add_inner_multi_use(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umax.i8(i8 [[X:%.*]], i8 10)
; CHECK:       call void @use(i8 [[INNER]])
; CHECK:       [[ADD:%.*]] = add nuw i8 [[INNER]], 3
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umax.i8(i8 [[ADD]], i8 5)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 10)

  ; extra use
  call void @use(i8 %inner)

  %add   = add nuw i8 %inner, 3
  %outer = call i8 @llvm.umax.i8(i8 %add, i8 5)
  ret i8 %outer
}


define i8 @umax_add_binop_multi_use(i8 %x) {
; CHECK-LABEL: @umax_add_binop_multi_use(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umax.i8(i8 [[X:%.*]], i8 10)
; CHECK:       [[ADD:%.*]] = add nuw i8 [[INNER]], 3
; CHECK:       call void @use(i8 [[ADD]])
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umax.i8(i8 [[ADD]], i8 5)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umax.i8(i8 %x, i8 10)
  %add   = add nuw i8 %inner, 3

  ; extra use of binop result
  call void @use(i8 %add)

  %outer = call i8 @llvm.umax.i8(i8 %add, i8 5)
  ret i8 %outer
}


define i8 @umin_sub_inner_multi_use(i8 %x) {
; CHECK-LABEL: @umin_sub_inner_multi_use(
; CHECK:       [[INNER:%.*]] = call i8 @llvm.umin.i8(i8 [[X:%.*]], i8 10)
; CHECK:       call void @use(i8 [[INNER]])
; CHECK:       [[SUB:%.*]] = sub nuw i8 [[INNER]], 3
; CHECK:       [[OUTER:%.*]] = call i8 @llvm.umin.i8(i8 [[SUB]], i8 4)
; CHECK:       ret i8 [[OUTER]]

entry:
  %inner = call i8 @llvm.umin.i8(i8 %x, i8 10)

  call void @use(i8 %inner)

  %sub   = sub nuw i8 %inner, 3
  %outer = call i8 @llvm.umin.i8(i8 %sub, i8 4)
  ret i8 %outer
}
