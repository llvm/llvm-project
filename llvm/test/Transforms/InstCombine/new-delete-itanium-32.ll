; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -passes=instcombine -S | FileCheck %s

; Set pointer (and size_t) size to 32 bits.  This lets the declarations
; below and calls to them be recognized as special.

target datalayout = "p:32:32"

%size_t = type i32
%align_val_t = type %size_t
%nothrow_t = type { }


; operator new(size_t = unsigned int)
declare i8* @_Znwj(%size_t)

; operator new[](size_t = unsigned int)
declare i8* @_Znaj(%size_t)

; operator new(size_t = unsigned int, std::align_val_t)
declare i8* @_ZnwjSt11align_val_t(%size_t, %size_t)

; operator new[](size_t = unsigned int, std::align_val_t)
declare i8* @_ZnajSt11align_val_t(%size_t, %size_t)

; operator new(size_t = unsigned int, std::align_val_t, const std::nothrow_t&)
declare i8* @_ZnwjSt11align_val_tRKSt9nothrow_t(%size_t, %size_t, %nothrow_t*)

; operator new[](size_t = unsigned int, std::align_val_t, const std::nothrow_t&)
declare i8* @_ZnajSt11align_val_tRKSt9nothrow_t(%size_t, %size_t, %nothrow_t*)


; operator delete(void*, size_t = unsigned int)
declare void @_ZdlPvj(i8*, %size_t)

; operator delete[](void*, size_t = unsigned int)
declare void @_ZdaPvj(i8*, %size_t)

; operator delete(void*, std::align_val_t)
declare void @_ZdlPvSt11align_val_t(i8*, %align_val_t)

; operator delete[](void*, std::align_val_t)
declare void @_ZdaPvSt11align_val_t(i8*, %align_val_t)

; operator delete(void*, size_t = unsigned int, std::align_val_t)
declare void @_ZdlPvjSt11align_val_t(i8*, %size_t, %align_val_t)

; operator delete[](void*, size_t = unsigned int, std::align_val_t)
declare void @_ZdaPvjSt11align_val_t(i8*, %size_t, %align_val_t)

; operator delete(void*, std::align_val_t, const std::nothrow_t&)
declare void @_ZdlPvSt11align_val_tRKSt9nothrow_t(i8*, %align_val_t, %nothrow_t*)

; operator delete[](void*, std::align_val_t, const std::nothrow_t&)
declare void @_ZdaPvSt11align_val_tRKSt9nothrow_t(i8*, %align_val_t, %nothrow_t*)

declare void @llvm.assume(i1)


; Verify that pairs of matching calls to new/delete are eliminated.

define void @elim_new_delete_pairs() {
; CHECK-LABEL: @elim_new_delete_pairs(
; CHECK-NEXT:    ret void
;
  %nt = alloca %nothrow_t

  %nwj = call i8* @_Znwj(%size_t 32)
  call void @_ZdlPvj(i8* %nwj, %size_t 32)

  %naj = call i8* @_Znaj(%size_t 32)
  call void @_ZdaPvj(i8* %naj, %size_t 32)

  %nwja = call i8* @_ZnwjSt11align_val_t(%size_t 32, %size_t 8)
  call void @_ZdlPvSt11align_val_t(i8* %nwja, %size_t 8)

  %naja = call i8* @_ZnajSt11align_val_t(%size_t 32, %size_t 8)
  call void @_ZdaPvSt11align_val_t(i8* %naja, i32 8)

  %nwjat = call i8* @_ZnwjSt11align_val_tRKSt9nothrow_t(%size_t 32, %size_t 8, %nothrow_t* %nt)
  call void @_ZdlPvSt11align_val_tRKSt9nothrow_t(i8* %nwjat, %size_t 8, %nothrow_t* %nt)

  %najat = call i8* @_ZnajSt11align_val_tRKSt9nothrow_t(%size_t 32, %size_t 8, %nothrow_t* %nt)
  call void @_ZdaPvSt11align_val_tRKSt9nothrow_t(i8* %najat, i32 8, %nothrow_t* %nt)

  %nwja2 = call i8* @_ZnwjSt11align_val_t(%size_t 32, %size_t 8)
  call void @_ZdlPvjSt11align_val_t(i8* %nwja2, %size_t 32, %size_t 8)

  %naja2 = call i8* @_ZnajSt11align_val_t(%size_t 32, %size_t 8)
  call void @_ZdaPvjSt11align_val_t(i8* %naja2, %size_t 32, %size_t 8)

  ; Check that the alignment assume does not prevent the removal.
  %nwa3 = call i8* @_ZnajSt11align_val_t(%size_t 32, %size_t 16)

  call void @llvm.assume(i1 true) [ "align"(i8* %nwa3, i32 16) ]

  call void @_ZdaPvjSt11align_val_t(i8* %nwa3, %size_t 32, %size_t 16)

  ret void
}
