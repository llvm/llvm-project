; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -S -passes=instcombine -mtriple=amdgcn-amd-amdhsa %s | FileCheck %s

; TODO: We should use UniformityAnalysis instead of just checking for
; trivially uniform constants. In that case, this test would also be optimized.
define amdgpu_kernel void @v_wave_match_sgpr(ptr addrspace(1) %out, i32 %src) {
; CHECK-LABEL: @v_wave_match_sgpr(
; CHECK-NEXT:    [[V:%.*]] = call i32 @llvm.amdgcn.wave.match(i32 [[SRC:%.*]])
; CHECK-NEXT:    store i32 [[V]], ptr addrspace(1) [[OUT:%.*]], align 4
; CHECK-NEXT:    ret void
;
  %v = call i32 @llvm.amdgcn.wave.match(i32 %src)
  store i32 %v, ptr addrspace(1) %out
  ret void
}

define amdgpu_kernel void @v_wave_match_vgpr(i32 addrspace(1)* %out) {
; CHECK-LABEL: @v_wave_match_vgpr(
; CHECK-NEXT:    [[TID:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-NEXT:    [[V:%.*]] = call i32 @llvm.amdgcn.wave.match(i32 [[TID]])
; CHECK-NEXT:    [[TMP1:%.*]] = sext i32 [[TID]] to i64
; CHECK-NEXT:    [[OUT_PTR:%.*]] = getelementptr i32, ptr addrspace(1) [[OUT:%.*]], i64 [[TMP1]]
; CHECK-NEXT:    store i32 [[V]], ptr addrspace(1) [[OUT_PTR]], align 4
; CHECK-NEXT:    ret void
;
  %tid = call i32 @llvm.amdgcn.workitem.id.x()
  %v = call i32 @llvm.amdgcn.wave.match(i32 %tid)
  %out_ptr = getelementptr i32, i32 addrspace(1)* %out, i32 %tid
  store i32 %v, i32 addrspace(1)* %out_ptr
  ret void
}

define amdgpu_kernel void @v_wave_match_vgpr_expression(i32 addrspace(1)* %out) {
; CHECK-LABEL: @v_wave_match_vgpr_expression(
; CHECK-NEXT:    [[TID:%.*]] = call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-NEXT:    [[TID2:%.*]] = add i32 [[TID]], 1
; CHECK-NEXT:    [[V:%.*]] = call i32 @llvm.amdgcn.wave.match(i32 [[TID2]])
; CHECK-NEXT:    [[TMP1:%.*]] = sext i32 [[TID]] to i64
; CHECK-NEXT:    [[OUT_PTR:%.*]] = getelementptr i32, ptr addrspace(1) [[OUT:%.*]], i64 [[TMP1]]
; CHECK-NEXT:    store i32 [[V]], ptr addrspace(1) [[OUT_PTR]], align 4
; CHECK-NEXT:    ret void
;
  %tid = call i32 @llvm.amdgcn.workitem.id.x()
  %tid2 = add i32 %tid, 1
  %v = call i32 @llvm.amdgcn.wave.match(i32 %tid2)
  %out_ptr = getelementptr i32, i32 addrspace(1)* %out, i32 %tid
  store i32 %v, i32 addrspace(1)* %out_ptr
  ret void
}

define amdgpu_kernel void @v_wave_match_constant(ptr addrspace(1) %out, i32 %src) {
; CHECK-LABEL: @v_wave_match_constant(
; CHECK-NEXT:    [[V:%.*]] = call i32 @llvm.amdgcn.ballot.i32(i1 true)
; CHECK-NEXT:    store i32 [[V]], ptr addrspace(1) [[OUT:%.*]], align 4
; CHECK-NEXT:    ret void
;
  %v = call i32 @llvm.amdgcn.wave.match(i32 7)
  store i32 %v, ptr addrspace(1) %out
  ret void
}

define amdgpu_kernel void @v_wave_match_undef(ptr addrspace(1) %out, i32 %src) {
; CHECK-LABEL: @v_wave_match_undef(
; CHECK-NEXT:    [[V:%.*]] = call i32 @llvm.amdgcn.ballot.i32(i1 true)
; CHECK-NEXT:    store i32 [[V]], ptr addrspace(1) [[OUT:%.*]], align 4
; CHECK-NEXT:    ret void
;
  %v = call i32 @llvm.amdgcn.wave.match(i32 undef)
  store i32 %v, ptr addrspace(1) %out
  ret void
}
