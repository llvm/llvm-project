; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1100 -passes=instcombine -S < %s | FileCheck %s

define i32 @wave_shuffle_self_select(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_self_select(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[TID]])
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %tid)
  ret i32 %res
}

define i32 @wave_shuffle_dpp_row_share_0(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_dpp_row_share_0(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 272, i32 15, i32 15, i1 false)
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_0 = or i32 %masked, 0
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_0)
  ret i32 %res
}

define i32 @wave_shuffle_dpp_row_share_7(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_dpp_row_share_7(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 279, i32 15, i32 15, i1 false)
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @wave_shuffle_dpp_row_share_7_no_mask(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_dpp_row_share_7_no_mask(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-NEXT:    [[SHARE_7:%.*]] = or i32 [[TID]], 7
; CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %share_7 = or i32 %tid, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @wave_shuffle_not_quite_row_share(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_not_quite_row_share(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65280
; CHECK-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 55
; CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %masked = and i32 %tid, 65280   ; 0xFF00
  %or_res = or i32 %masked, 55    ; 0x37
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %or_res)
  ret i32 %res
}

define i32 @wave_shuffle_workitem_row_share_14(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_workitem_row_share_14(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 286, i32 15, i32 15, i1 false)
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_14 = or i32 %masked, 14
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_14)
  ret i32 %res
}

define i32 @wave_shuffle_workitem_row_share_14_no_mask(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_workitem_row_share_14_no_mask(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-NEXT:    [[SHARE_14:%.*]] = or i32 [[TID]], 14
; CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_14]])
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %share_14 = or i32 %tid, 14
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_14)
  ret i32 %res
}

define i32 @wave_shuffle_workitem_row_share_15(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_workitem_row_share_15(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_15 = or i32 %masked, 15
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_15)
  ret i32 %res
}

define i32 @wave_shuffle_workitem_row_share_15_no_mask(i32 %val) {
; CHECK-LABEL: define i32 @wave_shuffle_workitem_row_share_15_no_mask(
; CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %share_15 = or i32 %tid, 15
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_15)
  ret i32 %res
}
