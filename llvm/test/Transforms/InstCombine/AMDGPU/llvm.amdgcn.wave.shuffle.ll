; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -mtriple=amdgcn-- -mcpu=hawaii -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX7 %s

; RUN: opt -mtriple=amdgcn-- -mcpu=fiji -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX8 %s

; RUN: opt -mtriple=amdgcn-- -mcpu=gfx90a -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX9 %s

; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1010 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX10-W32 %s
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1010 -mattr=+wavefrontsize64 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX10-W64 %s

; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1100 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX11-W32 %s
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1100 -mattr=+wavefrontsize64 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX11-W64 %s

; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1200 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX12-W32 %s
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1200 -mattr=+wavefrontsize64 -passes=instcombine -S < %s | FileCheck -check-prefixes=GFX12-W64 %s

; Several optimizations depend on knowing the wavefront size, this run should skip those optimizations
; RUN: opt -mtriple=amdgcn-- -mattr=+dpp -passes=instcombine -S < %s | FileCheck -check-prefixes=NO-INFO-CHECK %s

; Using wave shuffle to select self lane is a noop
define i32 @test_wave_shuffle_self_select(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX7-NEXT:    ret i32 [[VAL]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX8-NEXT:    ret i32 [[VAL]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX9-NEXT:    ret i32 [[VAL]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX10-W32-NEXT:    ret i32 [[VAL]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX10-W64-NEXT:    ret i32 [[VAL]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX11-W32-NEXT:    ret i32 [[VAL]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX11-W64-NEXT:    ret i32 [[VAL]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX12-W32-NEXT:    ret i32 [[VAL]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_self_select(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; GFX12-W64-NEXT:    ret i32 [[VAL]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_self_select(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; NO-INFO-CHECK-NEXT:    ret i32 [[VAL]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %lid)
  ret i32 %res
}

; In the Row Share 0 case, the logic is the same with and without the or.
; In fact, the or will likely be optimized out before reaching the DPP
; optimization step anyway. So this case should work with or without the or
define i32 @test_wave_shuffle_dpp_row_share_0(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %lid, 65520   ; 0xFFF0
  %share_0 = or i32 %masked, 0
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_0)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_0_no_or(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 336, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0_no_or(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %lid, 65520   ; 0xFFF0
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %masked)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_7(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 48
; GFX7-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 48
; GFX8-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 48
; NO-INFO-CHECK-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %lid, 48  ; 0x30
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W32-NEXT:    [[SHARE_7:%.*]] = or i32 [[LO]], 7
; GFX10-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W32-NEXT:    [[SHARE_7:%.*]] = or i32 [[LO]], 7
; GFX11-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W32-NEXT:    [[SHARE_7:%.*]] = or i32 [[LO]], 7
; GFX12-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[SHARE_7:%.*]] = or i32 [[LID]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %share_7 = or i32 %lid, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

; Doing both mbcnt.lo and mbcnt.hi works for both wave32 and wave64 because the
; mbcnt.hi is optimized away for wave32. However, ommitting mbcnt.hi should prevent
; wave64 from optimizing to dpp.
define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX7-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX8-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX9-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX10-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX11-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; GFX12-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65520
; NO-INFO-CHECK-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %masked = and i32 %lid, 65520   ; 0xFFF0
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

; The mask requirements for wave32 and wave64 are slightly different since wave64
; has 4 rows. This test has a mask that should only be valid for wave32 to be
; optimized to dpp.
define i32 @test_wave_shuffle_dpp_row_share_w32_mask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX7-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX8-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX9-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX10-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX11-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 343, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; GFX12-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 16
; NO-INFO-CHECK-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %lid, 16  ; 0x10
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @test_wave_shuffle_not_quite_row_share(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX7-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX8-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX9-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W32-NEXT:    [[MASKED:%.*]] = and i32 [[LO]], 65280
; GFX10-W32-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX10-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX10-W64-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W32-NEXT:    [[MASKED:%.*]] = and i32 [[LO]], 65280
; GFX11-W32-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX11-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX11-W64-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W32-NEXT:    [[MASKED:%.*]] = and i32 [[LO]], 65280
; GFX12-W32-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX12-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; GFX12-W64-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[MASKED:%.*]] = and i32 [[LID]], 65280
; NO-INFO-CHECK-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %lid, 65280   ; 0xFF00
  %or_res = or i32 %masked, 55    ; 0x37
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %or_res)
  ret i32 %res
}

define i32 @test_wave_shuffle_row_xmask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 65520      ; 0xFFF0
  %row_idx = and i32 %lid, 15     ; 0xF
  %xor_res = xor i32 %row_idx, 5  ; 0x5
  %idx = or i32 %row, %xor_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; While it is okay to do a mask-off and or to compute the index, since
; we know the lane ID is 32(64) or less, it's not necessary. So the
; optimization should work with or without the masking
define i32 @test_wave_shuffle_row_xmask_simple(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 5
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 5
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 5
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_simple(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 5
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %idx = xor i32 %lid, 5  ; 0x5
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; XMask with 0 is effectively a self-select, should be noop
define i32 @test_wave_shuffle_row_xmask_0(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    ret i32 [[VAL]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    ret i32 [[VAL]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    ret i32 [[VAL]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    ret i32 [[VAL]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    ret i32 [[VAL]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    ret i32 [[VAL]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    ret i32 [[VAL]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    ret i32 [[VAL]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    ret i32 [[VAL]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_0(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    ret i32 [[VAL]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %idx = xor i32 %lid, 0  ; 0x0
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; This case of Row XMask is equivalent to Row Mirror. On architectures
; that have Row Mirror but not Row XMask, this case should still
; optimize to Row Mirror
define i32 @test_wave_shuffle_row_xmask_15(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 320, i32 15, i32 15, i1 false)
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 320, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_15(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %idx = xor i32 %lid, 15  ; 0xF
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; This case of Row XMask is equivalent to Row Half Mirror. On architectures
; that have Row Half Mirror but not Row XMask, this case should still
; optimize to Row Half Mirror
define i32 @test_wave_shuffle_row_xmask_7(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 321, i32 15, i32 15, i1 false)
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 321, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_7(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %idx = xor i32 %lid, 7   ; 0x7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; While masks are not necessary for this optimization, if there is a mask then
; it does have to be of proper form. The mask requirements for wave32 and wave64
; are slightly different since wave64 has 4 rows. This test has a mask that should
; only be valid for wave32 to be optimized to dpp.
define i32 @test_wave_shuffle_row_xmask_w32_mask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 357, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_w32_mask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 5
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 16         ; 0x10
  %row_idx = and i32 %lid, 15     ; 0xF
  %xor_res = xor i32 %row_idx, 5  ; 0x5
  %idx = or i32 %row, %xor_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; Doing both mbcnt.lo and mbcnt.hi works for both wave32 and wave64 because the
; mbcnt.hi is optimized away for wave32. However, ommitting mbcnt.hi should prevent
; wave64 from optimizing to dpp.
define i32 @test_wave_shuffle_row_xmask_lo_only(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_xmask_lo_only(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[LID]], 15
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %idx = xor i32 %lid, 15  ; 0xF
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; Similar to before, Row Mirror is equivalent to Row XMask 15. So, architectures
; with Row XMask should optimize to that instead
define i32 @test_wave_shuffle_row_mirror(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 320, i32 15, i32 15, i1 false)
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 320, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_mirror(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_mirror(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 65520      ; 0xFFF0
  %row_idx = and i32 %lid, 15     ; 0xF
  %sub_res = sub i32 15, %row_idx ; 0xF
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

define i32 @test_wave_shuffle_row_mirror_w32_mask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_mirror_w32_mask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 16         ; 0x10
  %row_idx = and i32 %lid, 15     ; 0xF
  %sub_res = sub i32 15, %row_idx ; 0xF
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

define i32 @test_wave_shuffle_row_mirror_lo_only(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 367, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_mirror_lo_only(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 15
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %row = and i32 %lid, 65520      ; 0xFFF0
  %row_idx = and i32 %lid, 15     ; 0xF
  %sub_res = sub i32 15, %row_idx ; 0xF
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

; Similar to before, Row Half Mirror is equivalent to Row XMask 7. So, architectures
; with Row XMask should optimize to that instead
define i32 @test_wave_shuffle_row_half_mirror(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 321, i32 15, i32 15, i1 false)
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 321, i32 15, i32 15, i1 false)
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_half_mirror(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 65528      ; 0xFFF8
  %row_idx = and i32 %lid, 7      ; 0x7
  %sub_res = sub i32 7, %row_idx  ; 0x7
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

define i32 @test_wave_shuffle_row_half_mirror_w32_mask(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_half_mirror_w32_mask(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 31
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 24         ; 0x18
  %row_idx = and i32 %lid, 7      ; 0x7
  %sub_res = sub i32 7, %row_idx  ; 0x7
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

define i32 @test_wave_shuffle_row_half_mirror_lo_only(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 poison, i32 [[VAL]], i32 359, i32 15, i32 15, i1 false)
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_row_half_mirror_lo_only(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65535
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %row = and i32 %lid, 65528      ; 0xFFF8
  %row_idx = and i32 %lid, 7      ; 0x7
  %sub_res = sub i32 7, %row_idx  ; 0x7
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}

define i32 @test_wave_shuffle_not_quite_row_half_mirror(i32 %val) {
; GFX7-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX7-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX7-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX7-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX7-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX7-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX7-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX7-NEXT:    ret i32 [[RES]]
;
; GFX8-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX8-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX8-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX8-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX8-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX8-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX8-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX8-NEXT:    ret i32 [[RES]]
;
; GFX9-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX9-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX9-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX9-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX9-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX9-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX9-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX9-NEXT:    ret i32 [[RES]]
;
; GFX10-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX10-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W32-NEXT:    [[TMP1:%.*]] = and i32 [[LO]], 65527
; GFX10-W32-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX10-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W32-NEXT:    ret i32 [[RES]]
;
; GFX10-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX10-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX10-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX10-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX10-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX10-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX10-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX10-W64-NEXT:    ret i32 [[RES]]
;
; GFX11-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX11-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W32-NEXT:    [[TMP1:%.*]] = and i32 [[LO]], 65527
; GFX11-W32-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX11-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W32-NEXT:    ret i32 [[RES]]
;
; GFX11-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX11-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX11-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX11-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX11-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX11-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX11-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX11-W64-NEXT:    ret i32 [[RES]]
;
; GFX12-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX12-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W32-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W32-NEXT:    [[TMP1:%.*]] = and i32 [[LO]], 65527
; GFX12-W32-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX12-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W32-NEXT:    ret i32 [[RES]]
;
; GFX12-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; GFX12-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; GFX12-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; GFX12-W64-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; GFX12-W64-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; GFX12-W64-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; GFX12-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; GFX12-W64-NEXT:    ret i32 [[RES]]
;
; NO-INFO-CHECK-LABEL: define i32 @test_wave_shuffle_not_quite_row_half_mirror(
; NO-INFO-CHECK-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; NO-INFO-CHECK-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; NO-INFO-CHECK-NEXT:    [[LID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; NO-INFO-CHECK-NEXT:    [[TMP1:%.*]] = and i32 [[LID]], 65527
; NO-INFO-CHECK-NEXT:    [[IDX:%.*]] = xor i32 [[TMP1]], 7
; NO-INFO-CHECK-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[IDX]])
; NO-INFO-CHECK-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %lid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %row = and i32 %lid, 65520      ; 0xFFF0
  %row_idx = and i32 %lid, 7      ; 0x7
  %sub_res = sub i32 7, %row_idx  ; 0x7
  %idx = or i32 %row, %sub_res
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %idx)
  ret i32 %res
}
