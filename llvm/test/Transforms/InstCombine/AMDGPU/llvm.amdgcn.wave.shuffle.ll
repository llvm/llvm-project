; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 5
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1100 -passes=instcombine -S < %s | FileCheck -check-prefixes=CHECK-W32 %s
; RUN: opt -mtriple=amdgcn-- -mcpu=gfx1100 -mattr=+wavefrontsize64 -passes=instcombine -S < %s | FileCheck -check-prefixes=CHECK-W64 %s
; RUN: opt -mtriple=amdgcn-- -mattr=+dpp -passes=instcombine -S < %s | FileCheck -check-prefixes=CHECK-DPP %s

define i32 @test_wave_shuffle_self_select(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_self_select(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-W32-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[TID]])
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_self_select(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W64-NEXT:    [[TID1:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[TID]])
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[TID1]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_self_select(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[TID]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %tid)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_0(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 272, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 272, i32 15, i32 15, i1 false)
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_dpp_row_share_0(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65520
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[MASKED]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_0 = or i32 %masked, 0
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_0)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_7(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 279, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 279, i32 15, i32 15, i1 false)
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 48
; CHECK-DPP-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %tid, 48  ; 0x30
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W32-NEXT:    [[SHARE_7:%.*]] = or i32 [[TID]], 7
; CHECK-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W64-NEXT:    [[TID1:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[TID]])
; CHECK-W64-NEXT:    [[SHARE_7:%.*]] = or i32 [[TID1]], 7
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_no_mask(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[SHARE_7:%.*]] = or i32 [[TID]], 7
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %share_7 = or i32 %tid, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

; Doing both mbcnt.lo and mbcnt.hi works for both wave32 and wave64 because the
; mbcnt.hi is optimized away for wave32. However, ommitting mbcnt.hi should prevent
; wave64 from optimizing to dpp.
define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 279, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W64-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65520
; CHECK-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_dpp_row_share_7_lo_only(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65520
; CHECK-DPP-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

; The mask requirements for wave32 and wave64 are slightly different since wave64
; has 4 rows. This test has a mask that should only be valid for wave32 to be
; optimized to dpp.
define i32 @test_wave_shuffle_dpp_row_share_w32_mask(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 279, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-W64-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 16
; CHECK-W64-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_dpp_row_share_w32_mask(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 16
; CHECK-DPP-NEXT:    [[SHARE_7:%.*]] = or disjoint i32 [[MASKED]], 7
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_7]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %tid, 16  ; 0x10
  %share_7 = or i32 %masked, 7
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_7)
  ret i32 %res
}

define i32 @test_wave_shuffle_not_quite_row_share(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W32-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65280
; CHECK-W32-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; CHECK-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-W64-NEXT:    [[TID1:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[TID]])
; CHECK-W64-NEXT:    [[MASKED:%.*]] = and i32 [[TID1]], 65280
; CHECK-W64-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_not_quite_row_share(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[LO:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 [[LO]])
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 65280
; CHECK-DPP-NEXT:    [[OR_RES:%.*]] = or disjoint i32 [[MASKED]], 55
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[OR_RES]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %lo = tail call i32 @llvm.amdgcn.mbcnt.lo(i32 -1, i32 0)
  %tid = tail call i32 @llvm.amdgcn.mbcnt.hi(i32 -1, i32 %lo)
  %masked = and i32 %tid, 65280   ; 0xFF00
  %or_res = or i32 %masked, 55    ; 0x37
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %or_res)
  ret i32 %res
}

define i32 @test_wave_shuffle_workitem_row_share_14(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 286, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 286, i32 15, i32 15, i1 false)
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-DPP-NEXT:    [[MASKED:%.*]] = and i32 [[TID]], 1008
; CHECK-DPP-NEXT:    [[SHARE_14:%.*]] = or disjoint i32 [[MASKED]], 14
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_14]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_14 = or i32 %masked, 14
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_14)
  ret i32 %res
}

define i32 @test_wave_shuffle_workitem_row_share_14_no_mask(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14_no_mask(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-W32-NEXT:    [[SHARE_14:%.*]] = or i32 [[TID]], 14
; CHECK-W32-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_14]])
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14_no_mask(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-W64-NEXT:    [[SHARE_14:%.*]] = or i32 [[TID]], 14
; CHECK-W64-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_14]])
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_workitem_row_share_14_no_mask(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-DPP-NEXT:    [[SHARE_14:%.*]] = or i32 [[TID]], 14
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_14]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %share_14 = or i32 %tid, 14
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_14)
  ret i32 %res
}

define i32 @test_wave_shuffle_workitem_row_share_15(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-DPP-NEXT:    [[SHARE_15:%.*]] = or i32 [[TID]], 15
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_15]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %masked = and i32 %tid, 65520   ; 0xFFF0
  %share_15 = or i32 %masked, 15
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_15)
  ret i32 %res
}

define i32 @test_wave_shuffle_workitem_row_share_15_no_mask(i32 %val) {
; CHECK-W32-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15_no_mask(
; CHECK-W32-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W32-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-W32-NEXT:    ret i32 [[RES]]
;
; CHECK-W64-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15_no_mask(
; CHECK-W64-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-W64-NEXT:    [[RES:%.*]] = call i32 @llvm.amdgcn.update.dpp.i32(i32 0, i32 [[VAL]], i32 287, i32 15, i32 15, i1 false)
; CHECK-W64-NEXT:    ret i32 [[RES]]
;
; CHECK-DPP-LABEL: define i32 @test_wave_shuffle_workitem_row_share_15_no_mask(
; CHECK-DPP-SAME: i32 [[VAL:%.*]]) #[[ATTR0]] {
; CHECK-DPP-NEXT:    [[TID:%.*]] = tail call i32 @llvm.amdgcn.workitem.id.x()
; CHECK-DPP-NEXT:    [[SHARE_15:%.*]] = or i32 [[TID]], 15
; CHECK-DPP-NEXT:    [[RES:%.*]] = tail call i32 @llvm.amdgcn.wave.shuffle.i32(i32 [[VAL]], i32 [[SHARE_15]])
; CHECK-DPP-NEXT:    ret i32 [[RES]]
;
  %tid = tail call i32 @llvm.amdgcn.workitem.id.x()
  %share_15 = or i32 %tid, 15
  %res = tail call i32 @llvm.amdgcn.wave.shuffle(i32 %val, i32 %share_15)
  ret i32 %res
}
