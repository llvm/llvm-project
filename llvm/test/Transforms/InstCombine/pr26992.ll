; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -passes=instcombine -S < %s | FileCheck %s
target triple = "x86_64-pc-windows-msvc"

define i1 @test1(ptr %p) personality ptr @__CxxFrameHandler3 {
; CHECK-LABEL: @test1(
; CHECK-NEXT:  entry:
; CHECK-NEXT:    [[A:%.*]] = getelementptr i8, ptr [[P:%.*]], i64 1
; CHECK-NEXT:    invoke void @may_throw()
; CHECK-NEXT:    to label [[INVOKE_CONT:%.*]] unwind label [[CATCH_DISPATCH:%.*]]
; CHECK:       invoke.cont:
; CHECK-NEXT:    [[B:%.*]] = getelementptr i8, ptr [[P]], i64 2
; CHECK-NEXT:    invoke void @may_throw()
; CHECK-NEXT:    to label [[EXIT:%.*]] unwind label [[CATCH_DISPATCH]]
; CHECK:       catch.dispatch:
; CHECK-NEXT:    [[C:%.*]] = phi ptr [ [[B]], [[INVOKE_CONT]] ], [ [[A]], [[ENTRY:%.*]] ]
; CHECK-NEXT:    [[TMP1:%.*]] = catchswitch within none [label %catch] unwind to caller
; CHECK:       catch:
; CHECK-NEXT:    [[TMP2:%.*]] = catchpad within [[TMP1]] [ptr null, i32 64, ptr null]
; CHECK-NEXT:    catchret from [[TMP2]] to label [[EXIT]]
; CHECK:       exit:
; CHECK-NEXT:    [[D:%.*]] = phi ptr [ [[A]], [[INVOKE_CONT]] ], [ [[C]], [[CATCH:%.*]] ]
; CHECK-NEXT:    [[CMP:%.*]] = icmp eq ptr [[D]], [[A]]
; CHECK-NEXT:    ret i1 [[CMP]]
;
entry:
  %a = getelementptr i8, ptr %p, i64 1
  invoke void @may_throw()
  to label %invoke.cont unwind label %catch.dispatch

invoke.cont:
  %b = getelementptr inbounds i8, ptr %a, i64 1
  invoke void @may_throw()
  to label %exit unwind label %catch.dispatch

catch.dispatch:
  %c = phi ptr [ %b, %invoke.cont ], [ %a, %entry ]
  %tmp1 = catchswitch within none [label %catch] unwind to caller

catch:
  %tmp2 = catchpad within %tmp1 [ptr null, i32 64, ptr null]
  catchret from %tmp2 to label %exit

exit:
  %d = phi ptr [ %a, %invoke.cont ], [ %c, %catch ]
  %cmp = icmp eq ptr %d, %a
  ret i1 %cmp
}

declare void @may_throw()

declare i32 @__CxxFrameHandler3(...)
