; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 2
; Regression test for PR51200.
;
; RUN: opt < %s -passes=instcombine -S | FileCheck %s
;
; This transformation requires the pointer size, as it assumes that size_t is
; the size of a pointer.

@percent_s = constant [3 x i8] c"%s\00"

declare i32 @sprintf(ptr, ptr, ...)

define i32 @PR51200(ptr %p, ptr %p2) {
; CHECK-LABEL: define i32 @PR51200
; CHECK-SAME: (ptr [[P:%.*]], ptr [[P2:%.*]]) {
; CHECK-NEXT:    [[STPCPY:%.*]] = call ptr @stpcpy(ptr [[P]], ptr [[P2]])
; CHECK-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[STPCPY]] to i64
; CHECK-NEXT:    [[TMP2:%.*]] = ptrtoint ptr [[P]] to i64
; CHECK-NEXT:    [[TMP3:%.*]] = sub i64 [[TMP1]], [[TMP2]]
; CHECK-NEXT:    [[CALL:%.*]] = trunc i64 [[TMP3]] to i32
; CHECK-NEXT:    ret i32 [[CALL]]
;
; Don't check anything, just expect the test to compile successfully.
  %call = call i32 (ptr, ptr, ...) @sprintf(ptr %p, ptr @percent_s, ptr %p2)
  ret i32 %call
}
