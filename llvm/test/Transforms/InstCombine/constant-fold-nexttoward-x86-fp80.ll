; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: cat %S/floating-point-constants.ll %s | opt -passes=instcombine -S | FileCheck %s

declare double @nexttoward(double noundef, x86_fp80 noundef) #0
declare float @nexttowardf(float noundef, x86_fp80 noundef) #0

attributes #0 = { willreturn memory(errnomem: write) }

; ==================
; nexttoward tests
; ==================

define double @nexttoward_can_constant_fold_up_direction() {
; CHECK-LABEL: define double @nexttoward_can_constant_fold_up_direction() {
; CHECK-NEXT:    ret double 0x3FF0000000000001
;
  %arg = fpext double 2.0 to x86_fp80
  %next = call double @nexttoward(double noundef 1.0, x86_fp80 %arg)
  ret double %next
}
define double @nexttoward_can_constant_fold_down_direction() {
; CHECK-LABEL: define double @nexttoward_can_constant_fold_down_direction() {
; CHECK-NEXT:    ret double 0x3FEFFFFFFFFFFFFF
;
  %arg = fpext double 0.0 to x86_fp80
  %next = call double @nexttoward(double noundef 1.0, x86_fp80 %arg)
  ret double %next
}
define double @nexttoward_can_constant_fold_equal_args() {
; CHECK-LABEL: define double @nexttoward_can_constant_fold_equal_args() {
; CHECK-NEXT:    ret double 1.000000e+00
;
  %arg = fpext double 1.0 to x86_fp80
  %next = call double @nexttoward(double 1.0, x86_fp80 %arg)
  ret double %next
}
define double @nexttoward_can_constant_fold_with_nan_arg() {
; CHECK-LABEL: define double @nexttoward_can_constant_fold_with_nan_arg() {
; CHECK-NEXT:    ret double 0x7FF8000000000000
;
  %nan = load double, double* @dbl_nan
  %arg = fpext double %nan to x86_fp80
  %next = call double @nexttoward(double 1.0, x86_fp80 %arg)
  ret double %next
}
define double @nexttoward_constant_fold_propagates_nan_payload() {
; CHECK-LABEL: define double @nexttoward_constant_fold_propagates_nan_payload() {
; CHECK-NEXT:    ret double 0x7FF8000000000001
;
  %nan = load double, double* @dbl_nan
  %tmp1 = bitcast double %nan to i64
  %tmp2 = or i64 %tmp1, 1
  %nan_with_payload = bitcast i64 %tmp2 to double
  %dummy_arg = fpext double 1.0 to x86_fp80
  %next = call double @nexttoward(double %nan_with_payload, x86_fp80 %dummy_arg)
  ret double %next
}
define double @nexttoward_not_marked_dead_on_pos_overflow () {
; CHECK-LABEL: define double @nexttoward_not_marked_dead_on_pos_overflow() {
; CHECK-NEXT:    [[NEXT:%.*]] = call double @nexttoward(double 0x7FEFFFFFFFFFFFFF, x86_fp80 0xK7FFF8000000000000000)
; CHECK-NEXT:    ret double 0x7FF0000000000000
;
  %pos_max = load double, double* @dbl_pos_max
  %pos_inf = load double, double* @dbl_pos_infinity
  %ext_pos_inf = fpext double %pos_inf to x86_fp80
  %next = call double @nexttoward(double %pos_max, x86_fp80 %ext_pos_inf)
  ret double %next
}
define double @nexttoward_not_marked_dead_on_neg_overflow() {
; CHECK-LABEL: define double @nexttoward_not_marked_dead_on_neg_overflow() {
; CHECK-NEXT:    [[NEXT:%.*]] = call double @nexttoward(double 0xFFEFFFFFFFFFFFFF, x86_fp80 0xKFFFF8000000000000000)
; CHECK-NEXT:    ret double 0xFFF0000000000000
;
  %neg_max = load double, double* @dbl_neg_max
  %neg_inf = load double, double* @dbl_neg_infinity
  %ext_neg_inf = fpext double %neg_inf to x86_fp80
  %next = call double @nexttoward(double %neg_max, x86_fp80 %ext_neg_inf)
  ret double %next
}
define double @nexttoward_not_marked_dead_on_zero_from_above() {
; CHECK-LABEL: define double @nexttoward_not_marked_dead_on_zero_from_above() {
; CHECK-NEXT:    [[NEXT:%.*]] = call double @nexttoward(double 4.940660e-324, x86_fp80 0xK00000000000000000000)
; CHECK-NEXT:    ret double 0.000000e+00
;
  %subnormal = load double, double* @dbl_pos_min_subnormal
  %zero = fpext double 0.0 to x86_fp80
  %next = call double @nexttoward(double %subnormal, x86_fp80 %zero)
  ret double %next
}
define double @nexttoward_not_marked_dead_on_zero_from_below() {
; CHECK-LABEL: define double @nexttoward_not_marked_dead_on_zero_from_below() {
; CHECK-NEXT:    [[NEXT:%.*]] = call double @nexttoward(double -4.940660e-324, x86_fp80 0xK00000000000000000000)
; CHECK-NEXT:    ret double -0.000000e+00
;
  %subnormal = load double, double* @dbl_neg_min_subnormal
  %zero = fpext double 0.0 to x86_fp80
  %next = call double @nexttoward(double %subnormal, x86_fp80 %zero)
  ret double %next
}
define double @nexttoward_not_marked_dead_on_subnormal() {
; CHECK-LABEL: define double @nexttoward_not_marked_dead_on_subnormal() {
; CHECK-NEXT:    [[NEXT:%.*]] = call double @nexttoward(double 4.940660e-324, x86_fp80 0xK3FFF8000000000000000)
; CHECK-NEXT:    ret double 9.881310e-324
;
  %subnormal = load double, double* @dbl_pos_min_subnormal
  %target = fpext double 1.0 to x86_fp80
  %next = call double @nexttoward(double %subnormal, x86_fp80 %target)
  ret double %next
}

; ==================
; nexttowardf tests
; ==================

define float @nexttowardf_can_constant_fold_up_direction() {
; CHECK-LABEL: define float @nexttowardf_can_constant_fold_up_direction() {
; CHECK-NEXT:    ret float 0x3FF0000020000000
;
  %arg = fpext float 2.0 to x86_fp80
  %next = call float @nexttowardf(float noundef 1.0, x86_fp80 %arg)
  ret float %next
}
define float @nexttowardf_can_constant_fold_down_direction() {
; CHECK-LABEL: define float @nexttowardf_can_constant_fold_down_direction() {
; CHECK-NEXT:    ret float 0x3FEFFFFFE0000000
;
  %arg = fpext float 0.0 to x86_fp80
  %next = call float @nexttowardf(float noundef 1.0, x86_fp80 %arg)
  ret float %next
}
define float @nexttowardf_can_constant_fold_equal_args() {
; CHECK-LABEL: define float @nexttowardf_can_constant_fold_equal_args() {
; CHECK-NEXT:    ret float 1.000000e+00
;
  %arg = fpext float 1.0 to x86_fp80
  %next = call float @nexttowardf(float 1.0, x86_fp80 %arg)
  ret float %next
}
define float @nexttowardf_can_constant_fold_with_nan_arg() {
; CHECK-LABEL: define float @nexttowardf_can_constant_fold_with_nan_arg() {
; CHECK-NEXT:    ret float 0x7FF8000000000000
;
  %nan = load float, float* @flt_nan
  %ext_nan = fpext float %nan to x86_fp80
  %next = call float @nexttowardf(float 1.0, x86_fp80 %ext_nan)
  ret float %next
}
define float @nexttowardf_constant_fold_propagates_nan_payload() {
; CHECK-LABEL: define float @nexttowardf_constant_fold_propagates_nan_payload() {
; CHECK-NEXT:    ret float 0x7FF8000020000000
;
  %nan = load float, float* @flt_nan
  %tmp1 = bitcast float %nan to i32
  %tmp2 = or i32 %tmp1, 1
  %nan_with_payload = bitcast i32 %tmp2 to float
  %dummy_arg = fpext float 1.0 to x86_fp80
  %next = call float @nexttowardf(float %nan_with_payload, x86_fp80 %dummy_arg)
  ret float %next
}
define float @nexttowardf_not_marked_dead_on_pos_overflow() {
; CHECK-LABEL: define float @nexttowardf_not_marked_dead_on_pos_overflow() {
; CHECK-NEXT:    [[NEXT:%.*]] = call float @nexttowardf(float 0x47EFFFFFE0000000, x86_fp80 0xK7FFF8000000000000000)
; CHECK-NEXT:    ret float 0x7FF0000000000000
;
  %pos_max = load float, float* @flt_pos_max
  %pos_inf = load float, float* @flt_pos_infinity
  %ext_pos_inf = fpext float %pos_inf to x86_fp80
  %next = call float @nexttowardf(float %pos_max, x86_fp80 %ext_pos_inf)
  ret float %next
}
define float @nexttowardf_not_marked_dead_on_neg_overflow() {
; CHECK-LABEL: define float @nexttowardf_not_marked_dead_on_neg_overflow() {
; CHECK-NEXT:    [[NEXT:%.*]] = call float @nexttowardf(float 0xC7EFFFFFE0000000, x86_fp80 0xKFFFF8000000000000000)
; CHECK-NEXT:    ret float 0xFFF0000000000000
;
  %neg_max = load float, float* @flt_neg_max
  %neg_inf = load float, float* @flt_neg_infinity
  %ext_neg_inf = fpext float %neg_inf to x86_fp80
  %next = call float @nexttowardf(float %neg_max, x86_fp80 %ext_neg_inf)
  ret float %next
}
define float @nexttowardf_not_marked_dead_on_zero_from_above() {
; CHECK-LABEL: define float @nexttowardf_not_marked_dead_on_zero_from_above() {
; CHECK-NEXT:    [[NEXT:%.*]] = call float @nexttowardf(float 0x36A0000000000000, x86_fp80 0xK00000000000000000000)
; CHECK-NEXT:    ret float 0.000000e+00
;
  %min_subnormal = load float, float* @flt_pos_min_subnormal
  %zero = fpext float 0.0 to x86_fp80
  %next = call float @nexttowardf(float %min_subnormal, x86_fp80 %zero)
  ret float %next
}
define float @nexttowardf_not_marked_dead_on_zero_from_below() {
; CHECK-LABEL: define float @nexttowardf_not_marked_dead_on_zero_from_below() {
; CHECK-NEXT:    [[NEXT:%.*]] = call float @nexttowardf(float 0xB6A0000000000000, x86_fp80 0xK00000000000000000000)
; CHECK-NEXT:    ret float -0.000000e+00
;
  %min_subnormal = load float, float* @flt_neg_min_subnormal
  %zero = fpext float 0.0 to x86_fp80
  %next = call float @nexttowardf(float %min_subnormal, x86_fp80 %zero)
  ret float %next
}
define float @nexttowardf_not_marked_dead_on_subnormal() {
; CHECK-LABEL: define float @nexttowardf_not_marked_dead_on_subnormal() {
; CHECK-NEXT:    [[NEXT:%.*]] = call float @nexttowardf(float 0x36A0000000000000, x86_fp80 0xK3FFF8000000000000000)
; CHECK-NEXT:    ret float 0x36B0000000000000
;
  %subnormal = load float, float* @flt_pos_min_subnormal
  %target = fpext float 1.0 to x86_fp80
  %next = call float @nexttowardf(float %subnormal, x86_fp80 %target)
  ret float %next
}
