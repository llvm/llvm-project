; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -p instcombine -S %s | FileCheck %s

define i64 @test_sink_with_dereferenceable_assume(ptr %p, ptr %q, i1 %cond) {
; CHECK-LABEL: define i64 @test_sink_with_dereferenceable_assume(
; CHECK-SAME: ptr [[P:%.*]], ptr [[Q:%.*]], i1 [[COND:%.*]]) {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    br i1 [[COND]], label %[[THEN:.*]], label %[[ELSE:.*]]
; CHECK:       [[THEN]]:
; CHECK-NEXT:    [[Q_INT:%.*]] = ptrtoint ptr [[Q]] to i64
; CHECK-NEXT:    [[P_INT:%.*]] = ptrtoint ptr [[P]] to i64
; CHECK-NEXT:    [[DIFF:%.*]] = sub i64 [[Q_INT]], [[P_INT]]
; CHECK-NEXT:    ret i64 [[DIFF]]
; CHECK:       [[ELSE]]:
; CHECK-NEXT:    ret i64 0
;
entry:
  %p_int = ptrtoint ptr %p to i64
  %q_int = ptrtoint ptr %q to i64
  %diff = sub i64 %q_int, %p_int
  call void @llvm.assume(i1 true) [ "dereferenceable"(ptr %p, i64 %diff) ]
  br i1 %cond, label %then, label %else

then:
  ret i64 %diff

else:
  ret i64 0
}

declare void @llvm.assume(i1 noundef)
