; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -passes=instcombine -S | FileCheck %s

; Gracefully handle the alloca that is not in the alloca AS (=5)

target datalayout = "e-p:64:64-p1:64:64-p2:32:32-p3:32:32-p4:64:64-p5:32:32-p6:32:32-p7:160:256:256:32-p8:128:128-i64:64-v16:16-v24:32-v32:32-v48:64-v96:128-v192:256-v256:256-v512:512-v1024:1024-v2048:2048-n32:64-S32-A5-G1-ni:7:8"
target triple = "amdgcn-amd-amdhsa"

declare void @use(ptr, ptr)

define weak amdgpu_kernel void @__omp_offloading_802_ea0109_main_l8(ptr %a) {
; CHECK-LABEL: @__omp_offloading_802_ea0109_main_l8(
; CHECK-NEXT:  .master:
; CHECK-NEXT:    [[TMP0:%.*]] = alloca [8 x i8], align 1
; CHECK-NEXT:    call void @use(ptr nonnull [[TMP0]], ptr nonnull [[TMP0]])
; CHECK-NEXT:    ret void
;
.master:
  %0 = alloca i8, i64 8, align 1
  store ptr undef, ptr %0, align 8
  call void @use(ptr %0, ptr %0)
  ret void
}

%struct.widget = type { [8 x i8] }

define void @spam(ptr %arg1) {
; CHECK-LABEL: @spam(
; CHECK-NEXT:  bb:
; CHECK-NEXT:    [[ALLOCA1:%.*]] = alloca [0 x [30 x %struct.widget]], align 16
; CHECK-NEXT:    call void @zot(ptr nonnull [[ALLOCA1]])
; CHECK-NEXT:    ret void
;
bb:
  %alloca = alloca [30 x %struct.widget], i32 0, align 16
  call void @zot(ptr %alloca)
  ret void
}

define i1 @alloca_addrspace_0_nonnull() {
; CHECK-LABEL: @alloca_addrspace_0_nonnull(
; CHECK-NEXT:    [[ALLOCA:%.*]] = alloca i8, align 1
; CHECK-NEXT:    call void @use(ptr nonnull [[ALLOCA]], ptr null)
; CHECK-NEXT:    ret i1 true
;
  %alloca = alloca i8
  call void @use(ptr %alloca)
  %cmp = icmp ne ptr %alloca, null
  ret i1 %cmp
}

define i1 @alloca_addrspace_5_nonnull() {
; CHECK-LABEL: @alloca_addrspace_5_nonnull(
; CHECK-NEXT:    [[ALLOCA:%.*]] = alloca i8, align 1, addrspace(5)
; CHECK-NEXT:    call void @use(ptr addrspace(5) [[ALLOCA]])
; CHECK-NEXT:    [[CMP:%.*]] = icmp ne ptr addrspace(5) [[ALLOCA]], null
; CHECK-NEXT:    ret i1 [[CMP]]
;
  %alloca = alloca i8, addrspace(5)
  call void @use(ptr addrspace(5) %alloca)
  %cmp = icmp ne ptr addrspace(5) %alloca, null
  ret i1 %cmp
}

declare hidden void @zot(ptr)
