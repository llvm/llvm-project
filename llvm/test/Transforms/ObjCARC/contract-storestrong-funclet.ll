; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt -mtriple=i686-unknown-windows-msvc -passes=objc-arc-contract -S -o - %s | FileCheck %s

declare void @f()
declare i32 @__CxxFrameHandler3(...)
declare dllimport ptr @llvm.objc.retain(ptr)
declare dllimport ptr @llvm.objc.retainAutoreleasedReturnValue(ptr)
declare dllimport void @llvm.objc.release(ptr)

@x = external global ptr

define void @g(ptr %p) personality ptr @__CxxFrameHandler3 {
; CHECK-LABEL: @g(
; CHECK-NEXT:    invoke void @f()
; CHECK-NEXT:    to label [[INVOKE_CONT:%.*]] unwind label [[EHCLEANUP:%.*]]
; CHECK:       invoke.cont:
; CHECK-NEXT:    tail call void @llvm.objc.storeStrong(ptr @x, ptr [[P:%.*]]) #[[ATTR0:[0-9]+]]
; CHECK-NEXT:    ret void
; CHECK:       ehcleanup:
; CHECK-NEXT:    [[TMP1:%.*]] = cleanuppad within none []
; CHECK-NEXT:    tail call void @llvm.objc.storeStrong(ptr @x, ptr [[P]]) #[[ATTR0]] [ "funclet"(token [[TMP1]]) ]
; CHECK-NEXT:    cleanupret from [[TMP1]] unwind to caller
;
  invoke void @f() to label %invoke.cont unwind label %ehcleanup

invoke.cont:
  %call = tail call ptr @llvm.objc.retain(ptr %p) nounwind
  %tmp = load ptr, ptr @x, align 4
  store ptr %call, ptr @x, align 4
  tail call void @llvm.objc.release(ptr %tmp) nounwind
  ret void

ehcleanup:
  %1 = cleanuppad within none []
  %call1 = tail call ptr @llvm.objc.retain(ptr %p) nounwind [ "funclet"(token %1) ]
  %tmp1 = load ptr, ptr @x, align 4
  store ptr %call1, ptr @x, align 4
  tail call void @llvm.objc.release(ptr %tmp1) nounwind [ "funclet"(token %1) ]
  cleanupret from %1 unwind to caller
}
