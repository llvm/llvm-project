; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -S -mtriple=x86_64-- -passes='require<libcall-lowering-info>,expand-ir-insts' -expand-fp-convert-bits=0 < %s | FileCheck %s

; Test small bit widths that can be verified by alive2.

define i16 @fptosi_f16_i16(half %x) {
; CHECK-LABEL: define i16 @fptosi_f16_i16(
; CHECK-SAME: half [[X:%.*]]) {
; CHECK-NEXT:  [[FP_TO_I_ENTRY:.*]]:
; CHECK-NEXT:    [[TMP0:%.*]] = bitcast half [[X]] to i16
; CHECK-NEXT:    [[TMP1:%.*]] = icmp sgt i16 [[TMP0]], -1
; CHECK-NEXT:    [[TMP2:%.*]] = select i1 [[TMP1]], i16 1, i16 -1
; CHECK-NEXT:    [[TMP3:%.*]] = lshr i16 [[TMP0]], 10
; CHECK-NEXT:    [[TMP4:%.*]] = and i16 [[TMP3]], 31
; CHECK-NEXT:    [[TMP5:%.*]] = and i16 [[TMP0]], 1023
; CHECK-NEXT:    [[TMP6:%.*]] = or i16 [[TMP5]], 1024
; CHECK-NEXT:    [[TMP7:%.*]] = icmp ult i16 [[TMP4]], 15
; CHECK-NEXT:    br i1 [[TMP7]], label %[[FP_TO_I_CLEANUP:.*]], label %[[FP_TO_I_IF_END:.*]]
; CHECK:       [[FP_TO_I_IF_END]]:
; CHECK-NEXT:    [[TMP8:%.*]] = add i16 [[TMP4]], -31
; CHECK-NEXT:    [[TMP9:%.*]] = icmp ult i16 [[TMP8]], -16
; CHECK-NEXT:    br i1 [[TMP9]], label %[[FP_TO_I_IF_THEN5:.*]], label %[[FP_TO_I_IF_END9:.*]]
; CHECK:       [[FP_TO_I_IF_THEN5]]:
; CHECK-NEXT:    [[TMP10:%.*]] = select i1 [[TMP1]], i16 32767, i16 -32768
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_END9]]:
; CHECK-NEXT:    [[TMP11:%.*]] = icmp ult i16 [[TMP4]], 25
; CHECK-NEXT:    br i1 [[TMP11]], label %[[FP_TO_I_IF_THEN12:.*]], label %[[FP_TO_I_IF_ELSE:.*]]
; CHECK:       [[FP_TO_I_IF_THEN12]]:
; CHECK-NEXT:    [[TMP12:%.*]] = sub i16 25, [[TMP4]]
; CHECK-NEXT:    [[TMP13:%.*]] = lshr i16 [[TMP6]], [[TMP12]]
; CHECK-NEXT:    [[TMP14:%.*]] = mul i16 [[TMP13]], [[TMP2]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_ELSE]]:
; CHECK-NEXT:    [[TMP15:%.*]] = add i16 [[TMP4]], -25
; CHECK-NEXT:    [[TMP16:%.*]] = shl i16 [[TMP6]], [[TMP15]]
; CHECK-NEXT:    [[TMP17:%.*]] = mul i16 [[TMP16]], [[TMP2]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_CLEANUP]]:
; CHECK-NEXT:    [[TMP18:%.*]] = phi i16 [ [[TMP10]], %[[FP_TO_I_IF_THEN5]] ], [ [[TMP14]], %[[FP_TO_I_IF_THEN12]] ], [ [[TMP17]], %[[FP_TO_I_IF_ELSE]] ], [ 0, %[[FP_TO_I_ENTRY]] ]
; CHECK-NEXT:    ret i16 [[TMP18]]
;
  %res = fptosi half %x to i16
  ret i16 %res
}

define i24 @fptosi_f16_i24(half %x) {
; CHECK-LABEL: define i24 @fptosi_f16_i24(
; CHECK-SAME: half [[X:%.*]]) {
; CHECK-NEXT:  [[FP_TO_I_ENTRY:.*]]:
; CHECK-NEXT:    [[TMP0:%.*]] = bitcast half [[X]] to i16
; CHECK-NEXT:    [[TMP1:%.*]] = zext i16 [[TMP0]] to i24
; CHECK-NEXT:    [[TMP2:%.*]] = icmp sgt i16 [[TMP0]], -1
; CHECK-NEXT:    [[TMP3:%.*]] = select i1 [[TMP2]], i24 1, i24 -1
; CHECK-NEXT:    [[TMP4:%.*]] = lshr i24 [[TMP1]], 10
; CHECK-NEXT:    [[TMP5:%.*]] = and i24 [[TMP4]], 31
; CHECK-NEXT:    [[TMP6:%.*]] = and i24 [[TMP1]], 1023
; CHECK-NEXT:    [[TMP7:%.*]] = or i24 [[TMP6]], 1024
; CHECK-NEXT:    [[TMP8:%.*]] = icmp ult i24 [[TMP5]], 15
; CHECK-NEXT:    br i1 [[TMP8]], label %[[FP_TO_I_CLEANUP:.*]], label %[[FP_TO_I_IF_END:.*]]
; CHECK:       [[FP_TO_I_IF_END]]:
; CHECK-NEXT:    [[TMP9:%.*]] = add i24 [[TMP5]], -39
; CHECK-NEXT:    [[TMP10:%.*]] = icmp ult i24 [[TMP9]], -24
; CHECK-NEXT:    br i1 [[TMP10]], label %[[FP_TO_I_IF_THEN5:.*]], label %[[FP_TO_I_IF_END9:.*]]
; CHECK:       [[FP_TO_I_IF_THEN5]]:
; CHECK-NEXT:    [[TMP11:%.*]] = select i1 [[TMP2]], i24 8388607, i24 -8388608
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_END9]]:
; CHECK-NEXT:    [[TMP12:%.*]] = icmp ult i24 [[TMP5]], 25
; CHECK-NEXT:    br i1 [[TMP12]], label %[[FP_TO_I_IF_THEN12:.*]], label %[[FP_TO_I_IF_ELSE:.*]]
; CHECK:       [[FP_TO_I_IF_THEN12]]:
; CHECK-NEXT:    [[TMP13:%.*]] = sub i24 25, [[TMP5]]
; CHECK-NEXT:    [[TMP14:%.*]] = lshr i24 [[TMP7]], [[TMP13]]
; CHECK-NEXT:    [[TMP15:%.*]] = mul i24 [[TMP14]], [[TMP3]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_ELSE]]:
; CHECK-NEXT:    [[TMP16:%.*]] = add i24 [[TMP5]], -25
; CHECK-NEXT:    [[TMP17:%.*]] = shl i24 [[TMP7]], [[TMP16]]
; CHECK-NEXT:    [[TMP18:%.*]] = mul i24 [[TMP17]], [[TMP3]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_CLEANUP]]:
; CHECK-NEXT:    [[TMP19:%.*]] = phi i24 [ [[TMP11]], %[[FP_TO_I_IF_THEN5]] ], [ [[TMP15]], %[[FP_TO_I_IF_THEN12]] ], [ [[TMP18]], %[[FP_TO_I_IF_ELSE]] ], [ 0, %[[FP_TO_I_ENTRY]] ]
; CHECK-NEXT:    ret i24 [[TMP19]]
;
  %res = fptosi half %x to i24
  ret i24 %res
}

define i16 @fptoui_f16_i16(half %x) {
; CHECK-LABEL: define i16 @fptoui_f16_i16(
; CHECK-SAME: half [[X:%.*]]) {
; CHECK-NEXT:  [[FP_TO_I_ENTRY:.*]]:
; CHECK-NEXT:    [[TMP0:%.*]] = bitcast half [[X]] to i16
; CHECK-NEXT:    [[TMP1:%.*]] = icmp sgt i16 [[TMP0]], -1
; CHECK-NEXT:    [[TMP2:%.*]] = select i1 [[TMP1]], i16 1, i16 -1
; CHECK-NEXT:    [[TMP3:%.*]] = lshr i16 [[TMP0]], 10
; CHECK-NEXT:    [[TMP4:%.*]] = and i16 [[TMP3]], 31
; CHECK-NEXT:    [[TMP5:%.*]] = and i16 [[TMP0]], 1023
; CHECK-NEXT:    [[TMP6:%.*]] = or i16 [[TMP5]], 1024
; CHECK-NEXT:    [[TMP7:%.*]] = icmp ult i16 [[TMP4]], 15
; CHECK-NEXT:    br i1 [[TMP7]], label %[[FP_TO_I_CLEANUP:.*]], label %[[FP_TO_I_IF_END:.*]]
; CHECK:       [[FP_TO_I_IF_END]]:
; CHECK-NEXT:    [[TMP8:%.*]] = add i16 [[TMP4]], -31
; CHECK-NEXT:    [[TMP9:%.*]] = icmp ult i16 [[TMP8]], -16
; CHECK-NEXT:    br i1 [[TMP9]], label %[[FP_TO_I_IF_THEN5:.*]], label %[[FP_TO_I_IF_END9:.*]]
; CHECK:       [[FP_TO_I_IF_THEN5]]:
; CHECK-NEXT:    [[TMP10:%.*]] = select i1 [[TMP1]], i16 32767, i16 -32768
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_END9]]:
; CHECK-NEXT:    [[TMP11:%.*]] = icmp ult i16 [[TMP4]], 25
; CHECK-NEXT:    br i1 [[TMP11]], label %[[FP_TO_I_IF_THEN12:.*]], label %[[FP_TO_I_IF_ELSE:.*]]
; CHECK:       [[FP_TO_I_IF_THEN12]]:
; CHECK-NEXT:    [[TMP12:%.*]] = sub i16 25, [[TMP4]]
; CHECK-NEXT:    [[TMP13:%.*]] = lshr i16 [[TMP6]], [[TMP12]]
; CHECK-NEXT:    [[TMP14:%.*]] = mul i16 [[TMP13]], [[TMP2]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_ELSE]]:
; CHECK-NEXT:    [[TMP15:%.*]] = add i16 [[TMP4]], -25
; CHECK-NEXT:    [[TMP16:%.*]] = shl i16 [[TMP6]], [[TMP15]]
; CHECK-NEXT:    [[TMP17:%.*]] = mul i16 [[TMP16]], [[TMP2]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_CLEANUP]]:
; CHECK-NEXT:    [[TMP18:%.*]] = phi i16 [ [[TMP10]], %[[FP_TO_I_IF_THEN5]] ], [ [[TMP14]], %[[FP_TO_I_IF_THEN12]] ], [ [[TMP17]], %[[FP_TO_I_IF_ELSE]] ], [ 0, %[[FP_TO_I_ENTRY]] ]
; CHECK-NEXT:    ret i16 [[TMP18]]
;
  %res = fptoui half %x to i16
  ret i16 %res
}

define i24 @fptoui_f16_i24(half %x) {
; CHECK-LABEL: define i24 @fptoui_f16_i24(
; CHECK-SAME: half [[X:%.*]]) {
; CHECK-NEXT:  [[FP_TO_I_ENTRY:.*]]:
; CHECK-NEXT:    [[TMP0:%.*]] = bitcast half [[X]] to i16
; CHECK-NEXT:    [[TMP1:%.*]] = zext i16 [[TMP0]] to i24
; CHECK-NEXT:    [[TMP2:%.*]] = icmp sgt i16 [[TMP0]], -1
; CHECK-NEXT:    [[TMP3:%.*]] = select i1 [[TMP2]], i24 1, i24 -1
; CHECK-NEXT:    [[TMP4:%.*]] = lshr i24 [[TMP1]], 10
; CHECK-NEXT:    [[TMP5:%.*]] = and i24 [[TMP4]], 31
; CHECK-NEXT:    [[TMP6:%.*]] = and i24 [[TMP1]], 1023
; CHECK-NEXT:    [[TMP7:%.*]] = or i24 [[TMP6]], 1024
; CHECK-NEXT:    [[TMP8:%.*]] = icmp ult i24 [[TMP5]], 15
; CHECK-NEXT:    br i1 [[TMP8]], label %[[FP_TO_I_CLEANUP:.*]], label %[[FP_TO_I_IF_END:.*]]
; CHECK:       [[FP_TO_I_IF_END]]:
; CHECK-NEXT:    [[TMP9:%.*]] = add i24 [[TMP5]], -39
; CHECK-NEXT:    [[TMP10:%.*]] = icmp ult i24 [[TMP9]], -24
; CHECK-NEXT:    br i1 [[TMP10]], label %[[FP_TO_I_IF_THEN5:.*]], label %[[FP_TO_I_IF_END9:.*]]
; CHECK:       [[FP_TO_I_IF_THEN5]]:
; CHECK-NEXT:    [[TMP11:%.*]] = select i1 [[TMP2]], i24 8388607, i24 -8388608
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_END9]]:
; CHECK-NEXT:    [[TMP12:%.*]] = icmp ult i24 [[TMP5]], 25
; CHECK-NEXT:    br i1 [[TMP12]], label %[[FP_TO_I_IF_THEN12:.*]], label %[[FP_TO_I_IF_ELSE:.*]]
; CHECK:       [[FP_TO_I_IF_THEN12]]:
; CHECK-NEXT:    [[TMP13:%.*]] = sub i24 25, [[TMP5]]
; CHECK-NEXT:    [[TMP14:%.*]] = lshr i24 [[TMP7]], [[TMP13]]
; CHECK-NEXT:    [[TMP15:%.*]] = mul i24 [[TMP14]], [[TMP3]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_IF_ELSE]]:
; CHECK-NEXT:    [[TMP16:%.*]] = add i24 [[TMP5]], -25
; CHECK-NEXT:    [[TMP17:%.*]] = shl i24 [[TMP7]], [[TMP16]]
; CHECK-NEXT:    [[TMP18:%.*]] = mul i24 [[TMP17]], [[TMP3]]
; CHECK-NEXT:    br label %[[FP_TO_I_CLEANUP]]
; CHECK:       [[FP_TO_I_CLEANUP]]:
; CHECK-NEXT:    [[TMP19:%.*]] = phi i24 [ [[TMP11]], %[[FP_TO_I_IF_THEN5]] ], [ [[TMP15]], %[[FP_TO_I_IF_THEN12]] ], [ [[TMP18]], %[[FP_TO_I_IF_ELSE]] ], [ 0, %[[FP_TO_I_ENTRY]] ]
; CHECK-NEXT:    ret i24 [[TMP19]]
;
  %res = fptoui half %x to i24
  ret i24 %res
}
