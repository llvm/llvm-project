; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --include-generated-funcs --version 6
; RUN: opt < %s -passes='default<O2>' -S | FileCheck --check-prefixes=CHECK %s
; RUN: opt < %s -O0 -S | FileCheck --check-prefixes=CHECK-O0 %s
target datalayout = "p:64:64:64"

%async.task = type { i64 }
%async.actor = type { i64 }
%async.fp = type <{ i32, i32 }>

%async.ctxt = type { ptr, ptr }

; The async callee.
@my_other_async_function_fp = external global <{ i32, i32 }>
declare void @my_other_async_function(ptr %async.ctxt)

; The current async function (the caller).
; This struct describes an async function. The first field is the
; relative offset to the async function implementation, the second field is the
; size needed for the async context of the current async function.

@my_async_function_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @my_async_function to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @my_async_function_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
}>
@my_async_function_pa_fp = constant <{ i32, i32 }>
  <{ i32 trunc (
  i64 sub (
  i64 ptrtoint (ptr @my_async_function_pa to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @my_async_function_pa_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 8
}>

; Function that implements the dispatch to the callee function.
define swiftcc void @my_async_function.my_other_async_function_fp.apply(ptr %fnPtr, ptr %async.ctxt, ptr %task, ptr %actor) {
  tail call swiftcc void %fnPtr(ptr %async.ctxt, ptr %task, ptr %actor)
  ret void
}

declare void @some_user(i64)
declare void @some_may_write(ptr)

define ptr @__swift_async_resume_project_context(ptr %ctxt) {
entry:
  %resume_ctxt = load ptr, ptr %ctxt, align 8
  ret ptr %resume_ctxt
}

define ptr @resume_context_projection(ptr %ctxt) {
entry:
  %resume_ctxt = load ptr, ptr %ctxt, align 8
  ret ptr %resume_ctxt
}


define swiftcc void @my_async_function(ptr swiftasync %async.ctxt, ptr %task, ptr %actor) presplitcoroutine !dbg !1 {
entry:
  %tmp = alloca { i64, i64 }, align 8
  %vector = alloca <4 x double>, align 16
  %proj.1 = getelementptr inbounds { i64, i64 }, ptr %tmp, i64 0, i32 0
  %proj.2 = getelementptr inbounds { i64, i64 }, ptr %tmp, i64 0, i32 1

  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @my_async_function_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  store i64 0, ptr %proj.1, align 8
  store i64 1, ptr %proj.2, align 8
  call void @some_may_write(ptr %proj.1)

  ; Begin lowering: apply %my_other_async_function(%args...)

  ; setup callee context
  %callee_context = call ptr @llvm.coro.async.context.alloc(ptr %task, ptr @my_other_async_function_fp)
  ; store arguments ...
  ; ... (omitted)

  ; store the return continuation
  %callee_context.return_to_caller.addr = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr, ptr %callee_context.return_to_caller.addr

  ; store caller context into callee context
  store ptr %async.ctxt, ptr %callee_context
  %vector_spill = load <4 x double>, ptr %vector, align 16
  %res = call {ptr, ptr, ptr} (i32, ptr, ptr, ...) @llvm.coro.suspend.async(i32 0,
  ptr %resume.func_ptr,
  ptr @__swift_async_resume_project_context,
  ptr @my_async_function.my_other_async_function_fp.apply,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor), !dbg !5

  call void @llvm.coro.async.context.dealloc(ptr %callee_context)
  %continuation_task_arg = extractvalue {ptr, ptr, ptr} %res, 1
  %val = load i64, ptr %proj.1
  call void @some_user(i64 %val)
  %val.2 = load i64, ptr %proj.2
  call void @some_user(i64 %val.2)
  store <4 x double> %vector_spill, ptr %vector, align 16
  tail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %continuation_task_arg, ptr %actor)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable
}

define void @my_async_function_pa(ptr %ctxt, ptr %task, ptr %actor) {
  call void @llvm.coro.async.size.replace(ptr @my_async_function_pa_fp, ptr @my_async_function_fp)
  call swiftcc void @my_async_function(ptr %ctxt, ptr %task, ptr %actor)
  ret void
}

; Make sure we update the async function pointer

; Make sure the spill is underaligned to the max context alignment (16).


@my_async_function2_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @my_async_function2 to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @my_async_function2_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
  }>

define swiftcc void @my_async_function2(ptr %task, ptr %actor, ptr %async.ctxt) presplitcoroutine "frame-pointer"="all" !dbg !6 {
entry:

  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 2, ptr @my_async_function2_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  ; setup callee context
  %callee_context = call ptr @llvm.coro.async.context.alloc(ptr %task, ptr @my_other_async_function_fp)

  %callee_context.return_to_caller.addr = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr, ptr %callee_context.return_to_caller.addr
  store ptr %async.ctxt, ptr %callee_context
  %res = call {ptr, ptr, ptr} (i32, ptr, ptr, ...) @llvm.coro.suspend.async(i32 2,
  ptr %resume.func_ptr,
  ptr @resume_context_projection,
  ptr @my_async_function.my_other_async_function_fp.apply,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor), !dbg !9

  %continuation_task_arg = extractvalue {ptr, ptr, ptr} %res, 0

  %callee_context.return_to_caller.addr.1 = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr.1 = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr.1, ptr %callee_context.return_to_caller.addr.1
  store ptr %async.ctxt, ptr %callee_context
  %res.2 = call {ptr, ptr, ptr} (i32, ptr, ptr, ...) @llvm.coro.suspend.async(i32 0,
  ptr %resume.func_ptr.1,
  ptr @resume_context_projection,
  ptr @my_async_function.my_other_async_function_fp.apply,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor)

  call void @llvm.coro.async.context.dealloc(ptr %callee_context)
  %continuation_actor_arg = extractvalue {ptr, ptr, ptr} %res.2, 1

  tail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %continuation_task_arg, ptr %continuation_actor_arg)
  call void @llvm.coro.end(ptr %hdl, i1 0, token none)
  unreachable
}




define swiftcc void @top_level_caller(ptr %ctxt, ptr %task, ptr %actor) {
  %prepare = call ptr @llvm.coro.prepare.async(ptr @my_async_function)
  call swiftcc void %prepare(ptr %ctxt, ptr %task, ptr %actor)
  ret void
}


@dont_crash_on_cf_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @my_async_function to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @my_async_function_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
}>


define swiftcc void @dont_crash_on_cf_dispatch(ptr %fnPtr, ptr %async.ctxt, ptr %task, ptr %actor) {
  %isNull = icmp eq ptr %task, null
  br i1 %isNull, label %is_null, label %is_not_null

is_null:
  ret void

is_not_null:
  tail call swiftcc void %fnPtr(ptr %async.ctxt, ptr %task, ptr %actor)
  ret void
}

define swiftcc void @dont_crash_on_cf(ptr %async.ctxt, ptr %task, ptr %actor) presplitcoroutine  {
entry:
  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @dont_crash_on_cf_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  %callee_context = call ptr @llvm.coro.async.context.alloc(ptr %task, ptr @my_other_async_function_fp)
  %callee_context.return_to_caller.addr = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr, ptr %callee_context.return_to_caller.addr
  store ptr %async.ctxt, ptr %callee_context
  %res = call {ptr, ptr, ptr} (i32, ptr, ptr, ...) @llvm.coro.suspend.async(i32 0,
  ptr %resume.func_ptr,
  ptr @resume_context_projection,
  ptr @dont_crash_on_cf_dispatch,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor)

  call void @llvm.coro.async.context.dealloc(ptr %callee_context)
  %continuation_task_arg = extractvalue {ptr, ptr, ptr} %res, 1
  tail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %continuation_task_arg, ptr %actor)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable
}

@multiple_coro_end_async_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @multiple_coro_end_async to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @multiple_coro_end_async_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
}>

define swiftcc void @must_tail_call_return(ptr %async.ctxt, ptr %task, ptr %actor) {
  musttail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %task, ptr %actor)
  ret void
}

define swiftcc void @multiple_coro_end_async(ptr %async.ctxt, ptr %task, ptr %actor) presplitcoroutine {
entry:
  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @dont_crash_on_cf_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  %callee_context = call ptr @llvm.coro.async.context.alloc(ptr %task, ptr @my_other_async_function_fp)
  %callee_context.return_to_caller.addr = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr, ptr %callee_context.return_to_caller.addr
  store ptr %async.ctxt, ptr %callee_context
  %res = call {ptr, ptr, ptr} (i32, ptr, ptr, ...) @llvm.coro.suspend.async(i32 0,
  ptr %resume.func_ptr,
  ptr @resume_context_projection,
  ptr @dont_crash_on_cf_dispatch,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor)

  call void @llvm.coro.async.context.dealloc(ptr %callee_context)
  %continuation_task_arg = extractvalue {ptr, ptr, ptr} %res, 1
  %eq = icmp eq ptr %continuation_task_arg, null
  br i1 %eq, label %is_equal, label %is_not_equal

is_equal:
  tail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %continuation_task_arg, ptr %actor)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable

is_not_equal:
  call void (ptr, i1, ...) @llvm.coro.end.async(
  ptr %hdl, i1 0,
  ptr @must_tail_call_return,
  ptr %async.ctxt, ptr %continuation_task_arg, ptr null)
  unreachable
}


@polymorphic_suspend_return_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @polymorphic_suspend_return to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @polymorphic_suspend_return_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 64    ; Initial async context size without space for frame
}>

define swiftcc void @polymorphic_suspend_return(ptr swiftasync %async.ctxt, ptr %task, ptr %actor) presplitcoroutine {
entry:
  %tmp = alloca { i64, i64 }, align 8
  %proj.1 = getelementptr inbounds { i64, i64 }, ptr %tmp, i64 0, i32 0
  %proj.2 = getelementptr inbounds { i64, i64 }, ptr %tmp, i64 0, i32 1

  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @polymorphic_suspend_return_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  store i64 0, ptr %proj.1, align 8
  store i64 1, ptr %proj.2, align 8
  call void @some_may_write(ptr %proj.1)

  ; Begin lowering: apply %my_other_async_function(%args...)

  ; setup callee context
  %callee_context = call ptr @llvm.coro.async.context.alloc(ptr %task, ptr @my_other_async_function_fp)
  ; store arguments ...
  ; ... (omitted)

  ; store the return continuation
  %callee_context.return_to_caller.addr = getelementptr inbounds %async.ctxt, ptr %callee_context, i32 0, i32 1
  %resume.func_ptr = call ptr @llvm.coro.async.resume()
  store ptr %resume.func_ptr, ptr %callee_context.return_to_caller.addr

  ; store caller context into callee context
  store ptr %async.ctxt, ptr %callee_context
  %res = call {ptr, ptr, ptr, ptr} (i32, ptr, ptr, ...)
  @llvm.coro.suspend.async.sl_p0i8p0i8p0i8p0i8s(i32 256, ;; swiftasync at 0 and swiftself at 1 in resume function
  ptr %resume.func_ptr,
  ptr @resume_context_projection,
  ptr @my_async_function.my_other_async_function_fp.apply,
  ptr @asyncSuspend, ptr %callee_context, ptr %task, ptr %actor)

  call void @llvm.coro.async.context.dealloc(ptr %callee_context)
  %continuation_task_arg = extractvalue {ptr, ptr, ptr, ptr} %res, 3
  %val = load i64, ptr %proj.1
  call void @some_user(i64 %val)
  %val.2 = load i64, ptr %proj.2
  call void @some_user(i64 %val.2)

  tail call swiftcc void @asyncReturn(ptr %async.ctxt, ptr %continuation_task_arg, ptr %actor)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable
}


@no_coro_suspend_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @no_coro_suspend to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @no_coro_suspend_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
}>

define swiftcc void @no_coro_suspend(ptr %async.ctx) presplitcoroutine {
entry:
  %some_alloca = alloca i64
  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @no_coro_suspend_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  call void @some_may_write(ptr %some_alloca)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable
}


@no_coro_suspend_swifterror_fp = constant <{ i32, i32 }>
  <{ i32 trunc ( ; Relative pointer to async function
  i64 sub (
  i64 ptrtoint (ptr @no_coro_suspend_swifterror to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @no_coro_suspend_swifterror_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 128    ; Initial async context size without space for frame
}>

declare void @do_with_swifterror(ptr swifterror)

define swiftcc void @no_coro_suspend_swifterror(ptr %async.ctx) presplitcoroutine {
entry:
  %some_alloca = alloca swifterror ptr
  %id = call token @llvm.coro.id.async(i32 128, i32 16, i32 0,
  ptr @no_coro_suspend_swifterror_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  store ptr null, ptr %some_alloca, align 8
  call void @do_with_swifterror(ptr swifterror %some_alloca)
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 0)
  unreachable
}


@undefined_coro_async_resume_fp = constant <{ i32, i32 }>
  <{ i32 trunc (
  i64 sub (
  i64 ptrtoint (ptr @undefined_coro_async_resume to i64),
  i64 ptrtoint (ptr getelementptr inbounds (<{ i32, i32 }>, ptr @undefined_coro_async_resume_fp, i32 0, i32 1) to i64)
  )
  to i32),
  i32 24
}>

declare void @crash()
declare void @use(ptr)

define swiftcc void @undefined_coro_async_resume(ptr %async.ctx) presplitcoroutine {
entry:
  %id = call token @llvm.coro.id.async(i32 24, i32 16, i32 0, ptr @undefined_coro_async_resume_fp)
  %hdl = call ptr @llvm.coro.begin(token %id, ptr null)
  %undefined_resume_pointer = call ptr @llvm.coro.async.resume()
  call void @use(ptr %undefined_resume_pointer)
  call void @crash()
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %hdl, i1 false)
  unreachable
}

@simpleFuncTu = global <{i32, i32}> <{
  i32 trunc (i64 sub (i64 ptrtoint (ptr @simpleFunc to i64),
  i64 ptrtoint (ptr @simpleFuncTu to i64)) to i32), i32 16 }>

define swifttailcc void @simpleFunc(ptr swiftasync %0) presplitcoroutine {
entry:
  %1 = alloca ptr, align 8
  %2 = call token @llvm.coro.id.async(i32 16, i32 16, i32 0, ptr @simpleFuncTu)
  %3 = call ptr @llvm.coro.begin(token %2, ptr null)
  store ptr %0, ptr %1, align 8
  %4 = load ptr, ptr %1, align 8
  %5 = getelementptr inbounds <{ ptr, ptr }>, ptr %4, i32 0, i32 1
  %6 = load ptr, ptr %5, align 8
  %7 = load ptr, ptr %1, align 8
  call void (ptr, i1, ...) @llvm.coro.end.async(ptr %3, i1 false, ptr @simpleFunc.0, ptr %6, ptr %7)
  unreachable
}


define internal swifttailcc void @simpleFunc.0(ptr %0, ptr %1) alwaysinline {
entry:
  musttail call swifttailcc void %0(ptr swiftasync %1)
  ret void
}

declare { ptr, ptr, ptr, ptr } @llvm.coro.suspend.async.sl_p0i8p0i8p0i8p0i8s(i32, ptr, ptr, ...)
declare ptr @llvm.coro.prepare.async(ptr)
declare token @llvm.coro.id.async(i32, i32, i32, ptr)
declare ptr @llvm.coro.begin(token, ptr)
declare void @llvm.coro.end.async(ptr, i1, ...)
declare void @llvm.coro.end(ptr, i1, token)
declare {ptr, ptr, ptr} @llvm.coro.suspend.async(i32, ptr, ptr, ...)
declare ptr @llvm.coro.async.context.alloc(ptr, ptr)
declare void @llvm.coro.async.context.dealloc(ptr)
declare swiftcc void @asyncReturn(ptr, ptr, ptr)
declare swiftcc void @asyncSuspend(ptr, ptr, ptr)
declare ptr @llvm.coro.async.resume()
declare void @llvm.coro.async.size.replace(ptr, ptr)
declare ptr @hide(ptr)

!llvm.dbg.cu = !{!2}
!llvm.module.flags = !{!0}

!0 = !{i32 2, !"Debug Info Version", i32 3}
!1 = distinct !DISubprogram(name: "my_async_function",
  linkageName: "my_async_function",
  scope: !2, file: !3, line: 1, type: !4,
  scopeLine: 1, spFlags: DISPFlagDefinition, unit: !2)
!2 = distinct !DICompileUnit(language: DW_LANG_Swift, file: !3, emissionKind: FullDebug)
!3 = !DIFile(filename: "/tmp/1.swift", directory: "/")
!4 = !DISubroutineType(types: !{})
!5 = !DILocation(line: 2, column: 0, scope: !1)

!6 = distinct !DISubprogram(name: "my_async_function2",
  linkageName: "my_async_function2",
  scope: !2, file: !3, line: 1, type: !4,
  scopeLine: 1, spFlags: DISPFlagDefinition, unit: !2)
!7 = !DILexicalBlockFile(scope: !6, file: !8, discriminator: 0)
!8 = !DIFile(filename: "/tmp/fake.cpp", directory: "/")
!9 = !DILocation(line: 2, column: 0, scope: !7)
; CHECK-LABEL: define swiftcc void @my_async_function.my_other_async_function_fp.apply(
; CHECK-SAME: ptr readonly captures(none) [[FNPTR:%.*]], ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) local_unnamed_addr {
; CHECK-NEXT:    tail call swiftcc void [[FNPTR]](ptr [[ASYNC_CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define ptr @__swift_async_resume_project_context(
; CHECK-SAME: ptr readonly captures(none) [[CTXT:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT:%.*]] = load ptr, ptr [[CTXT]], align 8
; CHECK-NEXT:    ret ptr [[RESUME_CTXT]]
;
;
; CHECK-LABEL: define ptr @resume_context_projection(
; CHECK-SAME: ptr readonly captures(none) [[CTXT:%.*]]) local_unnamed_addr #[[ATTR0]] {
; CHECK-NEXT:  [[ENTRY:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT:%.*]] = load ptr, ptr [[CTXT]], align 8
; CHECK-NEXT:    ret ptr [[RESUME_CTXT]]
;
;
; CHECK-LABEL: define swiftcc void @my_async_function(
; CHECK-SAME: ptr swiftasync initializes((152, 160)) [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) !dbg [[DBG3:![0-9]+]] {
; CHECK-NEXT:  [[CORO_RETURN:.*:]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 152
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 144
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[PROJ_2:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 136
; CHECK-NEXT:    store i64 0, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    store i64 1, ptr [[PROJ_2]], align 8
; CHECK-NEXT:    tail call void @some_may_write(ptr nonnull [[ASYNC_CTX_FRAMEPTR]])
; CHECK-NEXT:    [[CALLEE_CONTEXT:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 160
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT]], i64 8
; CHECK-NEXT:    store ptr @my_async_functionTQ0_, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG6:![0-9]+]]
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @my_async_functionTQ0_(
; CHECK-SAME: ptr readonly swiftasync captures(none) [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr readnone captures(none) [[TMP2:%.*]]) !dbg [[DBG7:![0-9]+]] {
; CHECK-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8, !dbg [[DBG8:![0-9]+]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 128
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 160
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 152
; CHECK-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[PROJ_21:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 136
; CHECK-NEXT:    tail call void @llvm.coro.async.context.dealloc(ptr nonnull [[CALLEE_CONTEXT_RELOAD]])
; CHECK-NEXT:    [[VAL:%.*]] = load i64, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    tail call void @some_user(i64 [[VAL]])
; CHECK-NEXT:    [[VAL_2:%.*]] = load i64, ptr [[PROJ_21]], align 8
; CHECK-NEXT:    tail call void @some_user(i64 [[VAL_2]])
; CHECK-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP1]], ptr [[ACTOR_RELOAD]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define void @my_async_function_pa(
; CHECK-SAME: ptr initializes((152, 160)) [[CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 152
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 144
; CHECK-NEXT:    store ptr [[CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[PROJ_2_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 136
; CHECK-NEXT:    store i64 0, ptr [[ASYNC_CTX_FRAMEPTR_I]], align 8
; CHECK-NEXT:    store i64 1, ptr [[PROJ_2_I]], align 8
; CHECK-NEXT:    tail call void @some_may_write(ptr nonnull [[ASYNC_CTX_FRAMEPTR_I]])
; CHECK-NEXT:    [[CALLEE_CONTEXT_I:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 160
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT_I]], ptr [[CALLEE_CONTEXT_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT_I]], i64 8
; CHECK-NEXT:    store ptr @my_async_functionTQ0_, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_I]], align 8
; CHECK-NEXT:    store ptr [[CTXT]], ptr [[CALLEE_CONTEXT_I]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT_I]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG6]]
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @my_async_function2(
; CHECK-SAME: ptr [[TASK:%.*]], ptr [[ACTOR:%.*]], ptr [[ASYNC_CTXT:%.*]]) #[[ATTR1:[0-9]+]] !dbg [[DBG9:![0-9]+]] {
; CHECK-NEXT:  [[CORO_RETURN:.*:]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 128
; CHECK-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 144
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 136
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-NEXT:    store ptr [[TASK]], ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 152
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT]], i64 8
; CHECK-NEXT:    store ptr @my_async_function2.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG10:![0-9]+]]
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @my_async_function2.resume.0(
; CHECK-SAME: ptr [[TMP0:%.*]], ptr readnone captures(none) [[TMP1:%.*]], ptr readonly captures(none) [[TMP2:%.*]]) #[[ATTR1]] !dbg [[DBG13:![0-9]+]] {
; CHECK-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP2]], align 8, !dbg [[DBG14:![0-9]+]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 128
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR10:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 152
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD11:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR10]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR4:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD5:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR4]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR3:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT_RELOAD11]], i64 8
; CHECK-NEXT:    [[CONTINUATION_TASK_ARG_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 160
; CHECK-NEXT:    store ptr [[TMP0]], ptr [[CONTINUATION_TASK_ARG_SPILL_ADDR]], align 8
; CHECK-NEXT:    store ptr @my_async_function2.resume.1, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR3]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT_RELOAD5]], ptr [[CALLEE_CONTEXT_RELOAD11]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD9:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR10]], align 8
; CHECK-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 136
; CHECK-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[TASK_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT_RELOAD9]], ptr [[TASK_RELOAD]], ptr [[ACTOR_RELOAD]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @my_async_function2.resume.1(
; CHECK-SAME: ptr readonly captures(none) [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr readnone captures(none) [[TMP2:%.*]]) #[[ATTR1]] !dbg [[DBG16:![0-9]+]] {
; CHECK-NEXT:  [[ENTRYRESUME_1:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-NEXT:    [[CONTINUATION_TASK_ARG_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 160
; CHECK-NEXT:    [[CONTINUATION_TASK_ARG_RELOAD:%.*]] = load ptr, ptr [[CONTINUATION_TASK_ARG_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR6:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 152
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD7:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR6]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    tail call void @llvm.coro.async.context.dealloc(ptr nonnull [[CALLEE_CONTEXT_RELOAD7]])
; CHECK-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[CONTINUATION_TASK_ARG_RELOAD]], ptr [[TMP1]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @top_level_caller(
; CHECK-SAME: ptr initializes((152, 160)) [[CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) local_unnamed_addr {
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 152
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 144
; CHECK-NEXT:    store ptr [[CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[PROJ_2_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 136
; CHECK-NEXT:    store i64 0, ptr [[ASYNC_CTX_FRAMEPTR_I]], align 8
; CHECK-NEXT:    store i64 1, ptr [[PROJ_2_I]], align 8
; CHECK-NEXT:    tail call void @some_may_write(ptr nonnull [[ASYNC_CTX_FRAMEPTR_I]])
; CHECK-NEXT:    [[CALLEE_CONTEXT_I:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CTXT]], i64 160
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT_I]], ptr [[CALLEE_CONTEXT_SPILL_ADDR_I]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_I:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT_I]], i64 8
; CHECK-NEXT:    store ptr @my_async_functionTQ0_, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_I]], align 8
; CHECK-NEXT:    store ptr [[CTXT]], ptr [[CALLEE_CONTEXT_I]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT_I]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG6]]
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @dont_crash_on_cf_dispatch(
; CHECK-SAME: ptr readonly captures(none) [[FNPTR:%.*]], ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) local_unnamed_addr {
; CHECK-NEXT:    [[ISNULL:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-NEXT:    br i1 [[ISNULL]], label %[[COMMON_RET:.*]], label %[[IS_NOT_NULL:.*]]
; CHECK:       [[COMMON_RET]]:
; CHECK-NEXT:    ret void
; CHECK:       [[IS_NOT_NULL]]:
; CHECK-NEXT:    tail call swiftcc void [[FNPTR]](ptr [[ASYNC_CTXT]], ptr nonnull [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    br label %[[COMMON_RET]]
;
;
; CHECK-LABEL: define swiftcc void @dont_crash_on_cf(
; CHECK-SAME: ptr initializes((136, 144)) [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) local_unnamed_addr {
; CHECK-NEXT:  [[CORO_RETURN:.*:]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 136
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 144
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT]], i64 8
; CHECK-NEXT:    store ptr @dont_crash_on_cf.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-NEXT:    [[ISNULL_I:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-NEXT:    br i1 [[ISNULL_I]], label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT:.*]], label %[[IS_NOT_NULL_I:.*]]
; CHECK:       [[IS_NOT_NULL_I]]:
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT]], ptr nonnull [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    br label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT]]
; CHECK:       [[DONT_CRASH_ON_CF_DISPATCH_EXIT]]:
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @dont_crash_on_cf.resume.0(
; CHECK-SAME: ptr readonly captures(none) [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr readnone captures(none) [[TMP2:%.*]]) {
; CHECK-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 128
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 136
; CHECK-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    tail call void @llvm.coro.async.context.dealloc(ptr nonnull [[CALLEE_CONTEXT_RELOAD]])
; CHECK-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP1]], ptr [[ACTOR_RELOAD]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @must_tail_call_return(
; CHECK-SAME: ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) local_unnamed_addr {
; CHECK-NEXT:    musttail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @multiple_coro_end_async(
; CHECK-SAME: ptr initializes((136, 144)) [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-NEXT:  [[CORO_RETURN:.*:]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 136
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 144
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT]], i64 8
; CHECK-NEXT:    store ptr @multiple_coro_end_async.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-NEXT:    [[ISNULL_I:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-NEXT:    br i1 [[ISNULL_I]], label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT:.*]], label %[[IS_NOT_NULL_I:.*]]
; CHECK:       [[IS_NOT_NULL_I]]:
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT]], ptr nonnull [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    br label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT]]
; CHECK:       [[DONT_CRASH_ON_CF_DISPATCH_EXIT]]:
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @multiple_coro_end_async.resume.0(
; CHECK-SAME: ptr readonly captures(none) [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr readnone captures(none) [[TMP2:%.*]]) {
; CHECK-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 128
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    tail call void @llvm.coro.async.context.dealloc(ptr nonnull [[CALLEE_CONTEXT_RELOAD]])
; CHECK-NEXT:    [[EQ:%.*]] = icmp eq ptr [[TMP1]], null
; CHECK-NEXT:    br i1 [[EQ]], label %[[COROEND:.*]], label %[[AFTERMUSTTAILCALL_BEFORE_COROEND:.*]]
; CHECK:       [[COROEND]]:
; CHECK-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 136
; CHECK-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD4:%.*]] = load ptr, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD4]], ptr null, ptr [[ACTOR_RELOAD]])
; CHECK-NEXT:    ret void
; CHECK:       [[AFTERMUSTTAILCALL_BEFORE_COROEND]]:
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    musttail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr nonnull [[TMP1]], ptr null)
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @polymorphic_suspend_return(
; CHECK-SAME: ptr swiftasync initializes((152, 160)) [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-NEXT:  [[CORO_RETURN:.*:]]
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 128
; CHECK-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 152
; CHECK-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 144
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[PROJ_2:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 136
; CHECK-NEXT:    store i64 0, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    store i64 1, ptr [[PROJ_2]], align 8
; CHECK-NEXT:    tail call void @some_may_write(ptr nonnull [[ASYNC_CTX_FRAMEPTR]])
; CHECK-NEXT:    [[CALLEE_CONTEXT:%.*]] = tail call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr nonnull @my_other_async_function_fp)
; CHECK-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[ASYNC_CTXT]], i64 160
; CHECK-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[CALLEE_CONTEXT]], i64 8
; CHECK-NEXT:    store ptr @polymorphic_suspend_return.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-NEXT:    tail call swiftcc void @asyncSuspend(ptr nonnull [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define internal swiftcc void @polymorphic_suspend_return.resume.0(
; CHECK-SAME: ptr readonly swiftasync captures(none) [[TMP0:%.*]], ptr readnone swiftself captures(none) [[TMP1:%.*]], ptr readnone captures(none) [[TMP2:%.*]], ptr [[TMP3:%.*]]) {
; CHECK-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 128
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 160
; CHECK-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 152
; CHECK-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 144
; CHECK-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[PROJ_21:%.*]] = getelementptr inbounds nuw i8, ptr [[RESUME_CTXT_I]], i64 136
; CHECK-NEXT:    tail call void @llvm.coro.async.context.dealloc(ptr nonnull [[CALLEE_CONTEXT_RELOAD]])
; CHECK-NEXT:    [[VAL:%.*]] = load i64, ptr [[ASYNC_CTX_FRAMEPTR]], align 8
; CHECK-NEXT:    tail call void @some_user(i64 [[VAL]])
; CHECK-NEXT:    [[VAL_2:%.*]] = load i64, ptr [[PROJ_21]], align 8
; CHECK-NEXT:    tail call void @some_user(i64 [[VAL_2]])
; CHECK-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP3]], ptr [[ACTOR_RELOAD]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @no_coro_suspend(
; CHECK-SAME: ptr readnone captures(none) [[ASYNC_CTX:%.*]]) {
; CHECK-NEXT:  [[COROEND:.*:]]
; CHECK-NEXT:    [[SOME_ALLOCA:%.*]] = alloca i64, align 8
; CHECK-NEXT:    call void @some_may_write(ptr nonnull [[SOME_ALLOCA]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @no_coro_suspend_swifterror(
; CHECK-SAME: ptr readnone captures(none) [[ASYNC_CTX:%.*]]) {
; CHECK-NEXT:  [[COROEND:.*:]]
; CHECK-NEXT:    [[SOME_ALLOCA:%.*]] = alloca swifterror ptr, align 8
; CHECK-NEXT:    store ptr null, ptr [[SOME_ALLOCA]], align 8
; CHECK-NEXT:    call void @do_with_swifterror(ptr nonnull swifterror [[SOME_ALLOCA]])
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swiftcc void @undefined_coro_async_resume(
; CHECK-SAME: ptr readnone captures(none) [[ASYNC_CTX:%.*]]) {
; CHECK-NEXT:  [[COROEND:.*:]]
; CHECK-NEXT:    tail call void @use(ptr null)
; CHECK-NEXT:    tail call void @crash()
; CHECK-NEXT:    ret void
;
;
; CHECK-LABEL: define swifttailcc void @simpleFunc(
; CHECK-SAME: ptr swiftasync [[TMP0:%.*]]) {
; CHECK-NEXT:  [[AFTERMUSTTAILCALL_BEFORE_COROEND:.*:]]
; CHECK-NEXT:    [[TMP1:%.*]] = getelementptr inbounds nuw i8, ptr [[TMP0]], i64 8
; CHECK-NEXT:    [[TMP2:%.*]] = load ptr, ptr [[TMP1]], align 8
; CHECK-NEXT:    musttail call swifttailcc void [[TMP2]](ptr swiftasync [[TMP0]])
; CHECK-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @my_async_function.my_other_async_function_fp.apply(
; CHECK-O0-SAME: ptr [[FNPTR:%.*]], ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:    tail call swiftcc void [[FNPTR]](ptr [[ASYNC_CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define ptr @__swift_async_resume_project_context(
; CHECK-O0-SAME: ptr [[CTXT:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT:%.*]] = load ptr, ptr [[CTXT]], align 8
; CHECK-O0-NEXT:    ret ptr [[RESUME_CTXT]]
;
;
; CHECK-O0-LABEL: define ptr @resume_context_projection(
; CHECK-O0-SAME: ptr [[CTXT:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT:%.*]] = load ptr, ptr [[CTXT]], align 8
; CHECK-O0-NEXT:    ret ptr [[RESUME_CTXT]]
;
;
; CHECK-O0-LABEL: define swiftcc void @my_async_function(
; CHECK-O0-SAME: ptr swiftasync [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) !dbg [[DBG3:![0-9]+]] {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[ASYNC_CTXT]], i32 128
; CHECK-O0-NEXT:    [[TMP:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[VECTOR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 4
; CHECK-O0-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[PROJ_1:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 0
; CHECK-O0-NEXT:    [[PROJ_2:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 1
; CHECK-O0-NEXT:    store i64 0, ptr [[PROJ_1]], align 8
; CHECK-O0-NEXT:    store i64 1, ptr [[PROJ_2]], align 8
; CHECK-O0-NEXT:    call void @some_may_write(ptr [[PROJ_1]])
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT:%.*]] = call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr @my_other_async_function_fp)
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 5
; CHECK-O0-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @my_async_functionTQ0_, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-O0-NEXT:    [[VECTOR_SPILL:%.*]] = load <4 x double>, ptr [[VECTOR]], align 16
; CHECK-O0-NEXT:    [[VECTOR_SPILL_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1, !dbg [[DBG6:![0-9]+]]
; CHECK-O0-NEXT:    store <4 x double> [[VECTOR_SPILL]], ptr [[VECTOR_SPILL_SPILL_ADDR]], align 16, !dbg [[DBG6]]
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG6]]
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @my_async_functionTQ0_(
; CHECK-O0-SAME: ptr swiftasync [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr [[TMP2:%.*]]) !dbg [[DBG7:![0-9]+]] {
; CHECK-O0-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8, !dbg [[DBG8:![0-9]+]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[TMP:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[VECTOR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[VECTOR_SPILL_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    [[VECTOR_SPILL_RELOAD:%.*]] = load <4 x double>, ptr [[VECTOR_SPILL_RELOAD_ADDR]], align 16
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 5
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 4
; CHECK-O0-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[PROJ_22:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 1
; CHECK-O0-NEXT:    [[PROJ_11:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 0
; CHECK-O0-NEXT:    call void @llvm.coro.async.context.dealloc(ptr [[CALLEE_CONTEXT_RELOAD]])
; CHECK-O0-NEXT:    [[VAL:%.*]] = load i64, ptr [[PROJ_11]], align 4
; CHECK-O0-NEXT:    call void @some_user(i64 [[VAL]])
; CHECK-O0-NEXT:    [[VAL_2:%.*]] = load i64, ptr [[PROJ_22]], align 4
; CHECK-O0-NEXT:    call void @some_user(i64 [[VAL_2]])
; CHECK-O0-NEXT:    store <4 x double> [[VECTOR_SPILL_RELOAD]], ptr [[VECTOR]], align 16
; CHECK-O0-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP1]], ptr [[ACTOR_RELOAD]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define void @my_async_function_pa(
; CHECK-O0-SAME: ptr [[CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:    call swiftcc void @my_async_function(ptr [[CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @my_async_function2(
; CHECK-O0-SAME: ptr [[TASK:%.*]], ptr [[ACTOR:%.*]], ptr [[ASYNC_CTXT:%.*]]) #[[ATTR0:[0-9]+]] !dbg [[DBG9:![0-9]+]] {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[ASYNC_CTXT]], i32 128
; CHECK-O0-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[TASK_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    store ptr [[TASK]], ptr [[TASK_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT:%.*]] = call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr @my_other_async_function_fp)
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @my_async_function2.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]]), !dbg [[DBG10:![0-9]+]]
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @my_async_function2.resume.0(
; CHECK-O0-SAME: ptr [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr [[TMP2:%.*]]) #[[ATTR0]] !dbg [[DBG13:![0-9]+]] {
; CHECK-O0-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP2]], align 8, !dbg [[DBG14:![0-9]+]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR7:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD8:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR7]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR3:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD4:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR3]], align 8
; CHECK-O0-NEXT:    [[CONTINUATION_TASK_ARG_SPILL_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 4
; CHECK-O0-NEXT:    store ptr [[TMP0]], ptr [[CONTINUATION_TASK_ARG_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_1:%.*]] = getelementptr inbounds [[ASYNC_CTXT:%.*]], ptr [[CALLEE_CONTEXT_RELOAD8]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @my_async_function2.resume.1, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR_1]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT_RELOAD4]], ptr [[CALLEE_CONTEXT_RELOAD8]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR5:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD6:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR5]], align 8
; CHECK-O0-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[TASK_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[TASK_RELOAD:%.*]] = load ptr, ptr [[TASK_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT_RELOAD6]], ptr [[TASK_RELOAD]], ptr [[ACTOR_RELOAD]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @my_async_function2.resume.1(
; CHECK-O0-SAME: ptr [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr [[TMP2:%.*]]) #[[ATTR0]] !dbg [[DBG16:![0-9]+]] {
; CHECK-O0-NEXT:  [[ENTRYRESUME_1:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[CONTINUATION_TASK_ARG_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 4
; CHECK-O0-NEXT:    [[CONTINUATION_TASK_ARG_RELOAD:%.*]] = load ptr, ptr [[CONTINUATION_TASK_ARG_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MY_ASYNC_FUNCTION2_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    call void @llvm.coro.async.context.dealloc(ptr [[CALLEE_CONTEXT_RELOAD]])
; CHECK-O0-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[CONTINUATION_TASK_ARG_RELOAD]], ptr [[TMP1]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @top_level_caller(
; CHECK-O0-SAME: ptr [[CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:    call swiftcc void @my_async_function(ptr [[CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @dont_crash_on_cf_dispatch(
; CHECK-O0-SAME: ptr [[FNPTR:%.*]], ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:    [[ISNULL:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-O0-NEXT:    br i1 [[ISNULL]], label %[[IS_NULL:.*]], label %[[IS_NOT_NULL:.*]]
; CHECK-O0:       [[IS_NULL]]:
; CHECK-O0-NEXT:    ret void
; CHECK-O0:       [[IS_NOT_NULL]]:
; CHECK-O0-NEXT:    tail call swiftcc void [[FNPTR]](ptr [[ASYNC_CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @dont_crash_on_cf(
; CHECK-O0-SAME: ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[ASYNC_CTXT]], i32 128
; CHECK-O0-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT:%.*]] = call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr @my_other_async_function_fp)
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @dont_crash_on_cf.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-O0-NEXT:    [[ISNULL_I:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-O0-NEXT:    br i1 [[ISNULL_I]], label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT:.*]], label %[[IS_NOT_NULL_I:.*]]
; CHECK-O0:       [[IS_NOT_NULL_I]]:
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    br label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT]]
; CHECK-O0:       [[DONT_CRASH_ON_CF_DISPATCH_EXIT]]:
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @dont_crash_on_cf.resume.0(
; CHECK-O0-SAME: ptr [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr [[TMP2:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[DONT_CRASH_ON_CF_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    call void @llvm.coro.async.context.dealloc(ptr [[CALLEE_CONTEXT_RELOAD]])
; CHECK-O0-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP1]], ptr [[ACTOR_RELOAD]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @must_tail_call_return(
; CHECK-O0-SAME: ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:    musttail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @multiple_coro_end_async(
; CHECK-O0-SAME: ptr [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[ASYNC_CTXT]], i32 128
; CHECK-O0-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT:%.*]] = call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr @my_other_async_function_fp)
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @multiple_coro_end_async.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-O0-NEXT:    [[ISNULL_I:%.*]] = icmp eq ptr [[TASK]], null
; CHECK-O0-NEXT:    br i1 [[ISNULL_I]], label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT:.*]], label %[[IS_NOT_NULL_I:.*]]
; CHECK-O0:       [[IS_NOT_NULL_I]]:
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    br label %[[DONT_CRASH_ON_CF_DISPATCH_EXIT]]
; CHECK-O0:       [[DONT_CRASH_ON_CF_DISPATCH_EXIT]]:
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @multiple_coro_end_async.resume.0(
; CHECK-O0-SAME: ptr [[TMP0:%.*]], ptr [[TMP1:%.*]], ptr [[TMP2:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    call void @llvm.coro.async.context.dealloc(ptr [[CALLEE_CONTEXT_RELOAD]])
; CHECK-O0-NEXT:    [[EQ:%.*]] = icmp eq ptr [[TMP1]], null
; CHECK-O0-NEXT:    br i1 [[EQ]], label %[[IS_EQUAL:.*]], label %[[MUSTTAILCALL_BEFORE_COROEND:.*]]
; CHECK-O0:       [[IS_EQUAL]]:
; CHECK-O0-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR3:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD4:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR3]], align 8
; CHECK-O0-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD4]], ptr [[TMP1]], ptr [[ACTOR_RELOAD]])
; CHECK-O0-NEXT:    ret void
; CHECK-O0:       [[MUSTTAILCALL_BEFORE_COROEND]]:
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[MULTIPLE_CORO_END_ASYNC_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    musttail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP1]], ptr null)
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @polymorphic_suspend_return(
; CHECK-O0-SAME: ptr swiftasync [[ASYNC_CTXT:%.*]], ptr [[TASK:%.*]], ptr [[ACTOR:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[ASYNC_CTXT]], i32 128
; CHECK-O0-NEXT:    [[TMP:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[ACTOR_SPILL_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    store ptr [[ACTOR]], ptr [[ACTOR_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[ASYNC_CTXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[PROJ_1:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 0
; CHECK-O0-NEXT:    [[PROJ_2:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 1
; CHECK-O0-NEXT:    store i64 0, ptr [[PROJ_1]], align 8
; CHECK-O0-NEXT:    store i64 1, ptr [[PROJ_2]], align 8
; CHECK-O0-NEXT:    call void @some_may_write(ptr [[PROJ_1]])
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT:%.*]] = call ptr @llvm.coro.async.context.alloc(ptr [[TASK]], ptr @my_other_async_function_fp)
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_SPILL_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    store ptr [[CALLEE_CONTEXT]], ptr [[CALLEE_CONTEXT_SPILL_ADDR]], align 8
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR:%.*]] = getelementptr inbounds [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], i32 0, i32 1
; CHECK-O0-NEXT:    store ptr @polymorphic_suspend_return.resume.0, ptr [[CALLEE_CONTEXT_RETURN_TO_CALLER_ADDR]], align 8
; CHECK-O0-NEXT:    store ptr [[ASYNC_CTXT]], ptr [[CALLEE_CONTEXT]], align 8
; CHECK-O0-NEXT:    tail call swiftcc void @asyncSuspend(ptr [[CALLEE_CONTEXT]], ptr [[TASK]], ptr [[ACTOR]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define internal swiftcc void @polymorphic_suspend_return.resume.0(
; CHECK-O0-SAME: ptr swiftasync [[TMP0:%.*]], ptr swiftself [[TMP1:%.*]], ptr [[TMP2:%.*]], ptr [[TMP3:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRYRESUME_0:.*:]]
; CHECK-O0-NEXT:    [[RESUME_CTXT_I:%.*]] = load ptr, ptr [[TMP0]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTX_FRAMEPTR:%.*]] = getelementptr inbounds i8, ptr [[RESUME_CTXT_I]], i32 128
; CHECK-O0-NEXT:    [[TMP:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME:%.*]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 0
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 3
; CHECK-O0-NEXT:    [[CALLEE_CONTEXT_RELOAD:%.*]] = load ptr, ptr [[CALLEE_CONTEXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ACTOR_RELOAD_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 2
; CHECK-O0-NEXT:    [[ACTOR_RELOAD:%.*]] = load ptr, ptr [[ACTOR_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD_ADDR:%.*]] = getelementptr inbounds [[POLYMORPHIC_SUSPEND_RETURN_FRAME]], ptr [[ASYNC_CTX_FRAMEPTR]], i32 0, i32 1
; CHECK-O0-NEXT:    [[ASYNC_CTXT_RELOAD:%.*]] = load ptr, ptr [[ASYNC_CTXT_RELOAD_ADDR]], align 8
; CHECK-O0-NEXT:    [[PROJ_22:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 1
; CHECK-O0-NEXT:    [[PROJ_11:%.*]] = getelementptr inbounds { i64, i64 }, ptr [[TMP]], i64 0, i32 0
; CHECK-O0-NEXT:    call void @llvm.coro.async.context.dealloc(ptr [[CALLEE_CONTEXT_RELOAD]])
; CHECK-O0-NEXT:    [[VAL:%.*]] = load i64, ptr [[PROJ_11]], align 4
; CHECK-O0-NEXT:    call void @some_user(i64 [[VAL]])
; CHECK-O0-NEXT:    [[VAL_2:%.*]] = load i64, ptr [[PROJ_22]], align 4
; CHECK-O0-NEXT:    call void @some_user(i64 [[VAL_2]])
; CHECK-O0-NEXT:    tail call swiftcc void @asyncReturn(ptr [[ASYNC_CTXT_RELOAD]], ptr [[TMP3]], ptr [[ACTOR_RELOAD]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @no_coro_suspend(
; CHECK-O0-SAME: ptr [[ASYNC_CTX:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[SOME_ALLOCA:%.*]] = alloca i64, align 8
; CHECK-O0-NEXT:    call void @some_may_write(ptr [[SOME_ALLOCA]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @no_coro_suspend_swifterror(
; CHECK-O0-SAME: ptr [[ASYNC_CTX:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[SOME_ALLOCA:%.*]] = alloca swifterror ptr, align 8
; CHECK-O0-NEXT:    store ptr null, ptr [[SOME_ALLOCA]], align 8
; CHECK-O0-NEXT:    call void @do_with_swifterror(ptr swifterror [[SOME_ALLOCA]])
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swiftcc void @undefined_coro_async_resume(
; CHECK-O0-SAME: ptr [[ASYNC_CTX:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    call void @use(ptr null)
; CHECK-O0-NEXT:    call void @crash()
; CHECK-O0-NEXT:    ret void
;
;
; CHECK-O0-LABEL: define swifttailcc void @simpleFunc(
; CHECK-O0-SAME: ptr swiftasync [[TMP0:%.*]]) {
; CHECK-O0-NEXT:  [[ENTRY:.*:]]
; CHECK-O0-NEXT:    [[TMP1:%.*]] = alloca ptr, align 8
; CHECK-O0-NEXT:    store ptr [[TMP0]], ptr [[TMP1]], align 8
; CHECK-O0-NEXT:    [[TMP2:%.*]] = load ptr, ptr [[TMP1]], align 8
; CHECK-O0-NEXT:    [[TMP3:%.*]] = getelementptr inbounds <{ ptr, ptr }>, ptr [[TMP2]], i32 0, i32 1
; CHECK-O0-NEXT:    [[TMP4:%.*]] = load ptr, ptr [[TMP3]], align 8
; CHECK-O0-NEXT:    [[TMP5:%.*]] = load ptr, ptr [[TMP1]], align 8
; CHECK-O0-NEXT:    musttail call swifttailcc void [[TMP4]](ptr swiftasync [[TMP5]])
; CHECK-O0-NEXT:    ret void
;
;.
; CHECK: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_Swift, file: [[META1:![0-9]+]], isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug)
; CHECK: [[META1]] = !DIFile(filename: "{{.*}}1.swift", directory: {{.*}})
; CHECK: [[DBG3]] = distinct !DISubprogram(name: "my_async_function", linkageName: "my_async_function", scope: [[META0]], file: [[META1]], line: 1, type: [[META4:![0-9]+]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK: [[META4]] = !DISubroutineType(types: [[META5:![0-9]+]])
; CHECK: [[META5]] = !{}
; CHECK: [[DBG6]] = !DILocation(line: 2, scope: [[DBG3]])
; CHECK: [[DBG7]] = distinct !DISubprogram(name: "my_async_function", linkageName: "my_async_functionTQ0_", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 2, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK: [[DBG8]] = !DILocation(line: 2, scope: [[DBG7]])
; CHECK: [[DBG9]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK: [[DBG10]] = !DILocation(line: 2, scope: [[META11:![0-9]+]])
; CHECK: [[META11]] = !DILexicalBlockFile(scope: [[DBG9]], file: [[META12:![0-9]+]], discriminator: 0)
; CHECK: [[META12]] = !DIFile(filename: "{{.*}}fake.cpp", directory: {{.*}})
; CHECK: [[DBG13]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2.resume.0", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK: [[DBG14]] = !DILocation(line: 2, scope: [[META15:![0-9]+]])
; CHECK: [[META15]] = !DILexicalBlockFile(scope: [[DBG13]], file: [[META12]], discriminator: 0)
; CHECK: [[DBG16]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2.resume.1", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
;.
; CHECK-O0: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_Swift, file: [[META1:![0-9]+]], isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug)
; CHECK-O0: [[META1]] = !DIFile(filename: "{{.*}}1.swift", directory: {{.*}})
; CHECK-O0: [[DBG3]] = distinct !DISubprogram(name: "my_async_function", linkageName: "my_async_function", scope: [[META0]], file: [[META1]], line: 1, type: [[META4:![0-9]+]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK-O0: [[META4]] = !DISubroutineType(types: [[META5:![0-9]+]])
; CHECK-O0: [[META5]] = !{}
; CHECK-O0: [[DBG6]] = !DILocation(line: 2, scope: [[DBG3]])
; CHECK-O0: [[DBG7]] = distinct !DISubprogram(name: "my_async_function", linkageName: "my_async_functionTQ0_", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 2, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK-O0: [[DBG8]] = !DILocation(line: 2, scope: [[DBG7]])
; CHECK-O0: [[DBG9]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK-O0: [[DBG10]] = !DILocation(line: 2, scope: [[META11:![0-9]+]])
; CHECK-O0: [[META11]] = !DILexicalBlockFile(scope: [[DBG9]], file: [[META12:![0-9]+]], discriminator: 0)
; CHECK-O0: [[META12]] = !DIFile(filename: "{{.*}}fake.cpp", directory: {{.*}})
; CHECK-O0: [[DBG13]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2.resume.0", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
; CHECK-O0: [[DBG14]] = !DILocation(line: 2, scope: [[META15:![0-9]+]])
; CHECK-O0: [[META15]] = !DILexicalBlockFile(scope: [[DBG13]], file: [[META12]], discriminator: 0)
; CHECK-O0: [[DBG16]] = distinct !DISubprogram(name: "my_async_function2", linkageName: "my_async_function2.resume.1", scope: [[META0]], file: [[META1]], line: 1, type: [[META4]], scopeLine: 1, spFlags: DISPFlagDefinition, unit: [[META0]])
;.
