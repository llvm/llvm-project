; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt < %s -passes='module(coro-early),cgscc(coro-split,coro-split)' -S | FileCheck %s

; Checks whether the dbg.declare for `__coro_frame` are created.

;
;


%promise_type = type { i32, i32, double }
%struct.big_structure = type { [500 x i8] }
declare void @produce(ptr)
declare void @consume(ptr)
declare void @produce_vector(ptr)
declare void @consume_vector(ptr)
declare void @produce_vectori5(ptr)
declare void @consume_vectori5(ptr)
declare void @produce_vectori9(ptr)
declare void @consume_vectori9(ptr)
declare void @pi32(ptr)
declare void @pi64(ptr)
declare void @pdouble(ptr)
declare void @pi64p(ptr)

define void @f(i32 %a, i32 %b, i64 %c, double %d, ptr %e) presplitcoroutine !dbg !8 {
; CHECK-LABEL: define void @f(
; CHECK-SAME: i32 [[A:%.*]], i32 [[B:%.*]], i64 [[C:%.*]], double [[D:%.*]], ptr [[E:%.*]]) !dbg [[DBG6:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[__PROMISE:%.*]] = alloca [[PROMISE_TYPE:%.*]], align 8
; CHECK-NEXT:    [[A_ALLOC:%.*]] = alloca i32, align 4
; CHECK-NEXT:    [[B_ALLOC:%.*]] = alloca i32, align 4
; CHECK-NEXT:    [[C_ALLOC:%.*]] = alloca i64, align 4
; CHECK-NEXT:    [[D_ALLOC:%.*]] = alloca double, align 4
; CHECK-NEXT:    [[E_ALLOC:%.*]] = alloca ptr, align 4
; CHECK-NEXT:    store i32 [[A]], ptr [[A_ALLOC]], align 4
; CHECK-NEXT:    store i32 [[B]], ptr [[B_ALLOC]], align 4
; CHECK-NEXT:    store i64 [[C]], ptr [[C_ALLOC]], align 4
; CHECK-NEXT:    store double [[D]], ptr [[D_ALLOC]], align 8
; CHECK-NEXT:    store ptr [[E]], ptr [[E_ALLOC]], align 8
; CHECK-NEXT:    [[STRUCT_DATA:%.*]] = alloca [[STRUCT_BIG_STRUCTURE:%.*]], align 1
; CHECK-NEXT:    call void @produce(ptr [[STRUCT_DATA]])
; CHECK-NEXT:    [[UNRESOLVED_DATA:%.*]] = alloca <4 x i32>, align 16
; CHECK-NEXT:    call void @produce_vector(ptr [[UNRESOLVED_DATA]])
; CHECK-NEXT:    [[UNRESOLVED_DATA2:%.*]] = alloca <5 x i1>, align 1
; CHECK-NEXT:    call void @produce_vectori5(ptr [[UNRESOLVED_DATA2]])
; CHECK-NEXT:    [[UNRESOLVED_DATA3:%.*]] = alloca <9 x i1>, align 2
; CHECK-NEXT:    call void @produce_vectori9(ptr [[UNRESOLVED_DATA3]])
; CHECK-NEXT:    [[ID:%.*]] = call token @llvm.coro.id(i32 16, ptr null, ptr @f, ptr @f.resumers)
; CHECK-NEXT:    [[ALLOC:%.*]] = call i1 @llvm.coro.alloc(token [[ID]])
; CHECK-NEXT:    br i1 [[ALLOC]], label %[[CORO_ALLOC:.*]], label %[[CORO_INIT_FROM_ENTRY:.*]]
; CHECK:       [[CORO_INIT_FROM_ENTRY]]:
; CHECK-NEXT:    [[DOTCORO_INIT:%.*]] = phi ptr [ null, %[[ENTRY]] ]
; CHECK-NEXT:    br label %[[CORO_INIT:.*]]
; CHECK:       [[CORO_ALLOC]]:
; CHECK-NEXT:    [[MEMORY:%.*]] = call ptr @new(i64 592)
; CHECK-NEXT:    br label %[[CORO_INIT_FROM_CORO_ALLOC:.*]]
; CHECK:       [[CORO_INIT_FROM_CORO_ALLOC]]:
; CHECK-NEXT:    [[MEMORY_CORO_INIT:%.*]] = phi ptr [ [[MEMORY]], %[[CORO_ALLOC]] ]
; CHECK-NEXT:    br label %[[CORO_INIT]]
; CHECK:       [[CORO_INIT]]:
; CHECK-NEXT:    [[PHI_ENTRY_ALLOC:%.*]] = phi ptr [ [[DOTCORO_INIT]], %[[CORO_INIT_FROM_ENTRY]] ], [ [[MEMORY_CORO_INIT]], %[[CORO_INIT_FROM_CORO_ALLOC]] ]
; CHECK-NEXT:    [[BEGIN:%.*]] = call noalias nonnull ptr @llvm.coro.begin(token [[ID]], ptr [[PHI_ENTRY_ALLOC]])
; CHECK-NEXT:      #dbg_declare(ptr [[BEGIN]], [[META52:![0-9]+]], !DIExpression(DW_OP_plus_uconst, 16), [[META54:![0-9]+]])
; CHECK-NEXT:      #dbg_declare(ptr [[BEGIN]], [[META9:![0-9]+]], !DIExpression(), [[META55:![0-9]+]])
; CHECK-NEXT:    [[RESUME_ADDR:%.*]] = getelementptr inbounds nuw [[F_FRAME:%.*]], ptr [[BEGIN]], i32 0, i32 0
; CHECK-NEXT:    store ptr @f.resume, ptr [[RESUME_ADDR]], align 8
; CHECK-NEXT:    [[TMP0:%.*]] = select i1 [[ALLOC]], ptr @f.destroy, ptr @f.cleanup
; CHECK-NEXT:    [[DESTROY_ADDR:%.*]] = getelementptr inbounds nuw [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 1
; CHECK-NEXT:    store ptr [[TMP0]], ptr [[DESTROY_ADDR]], align 8
; CHECK-NEXT:    [[TMP1:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 7
; CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[A_ALLOC]], align 4
; CHECK-NEXT:    store i32 [[TMP2]], ptr [[TMP1]], align 4
; CHECK-NEXT:    [[TMP3:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 8
; CHECK-NEXT:    [[TMP4:%.*]] = load i32, ptr [[B_ALLOC]], align 4
; CHECK-NEXT:    store i32 [[TMP4]], ptr [[TMP3]], align 4
; CHECK-NEXT:    [[TMP5:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 4
; CHECK-NEXT:    [[TMP6:%.*]] = load i64, ptr [[C_ALLOC]], align 4
; CHECK-NEXT:    store i64 [[TMP6]], ptr [[TMP5]], align 4
; CHECK-NEXT:    [[TMP7:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 5
; CHECK-NEXT:    [[TMP8:%.*]] = load double, ptr [[D_ALLOC]], align 8
; CHECK-NEXT:    store double [[TMP8]], ptr [[TMP7]], align 8
; CHECK-NEXT:    [[TMP9:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 6
; CHECK-NEXT:    [[TMP10:%.*]] = load ptr, ptr [[E_ALLOC]], align 8
; CHECK-NEXT:    store ptr [[TMP10]], ptr [[TMP9]], align 8
; CHECK-NEXT:    [[TMP11:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 10
; CHECK-NEXT:    [[TMP12:%.*]] = load [[STRUCT_BIG_STRUCTURE]], ptr [[STRUCT_DATA]], align 1
; CHECK-NEXT:    store [[STRUCT_BIG_STRUCTURE]] [[TMP12]], ptr [[TMP11]], align 1
; CHECK-NEXT:    [[TMP13:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 3
; CHECK-NEXT:    [[TMP14:%.*]] = load <4 x i32>, ptr [[UNRESOLVED_DATA]], align 16
; CHECK-NEXT:    store <4 x i32> [[TMP14]], ptr [[TMP13]], align 16
; CHECK-NEXT:    [[TMP15:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 12
; CHECK-NEXT:    [[TMP16:%.*]] = load <5 x i1>, ptr [[UNRESOLVED_DATA2]], align 1
; CHECK-NEXT:    store <5 x i1> [[TMP16]], ptr [[TMP15]], align 1
; CHECK-NEXT:    [[TMP17:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 9
; CHECK-NEXT:    [[TMP18:%.*]] = load <9 x i1>, ptr [[UNRESOLVED_DATA3]], align 2
; CHECK-NEXT:    store <9 x i1> [[TMP18]], ptr [[TMP17]], align 2
; CHECK-NEXT:    br label %[[ALLOCASPILLBB:.*]]
; CHECK:       [[ALLOCASPILLBB]]:
; CHECK-NEXT:    [[A_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 7
; CHECK-NEXT:    [[B_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 8
; CHECK-NEXT:    [[C_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 4
; CHECK-NEXT:    [[D_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 5
; CHECK-NEXT:    [[E_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 6
; CHECK-NEXT:    [[STRUCT_DATA_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 10
; CHECK-NEXT:    [[UNRESOLVED_DATA_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 3
; CHECK-NEXT:    [[UNRESOLVED_DATA2_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 12
; CHECK-NEXT:    [[UNRESOLVED_DATA3_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 9
; CHECK-NEXT:    [[__PROMISE_RELOAD_ADDR:%.*]] = getelementptr inbounds [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 2
; CHECK-NEXT:    br label %[[POSTSPILL:.*]]
; CHECK:       [[POSTSPILL]]:
; CHECK-NEXT:    [[READY:%.*]] = call i1 @await_ready()
; CHECK-NEXT:    br i1 [[READY]], label %[[INIT_READY:.*]], label %[[COROSAVE:.*]]
; CHECK:       [[COROSAVE]]:
; CHECK-NEXT:    [[INDEX_ADDR13:%.*]] = getelementptr inbounds nuw [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 11
; CHECK-NEXT:    store i2 0, ptr [[INDEX_ADDR13]], align 1
; CHECK-NEXT:    br label %[[AFTERCOROSAVE:.*]]
; CHECK:       [[AFTERCOROSAVE]]:
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND:.*]]
; CHECK:       [[COROSUSPEND]]:
; CHECK-NEXT:    br label %[[RESUME_0_LANDING:.*]]
; CHECK:       [[RESUME_0_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND:.*]]
; CHECK:       [[AFTERCOROSUSPEND]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET:.*]] [
; CHECK-NEXT:      i8 0, label %[[INIT_READY]]
; CHECK-NEXT:      i8 1, label %[[INIT_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[INIT_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_INIT_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_INIT_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP11:%.*]] = phi i32 [ 2, %[[INIT_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP:.*]]
; CHECK:       [[INIT_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    [[READY_AGAIN:%.*]] = call zeroext i1 @await_ready()
; CHECK-NEXT:    br i1 [[READY_AGAIN]], label %[[AWAIT_READY:.*]], label %[[COROSAVE1:.*]]
; CHECK:       [[COROSAVE1]]:
; CHECK-NEXT:    [[INDEX_ADDR14:%.*]] = getelementptr inbounds nuw [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 11
; CHECK-NEXT:    store i2 1, ptr [[INDEX_ADDR14]], align 1
; CHECK-NEXT:    br label %[[AFTERCOROSAVE2:.*]]
; CHECK:       [[AFTERCOROSAVE2]]:
; CHECK-NEXT:    [[FROM_ADDRESS:%.*]] = call ptr @from_address(ptr [[BEGIN]])
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND3:.*]]
; CHECK:       [[COROSUSPEND3]]:
; CHECK-NEXT:    br label %[[RESUME_1_LANDING:.*]]
; CHECK:       [[RESUME_1_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND4:.*]]
; CHECK:       [[AFTERCOROSUSPEND4]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET]] [
; CHECK-NEXT:      i8 0, label %[[AWAIT_READY]]
; CHECK-NEXT:      i8 1, label %[[AWAIT_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[AWAIT_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_AWAIT_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_AWAIT_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP10:%.*]] = phi i32 [ 2, %[[AWAIT_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[AWAIT_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    store i32 1, ptr [[__PROMISE_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[J_I:%.*]] = getelementptr inbounds [[PROMISE_TYPE]], ptr [[__PROMISE_RELOAD_ADDR]], i64 0, i32 1
; CHECK-NEXT:    store i32 2, ptr [[J_I]], align 4
; CHECK-NEXT:    [[K_I:%.*]] = getelementptr inbounds [[PROMISE_TYPE]], ptr [[__PROMISE_RELOAD_ADDR]], i64 0, i32 2
; CHECK-NEXT:    store double 3.000000e+00, ptr [[K_I]], align 8
; CHECK-NEXT:    call void @consume(ptr [[STRUCT_DATA_RELOAD_ADDR]])
; CHECK-NEXT:    call void @consume_vector(ptr [[UNRESOLVED_DATA_RELOAD_ADDR]])
; CHECK-NEXT:    call void @consume_vectori5(ptr [[UNRESOLVED_DATA2_RELOAD_ADDR]])
; CHECK-NEXT:    call void @consume_vectori9(ptr [[UNRESOLVED_DATA3_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi32(ptr [[A_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi32(ptr [[B_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi64(ptr [[C_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pdouble(ptr [[D_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi64p(ptr [[E_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @return_void()
; CHECK-NEXT:    br label %[[CORO_FINAL:.*]]
; CHECK:       [[CORO_FINAL]]:
; CHECK-NEXT:    call void @final_suspend()
; CHECK-NEXT:    [[CORO_FINAL_AWAIT_READY:%.*]] = call i1 @await_ready()
; CHECK-NEXT:    br i1 [[CORO_FINAL_AWAIT_READY]], label %[[FINAL_READY:.*]], label %[[COROSAVE5:.*]]
; CHECK:       [[COROSAVE5]]:
; CHECK-NEXT:    [[RESUMEFN_ADDR:%.*]] = getelementptr inbounds nuw [[F_FRAME]], ptr [[BEGIN]], i32 0, i32 0
; CHECK-NEXT:    store ptr null, ptr [[RESUMEFN_ADDR]], align 8
; CHECK-NEXT:    br label %[[AFTERCOROSAVE6:.*]]
; CHECK:       [[AFTERCOROSAVE6]]:
; CHECK-NEXT:    [[FINAL_SUSPEND_FROM_ADDRESS:%.*]] = call ptr @from_address(ptr [[BEGIN]])
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND7:.*]]
; CHECK:       [[COROSUSPEND7]]:
; CHECK-NEXT:    br label %[[RESUME_2_LANDING:.*]]
; CHECK:       [[RESUME_2_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND8:.*]]
; CHECK:       [[AFTERCOROSUSPEND8]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET]] [
; CHECK-NEXT:      i8 0, label %[[FINAL_READY]]
; CHECK-NEXT:      i8 1, label %[[FINAL_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[FINAL_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_FINAL_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_FINAL_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP9:%.*]] = phi i32 [ 2, %[[FINAL_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[FINAL_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    br label %[[CLEANUP_FROM_FINAL_READY:.*]]
; CHECK:       [[CLEANUP_FROM_FINAL_READY]]:
; CHECK-NEXT:    [[DOTCLEANUP:%.*]] = phi i32 [ 0, %[[FINAL_READY]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[CLEANUP]]:
; CHECK-NEXT:    [[CLEANUP_DEST_SLOT_0:%.*]] = phi i32 [ [[DOTCLEANUP]], %[[CLEANUP_FROM_FINAL_READY]] ], [ [[DOTCLEANUP9]], %[[CLEANUP_FROM_FINAL_CLEANUP]] ], [ [[DOTCLEANUP10]], %[[CLEANUP_FROM_AWAIT_CLEANUP]] ], [ [[DOTCLEANUP11]], %[[CLEANUP_FROM_INIT_CLEANUP]] ]
; CHECK-NEXT:    [[FREE_MEMORY:%.*]] = call ptr @llvm.coro.free(token [[ID]], ptr [[BEGIN]])
; CHECK-NEXT:    [[FREE:%.*]] = icmp ne ptr [[FREE_MEMORY]], null
; CHECK-NEXT:    br i1 [[FREE]], label %[[CORO_FREE:.*]], label %[[AFTER_CORO_FREE:.*]]
; CHECK:       [[CORO_FREE]]:
; CHECK-NEXT:    call void @delete(ptr [[FREE_MEMORY]])
; CHECK-NEXT:    br label %[[AFTER_CORO_FREE]]
; CHECK:       [[AFTER_CORO_FREE]]:
; CHECK-NEXT:    switch i32 [[CLEANUP_DEST_SLOT_0]], label %[[UNREACHABLE:.*]] [
; CHECK-NEXT:      i32 0, label %[[CLEANUP_CONT:.*]]
; CHECK-NEXT:      i32 2, label %[[CORO_RET]]
; CHECK-NEXT:    ]
; CHECK:       [[CLEANUP_CONT]]:
; CHECK-NEXT:    br label %[[CORO_RET]]
; CHECK:       [[CORO_RET]]:
; CHECK-NEXT:    br label %[[COROEND:.*]]
; CHECK:       [[COROEND]]:
; CHECK-NEXT:    br label %[[AFTERCOROEND:.*]]
; CHECK:       [[AFTERCOROEND]]:
; CHECK-NEXT:    ret void
; CHECK:       [[UNREACHABLE]]:
; CHECK-NEXT:    unreachable
;
entry:
  %__promise = alloca %promise_type, align 8
  %a.alloc = alloca i32, align 4
  %b.alloc = alloca i32, align 4
  %c.alloc = alloca i64, align 4
  %d.alloc = alloca double, align 4
  %e.alloc = alloca ptr, align 4
  store i32 %a, ptr %a.alloc
  store i32 %b, ptr %b.alloc
  store i64 %c, ptr %c.alloc
  store double %d, ptr %d.alloc
  store ptr %e, ptr %e.alloc
  %struct.data = alloca %struct.big_structure, align 1
  call void @produce(ptr %struct.data)
  ; We treat vector type as unresolved type now for test coverage.
  %unresolved_data = alloca <4 x i32>
  call void @produce_vector(ptr %unresolved_data)
  %unresolved_data2 = alloca <5 x i1>
  call void @produce_vectori5(ptr %unresolved_data2)
  %unresolved_data3 = alloca <9 x i1>
  call void @produce_vectori9(ptr %unresolved_data3)
  %id = call token @llvm.coro.id(i32 16, ptr %__promise, ptr null, ptr null)
  %alloc = call i1 @llvm.coro.alloc(token %id)
  br i1 %alloc, label %coro.alloc, label %coro.init

coro.alloc:                                       ; preds = %entry
  %size = call i64 @llvm.coro.size.i64()
  %memory = call ptr @new(i64 %size)
  br label %coro.init

coro.init:                                        ; preds = %coro.alloc, %entry
  %phi.entry.alloc = phi ptr [ null, %entry ], [ %memory, %coro.alloc ]
  %begin = call ptr @llvm.coro.begin(token %id, ptr %phi.entry.alloc)
  call void @llvm.dbg.declare(metadata ptr %__promise, metadata !6, metadata !DIExpression()), !dbg !18
  %ready = call i1 @await_ready()
  br i1 %ready, label %init.ready, label %init.suspend

init.suspend:                                     ; preds = %coro.init
  %save = call token @llvm.coro.save(ptr null)
  call void @await_suspend()
  %suspend = call i8 @llvm.coro.suspend(token %save, i1 false)
  switch i8 %suspend, label %coro.ret [
  i8 0, label %init.ready
  i8 1, label %init.cleanup
  ]

init.cleanup:                                     ; preds = %init.suspend
  br label %cleanup

init.ready:                                       ; preds = %init.suspend, %coro.init
  call void @await_resume()
  %ready.again = call zeroext i1 @await_ready()
  br i1 %ready.again, label %await.ready, label %await.suspend

await.suspend:                                    ; preds = %init.ready
  %save.again = call token @llvm.coro.save(ptr null)
  %from.address = call ptr @from_address(ptr %begin)
  call void @await_suspend()
  %suspend.again = call i8 @llvm.coro.suspend(token %save.again, i1 false)
  switch i8 %suspend.again, label %coro.ret [
  i8 0, label %await.ready
  i8 1, label %await.cleanup
  ]

await.cleanup:                                    ; preds = %await.suspend
  br label %cleanup

await.ready:                                      ; preds = %await.suspend, %init.ready
  call void @await_resume()
  store i32 1, ptr %__promise, align 8
  %j.i = getelementptr inbounds %promise_type, ptr %__promise, i64 0, i32 1
  store i32 2, ptr %j.i, align 4
  %k.i = getelementptr inbounds %promise_type, ptr %__promise, i64 0, i32 2
  store double 3.000000e+00, ptr %k.i, align 8
  call void @consume(ptr %struct.data)
  call void @consume_vector(ptr %unresolved_data)
  call void @consume_vectori5(ptr %unresolved_data2)
  call void @consume_vectori9(ptr %unresolved_data3)
  call void @pi32(ptr %a.alloc)
  call void @pi32(ptr %b.alloc)
  call void @pi64(ptr %c.alloc)
  call void @pdouble(ptr %d.alloc)
  call void @pi64p(ptr %e.alloc)
  call void @return_void()
  br label %coro.final

coro.final:                                       ; preds = %await.ready
  call void @final_suspend()
  %coro.final.await_ready = call i1 @await_ready()
  br i1 %coro.final.await_ready, label %final.ready, label %final.suspend

final.suspend:                                    ; preds = %coro.final
  %final.suspend.coro.save = call token @llvm.coro.save(ptr null)
  %final.suspend.from_address = call ptr @from_address(ptr %begin)
  call void @await_suspend()
  %final.suspend.coro.suspend = call i8 @llvm.coro.suspend(token %final.suspend.coro.save, i1 true)
  switch i8 %final.suspend.coro.suspend, label %coro.ret [
  i8 0, label %final.ready
  i8 1, label %final.cleanup
  ]

final.cleanup:                                    ; preds = %final.suspend
  br label %cleanup

final.ready:                                      ; preds = %final.suspend, %coro.final
  call void @await_resume()
  br label %cleanup

cleanup:                                          ; preds = %final.ready, %final.cleanup, %await.cleanup, %init.cleanup
  %cleanup.dest.slot.0 = phi i32 [ 0, %final.ready ], [ 2, %final.cleanup ], [ 2, %await.cleanup ], [ 2, %init.cleanup ]
  %free.memory = call ptr @llvm.coro.free(token %id, ptr %begin)
  %free = icmp ne ptr %free.memory, null
  br i1 %free, label %coro.free, label %after.coro.free

coro.free:                                        ; preds = %cleanup
  call void @delete(ptr %free.memory)
  br label %after.coro.free

after.coro.free:                                  ; preds = %coro.free, %cleanup
  switch i32 %cleanup.dest.slot.0, label %unreachable [
  i32 0, label %cleanup.cont
  i32 2, label %coro.ret
  ]

cleanup.cont:                                     ; preds = %after.coro.free
  br label %coro.ret

coro.ret:                                         ; preds = %cleanup.cont, %after.coro.free, %final.suspend, %await.suspend, %init.suspend
  call void @llvm.coro.end(ptr null, i1 false, token none)
  ret void

unreachable:                                      ; preds = %after.coro.free
  unreachable

}

; bar is used to check that we wouldn't create duplicate DIType
define void @bar(i32 %a, i64 %c, double %d, ptr %e) presplitcoroutine !dbg !19 {
; CHECK-LABEL: define void @bar(
; CHECK-SAME: i32 [[A:%.*]], i64 [[C:%.*]], double [[D:%.*]], ptr [[E:%.*]]) !dbg [[DBG56:![0-9]+]] {
; CHECK-NEXT:  [[ENTRY:.*]]:
; CHECK-NEXT:    [[__PROMISE:%.*]] = alloca [[PROMISE_TYPE:%.*]], align 8
; CHECK-NEXT:    [[A_ALLOC:%.*]] = alloca i32, align 4
; CHECK-NEXT:    [[C_ALLOC:%.*]] = alloca i64, align 4
; CHECK-NEXT:    [[D_ALLOC:%.*]] = alloca double, align 4
; CHECK-NEXT:    [[E_ALLOC:%.*]] = alloca ptr, align 4
; CHECK-NEXT:    store i32 [[A]], ptr [[A_ALLOC]], align 4
; CHECK-NEXT:    store i64 [[C]], ptr [[C_ALLOC]], align 4
; CHECK-NEXT:    store double [[D]], ptr [[D_ALLOC]], align 8
; CHECK-NEXT:    store ptr [[E]], ptr [[E_ALLOC]], align 8
; CHECK-NEXT:    [[STRUCT_DATA:%.*]] = alloca [[STRUCT_BIG_STRUCTURE:%.*]], align 1
; CHECK-NEXT:    call void @produce(ptr [[STRUCT_DATA]])
; CHECK-NEXT:    [[UNRESOLVED_DATA:%.*]] = alloca <4 x i32>, align 16
; CHECK-NEXT:    call void @produce_vector(ptr [[UNRESOLVED_DATA]])
; CHECK-NEXT:    [[ID:%.*]] = call token @llvm.coro.id(i32 16, ptr null, ptr @bar, ptr @bar.resumers)
; CHECK-NEXT:    [[ALLOC:%.*]] = call i1 @llvm.coro.alloc(token [[ID]])
; CHECK-NEXT:    br i1 [[ALLOC]], label %[[CORO_ALLOC:.*]], label %[[CORO_INIT_FROM_ENTRY:.*]]
; CHECK:       [[CORO_INIT_FROM_ENTRY]]:
; CHECK-NEXT:    [[DOTCORO_INIT:%.*]] = phi ptr [ null, %[[ENTRY]] ]
; CHECK-NEXT:    br label %[[CORO_INIT:.*]]
; CHECK:       [[CORO_ALLOC]]:
; CHECK-NEXT:    [[MEMORY:%.*]] = call ptr @new(i64 592)
; CHECK-NEXT:    br label %[[CORO_INIT_FROM_CORO_ALLOC:.*]]
; CHECK:       [[CORO_INIT_FROM_CORO_ALLOC]]:
; CHECK-NEXT:    [[MEMORY_CORO_INIT:%.*]] = phi ptr [ [[MEMORY]], %[[CORO_ALLOC]] ]
; CHECK-NEXT:    br label %[[CORO_INIT]]
; CHECK:       [[CORO_INIT]]:
; CHECK-NEXT:    [[PHI_ENTRY_ALLOC:%.*]] = phi ptr [ [[DOTCORO_INIT]], %[[CORO_INIT_FROM_ENTRY]] ], [ [[MEMORY_CORO_INIT]], %[[CORO_INIT_FROM_CORO_ALLOC]] ]
; CHECK-NEXT:    [[BEGIN:%.*]] = call noalias nonnull ptr @llvm.coro.begin(token [[ID]], ptr [[PHI_ENTRY_ALLOC]])
; CHECK-NEXT:      #dbg_declare(ptr [[BEGIN]], [[META74:![0-9]+]], !DIExpression(DW_OP_plus_uconst, 16), [[META76:![0-9]+]])
; CHECK-NEXT:      #dbg_declare(ptr [[BEGIN]], [[META58:![0-9]+]], !DIExpression(), [[META77:![0-9]+]])
; CHECK-NEXT:    [[RESUME_ADDR:%.*]] = getelementptr inbounds nuw [[BAR_FRAME:%.*]], ptr [[BEGIN]], i32 0, i32 0
; CHECK-NEXT:    store ptr @bar.resume, ptr [[RESUME_ADDR]], align 8
; CHECK-NEXT:    [[TMP0:%.*]] = select i1 [[ALLOC]], ptr @bar.destroy, ptr @bar.cleanup
; CHECK-NEXT:    [[DESTROY_ADDR:%.*]] = getelementptr inbounds nuw [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 1
; CHECK-NEXT:    store ptr [[TMP0]], ptr [[DESTROY_ADDR]], align 8
; CHECK-NEXT:    [[TMP1:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 7
; CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[A_ALLOC]], align 4
; CHECK-NEXT:    store i32 [[TMP2]], ptr [[TMP1]], align 4
; CHECK-NEXT:    [[TMP3:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 4
; CHECK-NEXT:    [[TMP4:%.*]] = load i64, ptr [[C_ALLOC]], align 4
; CHECK-NEXT:    store i64 [[TMP4]], ptr [[TMP3]], align 4
; CHECK-NEXT:    [[TMP5:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 5
; CHECK-NEXT:    [[TMP6:%.*]] = load double, ptr [[D_ALLOC]], align 8
; CHECK-NEXT:    store double [[TMP6]], ptr [[TMP5]], align 8
; CHECK-NEXT:    [[TMP7:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 6
; CHECK-NEXT:    [[TMP8:%.*]] = load ptr, ptr [[E_ALLOC]], align 8
; CHECK-NEXT:    store ptr [[TMP8]], ptr [[TMP7]], align 8
; CHECK-NEXT:    [[TMP9:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 8
; CHECK-NEXT:    [[TMP10:%.*]] = load [[STRUCT_BIG_STRUCTURE]], ptr [[STRUCT_DATA]], align 1
; CHECK-NEXT:    store [[STRUCT_BIG_STRUCTURE]] [[TMP10]], ptr [[TMP9]], align 1
; CHECK-NEXT:    [[TMP11:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 3
; CHECK-NEXT:    [[TMP12:%.*]] = load <4 x i32>, ptr [[UNRESOLVED_DATA]], align 16
; CHECK-NEXT:    store <4 x i32> [[TMP12]], ptr [[TMP11]], align 16
; CHECK-NEXT:    br label %[[ALLOCASPILLBB:.*]]
; CHECK:       [[ALLOCASPILLBB]]:
; CHECK-NEXT:    [[A_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 7
; CHECK-NEXT:    [[C_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 4
; CHECK-NEXT:    [[D_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 5
; CHECK-NEXT:    [[E_ALLOC_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 6
; CHECK-NEXT:    [[STRUCT_DATA_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 8
; CHECK-NEXT:    [[UNRESOLVED_DATA_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 3
; CHECK-NEXT:    [[__PROMISE_RELOAD_ADDR:%.*]] = getelementptr inbounds [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 2
; CHECK-NEXT:    br label %[[POSTSPILL:.*]]
; CHECK:       [[POSTSPILL]]:
; CHECK-NEXT:    [[READY:%.*]] = call i1 @await_ready()
; CHECK-NEXT:    br i1 [[READY]], label %[[INIT_READY:.*]], label %[[COROSAVE:.*]]
; CHECK:       [[COROSAVE]]:
; CHECK-NEXT:    [[INDEX_ADDR13:%.*]] = getelementptr inbounds nuw [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 9
; CHECK-NEXT:    store i2 0, ptr [[INDEX_ADDR13]], align 1
; CHECK-NEXT:    br label %[[AFTERCOROSAVE:.*]]
; CHECK:       [[AFTERCOROSAVE]]:
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND:.*]]
; CHECK:       [[COROSUSPEND]]:
; CHECK-NEXT:    br label %[[RESUME_0_LANDING:.*]]
; CHECK:       [[RESUME_0_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND:.*]]
; CHECK:       [[AFTERCOROSUSPEND]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET:.*]] [
; CHECK-NEXT:      i8 0, label %[[INIT_READY]]
; CHECK-NEXT:      i8 1, label %[[INIT_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[INIT_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_INIT_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_INIT_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP11:%.*]] = phi i32 [ 2, %[[INIT_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP:.*]]
; CHECK:       [[INIT_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    [[READY_AGAIN:%.*]] = call zeroext i1 @await_ready()
; CHECK-NEXT:    br i1 [[READY_AGAIN]], label %[[AWAIT_READY:.*]], label %[[COROSAVE1:.*]]
; CHECK:       [[COROSAVE1]]:
; CHECK-NEXT:    [[INDEX_ADDR14:%.*]] = getelementptr inbounds nuw [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 9
; CHECK-NEXT:    store i2 1, ptr [[INDEX_ADDR14]], align 1
; CHECK-NEXT:    br label %[[AFTERCOROSAVE2:.*]]
; CHECK:       [[AFTERCOROSAVE2]]:
; CHECK-NEXT:    [[FROM_ADDRESS:%.*]] = call ptr @from_address(ptr [[BEGIN]])
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND3:.*]]
; CHECK:       [[COROSUSPEND3]]:
; CHECK-NEXT:    br label %[[RESUME_1_LANDING:.*]]
; CHECK:       [[RESUME_1_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND4:.*]]
; CHECK:       [[AFTERCOROSUSPEND4]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET]] [
; CHECK-NEXT:      i8 0, label %[[AWAIT_READY]]
; CHECK-NEXT:      i8 1, label %[[AWAIT_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[AWAIT_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_AWAIT_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_AWAIT_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP10:%.*]] = phi i32 [ 2, %[[AWAIT_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[AWAIT_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    store i32 1, ptr [[__PROMISE_RELOAD_ADDR]], align 8
; CHECK-NEXT:    [[J_I:%.*]] = getelementptr inbounds [[PROMISE_TYPE]], ptr [[__PROMISE_RELOAD_ADDR]], i64 0, i32 1
; CHECK-NEXT:    store i32 2, ptr [[J_I]], align 4
; CHECK-NEXT:    [[K_I:%.*]] = getelementptr inbounds [[PROMISE_TYPE]], ptr [[__PROMISE_RELOAD_ADDR]], i64 0, i32 2
; CHECK-NEXT:    store double 3.000000e+00, ptr [[K_I]], align 8
; CHECK-NEXT:    call void @consume(ptr [[STRUCT_DATA_RELOAD_ADDR]])
; CHECK-NEXT:    call void @consume_vector(ptr [[UNRESOLVED_DATA_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi32(ptr [[A_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi64(ptr [[C_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pdouble(ptr [[D_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @pi64p(ptr [[E_ALLOC_RELOAD_ADDR]])
; CHECK-NEXT:    call void @return_void()
; CHECK-NEXT:    br label %[[CORO_FINAL:.*]]
; CHECK:       [[CORO_FINAL]]:
; CHECK-NEXT:    call void @final_suspend()
; CHECK-NEXT:    [[CORO_FINAL_AWAIT_READY:%.*]] = call i1 @await_ready()
; CHECK-NEXT:    br i1 [[CORO_FINAL_AWAIT_READY]], label %[[FINAL_READY:.*]], label %[[COROSAVE5:.*]]
; CHECK:       [[COROSAVE5]]:
; CHECK-NEXT:    [[RESUMEFN_ADDR:%.*]] = getelementptr inbounds nuw [[BAR_FRAME]], ptr [[BEGIN]], i32 0, i32 0
; CHECK-NEXT:    store ptr null, ptr [[RESUMEFN_ADDR]], align 8
; CHECK-NEXT:    br label %[[AFTERCOROSAVE6:.*]]
; CHECK:       [[AFTERCOROSAVE6]]:
; CHECK-NEXT:    [[FINAL_SUSPEND_FROM_ADDRESS:%.*]] = call ptr @from_address(ptr [[BEGIN]])
; CHECK-NEXT:    call void @await_suspend()
; CHECK-NEXT:    br label %[[COROSUSPEND7:.*]]
; CHECK:       [[COROSUSPEND7]]:
; CHECK-NEXT:    br label %[[RESUME_2_LANDING:.*]]
; CHECK:       [[RESUME_2_LANDING]]:
; CHECK-NEXT:    br label %[[AFTERCOROSUSPEND8:.*]]
; CHECK:       [[AFTERCOROSUSPEND8]]:
; CHECK-NEXT:    switch i8 -1, label %[[CORO_RET]] [
; CHECK-NEXT:      i8 0, label %[[FINAL_READY]]
; CHECK-NEXT:      i8 1, label %[[FINAL_CLEANUP:.*]]
; CHECK-NEXT:    ]
; CHECK:       [[FINAL_CLEANUP]]:
; CHECK-NEXT:    br label %[[CLEANUP_FROM_FINAL_CLEANUP:.*]]
; CHECK:       [[CLEANUP_FROM_FINAL_CLEANUP]]:
; CHECK-NEXT:    [[DOTCLEANUP9:%.*]] = phi i32 [ 2, %[[FINAL_CLEANUP]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[FINAL_READY]]:
; CHECK-NEXT:    call void @await_resume()
; CHECK-NEXT:    br label %[[CLEANUP_FROM_FINAL_READY:.*]]
; CHECK:       [[CLEANUP_FROM_FINAL_READY]]:
; CHECK-NEXT:    [[DOTCLEANUP:%.*]] = phi i32 [ 0, %[[FINAL_READY]] ]
; CHECK-NEXT:    br label %[[CLEANUP]]
; CHECK:       [[CLEANUP]]:
; CHECK-NEXT:    [[CLEANUP_DEST_SLOT_0:%.*]] = phi i32 [ [[DOTCLEANUP]], %[[CLEANUP_FROM_FINAL_READY]] ], [ [[DOTCLEANUP9]], %[[CLEANUP_FROM_FINAL_CLEANUP]] ], [ [[DOTCLEANUP10]], %[[CLEANUP_FROM_AWAIT_CLEANUP]] ], [ [[DOTCLEANUP11]], %[[CLEANUP_FROM_INIT_CLEANUP]] ]
; CHECK-NEXT:    [[FREE_MEMORY:%.*]] = call ptr @llvm.coro.free(token [[ID]], ptr [[BEGIN]])
; CHECK-NEXT:    [[FREE:%.*]] = icmp ne ptr [[FREE_MEMORY]], null
; CHECK-NEXT:    br i1 [[FREE]], label %[[CORO_FREE:.*]], label %[[AFTER_CORO_FREE:.*]]
; CHECK:       [[CORO_FREE]]:
; CHECK-NEXT:    call void @delete(ptr [[FREE_MEMORY]])
; CHECK-NEXT:    br label %[[AFTER_CORO_FREE]]
; CHECK:       [[AFTER_CORO_FREE]]:
; CHECK-NEXT:    switch i32 [[CLEANUP_DEST_SLOT_0]], label %[[UNREACHABLE:.*]] [
; CHECK-NEXT:      i32 0, label %[[CLEANUP_CONT:.*]]
; CHECK-NEXT:      i32 2, label %[[CORO_RET]]
; CHECK-NEXT:    ]
; CHECK:       [[CLEANUP_CONT]]:
; CHECK-NEXT:    br label %[[CORO_RET]]
; CHECK:       [[CORO_RET]]:
; CHECK-NEXT:    br label %[[COROEND:.*]]
; CHECK:       [[COROEND]]:
; CHECK-NEXT:    br label %[[AFTERCOROEND:.*]]
; CHECK:       [[AFTERCOROEND]]:
; CHECK-NEXT:    ret void
; CHECK:       [[UNREACHABLE]]:
; CHECK-NEXT:    unreachable
;
entry:
  %__promise = alloca %promise_type, align 8
  %a.alloc = alloca i32, align 4
  %c.alloc = alloca i64, align 4
  %d.alloc = alloca double, align 4
  %e.alloc = alloca ptr, align 4
  store i32 %a, ptr %a.alloc
  store i64 %c, ptr %c.alloc
  store double %d, ptr %d.alloc
  store ptr %e, ptr %e.alloc
  %struct.data = alloca %struct.big_structure, align 1
  call void @produce(ptr %struct.data)
  ; We treat vector type as unresolved type now for test coverage.
  %unresolved_data = alloca <4 x i32>
  call void @produce_vector(ptr %unresolved_data)
  %id = call token @llvm.coro.id(i32 16, ptr %__promise, ptr null, ptr null)
  %alloc = call i1 @llvm.coro.alloc(token %id)
  br i1 %alloc, label %coro.alloc, label %coro.init

coro.alloc:                                       ; preds = %entry
  %size = call i64 @llvm.coro.size.i64()
  %memory = call ptr @new(i64 %size)
  br label %coro.init

coro.init:                                        ; preds = %coro.alloc, %entry
  %phi.entry.alloc = phi ptr [ null, %entry ], [ %memory, %coro.alloc ]
  %begin = call ptr @llvm.coro.begin(token %id, ptr %phi.entry.alloc)
  call void @llvm.dbg.declare(metadata ptr %__promise, metadata !21, metadata !DIExpression()), !dbg !22
  %ready = call i1 @await_ready()
  br i1 %ready, label %init.ready, label %init.suspend

init.suspend:                                     ; preds = %coro.init
  %save = call token @llvm.coro.save(ptr null)
  call void @await_suspend()
  %suspend = call i8 @llvm.coro.suspend(token %save, i1 false)
  switch i8 %suspend, label %coro.ret [
  i8 0, label %init.ready
  i8 1, label %init.cleanup
  ]

init.cleanup:                                     ; preds = %init.suspend
  br label %cleanup

init.ready:                                       ; preds = %init.suspend, %coro.init
  call void @await_resume()
  %ready.again = call zeroext i1 @await_ready()
  br i1 %ready.again, label %await.ready, label %await.suspend

await.suspend:                                    ; preds = %init.ready
  %save.again = call token @llvm.coro.save(ptr null)
  %from.address = call ptr @from_address(ptr %begin)
  call void @await_suspend()
  %suspend.again = call i8 @llvm.coro.suspend(token %save.again, i1 false)
  switch i8 %suspend.again, label %coro.ret [
  i8 0, label %await.ready
  i8 1, label %await.cleanup
  ]

await.cleanup:                                    ; preds = %await.suspend
  br label %cleanup

await.ready:                                      ; preds = %await.suspend, %init.ready
  call void @await_resume()
  store i32 1, ptr %__promise, align 8
  %j.i = getelementptr inbounds %promise_type, ptr %__promise, i64 0, i32 1
  store i32 2, ptr %j.i, align 4
  %k.i = getelementptr inbounds %promise_type, ptr %__promise, i64 0, i32 2
  store double 3.000000e+00, ptr %k.i, align 8
  call void @consume(ptr %struct.data)
  call void @consume_vector(ptr %unresolved_data)
  call void @pi32(ptr %a.alloc)
  call void @pi64(ptr %c.alloc)
  call void @pdouble(ptr %d.alloc)
  call void @pi64p(ptr %e.alloc)
  call void @return_void()
  br label %coro.final

coro.final:                                       ; preds = %await.ready
  call void @final_suspend()
  %coro.final.await_ready = call i1 @await_ready()
  br i1 %coro.final.await_ready, label %final.ready, label %final.suspend

final.suspend:                                    ; preds = %coro.final
  %final.suspend.coro.save = call token @llvm.coro.save(ptr null)
  %final.suspend.from_address = call ptr @from_address(ptr %begin)
  call void @await_suspend()
  %final.suspend.coro.suspend = call i8 @llvm.coro.suspend(token %final.suspend.coro.save, i1 true)
  switch i8 %final.suspend.coro.suspend, label %coro.ret [
  i8 0, label %final.ready
  i8 1, label %final.cleanup
  ]

final.cleanup:                                    ; preds = %final.suspend
  br label %cleanup

final.ready:                                      ; preds = %final.suspend, %coro.final
  call void @await_resume()
  br label %cleanup

cleanup:                                          ; preds = %final.ready, %final.cleanup, %await.cleanup, %init.cleanup
  %cleanup.dest.slot.0 = phi i32 [ 0, %final.ready ], [ 2, %final.cleanup ], [ 2, %await.cleanup ], [ 2, %init.cleanup ]
  %free.memory = call ptr @llvm.coro.free(token %id, ptr %begin)
  %free = icmp ne ptr %free.memory, null
  br i1 %free, label %coro.free, label %after.coro.free

coro.free:                                        ; preds = %cleanup
  call void @delete(ptr %free.memory)
  br label %after.coro.free

after.coro.free:                                  ; preds = %coro.free, %cleanup
  switch i32 %cleanup.dest.slot.0, label %unreachable [
  i32 0, label %cleanup.cont
  i32 2, label %coro.ret
  ]

cleanup.cont:                                     ; preds = %after.coro.free
  br label %coro.ret

coro.ret:                                         ; preds = %cleanup.cont, %after.coro.free, %final.suspend, %await.suspend, %init.suspend
  call void @llvm.coro.end(ptr null, i1 false, token none)
  ret void

unreachable:                                      ; preds = %after.coro.free
  unreachable

}

declare void @llvm.dbg.declare(metadata, metadata, metadata)
declare token @llvm.coro.id(i32, ptr readnone, ptr nocapture readonly, ptr)
declare i1 @llvm.coro.alloc(token)
declare i64 @llvm.coro.size.i64()
declare token @llvm.coro.save(ptr)
declare ptr @llvm.coro.begin(token, ptr writeonly)
declare i8 @llvm.coro.suspend(token, i1)
declare ptr @llvm.coro.free(token, ptr nocapture readonly)
declare void @llvm.coro.end(ptr, i1, token)

declare ptr @new(i64)
declare void @delete(ptr)
declare i1 @await_ready()
declare void @await_suspend()
declare void @await_resume()
declare void @print(i32)
declare ptr @from_address(ptr)
declare void @return_void()
declare void @final_suspend()

!llvm.dbg.cu = !{!0}
!llvm.linker.options = !{}
!llvm.module.flags = !{!3, !4}
!llvm.ident = !{!5}

!0 = distinct !DICompileUnit(language: DW_LANG_C_plus_plus_14, file: !1, producer: "clang version 11.0.0", isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug, enums: !2, retainedTypes: !2, splitDebugInlining: false, nameTableKind: None)
!1 = !DIFile(filename: "coro-debug.cpp", directory: ".")
!2 = !{}
!3 = !{i32 7, !"Dwarf Version", i32 4}
!4 = !{i32 2, !"Debug Info Version", i32 3}
!5 = !{!"clang version 11.0.0"}
!6 = !DILocalVariable(name: "__promise", scope: !7, file: !1, line: 24, type: !10)
!7 = distinct !DILexicalBlock(scope: !8, file: !1, line: 23, column: 12)
!8 = distinct !DISubprogram(name: "foo", linkageName: "_Z3foov", scope: !8, file: !1, line: 23, type: !9, scopeLine: 23, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !0, retainedNodes: !2)
!9 = !DISubroutineType(types: !2)
!10 = !DIDerivedType(tag: DW_TAG_typedef, name: "promise_type", scope: !8, file: !1, line: 15, baseType: !11)
!11 = distinct !DICompositeType(tag: DW_TAG_structure_type, name: "promise_type", scope: !8, file: !1, line: 10, size: 128, flags: DIFlagTypePassByValue | DIFlagNonTrivial, elements: !12, identifier: "_ZTSN4coro12promise_typeE")
!12 = !{!13, !14, !15}
!13 = !DIDerivedType(tag: DW_TAG_member, name: "i", scope: !8, file: !1, line: 10, baseType: !16, size: 32)
!14 = !DIDerivedType(tag: DW_TAG_member, name: "j", scope: !8, file: !1, line: 10, baseType: !16, size: 32, offset: 32)
!15 = !DIDerivedType(tag: DW_TAG_member, name: "k", scope: !8, file: !1, line: 10, baseType: !17, size: 64, offset: 64)
!16 = !DIBasicType(name: "int", size: 32, encoding: DW_ATE_signed)
!17 = !DIBasicType(name: "double", size: 64, encoding: DW_ATE_float)
!18 = !DILocation(line: 8, scope: !7)
!19 = distinct !DISubprogram(name: "bar", linkageName: "_Z3barv", scope: !19, file: !1, line: 54, type: !9, scopeLine: 54, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: !0, retainedNodes: !2)
!20 = distinct !DILexicalBlock(scope: !19, file: !1, line: 23, column: 12)
!21 = !DILocalVariable(name: "__promise", scope: !20, file: !1, line: 55, type: !10)
!22 = !DILocation(line: 10, scope: !20)
;.
; CHECK: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_C_plus_plus_14, file: [[META1:![0-9]+]], producer: "{{.*}}clang version {{.*}}", isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug, enums: [[META2:![0-9]+]], retainedTypes: [[META2]], splitDebugInlining: false, nameTableKind: None)
; CHECK: [[META1]] = !DIFile(filename: "{{.*}}coro-debug.cpp", directory: {{.*}})
; CHECK: [[META2]] = !{}
; CHECK: [[DBG6]] = distinct !DISubprogram(name: "foo", linkageName: "_Z3foov", scope: [[DBG6]], file: [[META1]], line: 23, type: [[META7:![0-9]+]], scopeLine: 23, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META8:![0-9]+]])
; CHECK: [[META7]] = !DISubroutineType(types: [[META2]])
; CHECK: [[META8]] = !{[[META9]]}
; CHECK: [[META9]] = !DILocalVariable(name: "__coro_frame", scope: [[DBG6]], file: [[META1]], line: 23, type: [[META10:![0-9]+]], flags: DIFlagArtificial)
; CHECK: [[META10]] = !DICompositeType(tag: DW_TAG_structure_type, name: "f.coro_frame_ty", file: [[META1]], line: 23, size: 4736, align: 128, flags: DIFlagArtificial, elements: [[META11:![0-9]+]])
; CHECK: [[META11]] = !{[[META12:![0-9]+]], [[META14:![0-9]+]], [[META15:![0-9]+]], [[META24:![0-9]+]], [[META29:![0-9]+]], [[META31:![0-9]+]], [[META33:![0-9]+]], [[META35:![0-9]+]], [[META37:![0-9]+]], [[META38:![0-9]+]], [[META42:![0-9]+]], [[META49:![0-9]+]], [[META51:![0-9]+]]}
; CHECK: [[META12]] = !DIDerivedType(tag: DW_TAG_member, name: "__resume_fn", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META13:![0-9]+]], size: 64, align: 64, flags: DIFlagArtificial)
; CHECK: [[META13]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: null, size: 64)
; CHECK: [[META14]] = !DIDerivedType(tag: DW_TAG_member, name: "__destroy_fn", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META13]], size: 64, align: 64, offset: 64, flags: DIFlagArtificial)
; CHECK: [[META15]] = !DIDerivedType(tag: DW_TAG_member, name: "__promise", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META16:![0-9]+]], size: 128, align: 64, offset: 128, flags: DIFlagArtificial)
; CHECK: [[META16]] = !DIDerivedType(tag: DW_TAG_typedef, name: "promise_type", scope: [[DBG6]], file: [[META1]], line: 15, baseType: [[META17:![0-9]+]])
; CHECK: [[META17]] = distinct !DICompositeType(tag: DW_TAG_structure_type, name: "promise_type", scope: [[DBG6]], file: [[META1]], line: 10, size: 128, flags: DIFlagTypePassByValue | DIFlagNonTrivial, elements: [[META18:![0-9]+]], identifier: "_ZTSN4coro12promise_typeE")
; CHECK: [[META18]] = !{[[META19:![0-9]+]], [[META21:![0-9]+]], [[META22:![0-9]+]]}
; CHECK: [[META19]] = !DIDerivedType(tag: DW_TAG_member, name: "i", scope: [[DBG6]], file: [[META1]], line: 10, baseType: [[META20:![0-9]+]], size: 32)
; CHECK: [[META20]] = !DIBasicType(name: "int", size: 32, encoding: DW_ATE_signed)
; CHECK: [[META21]] = !DIDerivedType(tag: DW_TAG_member, name: "j", scope: [[DBG6]], file: [[META1]], line: 10, baseType: [[META20]], size: 32, offset: 32)
; CHECK: [[META22]] = !DIDerivedType(tag: DW_TAG_member, name: "k", scope: [[DBG6]], file: [[META1]], line: 10, baseType: [[META23:![0-9]+]], size: 64, offset: 64)
; CHECK: [[META23]] = !DIBasicType(name: "double", size: 64, encoding: DW_ATE_float)
; CHECK: [[META24]] = !DIDerivedType(tag: DW_TAG_member, name: "_0", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META25:![0-9]+]], size: 128, align: 128, offset: 256, flags: DIFlagArtificial)
; CHECK: [[META25]] = !DICompositeType(tag: DW_TAG_array_type, baseType: [[META26:![0-9]+]], size: 128, align: 16, elements: [[META27:![0-9]+]])
; CHECK: [[META26]] = !DIBasicType(name: "UnknownType", size: 8, encoding: DW_ATE_unsigned_char, flags: DIFlagArtificial)
; CHECK: [[META27]] = !{[[META28:![0-9]+]]}
; CHECK: [[META28]] = !DISubrange(count: 16, lowerBound: 0)
; CHECK: [[META29]] = !DIDerivedType(tag: DW_TAG_member, name: "__int_64_1", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META30:![0-9]+]], size: 64, align: 32, offset: 384, flags: DIFlagArtificial)
; CHECK: [[META30]] = !DIBasicType(name: "__int_64", size: 64, encoding: DW_ATE_signed, flags: DIFlagArtificial)
; CHECK: [[META31]] = !DIDerivedType(tag: DW_TAG_member, name: "__double__2", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META32:![0-9]+]], size: 64, align: 32, offset: 448, flags: DIFlagArtificial)
; CHECK: [[META32]] = !DIBasicType(name: "__double_", size: 64, encoding: DW_ATE_float, flags: DIFlagArtificial)
; CHECK: [[META33]] = !DIDerivedType(tag: DW_TAG_member, name: "PointerType_3", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META34:![0-9]+]], size: 64, align: 32, offset: 512, flags: DIFlagArtificial)
; CHECK: [[META34]] = !DIDerivedType(tag: DW_TAG_pointer_type, name: "PointerType", baseType: null, size: 64, align: 64)
; CHECK: [[META35]] = !DIDerivedType(tag: DW_TAG_member, name: "__int_32_4", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META36:![0-9]+]], size: 32, align: 32, offset: 576, flags: DIFlagArtificial)
; CHECK: [[META36]] = !DIBasicType(name: "__int_32", size: 32, encoding: DW_ATE_signed, flags: DIFlagArtificial)
; CHECK: [[META37]] = !DIDerivedType(tag: DW_TAG_member, name: "__int_32_5", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META36]], size: 32, align: 32, offset: 608, flags: DIFlagArtificial)
; CHECK: [[META38]] = !DIDerivedType(tag: DW_TAG_member, name: "_6", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META39:![0-9]+]], size: 9, align: 16, offset: 640, flags: DIFlagArtificial)
; CHECK: [[META39]] = !DICompositeType(tag: DW_TAG_array_type, baseType: [[META26]], size: 16, align: 2, elements: [[META40:![0-9]+]])
; CHECK: [[META40]] = !{[[META41:![0-9]+]]}
; CHECK: [[META41]] = !DISubrange(count: 2, lowerBound: 0)
; CHECK: [[META42]] = !DIDerivedType(tag: DW_TAG_member, name: "struct_big_structure_7", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META43:![0-9]+]], size: 4000, align: 8, offset: 656, flags: DIFlagArtificial)
; CHECK: [[META43]] = !DICompositeType(tag: DW_TAG_structure_type, name: "struct_big_structure", scope: [[META10]], file: [[META1]], line: 23, size: 4000, align: 64, flags: DIFlagArtificial, elements: [[META44:![0-9]+]])
; CHECK: [[META44]] = !{[[META45:![0-9]+]]}
; CHECK: [[META45]] = !DIDerivedType(tag: DW_TAG_member, scope: [[META43]], file: [[META1]], line: 23, baseType: [[META46:![0-9]+]], size: 4000, align: 1, flags: DIFlagArtificial)
; CHECK: [[META46]] = !DICompositeType(tag: DW_TAG_array_type, baseType: [[META26]], size: 4000, align: 1, elements: [[META47:![0-9]+]])
; CHECK: [[META47]] = !{[[META48:![0-9]+]]}
; CHECK: [[META48]] = !DISubrange(count: 500, lowerBound: 0)
; CHECK: [[META49]] = !DIDerivedType(tag: DW_TAG_member, name: "__coro_index", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META50:![0-9]+]], size: 2, align: 8, offset: 4656, flags: DIFlagArtificial)
; CHECK: [[META50]] = !DIBasicType(name: "__coro_index", size: 8, encoding: DW_ATE_unsigned_char)
; CHECK: [[META51]] = !DIDerivedType(tag: DW_TAG_member, name: "UnknownType_8", scope: [[META10]], file: [[META1]], line: 23, baseType: [[META26]], size: 5, align: 8, offset: 4664, flags: DIFlagArtificial)
; CHECK: [[META52]] = !DILocalVariable(name: "__promise", scope: [[META53:![0-9]+]], file: [[META1]], line: 24, type: [[META16]])
; CHECK: [[META53]] = distinct !DILexicalBlock(scope: [[DBG6]], file: [[META1]], line: 23, column: 12)
; CHECK: [[META54]] = !DILocation(line: 8, scope: [[META53]])
; CHECK: [[META55]] = !DILocation(line: 23, column: 1, scope: [[DBG6]])
; CHECK: [[DBG56]] = distinct !DISubprogram(name: "bar", linkageName: "_Z3barv", scope: [[DBG56]], file: [[META1]], line: 54, type: [[META7]], scopeLine: 54, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META57:![0-9]+]])
; CHECK: [[META57]] = !{[[META58]]}
; CHECK: [[META58]] = !DILocalVariable(name: "__coro_frame", scope: [[DBG56]], file: [[META1]], line: 54, type: [[META59:![0-9]+]], flags: DIFlagArtificial)
; CHECK: [[META59]] = !DICompositeType(tag: DW_TAG_structure_type, name: "bar.coro_frame_ty", file: [[META1]], line: 54, size: 4736, align: 128, flags: DIFlagArtificial, elements: [[META60:![0-9]+]])
; CHECK: [[META60]] = !{[[META61:![0-9]+]], [[META62:![0-9]+]], [[META63:![0-9]+]], [[META64:![0-9]+]], [[META65:![0-9]+]], [[META66:![0-9]+]], [[META67:![0-9]+]], [[META68:![0-9]+]], [[META69:![0-9]+]], [[META73:![0-9]+]]}
; CHECK: [[META61]] = !DIDerivedType(tag: DW_TAG_member, name: "__resume_fn", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META13]], size: 64, align: 64, flags: DIFlagArtificial)
; CHECK: [[META62]] = !DIDerivedType(tag: DW_TAG_member, name: "__destroy_fn", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META13]], size: 64, align: 64, offset: 64, flags: DIFlagArtificial)
; CHECK: [[META63]] = !DIDerivedType(tag: DW_TAG_member, name: "__promise", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META16]], size: 128, align: 64, offset: 128, flags: DIFlagArtificial)
; CHECK: [[META64]] = !DIDerivedType(tag: DW_TAG_member, name: "_0", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META25]], size: 128, align: 128, offset: 256, flags: DIFlagArtificial)
; CHECK: [[META65]] = !DIDerivedType(tag: DW_TAG_member, name: "__int_64_1", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META30]], size: 64, align: 32, offset: 384, flags: DIFlagArtificial)
; CHECK: [[META66]] = !DIDerivedType(tag: DW_TAG_member, name: "__double__2", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META32]], size: 64, align: 32, offset: 448, flags: DIFlagArtificial)
; CHECK: [[META67]] = !DIDerivedType(tag: DW_TAG_member, name: "PointerType_3", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META34]], size: 64, align: 32, offset: 512, flags: DIFlagArtificial)
; CHECK: [[META68]] = !DIDerivedType(tag: DW_TAG_member, name: "__int_32_4", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META36]], size: 32, align: 32, offset: 576, flags: DIFlagArtificial)
; CHECK: [[META69]] = !DIDerivedType(tag: DW_TAG_member, name: "struct_big_structure_5", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META70:![0-9]+]], size: 4000, align: 8, offset: 608, flags: DIFlagArtificial)
; CHECK: [[META70]] = !DICompositeType(tag: DW_TAG_structure_type, name: "struct_big_structure", scope: [[META59]], file: [[META1]], line: 54, size: 4000, align: 64, flags: DIFlagArtificial, elements: [[META71:![0-9]+]])
; CHECK: [[META71]] = !{[[META72:![0-9]+]]}
; CHECK: [[META72]] = !DIDerivedType(tag: DW_TAG_member, scope: [[META70]], file: [[META1]], line: 54, baseType: [[META46]], size: 4000, align: 1, flags: DIFlagArtificial)
; CHECK: [[META73]] = !DIDerivedType(tag: DW_TAG_member, name: "__coro_index", scope: [[META59]], file: [[META1]], line: 54, baseType: [[META50]], size: 2, align: 8, offset: 4608, flags: DIFlagArtificial)
; CHECK: [[META74]] = !DILocalVariable(name: "__promise", scope: [[META75:![0-9]+]], file: [[META1]], line: 55, type: [[META16]])
; CHECK: [[META75]] = distinct !DILexicalBlock(scope: [[DBG56]], file: [[META1]], line: 23, column: 12)
; CHECK: [[META76]] = !DILocation(line: 10, scope: [[META75]])
; CHECK: [[META77]] = !DILocation(line: 54, column: 1, scope: [[DBG56]])
;.
