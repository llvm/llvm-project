; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --version 6
; RUN: opt -S -passes=inline -locally-hot-callsite-threshold=525 < %s | FileCheck %s

; Make sure that we do not inline an exponential number of calls.

define void @caller() {
; CHECK-LABEL: define void @caller() {
; CHECK-NEXT:  [[START:.*]]:
; CHECK-NEXT:    br label %[[LOOP1:.*]]
; CHECK:       [[LOOP1]]:
; CHECK-NEXT:    [[PHI1:%.*]] = phi i1 [ true, %[[START]] ], [ false, %[[LOOP2:.*]] ]
; CHECK-NEXT:    br i1 [[PHI1]], label %[[LOOP2]], label %[[EXIT:.*]]
; CHECK:       [[LOOP2]]:
; CHECK-NEXT:    [[PHI2:%.*]] = phi i1 [ true, %[[LOOP1]] ], [ false, %[[LOOP2_BODY:.*]] ]
; CHECK-NEXT:    br i1 [[PHI2]], label %[[LOOP2_BODY]], label %[[LOOP1]]
; CHECK:       [[LOOP2_BODY]]:
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    br label %[[LOOP2]]
; CHECK:       [[EXIT]]:
; CHECK-NEXT:    ret void
;
start:
  br label %loop1

loop1:
  %phi1 = phi i1 [ true, %start ], [ false, %loop2 ]
  br i1 %phi1, label %loop2, label %exit

loop2:
  %phi2 = phi i1 [ true, %loop1 ], [ false, %loop2.body ]
  br i1 %phi2, label %loop2.body, label %loop1

loop2.body:
  call void @callee1()
  br label %loop2

exit:
  ret void
}

define void @callee1() {
; CHECK-LABEL: define void @callee1() {
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    ret void
;
  call void @callee2()
  call void @callee2()
  call void @callee2()
  call void @callee2()
  ret void
}

define void @callee2() {
; CHECK-LABEL: define void @callee2() {
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    call void @callee3()
; CHECK-NEXT:    ret void
;
  call void @callee3()
  call void @callee3()
  call void @callee3()
  call void @callee3()
  ret void
}

define void @callee3() {
; CHECK-LABEL: define void @callee3() {
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    ret void
;
  call void @callee4()
  call void @callee4()
  call void @callee4()
  call void @callee4()
  ret void
}

define void @callee4() {
; CHECK-LABEL: define void @callee4() {
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    call void @callee5()
; CHECK-NEXT:    ret void
;
  call void @callee5()
  call void @callee5()
  call void @callee5()
  call void @callee5()
  ret void
}

declare void @callee5()
