; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --check-globals --version 3
; RUN: opt -mtriple=x86_64-unknown-linux -S -passes=lowertypetests -lowertypetests-summary-action=import -lowertypetests-read-summary=%S/Inputs/import.yaml %s | FileCheck --check-prefixes=CHECK,X86 %s
; RUN: opt -mtriple=aarch64-unknown-linux -S -passes=lowertypetests -lowertypetests-summary-action=import -lowertypetests-read-summary=%S/Inputs/import.yaml %s | FileCheck --check-prefixes=CHECK,ARM %s

target datalayout = "e-p:64:64"

declare i1 @llvm.type.test(ptr %ptr, metadata %bitset) nounwind readnone

;.
; X86: @__typeid_single_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_inline6_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_inline6_align = external hidden global [0 x i8], !absolute_symbol [[META0:![0-9]+]]
; X86: @__typeid_inline6_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META1:![0-9]+]]
; X86: @__typeid_inline6_inline_bits = external hidden global [0 x i8], !absolute_symbol [[META2:![0-9]+]]
; X86: @__typeid_inline5_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_inline5_align = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_inline5_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META3:![0-9]+]]
; X86: @__typeid_inline5_inline_bits = external hidden global [0 x i8], !absolute_symbol [[META4:![0-9]+]]
; X86: @__typeid_bytearray32_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_bytearray32_align = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_bytearray32_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META4]]
; X86: @__typeid_bytearray32_byte_array = external hidden global [0 x i8]
; X86: @__typeid_bytearray32_bit_mask = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_bytearray7_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_bytearray7_align = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_bytearray7_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META5:![0-9]+]]
; X86: @__typeid_bytearray7_byte_array = external hidden global [0 x i8]
; X86: @__typeid_bytearray7_bit_mask = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_allones32_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_allones32_align = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_allones32_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META4]]
; X86: @__typeid_allones7_global_addr = external hidden global [0 x i8], code_model "small"
; X86: @__typeid_allones7_align = external hidden global [0 x i8], !absolute_symbol [[META0]]
; X86: @__typeid_allones7_size_m1 = external hidden global [0 x i8], !absolute_symbol [[META5]]
;.
; ARM: @__typeid_single_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_inline6_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_inline5_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_bytearray32_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_bytearray32_byte_array = external hidden global [0 x i8]
; ARM: @__typeid_bytearray7_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_bytearray7_byte_array = external hidden global [0 x i8]
; ARM: @__typeid_allones32_global_addr = external hidden global [0 x i8], code_model "small"
; ARM: @__typeid_allones7_global_addr = external hidden global [0 x i8], code_model "small"
;.
define i1 @allones7(ptr %p) {
; X86-LABEL: define i1 @allones7(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_allones7_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_allones7_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_allones7_size_m1 to i64)
; X86-NEXT:    ret i1 [[TMP4]]
;
; ARM-LABEL: define i1 @allones7(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_allones7_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 1)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 42
; ARM-NEXT:    ret i1 [[TMP4]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"allones7")
  ret i1 %x
}

define i1 @allones32(ptr %p) {
; X86-LABEL: define i1 @allones32(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_allones32_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_allones32_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_allones32_size_m1 to i64)
; X86-NEXT:    ret i1 [[TMP4]]
;
; ARM-LABEL: define i1 @allones32(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_allones32_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 2)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 12345
; ARM-NEXT:    ret i1 [[TMP4]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"allones32")
  ret i1 %x
}

define i1 @bytearray7(ptr %p) {
; X86-LABEL: define i1 @bytearray7(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_bytearray7_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_bytearray7_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_bytearray7_size_m1 to i64)
; X86-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF6:![0-9]+]]
; X86:       5:
; X86-NEXT:    [[TMP6:%.*]] = getelementptr i8, ptr @__typeid_bytearray7_byte_array, i64 [[TMP3]]
; X86-NEXT:    [[TMP7:%.*]] = load i8, ptr [[TMP6]], align 1
; X86-NEXT:    [[TMP8:%.*]] = and i8 [[TMP7]], ptrtoint (ptr @__typeid_bytearray7_bit_mask to i8)
; X86-NEXT:    [[TMP9:%.*]] = icmp ne i8 [[TMP8]], 0
; X86-NEXT:    br label [[TMP10]]
; X86:       10:
; X86-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; X86-NEXT:    ret i1 [[TMP11]]
;
; ARM-LABEL: define i1 @bytearray7(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_bytearray7_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 3)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 43
; ARM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF0:![0-9]+]]
; ARM:       5:
; ARM-NEXT:    [[TMP6:%.*]] = getelementptr i8, ptr @__typeid_bytearray7_byte_array, i64 [[TMP3]]
; ARM-NEXT:    [[TMP7:%.*]] = load i8, ptr [[TMP6]], align 1
; ARM-NEXT:    [[TMP8:%.*]] = and i8 [[TMP7]], ptrtoint (ptr inttoptr (i64 64 to ptr) to i8)
; ARM-NEXT:    [[TMP9:%.*]] = icmp ne i8 [[TMP8]], 0
; ARM-NEXT:    br label [[TMP10]]
; ARM:       10:
; ARM-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; ARM-NEXT:    ret i1 [[TMP11]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"bytearray7")
  ret i1 %x
}

define i1 @bytearray32(ptr %p) {
; X86-LABEL: define i1 @bytearray32(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_bytearray32_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_bytearray32_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_bytearray32_size_m1 to i64)
; X86-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF6]]
; X86:       5:
; X86-NEXT:    [[TMP6:%.*]] = getelementptr i8, ptr @__typeid_bytearray32_byte_array, i64 [[TMP3]]
; X86-NEXT:    [[TMP7:%.*]] = load i8, ptr [[TMP6]], align 1
; X86-NEXT:    [[TMP8:%.*]] = and i8 [[TMP7]], ptrtoint (ptr @__typeid_bytearray32_bit_mask to i8)
; X86-NEXT:    [[TMP9:%.*]] = icmp ne i8 [[TMP8]], 0
; X86-NEXT:    br label [[TMP10]]
; X86:       10:
; X86-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; X86-NEXT:    ret i1 [[TMP11]]
;
; ARM-LABEL: define i1 @bytearray32(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_bytearray32_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 4)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 12346
; ARM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF0]]
; ARM:       5:
; ARM-NEXT:    [[TMP6:%.*]] = getelementptr i8, ptr @__typeid_bytearray32_byte_array, i64 [[TMP3]]
; ARM-NEXT:    [[TMP7:%.*]] = load i8, ptr [[TMP6]], align 1
; ARM-NEXT:    [[TMP8:%.*]] = and i8 [[TMP7]], ptrtoint (ptr inttoptr (i64 128 to ptr) to i8)
; ARM-NEXT:    [[TMP9:%.*]] = icmp ne i8 [[TMP8]], 0
; ARM-NEXT:    br label [[TMP10]]
; ARM:       10:
; ARM-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; ARM-NEXT:    ret i1 [[TMP11]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"bytearray32")
  ret i1 %x
}

define i1 @inline5(ptr %p) {
; X86-LABEL: define i1 @inline5(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_inline5_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_inline5_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_inline5_size_m1 to i64)
; X86-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP11:%.*]], !prof [[PROF6]]
; X86:       5:
; X86-NEXT:    [[TMP6:%.*]] = trunc i64 [[TMP3]] to i32
; X86-NEXT:    [[TMP7:%.*]] = and i32 [[TMP6]], 31
; X86-NEXT:    [[TMP8:%.*]] = shl i32 1, [[TMP7]]
; X86-NEXT:    [[TMP9:%.*]] = and i32 ptrtoint (ptr @__typeid_inline5_inline_bits to i32), [[TMP8]]
; X86-NEXT:    [[TMP10:%.*]] = icmp ne i32 [[TMP9]], 0
; X86-NEXT:    br label [[TMP11]]
; X86:       11:
; X86-NEXT:    [[TMP12:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP10]], [[TMP5]] ]
; X86-NEXT:    ret i1 [[TMP12]]
;
; ARM-LABEL: define i1 @inline5(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_inline5_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 5)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 31
; ARM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP11:%.*]], !prof [[PROF0]]
; ARM:       5:
; ARM-NEXT:    [[TMP6:%.*]] = trunc i64 [[TMP3]] to i32
; ARM-NEXT:    [[TMP7:%.*]] = and i32 [[TMP6]], 31
; ARM-NEXT:    [[TMP8:%.*]] = shl i32 1, [[TMP7]]
; ARM-NEXT:    [[TMP9:%.*]] = and i32 123, [[TMP8]]
; ARM-NEXT:    [[TMP10:%.*]] = icmp ne i32 [[TMP9]], 0
; ARM-NEXT:    br label [[TMP11]]
; ARM:       11:
; ARM-NEXT:    [[TMP12:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP10]], [[TMP5]] ]
; ARM-NEXT:    ret i1 [[TMP12]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"inline5")
  ret i1 %x
}

define i1 @inline6(ptr %p) {
; X86-LABEL: define i1 @inline6(
; X86-SAME: ptr [[P:%.*]]) {
; X86-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; X86-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_inline6_global_addr to i64), [[TMP1]]
; X86-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 ptrtoint (ptr @__typeid_inline6_align to i64))
; X86-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], ptrtoint (ptr @__typeid_inline6_size_m1 to i64)
; X86-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF6]]
; X86:       5:
; X86-NEXT:    [[TMP6:%.*]] = and i64 [[TMP3]], 63
; X86-NEXT:    [[TMP7:%.*]] = shl i64 1, [[TMP6]]
; X86-NEXT:    [[TMP8:%.*]] = and i64 ptrtoint (ptr @__typeid_inline6_inline_bits to i64), [[TMP7]]
; X86-NEXT:    [[TMP9:%.*]] = icmp ne i64 [[TMP8]], 0
; X86-NEXT:    br label [[TMP10]]
; X86:       10:
; X86-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; X86-NEXT:    ret i1 [[TMP11]]
;
; ARM-LABEL: define i1 @inline6(
; ARM-SAME: ptr [[P:%.*]]) {
; ARM-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; ARM-NEXT:    [[TMP2:%.*]] = sub i64 ptrtoint (ptr @__typeid_inline6_global_addr to i64), [[TMP1]]
; ARM-NEXT:    [[TMP3:%.*]] = call i64 @llvm.fshr.i64(i64 [[TMP2]], i64 [[TMP2]], i64 6)
; ARM-NEXT:    [[TMP4:%.*]] = icmp ule i64 [[TMP3]], 63
; ARM-NEXT:    br i1 [[TMP4]], label [[TMP5:%.*]], label [[TMP10:%.*]], !prof [[PROF0]]
; ARM:       5:
; ARM-NEXT:    [[TMP6:%.*]] = and i64 [[TMP3]], 63
; ARM-NEXT:    [[TMP7:%.*]] = shl i64 1, [[TMP6]]
; ARM-NEXT:    [[TMP8:%.*]] = and i64 1000000000000, [[TMP7]]
; ARM-NEXT:    [[TMP9:%.*]] = icmp ne i64 [[TMP8]], 0
; ARM-NEXT:    br label [[TMP10]]
; ARM:       10:
; ARM-NEXT:    [[TMP11:%.*]] = phi i1 [ false, [[TMP0:%.*]] ], [ [[TMP9]], [[TMP5]] ]
; ARM-NEXT:    ret i1 [[TMP11]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"inline6")
  ret i1 %x
}

define i1 @single(ptr %p) {
; CHECK-LABEL: define i1 @single(
; CHECK-SAME: ptr [[P:%.*]]) {
; CHECK-NEXT:    [[TMP1:%.*]] = ptrtoint ptr [[P]] to i64
; CHECK-NEXT:    [[TMP2:%.*]] = icmp eq i64 [[TMP1]], ptrtoint (ptr @__typeid_single_global_addr to i64)
; CHECK-NEXT:    ret i1 [[TMP2]]
;
  %x = call i1 @llvm.type.test(ptr %p, metadata !"single")
  ret i1 %x
}
;.
; X86: attributes #[[ATTR0:[0-9]+]] = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }
; X86: attributes #[[ATTR1:[0-9]+]] = { nocallback nocreateundeforpoison nofree nosync nounwind speculatable willreturn memory(none) }
;.
; ARM: attributes #[[ATTR0:[0-9]+]] = { nocallback nofree nosync nounwind speculatable willreturn memory(none) }
; ARM: attributes #[[ATTR1:[0-9]+]] = { nocallback nocreateundeforpoison nofree nosync nounwind speculatable willreturn memory(none) }
;.
; X86: [[META0]] = !{i64 0, i64 256}
; X86: [[META1]] = !{i64 0, i64 64}
; X86: [[META2]] = !{i64 -1, i64 -1}
; X86: [[META3]] = !{i64 0, i64 32}
; X86: [[META4]] = !{i64 0, i64 4294967296}
; X86: [[META5]] = !{i64 0, i64 128}
; X86: [[PROF6]] = !{!"branch_weights", i32 1048575, i32 1}
;.
; ARM: [[PROF0]] = !{!"branch_weights", i32 1048575, i32 1}
;.
