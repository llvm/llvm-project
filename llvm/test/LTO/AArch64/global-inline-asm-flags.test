RUN: llvm-as %p/Inputs/asm-bar1.ll -o %t-asm-bar1.bc
RUN: llvm-as %p/Inputs/asm-foo1.ll -o %t-asm-foo1.bc

Test LTO with unique symbols foo, bar, bar@VER.

RUN: llvm-lto -save-merged-module -filetype=asm %t-asm-bar1.bc %t-asm-foo1.bc -o %t1
RUN: llvm-dis %t1.merged.bc -o - | FileCheck %s --check-prefix CHECK-1
RUN: llvm-nm %t1.merged.bc | FileCheck %s --check-prefix CHECK-1-NM

CHECK-1-NOT: module asm
CHECK-1: module asm ".text"
CHECK-1: module asm ".balign 16"
CHECK-1: module asm ".globl bar"
CHECK-1: module asm "bar:"
CHECK-1: module asm "  nop"
CHECK-1: module asm ".symver bar, bar@VER"
CHECK-1: module asm ".previous"
CHECK-1: module asm ".text"
CHECK-1: module asm ".balign 16"
CHECK-1: module asm ".globl foo"
CHECK-1: module asm "foo:"
CHECK-1: module asm "  nop"
CHECK-1: module asm ".previous"
CHECK-1-NOT: module asm

CHECK-1: !{i32 6, !"global-asm-symbols", ![[SYMBOLS:[0-9]+]]}
CHECK-1: ![[SYMBOLS]] = distinct !{![[SYM_BAR:[0-9]+]], ![[SYM_BAR_VER:[0-9]+]], ![[SYM_FOO:[0-9]+]]}
CHECK-1: ![[SYM_BAR]] = !{!"bar", i32 2050}
CHECK-1: ![[SYM_BAR_VER]] = !{!"bar@VER", i32 2050}
CHECK-1: ![[SYM_FOO]] = !{!"foo", i32 2050}
CHECK-1: !{i32 6, !"global-asm-symvers", ![[SYMVERS:[0-9]+]]}
CHECK-1: ![[SYMVERS]] = distinct !{![[SYMVER_BAR:[0-9]+]]}
CHECK-1: ![[SYMVER_BAR]] = !{!"bar", !"bar@VER"}

CHECK-1-NM-NOT:      {{bar|foo}}
CHECK-1-NM:          T bar
CHECK-1-NM-NEXT:     T bar@VER
CHECK-1-NM-NEXT:     T foo
CHECK-1-NM-NOT:      {{bar|foo}}

Test LTO2 with unique symbols foo, bar, bar@VER.
All symbols are prevailing, so .lto_discard is emtpy and metadata from
2 modules are combined.

RUN: llvm-lto2 run -save-temps -filetype=asm %t-asm-bar1.bc %t-asm-foo1.bc -o %t2.s \
RUN:   -r=%t-asm-bar1.bc,bar,p \
RUN:   -r=%t-asm-bar1.bc,bar@VER,p \
RUN:   -r=%t-asm-foo1.bc,foo,p
RUN: llvm-dis %t2.s.0.5.precodegen.bc -o - | FileCheck %s --check-prefix CHECK-2
RUN: llvm-nm %t2.s.0.5.precodegen.bc | FileCheck %s --check-prefix CHECK-2-NM

CHECK-2-NOT: module asm
CHECK-2: module asm ".lto_discard"
CHECK-2: module asm ".text"
CHECK-2: module asm ".balign 16"
CHECK-2: module asm ".globl bar"
CHECK-2: module asm "bar:"
CHECK-2: module asm "  nop"
CHECK-2: module asm ".symver bar, bar@VER"
CHECK-2: module asm ".previous"
CHECK-2: module asm ".lto_discard"
CHECK-2: module asm ".text"
CHECK-2: module asm ".balign 16"
CHECK-2: module asm ".globl foo"
CHECK-2: module asm "foo:"
CHECK-2: module asm "  nop"
CHECK-2: module asm ".previous"
CHECK-2-NOT: module asm

CHECK-2: !{i32 6, !"global-asm-symbols", ![[SYMBOLS:[0-9]+]]}
CHECK-2: ![[SYMBOLS]] = distinct !{![[SYM_BAR:[0-9]+]], ![[SYM_BAR_VER:[0-9]+]], ![[SYM_FOO:[0-9]+]]}
CHECK-2: ![[SYM_BAR]] = !{!"bar", i32 2050}
CHECK-2: ![[SYM_BAR_VER]] = !{!"bar@VER", i32 2050}
CHECK-2: ![[SYM_FOO]] = !{!"foo", i32 2050}
CHECK-2: !{i32 6, !"global-asm-symvers", ![[SYMVERS:[0-9]+]]}
CHECK-2: ![[SYMVERS]] = distinct !{![[SYMVER_BAR:[0-9]+]]}
CHECK-2: ![[SYMVER_BAR]] = !{!"bar", !"bar@VER"}

CHECK-2-NM-NOT:      {{bar|foo}}
CHECK-2-NM:          T bar
CHECK-2-NM-NEXT:     T bar@VER
CHECK-2-NM-NEXT:     T foo
CHECK-2-NM-NOT:      {{bar|foo}}

Test LTO2 with non-prevailing symbol foo, and prevailing bar, bar@VER.
Non-prevailing symbols should be removed from the metadata
to match .lto_discard.

RUN: llvm-lto2 run -save-temps -filetype=asm %t-asm-bar1.bc %t-asm-foo1.bc -o %t3.s \
RUN:   -r=%t-asm-bar1.bc,bar,p \
RUN:   -r=%t-asm-bar1.bc,bar@VER,p \
RUN:   -r=%t-asm-foo1.bc,foo
RUN: llvm-dis %t3.s.0.5.precodegen.bc -o - | FileCheck %s --check-prefix CHECK-3
RUN: llvm-nm %t3.s.0.5.precodegen.bc | FileCheck %s --check-prefix CHECK-3-NM

CHECK-3-NOT: module asm
CHECK-3: module asm ".lto_discard"
CHECK-3: module asm ".text"
CHECK-3: module asm ".balign 16"
CHECK-3: module asm ".globl bar"
CHECK-3: module asm "bar:"
CHECK-3: module asm "  nop"
CHECK-3: module asm ".symver bar, bar@VER"
CHECK-3: module asm ".previous"
CHECK-3: module asm ".lto_discard foo"
CHECK-3: module asm ".text"
CHECK-3: module asm ".balign 16"
CHECK-3: module asm ".globl foo"
CHECK-3: module asm "foo:"
CHECK-3: module asm "  nop"
CHECK-3: module asm ".previous"
CHECK-3-NOT: module asm

CHECK-3: !{i32 6, !"global-asm-symbols", ![[SYMBOLS:[0-9]+]]}
CHECK-3: ![[SYMBOLS]] = distinct !{![[SYM_BAR:[0-9]+]], ![[SYM_BAR_VER:[0-9]+]]}
CHECK-3: ![[SYM_BAR]] = !{!"bar", i32 2050}
CHECK-3: ![[SYM_BAR_VER]] = !{!"bar@VER", i32 2050}
CHECK-3: !{i32 6, !"global-asm-symvers", ![[SYMVERS:[0-9]+]]}
CHECK-3: ![[SYMVERS]] = distinct !{![[SYMVER_BAR:[0-9]+]]}
CHECK-3: ![[SYMVER_BAR]] = !{!"bar", !"bar@VER"}

CHECK-3-NM-NOT:      {{bar|foo}}
CHECK-3-NM:          T bar
CHECK-3-NM-NEXT:     T bar@VER
CHECK-3-NM-NOT:      {{bar|foo}}
