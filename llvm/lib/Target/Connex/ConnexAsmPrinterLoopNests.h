//===-- ConnexAsmPrinterLoopNests.h -  -----*- C++ -*--===//
//
// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
// See https://llvm.org/LICENSE.txt for license information.
// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
//
//===----------------------------------------------------------------------===//
//
/// \file
/// This file implements reading the FILENAME_LOOPNESTS_LOCATIONS file with info
///   about start and end locations of loops nests, generated by the
///   LoopVectorize pass.
// Used by ConnexAsmPrinter.cpp and ReplaceLoopsWithOpincaaKernels.cpp.
//===----------------------------------------------------------------------===//

#ifndef CONNEX_ASM_PRINTER_LOOP_NESTS_H
#define CONNEX_ASM_PRINTER_LOOP_NESTS_H

// Used by ReplaceLoopsWithOpincaaKernels.cpp and ConnexAsmPrinter.cpp

std::vector<bool> treatRepeat2ndInnerLoop;
// The start and end of the innermost (or 2nd innermost) loop
std::vector<int> linStart, colStart, linEnd, colEnd;
//
std::vector<int> linStartLoopNest, colStartLoopNest, linEndLoopNest,
    colEndLoopNest;

/*
We read in vectors the lines and columns of the innermost loop
   and, if there is one, also of the outermost loop
  of the loop nests specified in the FILENAME_LOOPNESTS_LOCATIONS file.
 We put in treatRepeat2ndInnerLoop vector true
  depending if the loop nest has more than 1 loop in the nest,
   false otherwise.

Note: We keep the numbering from 1 throughout the ENTIRE program,
   BUT in FindEndLoop() we decrement the value.
*/
void readLoopsLocFile(char *fileNameSrc, bool silentFail = false) {
  int index;
  char str[MAXLEN_STR];

  int linStartTmp, colStartTmp;
  int linEndTmp, colEndTmp;

  FILE *fin = fopen(fileNameSrc, "rt");

  /* We need to process each loop, from the last in the file to the first,
       therefore preserving the line & column numbers of the loops that
       remain to be replaces.
  */
  if (silentFail) {
    if (fin == NULL) {
      printf("%s file NOT found (maybe NO loop was vectorized)",
             FILENAME_LOOPNESTS_LOCATIONS);
      return;
    }
  }
  assert(fin != NULL &&
         "readLoopsLocFile(): fileNameSrc (e.g., FILENAME_LOOPNESTS_LOCATIONS) "
         "file NOT found (maybe NO loop was vectorized). "
         "Anyhow cannot automatically replace in source file vectorized loops "
         "with OPINCAA kernels.");

  for (index = 0;; index++) {
    // We read the line with the C++ comment and discard it
    if (fgets(str, MAXLEN_STR - 1, fin) == NULL)
      break;

    printf("str = %s\n", str);
    fflush(stdout);

    // We read the coordinates of the innermost loop of the crt nest
    int res = fscanf(fin, "%d %d %d %d\r\n", &linStartTmp, &colStartTmp,
                     &linEndTmp, &colEndTmp);
    (void)res;
    //
    printf("readLoopsLocFile(): index = %d\n", index);

    printf("readLoopsLocFile(): (linStart = %d, colStart = %d) -> "
           "(linEndTmp = %d, colEndTmp = %d)\n",
           linStartTmp, colStartTmp, linEndTmp, colEndTmp);
    fflush(stdout);
    //
    linStart.push_back(linStartTmp);
    colStart.push_back(colStartTmp);
    linEnd.push_back(linEndTmp);
    colEnd.push_back(colEndTmp);
    assert(linStartTmp <= linEndTmp);

    // We check if the next line is one with C++ comment
    int ch = getc(fin);
    ungetc(ch, fin);

    printf("readLoopsLocFile(): ch = %d\n", (int)ch);
    fflush(stdout);

    if ((ch == '/') || (ch == -1)) {
      treatRepeat2ndInnerLoop.push_back(false);

      linStartLoopNest.push_back(-1);
      colStartLoopNest.push_back(-1);
      linEndLoopNest.push_back(-1);
      colEndLoopNest.push_back(-1);
    } else {
      // We read the coordinates of the outermost loop of the crt nest
      treatRepeat2ndInnerLoop.push_back(true);

      int res = fscanf(fin, "%d %d %d %d\r\n", &linStartTmp, &colStartTmp,
                       &linEndTmp, &colEndTmp);
      (void)res;
      printf("readLoopsLocFile(): (linStart = %d, colStart = %d) -> "
             "(linEndTmp = %d, colEndTmp = %d)\n",
             linStartTmp, colStartTmp, linEndTmp, colEndTmp);
      fflush(stdout);

      linStartLoopNest.push_back(linStartTmp);
      colStartLoopNest.push_back(colStartTmp);
      linEndLoopNest.push_back(linEndTmp);
      colEndLoopNest.push_back(colEndTmp);
    }

    printf("readLoopsLocFile(): treatRepeat2ndInnerLoop[%d] = %d\n", index,
           (int)treatRepeat2ndInnerLoop[index]);
    fflush(stdout);
  }

  fclose(fin);
} // End readLoopsLocFile()

#endif // End CONNEX_ASM_PRINTER_LOOP_NESTS_H
