<!--===- docs/GettingStarted.md 
  
   Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.
   See https://llvm.org/LICENSE.txt for license information.
   SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception
  
-->

# Flang-rt Runtime Library

```eval_rst
.. contents::
   :local:
```
## What is Flang-rt
Flang-rt is the runtime library project for Flang. The Flang driver requires
the Fortran_main and Flang-rt libraries at runtime in order to generate
user executables. Building this Flang-rt project will build both Fortran_main
and the Flang-rt library, which is comprised of the FortranRuntime and
FortranDecimalRT libraries.

### Fortran_main
Fortran_main is left out of the Flang-rt library because it is required to
always be static unlike the link type of the Flang-rt library which can be
configured. Fortran_main implements the main entry point into Fortran's
`PROGRAM` in Flang by being the bridge between object files generated by Flang 
and the C runtime that takes care of program set-up at system-level. For
every Fortran `PROGRAM`, Flang generates the `_QQmain` function.
Fortran_main implements the C `main` function that simply calls
`_QQmain`.

### FortranDecimalRT
In order to decouple the common dependency between compiler and runtime,
[FortranDecimal's sources](../../flang/lib/Decimal/CMakeLists.txt) are built
separately for the compiler and the runtime. When the library is built for
Flang-rt, the name FortranDecimalRT is used to avoid naming conflicts and
confusion.

### FortranRuntime
This is the core runtime library in Flang-rt. The sources for this library
currently still exist in the
[Flang source directory](../../flang/runtime/CMakeLists.txt). We hope to
migrate the sources to the Flang-rt directory in the future in order to further
decouple the runtime from the Flang compiler.

## Building Flang-rt
Like other LLVM runtimes, Flang-rt can be built by targetting the
[runtimes LLVM target](../../runtimes/CMakelists.txt). It can also be built
when targetting the [llvm target](../../llvm/CMakeLists.txt) as an enabled
runtime. Flang-rt will implicitly be added as an enabled runtime when Flang
is an enabled project built by llvm. Flang-rt does not support standalone
builds.

In the future, we may be interested in supporting in optionally building
Flang-rt when doing a Flang standalone build.

### Building with the llvm target
Assuming you are building Flang-rt to use with Flang, see
[Flang's Getting Started guide](../../flang/docs/GettingStarted.md) for more
information. To build Flang-rt when building the Flang compiler, once you have
the llvm-project source ready, make a clean build directory. Let root be the
root directory that you cloned llvm-project into.
```bash
cd root
rm -rf build
mkdir build
cd build
```
Now invoke the cmake configuration command for llvm that would build Flang with
Flang-rt.
```bash
cmake \
  -G Ninja \
  -DLLVM_ENABLE_RUNTIMES="compiler-rt;flang-rt" \
  -DCMAKE_CXX_STANDARD=17 \
  -DLLVM_INSTALL_UTILS=On \
  # New Flang-rt flags for enabled link types
  -DFLANG_RT_ENABLE_STATIC=On \
  -DFLANG_RT_ENABLE_SHARED=On \
  # We need to enable GTest if we want to run Flang-rt's testsuites
  -DLLVM_INSTALL_GTEST=On \
  -DFLANG_ENABLE_WERROR=On \
  -DLLVM_LIT_ARGS=-v \
  -DCMAKE_BUILD_TYPE=Release \
  -DLLVM_ENABLE_PROJECTS="clang;flang;lld;mlir;openmp" \
  ../llvm-project/llvm
```
Flang requires other llvm projects (see LLVM_ENABLE_PROJECTS and the [Flang
Getting Started Guide](../../flang/docs/GettingStarted.md) for more specifics
on building Flang.

By targetting the LLVM project, we are letting LLVM infrastructure handle
invoking the runtimes target that will build Flang-rt. This includes finding
the cmake packages for Clang, LLVM, Flang and MLIR that Flang-rt depends on.

### Building with the runtimes target
If you already have a pre-built/installed version of LLVM, Flang, Clang and
MLIR, and would like to build Flang-rt without rebuilding the sources for these
other projects. You can simply target the runtimes project directly and passing
the paths to the directories of these files. If you built LLVM as we did above
with default build directories, your runtimes invocation should look something
like:
```bash
cd build
BUILDDIR=`pwd`

cmake \
  -G Ninja \
  -DCMAKE_CXX_STANDARD=17 \
  # New Flang-rt flags for enabled link types
  -DFLANG_RT_ENABLE_SHARED=On \
  -DFLANG_RT_ENABLE_STATIC=On \
  -DLLVM_LIT_ARGS=-v \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_CXX_LINK_FLAGS="-Wl,-rpath,$LD_LIBRARY_PATH" \
  -DLLVM_TARGETS_TO_BUILD=host \
  -DLLVM_EXTERNAL_LIT=$BUILD_DIR/bin/llvm-lit \
  # We need to specify the paths to the cmake packages of the dependencies
  -DLLVM_DIR=$BUILD_DIR/lib/cmake/llvm \
  -DMLIR_DIR=$BUILD_DIR/lib/cmake/mlir \
  -DFLANG_DIR=$BUILD_DIR/lib/cmake/flang \
  -DLLVM_ENABLE_RUNTIMES="flang-rt" \
  ../llvm-project/runtimes/
```

## Library locations
When building the llvm target with flang as an enabled project, the Flang-rt
library will be built to `$BUILDDIR/runtimes/runtimes-bins/flang-rt/lib`. When
building the runtimes target with flang-rt as an enabled runtime, the libraries
will be built to `$BUILDDIR/flang-rt/lib` by default. In either configuration,
the Fortran_main library will be built to `$BUILDDIR/lib` by default.

## Using Flang-rt
The two build paths mentioned above get implicitly added as library paths at the
invocation of the driver. If Flang-rt is a shared library, you must make the
dynamic linker aware of where to look. One method to do so is to set the
environment variable `LD_LIBRARY_PATH` include the path to Flang-rt's directory.

## Options
Flang-rt introduces 2 CMake options used to configure the library's link type:
```
option(FLANG_RT_ENABLE_SHARED "Build flang-rt as a shared library." OFF)
option(FLANG_RT_ENABLE_STATIC "Build flang-rt as a static library." OFF)
```
Both can be specified if you want to build both shared and static versions of
the Flang-rt runtime. If both are specified, the static library will be named
Flang-rt_static.a to avoid naming conflicts, as per the LLVM standard.

## Usage Examples
```bash
# Example of using Flang with the shared Flang-rt runtime
# First we need to explicitly tell the dynamic linker where to find Flang-rt
# since it was built as shared.
$ $ export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$BUILDDIR/runtimes/runtimes-bins/flang-rt/lib"
$ flang-new -ffree-form hello.f95 -o hello
```
