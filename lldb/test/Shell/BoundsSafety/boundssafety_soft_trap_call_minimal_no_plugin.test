# UNSUPPORTED: system-windows
# REQUIRES: clang-bounds-safety
# RUN: %clang_host -c -fbounds-safety -fbounds-safety-soft-traps=call-minimal -g -O0 %S/Inputs/boundsSafetySoftTraps.c -o %t.o
# Note: Building the runtime without debug info is intentional because this is the common case
# RUN: %clang_host -c -O0 %S/Inputs/boundsSafetyMockSoftTrapRuntime.c -o %t.softtrap_runtime.o
# RUN: %clang_host %t.o %t.softtrap_runtime.o -o %t.out
# RUN: %lldb -b -s %s %t.out | FileCheck %s

# Run without the plugin. A user might want to do this so they can set their
# own custom breakpoint with custom stopping behavior (e.g. stop after n hits).
plugin disable instrumentation-runtime.BoundsSafety
# CHECK: [-] BoundsSafety

b __bounds_safety_soft_trap
run

# CHECK: * thread #{{.*}} stop reason = breakpoint 1.1

# Check that reason for bounds check failing can be seen in the stacktrace
bt
# CHECK: * frame #{{.*}}`__bounds_safety_soft_trap{{$}}
# CHECK-NEXT: frame #{{.*}}`__clang_trap_msg$Bounds check failed$indexing above upper bound in 'array[index]'
# CHECK-NEXT: frame #{{.*}}`bad_read(index=10) at boundsSafetySoftTraps.c:5

# Resume execution
c
# CHECK: BoundsSafety check FAILED
# CHECK-NEXT: Execution continued
# CHECK: Process {{[0-9]+}} exited with status = 0
q
