// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --prefix-filecheck-ir-name TMP_ --version 3

// RUN: %clang_cc1 -triple x86_64 -fbounds-safety -ftrap-function=fb_trap -ftrap-function-returns -O2 -emit-llvm %s -o - | FileCheck %s --check-prefix=X86_64

#include <ptrcheck.h>

// X86_64-LABEL: define dso_local i32 @foo(
// X86_64-SAME: ptr noundef readonly captures(address) [[BAR:%.*]], i32 noundef [[COUNT:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// X86_64-NEXT:  entry:
// X86_64-NEXT:    [[IDX_EXT:%.*]] = zext i32 [[COUNT]] to i64
// X86_64-NEXT:    [[ADD_PTR:%.*]] = getelementptr inbounds nuw i32, ptr [[BAR]], i64 [[IDX_EXT]]
// X86_64-NEXT:    [[TMP0:%.*]] = getelementptr i8, ptr [[BAR]], i64 4
// X86_64-NEXT:    [[TMP1:%.*]] = icmp ult ptr [[TMP0]], [[ADD_PTR]], !annotation [[META2:![0-9]+]]
// X86_64-NEXT:    br i1 [[TMP1]], label [[CONT:%.*]], label [[TRAP:%.*]], !annotation [[META2]]
// X86_64:       trap:
// X86_64-NEXT:    tail call void @fb_trap(i8 25) #[[ATTR1:[0-9]+]], !annotation [[META2]]
// X86_64-NEXT:    br label [[CONT]], !annotation [[META2]]
// X86_64:       cont:
// X86_64-NEXT:    [[DOTNOT:%.*]] = icmp ult ptr [[TMP0]], [[BAR]], !annotation [[META3:![0-9]+]]
// X86_64-NEXT:    br i1 [[DOTNOT]], label [[TRAP1:%.*]], label [[CONT2:%.*]], !annotation [[META3]]
// X86_64:       trap1:
// X86_64-NEXT:    tail call void @fb_trap(i8 25) #[[ATTR1]], !annotation [[META3]]
// X86_64-NEXT:    br label [[CONT2]], !annotation [[META3]]
// X86_64:       cont2:
// X86_64-NEXT:    [[TMP2:%.*]] = load i32, ptr [[TMP0]], align 4, !tbaa [[TBAA4:![0-9]+]]
// X86_64-NEXT:    ret i32 [[TMP2]]
//
int foo(int *__counted_by(count) bar, unsigned count) {
    return bar[1];
}
