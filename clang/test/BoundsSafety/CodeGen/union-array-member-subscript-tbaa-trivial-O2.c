// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5

// RUN: %clang_cc1 -O2 -fbounds-safety -triple arm64-apple-ios -emit-llvm %s -o - | FileCheck %s
// RUN: %clang_cc1 -O2 -fbounds-safety -triple arm64-apple-ios -x objective-c -fexperimental-bounds-safety-objc -emit-llvm %s -o - | FileCheck %s
// RUN: %clang_cc1 -O2 -triple arm64-apple-ios -emit-llvm %s -o - | FileCheck %s

#include <ptrcheck.h>

struct pf_addr {
 union {
  short _addr16[8];
  int _addr32[4];
 } pfa;
};

static short foo(struct pf_addr *a, struct pf_addr *b, int *p) {
  b->pfa._addr32[0] = a->pfa._addr32[0];

  *p = 0x10000010;
  short ret = b->pfa._addr16[0] + b->pfa._addr16[1]; // 0x1000 + 0x0010 = 4112
  b->pfa._addr16[0] = 3;
  return ret;
}

// CHECK-LABEL: i16 @bar(
// CHECK-SAME: ) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    ret i16 4112
//
short bar(void) {
  struct pf_addr a = {1, 0, 5, 0};
  struct pf_addr b = {3, 0, 7, 0};
  int *p = &b.pfa._addr32[0];

  return foo(&a, &b, p);
}
