// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --replace-value-regex "!annotation ![0-9]+" "!tbaa ![0-9]+" "!tbaa\.struct ![0-9]+" "!nosanitize ![0-9]+" "!srcloc ![0-9]+" --prefix-filecheck-ir-name TMP_
// RUN: %clang_cc1 -O2 -triple arm64-apple-iphoneos -fbounds-safety -emit-llvm %s -o - | FileCheck %s
// RUN: %clang_cc1 -O2 -triple arm64-apple-iphoneos -fbounds-safety -x objective-c -fexperimental-bounds-safety-objc -emit-llvm %s -o - | FileCheck %s


#include <ptrcheck.h>

typedef struct {
  int count;
  int elems[__counted_by(count)];
} flex_t;

// CHECK-LABEL: @null_noderef(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    ret void
//
void null_noderef() {
  flex_t *__single b = (flex_t *)0;
}

// CHECK-LABEL: @null_deref(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR4:[0-9]+]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable
//
void null_deref() {
  flex_t *__single a = (flex_t *)0;
  (void)*a;
}

// CHECK-LABEL: @null_deref2(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR4]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable
//
void null_deref2() {
  flex_t *a = (flex_t *)0;
  flex_t *__single b = a;
  (void)b->elems[0];
}

// CHECK-LABEL: @null_deref3(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    unreachable
//
void null_deref3() {
  flex_t *a = (flex_t *)0;
  flex_t *__single b = a;
  b->count = 0;
}

// CHECK-LABEL: @null_deref_member_access(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR4]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable
//
void null_deref_member_access() {
  flex_t *a = 0;
  flex_t *__single b = a;
  (*b).count = 10;
}

// XXX: rdar://103082765
// CHECK-LABEL: @null_deref_array_access(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR4]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable
//
void null_deref_array_access() {
  flex_t *a = (flex_t *)0;
  flex_t *__single b = a;
  (*b).elems[0] = 10;
}
