// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py


// RUN: %clang_cc1 -O2 -triple x86_64 -fbounds-safety -emit-llvm %s -o - | FileCheck %s --check-prefix=CHECK-O2
// RUN: %clang_cc1 -O2 -triple x86_64 -fbounds-safety -x objective-c -fexperimental-bounds-safety-objc -emit-llvm %s -o - | FileCheck %s --check-prefix=CHECK-O2

#include <ptrcheck.h>

// CHECK-O2-LABEL: @TestOK(
// CHECK-O2-NEXT:  entry:
// CHECK-O2-NEXT:    ret i32 0
//
int TestOK() {
    int len = 0;
    int *__single __counted_by(len) dcp = 0;
    int *__single tp = dcp;
    return 0;
}

// FIXME
// CHECK-O2-LABEL: @TestTrap(
// CHECK-O2-NEXT:  entry:
// CHECK-O2-NEXT:    [[P:%.*]] = alloca i8, align 1
// CHECK-O2-NEXT:    call void @llvm.lifetime.start.p0(i64 1, ptr nonnull [[P]]) #[[ATTR4:[0-9]+]]
// CHECK-O2-NEXT:    [[TMP0:%.*]] = getelementptr inbounds nuw i8, ptr [[P]], i64 1
// CHECK-O2-NEXT:    [[TMP1:%.*]] = getelementptr i8, ptr [[P]], i64 4, !annotation [[META2:![0-9]+]]
// CHECK-O2-NEXT:    [[TMP2:%.*]] = icmp ule ptr [[TMP1]], [[TMP0]], !annotation [[META2]]
// CHECK-O2-NEXT:    [[TMP3:%.*]] = icmp ule ptr [[P]], [[TMP1]], !annotation [[META2]]
// CHECK-O2-NEXT:    [[OR_COND:%.*]] = and i1 [[TMP2]], [[TMP3]], !annotation [[META2]]
// CHECK-O2-NEXT:    br i1 [[OR_COND]], label [[CONT30:%.*]], label [[TRAP:%.*]], !prof [[PROF3:![0-9]+]], !annotation [[META2]]
// CHECK-O2:       trap:
// CHECK-O2-NEXT:    call void @llvm.ubsantrap(i8 25) #[[ATTR5:[0-9]+]], !annotation [[META4:![0-9]+]]
// CHECK-O2-NEXT:    unreachable, !annotation [[META4]]
// CHECK-O2:       cont30:
// CHECK-O2-NEXT:    call void @llvm.lifetime.end.p0(i64 1, ptr nonnull [[P]]) #[[ATTR4]]
// CHECK-O2-NEXT:    ret void
//
void TestTrap() {
  int len = 1;
  char p;
  char *__counted_by(len) dcp = &p;
  int *__single tp = dcp; // rdar://80816535
}
