// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --replace-value-regex "!annotation ![0-9]+" "!tbaa ![0-9]+" "!tbaa\.struct ![0-9]+" "!nosanitize ![0-9]+" "!srcloc ![0-9]+" --prefix-filecheck-ir-name TMP_
// RUN: %clang_cc1 -O2 -fbounds-safety -emit-llvm -triple arm64e-apple-iphoneos %s -o - | FileCheck %s
// RUN: %clang_cc1 -O2 -fbounds-safety -x objective-c -fexperimental-bounds-safety-objc -emit-llvm -triple arm64e-apple-iphoneos %s -o - | FileCheck %s

#include <ptrcheck.h>

struct foo {
  char *ptr;
  int i;
  long l;
};

// CHECK-LABEL: @addrof_single_ptr_to_single(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[TMP0:%.*]] = getelementptr i8, ptr [[F:%.*]], i64 8
// CHECK-NEXT:    [[DOTNOT4:%.*]] = icmp ugt ptr [[F]], [[TMP0]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    br i1 [[DOTNOT4]], label [[TRAP:%.*]], label [[CONT2:%.*]], !prof [[PROF3:![0-9]+]], {{!annotation ![0-9]+}}
// CHECK:       trap:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5:[0-9]+]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
// CHECK:       cont2:
// CHECK-NEXT:    ret ptr [[F]]
//
char **addrof_single_ptr_to_single(struct foo *f) {
  return &f->ptr;
}

// CHECK-LABEL: @addrof_single_i_to_single(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[TMP0:%.*]] = getelementptr inbounds nuw i8, ptr [[F:%.*]], i64 8
// CHECK-NEXT:    [[TMP1:%.*]] = getelementptr i8, ptr [[F]], i64 12
// CHECK-NEXT:    [[DOTNOT:%.*]] = icmp ugt ptr [[TMP0]], [[TMP1]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    br i1 [[DOTNOT]], label [[TRAP:%.*]], label [[CONT2:%.*]], !prof [[PROF6:![0-9]+]], {{!annotation ![0-9]+}}
// CHECK:       trap:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
// CHECK:       cont2:
// CHECK-NEXT:    ret ptr [[TMP0]]
//
int *addrof_single_i_to_single(struct foo *f) {
  return &f->i;
}

// CHECK-LABEL: @addrof_single_l_to_single(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[TMP0:%.*]] = getelementptr inbounds nuw i8, ptr [[F:%.*]], i64 16
// CHECK-NEXT:    [[TMP1:%.*]] = getelementptr i8, ptr [[F]], i64 24
// CHECK-NEXT:    [[DOTNOT:%.*]] = icmp ugt ptr [[TMP0]], [[TMP1]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    br i1 [[DOTNOT]], label [[TRAP:%.*]], label [[CONT2:%.*]], !prof [[PROF6]], {{!annotation ![0-9]+}}
// CHECK:       trap:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
// CHECK:       cont2:
// CHECK-NEXT:    ret ptr [[TMP0]]
//
long *addrof_single_l_to_single(struct foo *f) {
  return &f->l;
}

static inline char **__addrof_bidi_ptr_to_single(struct foo *__bidi_indexable f) {
  return &f->ptr;
}

// CHECK-LABEL: @addrof_bidi_ptr_to_single(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[F:%.*]] = alloca [[STRUCT_FOO:%.*]], align 8
// CHECK-NEXT:    ret ptr [[F]]
//
char **addrof_bidi_ptr_to_single(void) {
  struct foo f;
  return __addrof_bidi_ptr_to_single(&f);
}

// CHECK-LABEL: @addrof_bidi_ptr_to_single_oob_upper(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
char **addrof_bidi_ptr_to_single_oob_upper(void) {
  struct foo f;
  struct foo *fp = &f + 1;
  return __addrof_bidi_ptr_to_single(fp);
}


// CHECK-LABEL: @addrof_bidi_ptr_to_single_oob_lower(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
char **addrof_bidi_ptr_to_single_oob_lower(void) {
  struct foo f;
  struct foo *fp = &f - 1;
  return __addrof_bidi_ptr_to_single(fp);
}

static inline int *__addrof_bidi_i_to_single(struct foo *__bidi_indexable f) {
  return &f->i;
}

// CHECK-LABEL: @addrof_bidi_i_to_single(
// CHECK-NEXT:  cont3.i:
// CHECK-NEXT:    [[F:%.*]] = alloca [[STRUCT_FOO:%.*]], align 8
// CHECK-NEXT:    call void @llvm.lifetime.start.p0(ptr nonnull [[F]]) #[[ATTR6:[0-9]+]]
// CHECK-NEXT:    [[TMP0:%.*]] = getelementptr inbounds nuw i8, ptr [[F]], i64 8
// CHECK-NEXT:    call void @llvm.lifetime.end.p0(ptr nonnull [[F]]) #[[ATTR6]]
// CHECK-NEXT:    ret ptr [[TMP0]]
//
int *addrof_bidi_i_to_single(void) {
  struct foo f;
  return __addrof_bidi_i_to_single(&f);
}

// CHECK-LABEL: @addrof_bidi_i_to_single_oob_upper(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
int *addrof_bidi_i_to_single_oob_upper(void) {
  struct foo f;
  struct foo *fp = &f+1;
  return __addrof_bidi_i_to_single(fp);
}

// CHECK-LABEL: @addrof_bidi_i_to_single_oob_lower(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
int *addrof_bidi_i_to_single_oob_lower(void) {
  struct foo f;
  struct foo *fp = &f-1;
  return __addrof_bidi_i_to_single(fp);
}

static inline long *__addrof_bidi_l_to_single(struct foo *__bidi_indexable f) {
  return &f->l;
}

// CHECK-LABEL: @addrof_bidi_l_to_single(
// CHECK-NEXT:  __addrof_bidi_l_to_single.exit:
// CHECK-NEXT:    [[F:%.*]] = alloca [[STRUCT_FOO:%.*]], align 8
// CHECK-NEXT:    call void @llvm.lifetime.start.p0(ptr nonnull [[F]]) #[[ATTR6]]
// CHECK-NEXT:    [[TMP0:%.*]] = getelementptr inbounds nuw i8, ptr [[F]], i64 16
// CHECK-NEXT:    call void @llvm.lifetime.end.p0(ptr nonnull [[F]]) #[[ATTR6]]
// CHECK-NEXT:    ret ptr [[TMP0]]
//
long *addrof_bidi_l_to_single(void) {
  struct foo f;
  return __addrof_bidi_l_to_single(&f);
}

// CHECK-LABEL: @addrof_bidi_l_to_single_oob_upper(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
long *addrof_bidi_l_to_single_oob_upper(void) {
  struct foo f;
  struct foo *fp = &f+1;
  return __addrof_bidi_l_to_single(fp);
}

// CHECK-LABEL: @addrof_bidi_l_to_single_oob_lower(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    tail call void @llvm.ubsantrap(i8 25) #[[ATTR5]], {{!annotation ![0-9]+}}
// CHECK-NEXT:    unreachable, {{!annotation ![0-9]+}}
//
long *addrof_bidi_l_to_single_oob_lower(void) {
  struct foo f;
  struct foo *fp = &f-1;
  return __addrof_bidi_l_to_single(fp);
}
