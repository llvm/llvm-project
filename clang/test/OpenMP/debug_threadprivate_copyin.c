// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py
// This testcase checks emission of debug info for threadprivate variables
// present in any clause of OpenMP construct.

// REQUIRES: x86_64-linux

// RUN: %clang_cc1 -debug-info-kind=constructor -x c -verify -triple x86_64-pc-linux-gnu -fopenmp -emit-llvm %s -o - | FileCheck %s
// expected-no-diagnostics


extern int printf(const char *, ...);
extern void omp_set_num_threads(int);
extern int omp_get_num_threads(void);
extern int omp_get_thread_num(void);

int gbl_dynamic_int;
__thread int gbl_static_int;

#pragma omp threadprivate(gbl_dynamic_int)

// CHECK-LABEL: @main(
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[RETVAL:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[NT:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[OFFSET:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[OMP_OUTLINED_ARG_AGG_:%.*]] = alloca [[STRUCT_ANON:%.*]], align 8
// CHECK-NEXT:    store i32 0, ptr [[RETVAL]], align 4
// CHECK-NEXT:    call void @llvm.dbg.declare(metadata ptr [[NT]], metadata [[META23:![0-9]+]], metadata !DIExpression()), !dbg [[DBG24:![0-9]+]]
// CHECK-NEXT:    store i32 0, ptr [[NT]], align 4, !dbg [[DBG24]]
// CHECK-NEXT:    call void @llvm.dbg.declare(metadata ptr [[OFFSET]], metadata [[META25:![0-9]+]], metadata !DIExpression()), !dbg [[DBG26:![0-9]+]]
// CHECK-NEXT:    store i32 10, ptr [[OFFSET]], align 4, !dbg [[DBG26]]
// CHECK-NEXT:    [[TMP0:%.*]] = call align 4 ptr @llvm.threadlocal.address.p0(ptr align 4 @gbl_dynamic_int), !dbg [[DBG27:![0-9]+]]
// CHECK-NEXT:    store i32 55, ptr [[TMP0]], align 4, !dbg [[DBG28:![0-9]+]]
// CHECK-NEXT:    [[TMP1:%.*]] = call align 4 ptr @llvm.threadlocal.address.p0(ptr align 4 @gbl_static_int), !dbg [[DBG29:![0-9]+]]
// CHECK-NEXT:    store i32 77, ptr [[TMP1]], align 4, !dbg [[DBG30:![0-9]+]]
// CHECK-NEXT:    call void @omp_set_num_threads(i32 noundef 4), !dbg [[DBG31:![0-9]+]]
// CHECK-NEXT:    [[TMP2:%.*]] = getelementptr inbounds [[STRUCT_ANON]], ptr [[OMP_OUTLINED_ARG_AGG_]], i32 0, i32 0, !dbg [[DBG32:![0-9]+]]
// CHECK-NEXT:    store ptr [[NT]], ptr [[TMP2]], align 8, !dbg [[DBG32]]
// CHECK-NEXT:    [[TMP3:%.*]] = getelementptr inbounds [[STRUCT_ANON]], ptr [[OMP_OUTLINED_ARG_AGG_]], i32 0, i32 1, !dbg [[DBG32]]
// CHECK-NEXT:    [[TMP4:%.*]] = call align 4 ptr @llvm.threadlocal.address.p0(ptr align 4 @gbl_dynamic_int), !dbg [[DBG33:![0-9]+]]
// CHECK-NEXT:    store ptr [[TMP4]], ptr [[TMP3]], align 8, !dbg [[DBG32]]
// CHECK-NEXT:    [[TMP5:%.*]] = getelementptr inbounds [[STRUCT_ANON]], ptr [[OMP_OUTLINED_ARG_AGG_]], i32 0, i32 2, !dbg [[DBG32]]
// CHECK-NEXT:    [[TMP6:%.*]] = call align 4 ptr @llvm.threadlocal.address.p0(ptr align 4 @gbl_static_int), !dbg [[DBG35:![0-9]+]]
// CHECK-NEXT:    store ptr [[TMP6]], ptr [[TMP5]], align 8, !dbg [[DBG32]]
// CHECK-NEXT:    call void (ptr, i32, ptr, ...) @__kmpc_fork_call(ptr @[[GLOB4:[0-9]+]], i32 1, ptr @.omp_outlined., ptr [[OMP_OUTLINED_ARG_AGG_]]), !dbg [[DBG32]]
// CHECK-NEXT:    ret i32 0, !dbg [[DBG36:![0-9]+]]
//
int main() {
  int nt = 0;
  int offset = 10;
  gbl_dynamic_int = 55;
  gbl_static_int = 77;

  omp_set_num_threads(4);
#pragma omp parallel copyin(gbl_dynamic_int, gbl_static_int)
  {
    int data;
    int tid;
    nt = omp_get_num_threads();
    tid = omp_get_thread_num();
    data = gbl_dynamic_int + gbl_static_int;
    gbl_dynamic_int += 10;
    gbl_static_int += 20;
#pragma omp barrier
    if (tid == 0)
      printf("In parallel region total threads = %d, thread id = %d data=%d gbl_dyn_addr = %p, gbl_static_addr = %p\n",
             nt, tid, data, &gbl_dynamic_int, &gbl_static_int);
    if (tid == 1)
      printf("In parallel region total threads = %d, thread id = %d data=%d gbl_dyn_addr = %p, gbl_static_addr = %p\n",
             nt, tid, data, &gbl_dynamic_int, &gbl_static_int);
    if (tid == 2)
      printf("In parallel region total threads = %d, thread id = %d data=%d gbl_dyn_addr = %p, gbl_static_addr = %p\n",
             nt, tid, data, &gbl_dynamic_int, &gbl_static_int);
    if (tid == 3)
      printf("In parallel region total threads = %d, thread id = %d data=%d gbl_dyn_addr = %p, gbl_static_addr = %p\n",
             nt, tid, data, &gbl_dynamic_int, &gbl_static_int);
  }

  return 0;
}
