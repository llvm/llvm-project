// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --function-signature
// RUN: %clang_cc1 -triple wasm32 -target-feature +reference-types -disable-O0-optnone -emit-llvm %s -o - | opt -S -passes=mem2reg | FileCheck %s -check-prefix=WASM32
// RUN: %clang_cc1 -triple wasm64 -target-feature +reference-types -disable-O0-optnone -emit-llvm %s -o - | opt -S -passes=mem2reg | FileCheck %s -check-prefixes=WASM64
// REQUIRES: webassembly-registered-target

typedef __SIZE_TYPE__ size_t;

typedef void (*__funcref funcref_t)();
static funcref_t table[0];

// WASM32-LABEL: define {{[^@]+}}@test_builtin_wasm_table_get
// WASM32-SAME: (i32 noundef [[INDEX:%.*]]) #[[ATTR0:[0-9]+]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    [[TMP0:%.*]] = call ptr addrspace(20) @llvm.wasm.table.get.funcref.i32(ptr addrspace(1) @table, i32 [[INDEX]])
// WASM32-NEXT:    ret ptr addrspace(20) [[TMP0]]
//
// WASM64-LABEL: define {{[^@]+}}@test_builtin_wasm_table_get
// WASM64-SAME: (i64 noundef [[INDEX:%.*]]) #[[ATTR0:[0-9]+]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    [[TMP0:%.*]] = call ptr addrspace(20) @llvm.wasm.table.get.funcref.i64(ptr addrspace(1) @table, i64 [[INDEX]])
// WASM64-NEXT:    ret ptr addrspace(20) [[TMP0]]
//
funcref_t test_builtin_wasm_table_get(size_t index) {
  return __builtin_wasm_table_get(table, index);
}

// WASM32-LABEL: define {{[^@]+}}@test_builtin_wasm_table_set
// WASM32-SAME: (i32 noundef [[INDEX:%.*]], ptr addrspace(20) noundef [[REF:%.*]]) #[[ATTR0]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    call void @llvm.wasm.table.set.funcref.i32(ptr addrspace(1) @table, i32 [[INDEX]], ptr addrspace(20) [[REF]])
// WASM32-NEXT:    ret void
//
// WASM64-LABEL: define {{[^@]+}}@test_builtin_wasm_table_set
// WASM64-SAME: (i64 noundef [[INDEX:%.*]], ptr addrspace(20) noundef [[REF:%.*]]) #[[ATTR0]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    call void @llvm.wasm.table.set.funcref.i64(ptr addrspace(1) @table, i64 [[INDEX]], ptr addrspace(20) [[REF]])
// WASM64-NEXT:    ret void
//
void test_builtin_wasm_table_set(size_t index, funcref_t ref) {
  return __builtin_wasm_table_set(table, index, ref);
}

// WASM32-LABEL: define {{[^@]+}}@test_builtin_wasm_table_size
// WASM32-SAME: () #[[ATTR0]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    [[TMP0:%.*]] = call i32 @llvm.wasm.table.size.i32(ptr addrspace(1) @table)
// WASM32-NEXT:    ret i32 [[TMP0]]
//
// WASM64-LABEL: define {{[^@]+}}@test_builtin_wasm_table_size
// WASM64-SAME: () #[[ATTR0]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    [[TMP0:%.*]] = call i64 @llvm.wasm.table.size.i64(ptr addrspace(1) @table)
// WASM64-NEXT:    ret i64 [[TMP0]]
//
size_t test_builtin_wasm_table_size() {
  return __builtin_wasm_table_size(table);
}


// WASM32-LABEL: define {{[^@]+}}@test_builtin_wasm_table_grow
// WASM32-SAME: (ptr addrspace(20) noundef [[REF:%.*]], i32 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    [[TMP0:%.*]] = call i32 @llvm.wasm.table.grow.funcref.i32(ptr addrspace(1) @table, ptr addrspace(20) [[REF]], i32 [[NELEM]])
// WASM32-NEXT:    ret i32 [[TMP0]]
//
// WASM64-LABEL: define {{[^@]+}}@test_builtin_wasm_table_grow
// WASM64-SAME: (ptr addrspace(20) noundef [[REF:%.*]], i64 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    [[TMP0:%.*]] = call i32 @llvm.wasm.table.grow.funcref.i64(ptr addrspace(1) @table, ptr addrspace(20) [[REF]], i64 [[NELEM]])
// WASM64-NEXT:    ret i32 [[TMP0]]
//
int test_builtin_wasm_table_grow(funcref_t ref, size_t nelem) {
  return __builtin_wasm_table_grow(table, ref, nelem);
}

// WASM32-LABEL: define {{[^@]+}}@test_builtin_wasm_table_fill
// WASM32-SAME: (i32 noundef [[INDEX:%.*]], ptr addrspace(20) noundef [[REF:%.*]], i32 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    call void @llvm.wasm.table.fill.funcref.i32(ptr addrspace(1) @table, i32 [[INDEX]], ptr addrspace(20) [[REF]], i32 [[NELEM]])
// WASM32-NEXT:    ret void
//
// WASM64-LABEL: define {{[^@]+}}@test_builtin_wasm_table_fill
// WASM64-SAME: (i64 noundef [[INDEX:%.*]], ptr addrspace(20) noundef [[REF:%.*]], i64 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    call void @llvm.wasm.table.fill.funcref.i64(ptr addrspace(1) @table, i64 [[INDEX]], ptr addrspace(20) [[REF]], i64 [[NELEM]])
// WASM64-NEXT:    ret void
//
void test_builtin_wasm_table_fill(size_t index, funcref_t ref, size_t nelem) {
  __builtin_wasm_table_fill(table, index, ref, nelem);
}

static funcref_t other_table[0];

// WASM32-LABEL: define {{[^@]+}}@test_table_copy
// WASM32-SAME: (i32 noundef [[DST_IDX:%.*]], i32 noundef [[SRC_IDX:%.*]], i32 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM32-NEXT:  entry:
// WASM32-NEXT:    call void @llvm.wasm.table.copy.i32(ptr addrspace(1) @table, ptr addrspace(1) @other_table, i32 [[SRC_IDX]], i32 [[DST_IDX]], i32 [[NELEM]])
// WASM32-NEXT:    ret void
//
// WASM64-LABEL: define {{[^@]+}}@test_table_copy
// WASM64-SAME: (i64 noundef [[DST_IDX:%.*]], i64 noundef [[SRC_IDX:%.*]], i64 noundef [[NELEM:%.*]]) #[[ATTR0]] {
// WASM64-NEXT:  entry:
// WASM64-NEXT:    call void @llvm.wasm.table.copy.i64(ptr addrspace(1) @table, ptr addrspace(1) @other_table, i64 [[SRC_IDX]], i64 [[DST_IDX]], i64 [[NELEM]])
// WASM64-NEXT:    ret void
//
void test_table_copy(size_t dst_idx, size_t src_idx, size_t nelem) {
  __builtin_wasm_table_copy(table, other_table, dst_idx, src_idx, nelem);
}
