// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// RUN: %clang_cc1 -emit-llvm -triple x86_64 -std=c17 -fsanitize=function %s -o - \
// RUN:   -fdebug-prefix-map=%S/= -fno-ident -fdebug-compilation-dir=%S -debug-info-kind=limited \
// RUN:   -fsanitize-annotate-debug-info=function \
// RUN:   | FileCheck %s

// CHECK-LABEL: define dso_local void @call_no_prototype(
// CHECK-SAME: ptr noundef [[F:%.*]]) #[[ATTR0:[0-9]+]] !dbg [[DBG4:![0-9]+]] !func_sanitize [[META12:![0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[F_ADDR:%.*]] = alloca ptr, align 8
// CHECK-NEXT:    store ptr [[F]], ptr [[F_ADDR]], align 8
// CHECK-NEXT:      #dbg_declare(ptr [[F_ADDR]], [[META13:![0-9]+]], !DIExpression(), [[META14:![0-9]+]])
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[F_ADDR]], align 8, !dbg [[DBG15:![0-9]+]]
// CHECK-NEXT:    call void (...) [[TMP0]](), !dbg [[DBG15]]
// CHECK-NEXT:    ret void, !dbg [[DBG16:![0-9]+]]
//
void call_no_prototype(void (*f)()) { f(); }

// CHECK-LABEL: define dso_local void @call_prototype(
// CHECK-SAME: ptr noundef [[F:%.*]]) #[[ATTR0]] !dbg [[DBG17:![0-9]+]] !func_sanitize [[META23:![0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[F_ADDR:%.*]] = alloca ptr, align 8
// CHECK-NEXT:    store ptr [[F]], ptr [[F_ADDR]], align 8
// CHECK-NEXT:      #dbg_declare(ptr [[F_ADDR]], [[META24:![0-9]+]], !DIExpression(), [[META25:![0-9]+]])
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[F_ADDR]], align 8, !dbg [[DBG26:![0-9]+]]
// CHECK-NEXT:    [[TMP1:%.*]] = getelementptr <{ i32, i32 }>, ptr [[TMP0]], i32 -1, i32 0, !dbg [[DBG26]], !nosanitize [[META11:![0-9]+]]
// CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[TMP1]], align 4, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    [[TMP3:%.*]] = icmp eq i32 [[TMP2]], -1056584962, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    br i1 [[TMP3]], label %[[TYPECHECK:.*]], label %[[CONT1:.*]], !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK:       [[TYPECHECK]]:
// CHECK-NEXT:    [[TMP4:%.*]] = getelementptr <{ i32, i32 }>, ptr [[TMP0]], i32 -1, i32 1, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    [[TMP5:%.*]] = load i32, ptr [[TMP4]], align 8, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    [[TMP6:%.*]] = icmp eq i32 [[TMP5]], 905068220, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    br i1 [[TMP6]], label %[[CONT:.*]], label %[[HANDLER_FUNCTION_TYPE_MISMATCH:.*]], !dbg [[DBG26]], !prof [[PROF27:![0-9]+]], !nosanitize [[META11]]
// CHECK:       [[HANDLER_FUNCTION_TYPE_MISMATCH]]:
// CHECK-NEXT:    [[TMP7:%.*]] = ptrtoint ptr [[TMP0]] to i64, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    call void @__ubsan_handle_function_type_mismatch_abort(ptr @[[GLOB1:[0-9]+]], i64 [[TMP7]]) #[[ATTR2:[0-9]+]], !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK-NEXT:    unreachable, !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    br label %[[CONT1]], !dbg [[DBG26]], !nosanitize [[META11]]
// CHECK:       [[CONT1]]:
// CHECK-NEXT:    call void [[TMP0]](), !dbg [[DBG26]]
// CHECK-NEXT:    ret void, !dbg [[DBG28:![0-9]+]]
//
void call_prototype(void (*f)(void)) { f(); }
//.
// CHECK: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_C11, file: [[META1:![0-9]+]], isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug, splitDebugInlining: false, nameTableKind: None)
// CHECK: [[META1]] = !DIFile(filename: "<stdin>", directory: {{.*}})
// CHECK: [[DBG4]] = distinct !DISubprogram(name: "call_no_prototype", scope: [[META5:![0-9]+]], file: [[META5]], line: 16, type: [[META6:![0-9]+]], scopeLine: 16, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META11]])
// CHECK: [[META5]] = !DIFile(filename: "{{.*}}ubsan-function-debuginfo.c", directory: {{.*}})
// CHECK: [[META6]] = !DISubroutineType(types: [[META7:![0-9]+]])
// CHECK: [[META7]] = !{null, [[META8:![0-9]+]]}
// CHECK: [[META8]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META9:![0-9]+]], size: 64)
// CHECK: [[META9]] = !DISubroutineType(types: [[META10:![0-9]+]])
// CHECK: [[META10]] = !{null, null}
// CHECK: [[META11]] = !{}
// CHECK: [[META12]] = !{i32 -1056584962, i32 187769638}
// CHECK: [[META13]] = !DILocalVariable(name: "f", arg: 1, scope: [[DBG4]], file: [[META5]], line: 16, type: [[META8]])
// CHECK: [[META14]] = !DILocation(line: 16, column: 31, scope: [[DBG4]])
// CHECK: [[DBG15]] = !DILocation(line: 16, column: 39, scope: [[DBG4]])
// CHECK: [[DBG16]] = !DILocation(line: 16, column: 44, scope: [[DBG4]])
// CHECK: [[DBG17]] = distinct !DISubprogram(name: "call_prototype", scope: [[META5]], file: [[META5]], line: 43, type: [[META18:![0-9]+]], scopeLine: 43, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META11]])
// CHECK: [[META18]] = !DISubroutineType(types: [[META19:![0-9]+]])
// CHECK: [[META19]] = !{null, [[META20:![0-9]+]]}
// CHECK: [[META20]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META21:![0-9]+]], size: 64)
// CHECK: [[META21]] = !DISubroutineType(types: [[META22:![0-9]+]])
// CHECK: [[META22]] = !{null}
// CHECK: [[META23]] = !{i32 -1056584962, i32 -747727454}
// CHECK: [[META24]] = !DILocalVariable(name: "f", arg: 1, scope: [[DBG17]], file: [[META5]], line: 43, type: [[META20]])
// CHECK: [[META25]] = !DILocation(line: 43, column: 28, scope: [[DBG17]])
// CHECK: [[DBG26]] = !DILocation(line: 43, column: 40, scope: [[DBG17]])
// CHECK: [[PROF27]] = !{!"branch_weights", i32 1048575, i32 1}
// CHECK: [[DBG28]] = !DILocation(line: 43, column: 45, scope: [[DBG17]])
//.
