// RUN: %clang_cc1 -triple aarch64-linux-gnu -mbranch-target-enforce -msign-return-address=all      -emit-llvm %s -o - | FileCheck -DLINKVIS="dso_local " --check-prefixes=CHECK,BTI-SIGNRA %s
// RUN: %clang_cc1 -triple arm64-apple-ios   -mbranch-target-enforce -msign-return-address=all      -emit-llvm %s -o - | FileCheck -DLINKVIS=""           --check-prefixes=CHECK,BTI-SIGNRA %s
// RUN: %clang_cc1 -triple aarch64-linux-gnu -fptrauth-calls -fptrauth-returns -fptrauth-auth-traps -emit-llvm %s -o - | FileCheck -DLINKVIS="dso_local " --check-prefixes=CHECK,PAUTHTEST %s
// RUN: %clang_cc1 -triple arm64-apple-ios   -fptrauth-calls -fptrauth-returns -fptrauth-auth-traps -emit-llvm %s -o - | FileCheck -DLINKVIS=""           --check-prefixes=CHECK,PAUTHTEST %s

// Check that resolver functions generated by clang have the correct attributes.

int __attribute__((target_clones("crc", "default"))) ftc(void) { return 0; }

int __attribute__((target_version("crc")))     fmv(void) { return 0; }
int __attribute__((target_version("default"))) fmv(void) { return 0; }

static int __attribute__((target_clones("crc", "default"))) static_ftc(void) { return 0; }

static int __attribute__((target_version("crc")))     static_fmv(void) { return 0; }
static int __attribute__((target_version("default"))) static_fmv(void) { return 0; }

// Force emission of static_* functions.
void *get_ptr1(void) { return static_ftc; }
void *get_ptr2(void) { return static_fmv; }

// CHECK-DAG: define [[LINKVIS]]i32 @ftc._Mcrc() #[[ATTR_CRC:[0-9]+]]
// CHECK-DAG: define [[LINKVIS]]i32 @ftc.default() #[[ATTR_DEFAULT:[0-9]+]]
// CHECK-DAG: define weak_odr ptr @ftc.resolver() #[[ATTR_RESOLVER:[0-9]+]]
// CHECK-DAG: define [[LINKVIS]]i32 @fmv._Mcrc() #[[ATTR_CRC]]
// CHECK-DAG: define [[LINKVIS]]i32 @fmv.default() #[[ATTR_DEFAULT]]
// CHECK-DAG: define weak_odr ptr @fmv.resolver() #[[ATTR_RESOLVER]]

// CHECK-DAG: define internal i32 @static_ftc._Mcrc() #[[ATTR_CRC:[0-9]+]]
// CHECK-DAG: define internal i32 @static_ftc.default() #[[ATTR_DEFAULT:[0-9]+]]
// CHECK-DAG: define internal ptr @static_ftc.resolver() #[[ATTR_RESOLVER:[0-9]+]]
// CHECK-DAG: define internal i32 @static_fmv._Mcrc() #[[ATTR_CRC]]
// CHECK-DAG: define internal i32 @static_fmv.default() #[[ATTR_DEFAULT]]
// CHECK-DAG: define internal ptr @static_fmv.resolver() #[[ATTR_RESOLVER]]

// BTI-SIGNRA-DAG: attributes #[[ATTR_CRC]]      = { {{.*}}"branch-target-enforcement" {{.*}}"sign-return-address"="all" "sign-return-address-key"="a_key"{{.*}} }
// BTI-SIGNRA-DAG: attributes #[[ATTR_RESOLVER]] = { {{.*}}"branch-target-enforcement" {{.*}}"sign-return-address"="all" "sign-return-address-key"="a_key"{{.*}} }
// BTI-SIGNRA-DAG: attributes #[[ATTR_DEFAULT]]  = { {{.*}}"branch-target-enforcement" {{.*}}"sign-return-address"="all" "sign-return-address-key"="a_key"{{.*}} }
// PAUTHTEST-DAG:  attributes #[[ATTR_CRC]]      = { {{.*}}"ptrauth-auth-traps" "ptrauth-calls" "ptrauth-returns"{{.*}} }
// PAUTHTEST-DAG:  attributes #[[ATTR_RESOLVER]] = { {{.*}}"ptrauth-auth-traps" "ptrauth-calls" "ptrauth-returns"{{.*}} }
// PAUTHTEST-DAG:  attributes #[[ATTR_DEFAULT]]  = { {{.*}}"ptrauth-auth-traps" "ptrauth-calls" "ptrauth-returns"{{.*}} }
