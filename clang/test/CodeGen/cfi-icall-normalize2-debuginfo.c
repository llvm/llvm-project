// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5
// RUN: %clang_cc1 -triple x86_64-unknown-linux -fsanitize=cfi-icall -fsanitize-trap=cfi-icall -fsanitize-cfi-icall-experimental-normalize-integers -emit-llvm -o - %s \
// RUN:     -fsanitize-annotate-debug-info=cfi-icall,cfi-nvcall,cfi-vcall,cfi-unrelated-cast,cfi-derived-cast \
// RUN:     -fdebug-prefix-map=%S/= -fno-ident -fdebug-compilation-dir=%S -debug-info-kind=limited \
// RUN:     | FileCheck %s

// Test that normalized type metadata for functions are emitted for cross-language CFI support with
// other languages that can't represent and encode C/C++ integer types.

// CHECK-LABEL: define dso_local void @foo(
// CHECK-SAME: ptr noundef [[FN:%.*]], i32 noundef [[ARG:%.*]]) #[[ATTR0:[0-9]+]] !dbg [[DBG6:![0-9]+]] !type [[META15:![0-9]+]] !type [[META16:![0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[FN_ADDR:%.*]] = alloca ptr, align 8
// CHECK-NEXT:    [[ARG_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    store ptr [[FN]], ptr [[FN_ADDR]], align 8
// CHECK-NEXT:      #dbg_declare(ptr [[FN_ADDR]], [[META17:![0-9]+]], !DIExpression(), [[META18:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG]], ptr [[ARG_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG_ADDR]], [[META19:![0-9]+]], !DIExpression(), [[META20:![0-9]+]])
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[FN_ADDR]], align 8, !dbg [[DBG21:![0-9]+]]
// CHECK-NEXT:    [[TMP1:%.*]] = call i1 @llvm.type.test(ptr [[TMP0]], metadata !"_ZTSFvu3i32E.normalized"), !dbg [[DBG21]], !nosanitize [[META14:![0-9]+]]
// CHECK-NEXT:    br i1 [[TMP1]], label %[[CONT:.*]], label %[[TRAP:.*]], !dbg [[DBG21]], !prof [[PROF22:![0-9]+]], !nosanitize [[META14]]
// CHECK:       [[TRAP]]:
// CHECK-NEXT:    call void @llvm.ubsantrap(i8 2) #[[ATTR3:[0-9]+]], !dbg [[DBG21]], !nosanitize [[META14]]
// CHECK-NEXT:    unreachable, !dbg [[DBG21]], !nosanitize [[META14]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[ARG_ADDR]], align 4, !dbg [[DBG23:![0-9]+]]
// CHECK-NEXT:    call void [[TMP0]](i32 noundef [[TMP2]]), !dbg [[DBG21]]
// CHECK-NEXT:    ret void, !dbg [[DBG24:![0-9]+]]
//
void foo(void (*fn)(int), int arg) {
    fn(arg);
}

// CHECK-LABEL: define dso_local void @bar(
// CHECK-SAME: ptr noundef [[FN:%.*]], i32 noundef [[ARG1:%.*]], i32 noundef [[ARG2:%.*]]) #[[ATTR0]] !dbg [[DBG25:![0-9]+]] !type [[META31:![0-9]+]] !type [[META32:![0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[FN_ADDR:%.*]] = alloca ptr, align 8
// CHECK-NEXT:    [[ARG1_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[ARG2_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    store ptr [[FN]], ptr [[FN_ADDR]], align 8
// CHECK-NEXT:      #dbg_declare(ptr [[FN_ADDR]], [[META33:![0-9]+]], !DIExpression(), [[META34:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG1]], ptr [[ARG1_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG1_ADDR]], [[META35:![0-9]+]], !DIExpression(), [[META36:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG2]], ptr [[ARG2_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG2_ADDR]], [[META37:![0-9]+]], !DIExpression(), [[META38:![0-9]+]])
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[FN_ADDR]], align 8, !dbg [[DBG39:![0-9]+]]
// CHECK-NEXT:    [[TMP1:%.*]] = call i1 @llvm.type.test(ptr [[TMP0]], metadata !"_ZTSFvu3i32S_E.normalized"), !dbg [[DBG39]], !nosanitize [[META14]]
// CHECK-NEXT:    br i1 [[TMP1]], label %[[CONT:.*]], label %[[TRAP:.*]], !dbg [[DBG39]], !prof [[PROF22]], !nosanitize [[META14]]
// CHECK:       [[TRAP]]:
// CHECK-NEXT:    call void @llvm.ubsantrap(i8 2) #[[ATTR3]], !dbg [[DBG39]], !nosanitize [[META14]]
// CHECK-NEXT:    unreachable, !dbg [[DBG39]], !nosanitize [[META14]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[ARG1_ADDR]], align 4, !dbg [[DBG40:![0-9]+]]
// CHECK-NEXT:    [[TMP3:%.*]] = load i32, ptr [[ARG2_ADDR]], align 4, !dbg [[DBG41:![0-9]+]]
// CHECK-NEXT:    call void [[TMP0]](i32 noundef [[TMP2]], i32 noundef [[TMP3]]), !dbg [[DBG39]]
// CHECK-NEXT:    ret void, !dbg [[DBG42:![0-9]+]]
//
void bar(void (*fn)(int, int), int arg1, int arg2) {
    fn(arg1, arg2);
}

// CHECK-LABEL: define dso_local void @baz(
// CHECK-SAME: ptr noundef [[FN:%.*]], i32 noundef [[ARG1:%.*]], i32 noundef [[ARG2:%.*]], i32 noundef [[ARG3:%.*]]) #[[ATTR0]] !dbg [[DBG43:![0-9]+]] !type [[META49:![0-9]+]] !type [[META50:![0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[FN_ADDR:%.*]] = alloca ptr, align 8
// CHECK-NEXT:    [[ARG1_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[ARG2_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    [[ARG3_ADDR:%.*]] = alloca i32, align 4
// CHECK-NEXT:    store ptr [[FN]], ptr [[FN_ADDR]], align 8
// CHECK-NEXT:      #dbg_declare(ptr [[FN_ADDR]], [[META51:![0-9]+]], !DIExpression(), [[META52:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG1]], ptr [[ARG1_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG1_ADDR]], [[META53:![0-9]+]], !DIExpression(), [[META54:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG2]], ptr [[ARG2_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG2_ADDR]], [[META55:![0-9]+]], !DIExpression(), [[META56:![0-9]+]])
// CHECK-NEXT:    store i32 [[ARG3]], ptr [[ARG3_ADDR]], align 4
// CHECK-NEXT:      #dbg_declare(ptr [[ARG3_ADDR]], [[META57:![0-9]+]], !DIExpression(), [[META58:![0-9]+]])
// CHECK-NEXT:    [[TMP0:%.*]] = load ptr, ptr [[FN_ADDR]], align 8, !dbg [[DBG59:![0-9]+]]
// CHECK-NEXT:    [[TMP1:%.*]] = call i1 @llvm.type.test(ptr [[TMP0]], metadata !"_ZTSFvu3i32S_S_E.normalized"), !dbg [[DBG59]], !nosanitize [[META14]]
// CHECK-NEXT:    br i1 [[TMP1]], label %[[CONT:.*]], label %[[TRAP:.*]], !dbg [[DBG59]], !prof [[PROF22]], !nosanitize [[META14]]
// CHECK:       [[TRAP]]:
// CHECK-NEXT:    call void @llvm.ubsantrap(i8 2) #[[ATTR3]], !dbg [[DBG59]], !nosanitize [[META14]]
// CHECK-NEXT:    unreachable, !dbg [[DBG59]], !nosanitize [[META14]]
// CHECK:       [[CONT]]:
// CHECK-NEXT:    [[TMP2:%.*]] = load i32, ptr [[ARG1_ADDR]], align 4, !dbg [[DBG60:![0-9]+]]
// CHECK-NEXT:    [[TMP3:%.*]] = load i32, ptr [[ARG2_ADDR]], align 4, !dbg [[DBG61:![0-9]+]]
// CHECK-NEXT:    [[TMP4:%.*]] = load i32, ptr [[ARG3_ADDR]], align 4, !dbg [[DBG62:![0-9]+]]
// CHECK-NEXT:    call void [[TMP0]](i32 noundef [[TMP2]], i32 noundef [[TMP3]], i32 noundef [[TMP4]]), !dbg [[DBG59]]
// CHECK-NEXT:    ret void, !dbg [[DBG63:![0-9]+]]
//
void baz(void (*fn)(int, int, int), int arg1, int arg2, int arg3) {
    fn(arg1, arg2, arg3);
}

//.
// CHECK: [[META0:![0-9]+]] = distinct !DICompileUnit(language: DW_LANG_C11, file: [[META1:![0-9]+]], isOptimized: false, runtimeVersion: 0, emissionKind: FullDebug, splitDebugInlining: false, nameTableKind: None)
// CHECK: [[META1]] = !DIFile(filename: "{{.*}}<stdin>", directory: {{.*}})
// CHECK: [[DBG6]] = distinct !DISubprogram(name: "foo", scope: [[META7:![0-9]+]], file: [[META7]], line: 9, type: [[META8:![0-9]+]], scopeLine: 9, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META14]])
// CHECK: [[META7]] = !DIFile(filename: "{{.*}}cfi-icall-normalize2-debuginfo.c", directory: {{.*}})
// CHECK: [[META8]] = !DISubroutineType(types: [[META9:![0-9]+]])
// CHECK: [[META9]] = !{null, [[META10:![0-9]+]], [[META13:![0-9]+]]}
// CHECK: [[META10]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META11:![0-9]+]], size: 64)
// CHECK: [[META11]] = !DISubroutineType(types: [[META12:![0-9]+]])
// CHECK: [[META12]] = !{null, [[META13]]}
// CHECK: [[META13]] = !DIBasicType(name: "int", size: 32, encoding: DW_ATE_signed)
// CHECK: [[META14]] = !{}
// CHECK: [[META15]] = !{i64 0, !"_ZTSFvPFvu3i32ES_E.normalized"}
// CHECK: [[META16]] = !{i64 0, !"_ZTSFvPvu3i32E.normalized.generalized"}
// CHECK: [[META17]] = !DILocalVariable(name: "fn", arg: 1, scope: [[DBG6]], file: [[META7]], line: 9, type: [[META10]])
// CHECK: [[META18]] = !DILocation(line: 9, column: 17, scope: [[DBG6]])
// CHECK: [[META19]] = !DILocalVariable(name: "arg", arg: 2, scope: [[DBG6]], file: [[META7]], line: 9, type: [[META13]])
// CHECK: [[META20]] = !DILocation(line: 9, column: 31, scope: [[DBG6]])
// CHECK: [[DBG21]] = !DILocation(line: 13, column: 5, scope: [[DBG6]])
// CHECK: [[PROF22]] = !{!"branch_weights", i32 1048575, i32 1}
// CHECK: [[DBG23]] = !DILocation(line: 13, column: 8, scope: [[DBG6]])
// CHECK: [[DBG24]] = !DILocation(line: 14, column: 1, scope: [[DBG6]])
// CHECK: [[DBG25]] = distinct !DISubprogram(name: "bar", scope: [[META7]], file: [[META7]], line: 16, type: [[META26:![0-9]+]], scopeLine: 16, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META14]])
// CHECK: [[META26]] = !DISubroutineType(types: [[META27:![0-9]+]])
// CHECK: [[META27]] = !{null, [[META28:![0-9]+]], [[META13]], [[META13]]}
// CHECK: [[META28]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META29:![0-9]+]], size: 64)
// CHECK: [[META29]] = !DISubroutineType(types: [[META30:![0-9]+]])
// CHECK: [[META30]] = !{null, [[META13]], [[META13]]}
// CHECK: [[META31]] = !{i64 0, !"_ZTSFvPFvu3i32S_ES_S_E.normalized"}
// CHECK: [[META32]] = !{i64 0, !"_ZTSFvPvu3i32S0_E.normalized.generalized"}
// CHECK: [[META33]] = !DILocalVariable(name: "fn", arg: 1, scope: [[DBG25]], file: [[META7]], line: 16, type: [[META28]])
// CHECK: [[META34]] = !DILocation(line: 16, column: 17, scope: [[DBG25]])
// CHECK: [[META35]] = !DILocalVariable(name: "arg1", arg: 2, scope: [[DBG25]], file: [[META7]], line: 16, type: [[META13]])
// CHECK: [[META36]] = !DILocation(line: 16, column: 36, scope: [[DBG25]])
// CHECK: [[META37]] = !DILocalVariable(name: "arg2", arg: 3, scope: [[DBG25]], file: [[META7]], line: 16, type: [[META13]])
// CHECK: [[META38]] = !DILocation(line: 16, column: 46, scope: [[DBG25]])
// CHECK: [[DBG39]] = !DILocation(line: 20, column: 5, scope: [[DBG25]])
// CHECK: [[DBG40]] = !DILocation(line: 20, column: 8, scope: [[DBG25]])
// CHECK: [[DBG41]] = !DILocation(line: 20, column: 14, scope: [[DBG25]])
// CHECK: [[DBG42]] = !DILocation(line: 21, column: 1, scope: [[DBG25]])
// CHECK: [[DBG43]] = distinct !DISubprogram(name: "baz", scope: [[META7]], file: [[META7]], line: 23, type: [[META44:![0-9]+]], scopeLine: 23, flags: DIFlagPrototyped, spFlags: DISPFlagDefinition, unit: [[META0]], retainedNodes: [[META14]])
// CHECK: [[META44]] = !DISubroutineType(types: [[META45:![0-9]+]])
// CHECK: [[META45]] = !{null, [[META46:![0-9]+]], [[META13]], [[META13]], [[META13]]}
// CHECK: [[META46]] = !DIDerivedType(tag: DW_TAG_pointer_type, baseType: [[META47:![0-9]+]], size: 64)
// CHECK: [[META47]] = !DISubroutineType(types: [[META48:![0-9]+]])
// CHECK: [[META48]] = !{null, [[META13]], [[META13]], [[META13]]}
// CHECK: [[META49]] = !{i64 0, !"_ZTSFvPFvu3i32S_S_ES_S_S_E.normalized"}
// CHECK: [[META50]] = !{i64 0, !"_ZTSFvPvu3i32S0_S0_E.normalized.generalized"}
// CHECK: [[META51]] = !DILocalVariable(name: "fn", arg: 1, scope: [[DBG43]], file: [[META7]], line: 23, type: [[META46]])
// CHECK: [[META52]] = !DILocation(line: 23, column: 17, scope: [[DBG43]])
// CHECK: [[META53]] = !DILocalVariable(name: "arg1", arg: 2, scope: [[DBG43]], file: [[META7]], line: 23, type: [[META13]])
// CHECK: [[META54]] = !DILocation(line: 23, column: 41, scope: [[DBG43]])
// CHECK: [[META55]] = !DILocalVariable(name: "arg2", arg: 3, scope: [[DBG43]], file: [[META7]], line: 23, type: [[META13]])
// CHECK: [[META56]] = !DILocation(line: 23, column: 51, scope: [[DBG43]])
// CHECK: [[META57]] = !DILocalVariable(name: "arg3", arg: 4, scope: [[DBG43]], file: [[META7]], line: 23, type: [[META13]])
// CHECK: [[META58]] = !DILocation(line: 23, column: 61, scope: [[DBG43]])
// CHECK: [[DBG59]] = !DILocation(line: 27, column: 5, scope: [[DBG43]])
// CHECK: [[DBG60]] = !DILocation(line: 27, column: 8, scope: [[DBG43]])
// CHECK: [[DBG61]] = !DILocation(line: 27, column: 14, scope: [[DBG43]])
// CHECK: [[DBG62]] = !DILocation(line: 27, column: 20, scope: [[DBG43]])
// CHECK: [[DBG63]] = !DILocation(line: 28, column: 1, scope: [[DBG43]])
//.
