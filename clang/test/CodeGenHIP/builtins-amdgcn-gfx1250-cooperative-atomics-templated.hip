// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --version 5

// REQUIRES: amdgpu-registered-target
// RUN: %clang_cc1 -O3 -triple amdgcn-unknown-unknown -target-cpu gfx1250 -fcuda-is-device -emit-llvm -o - %s | FileCheck %s
// RUN: %clang_cc1 -O3 -triple amdgcn-unknown-unknown -target-cpu gfx1251 -fcuda-is-device -emit-llvm -o - %s | FileCheck %s

#define __device__ __attribute__((device))

typedef int    v2i   __attribute__((ext_vector_type(2)));
typedef int    v4i   __attribute__((ext_vector_type(4)));

template<unsigned AO>
__device__ void template_cooperative_atomic_store_32x4B(int* gaddr, int val) {
  __builtin_amdgcn_cooperative_atomic_store_32x4B(gaddr, val, AO, "agent");
}

// CHECK-LABEL: define dso_local void @_Z42test_amdgcn_cooperative_atomic_store_32x4BPii(
// CHECK-SAME: ptr noundef writeonly captures(none) [[GADDR:%.*]], i32 noundef [[VAL:%.*]]) local_unnamed_addr #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    tail call void @llvm.amdgcn.cooperative.atomic.store.32x4B.p0(ptr [[GADDR]], i32 [[VAL]], i32 5, metadata [[META8:![0-9]+]])
// CHECK-NEXT:    ret void
//
__device__ void test_amdgcn_cooperative_atomic_store_32x4B(int* gaddr, int val)
{
  template_cooperative_atomic_store_32x4B<__ATOMIC_SEQ_CST>(gaddr, val);
}

template<unsigned AO>
__device__ int template_cooperative_atomic_load_32x4B(int* gaddr) {
  return __builtin_amdgcn_cooperative_atomic_load_32x4B(gaddr, AO, "");
}

// CHECK-LABEL: define dso_local void @_Z41test_amdgcn_cooperative_atomic_load_32x4BPiS_(
// CHECK-SAME: ptr noundef readonly captures(none) [[ADDR:%.*]], ptr noundef writeonly captures(none) initializes((0, 4)) [[OUT:%.*]]) local_unnamed_addr #[[ATTR1:[0-9]+]] {
// CHECK-NEXT:  [[ENTRY:.*:]]
// CHECK-NEXT:    [[TMP0:%.*]] = tail call noundef i32 @llvm.amdgcn.cooperative.atomic.load.32x4B.p0(ptr [[ADDR]], i32 5, metadata [[META9:![0-9]+]])
// CHECK-NEXT:    store i32 [[TMP0]], ptr [[OUT]], align 4, !tbaa [[TBAA4:![0-9]+]]
// CHECK-NEXT:    ret void
//
__device__ void test_amdgcn_cooperative_atomic_load_32x4B(int* addr, int *out)
{
  *out = template_cooperative_atomic_load_32x4B<__ATOMIC_SEQ_CST>(addr);
}
//.
// CHECK: [[TBAA4]] = !{[[META5:![0-9]+]], [[META5]], i64 0}
// CHECK: [[META5]] = !{!"int", [[META6:![0-9]+]], i64 0}
// CHECK: [[META6]] = !{!"omnipotent char", [[META7:![0-9]+]], i64 0}
// CHECK: [[META7]] = !{!"Simple C++ TBAA"}
// CHECK: [[META8]] = !{!"agent"}
// CHECK: [[META9]] = !{!""}
//.
