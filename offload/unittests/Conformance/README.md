# GPU Math Conformance Tests

## Overview

This test suite provides a framework to systematically measure the accuracy of math functions on GPUs and verify their conformance with standards like OpenCL.

While the primary focus is validating the implementations in the C standard math library (LLVM-libm), these tests can also be executed against other math library providers, such as CUDA Math and HIP Math, for comparison.

The goals of this project are to empower LLVM-libm contributors with a robust tool for validating their implementations and to build trust with end-users by providing transparent accuracy data.

### Table of Contents

- [Getting Started](#getting-started)
- [Running the Tests](#running-the-tests)
- [Test Results](#test-results)
- [Adding New Tests](#adding-new-tests)
- [Architecture Overview](#architecture-overview)

## Getting Started

This guide covers how to build the necessary dependencies, which include the new Offload API and the C standard library for both host and GPU targets.

### System Requirements

Before you begin, ensure your system meets the following requirements:

* A system with an AMD or NVIDIA GPU.
* The latest proprietary GPU drivers installed.
* The corresponding development SDK for your hardware:
    * **AMD:** [ROCm SDK](https://rocm.docs.amd.com)
    * **NVIDIA:** [CUDA Toolkit](https://developer.nvidia.com/cuda-toolkit)

### Building the Dependencies

The official documentation for building LLVM-libc for GPUs provides a detailed guide and should be considered the primary reference. Please follow the instructions in the **"Standard runtimes build"** section of that guide:

- [Building the GPU C library (Official Documentation)](https://libc.llvm.org/gpu/building.html)

> [!IMPORTANT]
> For the conformance tests, the standard `cmake` command from the official documentation must be adapted slightly. You must also add `libc` to the main `-DLLVM_ENABLE_RUNTIMES` list. This is a crucial step because the tests need a host-side build of `libc` to use as the reference oracle for validating GPU results.

## Running the Tests

### Default Test

To build and run the conformance test for a given function (e.g., `logf`) against the default C standard math library `llvm-libm` provider, use the following command. This will execute the test on all available and supported platforms.

```bash
ninja -C build/runtimes/runtimes-bins offload.conformance.logf
```

### Testing Other Providers

Once the test binary has been built, you can run it against other math library providers using the `--test-configs` flag.

* **For `cuda-math` on an NVIDIA GPU:**

  ```bash
  ./build/runtimes/runtimes-bins/offload/logf.conformance --test-configs=cuda-math:cuda
  ```

* **For `hip-math` on an AMD GPU:**

  ```bash
  ./build/runtimes/runtimes-bins/offload/logf.conformance --test-configs=hip-math:amdgpu
  ```

You can also run all available configurations for a test with:

```bash
./build/runtimes/runtimes-bins/offload/logf.conformance --test-configs=all
```

## Test Results

The results from the GPU are validated against reference values computed on the host CPU. These references are generated by the host's LLVM-libm, and the comparison is done by measuring the ULP (Units in the Last Place) distance. The pass/fail tolerances are typically based on the OpenCL C specification.

All tests assume the host machine operates in the default floating-point environment with the round-to-nearest-even rounding mode.

The results are generated using two distinct methodologies, chosen based on the size of the function's input space:

* **Exhaustive Testing**: This method iterates over every representable point in the input space. It is used for half-precision functions and single-precision univariate functions, ensuring complete coverage of the input space.

* **Randomized Testing**: This method is used for functions with larger input spaces, such as single-precision bivariate and double-precision functions, where exhaustive testing is computationally infeasible. Although not exhaustive, the tests are deterministic, using a fixed seed to sample a large, reproducible subset of points from the input space. The specific seed and sample size are configured in each test's source file, typically using 2<sup>32</sup> samples.

---

The following tables show the maximum observed ULP distance for each function compared against its host-side reference.

### Exhaustive Test Results for Half-Precision Math Functions

<table>
  <thead>
    <tr>
      <th rowspan="2" align="left">Function</th>
      <th rowspan="2" align="center">ULP Tolerance</th>
      <th colspan="4" align="center">Max ULP Distance</th>
    </tr>
    <tr>
      <th align="center">llvm-libm<br>(AMDGPU)</th>
      <th align="center">llvm-libm<br>(CUDA)</th>
      <th align="center">cuda-math<br>(CUDA)</th>
      <th align="center">hip-math<br>(AMDGPU)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="left">acosf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">acoshf16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center">0</td>
    </tr>
    <tr>
      <td align="left">acospif16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
    <tr>
      <td align="left">asinf16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">asinhf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">atanf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">atanhf16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cosf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">coshf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cospif16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
    <tr>
      <td align="left">expf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp10f16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp2f16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">0</td>
    </tr>
    <tr>
      <td align="left">expm1f16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">hypotf16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
    <tr>
      <td align="left">logf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log10f16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log2f16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">0</td>
    </tr>
    <tr>
      <td align="left">sinf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sinhf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sinpif16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
    <tr>
      <td align="left">tanf16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">tanhf16</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">tanpif16</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
  </tbody>
</table>

### Exhaustive Test Results for Single-Precision Univariate Math Functions

<table>
  <thead>
    <tr>
      <th rowspan="2" align="left">Function</th>
      <th rowspan="2" align="center">ULP Tolerance</th>
      <th colspan="4" align="center">Max ULP Distance</th>
    </tr>
    <tr>
      <th align="center">llvm-libm<br>(AMDGPU)</th>
      <th align="center">llvm-libm<br>(CUDA)</th>
      <th align="center">cuda-math<br>(CUDA)</th>
      <th align="center">hip-math<br>(AMDGPU)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="left">acosf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">acoshf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">asinf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">3</td>
    </tr>
    <tr>
      <td align="left">asinhf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">atanf</td>
      <td align="center">5</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">atanhf</td>
      <td align="center">5</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">3</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cbrtf</td>
      <td align="center">2</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cosf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">coshf</td>
      <td align="center">4</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cospif</td>
      <td align="center">4</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">erff</td>
      <td align="center">16</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">expf</td>
      <td align="center">3</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp10f</td>
      <td align="center">3</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp2f</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">expm1f</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">logf</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">log10f</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">log1pf</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log2f</td>
      <td align="center">3</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sinf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">sincosf (sin part)</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">sincosf (cos part)</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">sinhf</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">3</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sinpif</td>
      <td align="center">4</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">tanf</td>
      <td align="center">5</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">3</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">tanhf</td>
      <td align="center">5</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">tanpif</td>
      <td align="center">6</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center"></td>
      <td align="center"></td>
    </tr>
  </tbody>
</table>

### Randomized Test Results for Single-Precision Bivariate Math Functions

<table>
  <thead>
    <tr>
      <th rowspan="2" align="left">Function</th>
      <th rowspan="2" align="center">ULP Tolerance</th>
      <th colspan="4" align="center">Max ULP Distance</th>
    </tr>
    <tr>
      <th align="center">llvm-libm<br>(AMDGPU)</th>
      <th align="center">llvm-libm<br>(CUDA)</th>
      <th align="center">cuda-math<br>(CUDA)</th>
      <th align="center">hip-math<br>(AMDGPU)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="left">atan2f</td>
      <td align="center">6</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">3</td>
    </tr>
    <tr>
      <td align="left">hypotf</td>
      <td align="center">4</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">powf<br>(integer exponents)</td>
      <td align="center">16</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">powf<br>(real exponents)</td>
      <td align="center">16</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
  </tbody>
</table>

### Randomized Test Results for Double-Precision Math Functions

<table>
  <thead>
    <tr>
      <th rowspan="2" align="left">Function</th>
      <th rowspan="2" align="center">ULP Tolerance</th>
      <th colspan="4" align="center">Max ULP Distance</th>
    </tr>
    <tr>
      <th align="center">llvm-libm<br>(AMDGPU)</th>
      <th align="center">llvm-libm<br>(CUDA)</th>
      <th align="center">cuda-math<br>(CUDA)</th>
      <th align="center">hip-math<br>(AMDGPU)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td align="left">acos</td>
      <td align="center">4</td>
      <td align="center">6 (FAILED)</td>
      <td align="center">6 (FAILED)</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">asin</td>
      <td align="center">4</td>
      <td align="center">6 (FAILED)</td>
      <td align="center">6 (FAILED)</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cbrt</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">cos</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp10</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">exp2</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">expm1</td>
      <td align="center">3</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">1</td>
      <td align="center">2</td>
    </tr>
    <tr>
      <td align="left">hypot</td>
      <td align="center">4</td>
      <td align="center">0</td>
      <td align="center">0</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log10</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log1p</td>
      <td align="center">2</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">log2</td>
      <td align="center">3</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sin</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sincos (cos part)</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">sincos (sin part)</td>
      <td align="center">4</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
      <td align="center">1</td>
    </tr>
    <tr>
      <td align="left">tan</td>
      <td align="center">5</td>
      <td align="center">2</td>
      <td align="center">2</td>
      <td align="center">2</td>
      <td align="center">1</td>
    </tr>
  </tbody>
</table>

**Notes on Results:**

  * ULP tolerances are based on *The Khronos Group, The OpenCL C Specification v3.0.19, Sec. 7.4, Khronos Registry [July 10, 2025]*.
  * The AMD GPU used for testing is *gfx1030*.
  * The NVIDIA GPU used for testing is *NVIDIA RTX 4000 SFF Ada Generation*.

## Adding New Tests

To add a conformance test for a new math function, follow these steps:

1. **Implement the Device Kernels**: Create a kernel wrapper for the new function in each provider's source file. For CUDA Math and HIP Math, you must also add a forward declaration for the vendor function in `/device_code/DeviceAPIs.hpp`.

2. **Implement the Host Test**: Create a new `.cpp` file in `/tests`. This file defines the `FunctionConfig` (function and kernel names, as well as ULP tolerance) and the input generation strategy.

    * Use **exhaustive testing** (`ExhaustiveGenerator`) for functions with small input spaces (e.g., half-precision functions and single-precision univariate functions).
    * Use **randomized testing** (`RandomGenerator`) for functions with large input spaces (e.g., single-precision bivariate and double-precision functions).

3. **Add the Build Target**: Add a new `add_conformance_test(...)` entry to `/tests/CMakeLists.txt` to make the test buildable.

## Architecture Overview

The test suite is organized into the following main directories:

  * **/tests**: Contains the individual test executables, one for each function. These are the main entry points for a test run.
  * **/device_code**: Contains the GPU kernel wrappers that call the math functions from different providers (LLVM-libm, CUDA, HIP).
  * **/include/mathtest**: The core testing framework headers, defining the test harness, input generators, device abstraction, and result checking logic.
  * **/lib**: The implementation files for the core testing framework.
