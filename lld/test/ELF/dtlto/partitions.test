# REQUIRES: x86

## Test that DTLTO works with more than one LTO partition.

RUN: rm -rf %t && split-file %s %t && cd %t

## Compile bitcode.
RUN: llvm-as -o full.bc full.ll
RUN: opt -thinlto-bc thin1.ll -o thin1.bc
RUN: opt -thinlto-bc thin2.ll -o thin2.bc

## Generate object files for mock.py to return.
RUN: llc thin1.ll --filetype=obj -o thin1.o
RUN: llc thin2.ll --filetype=obj -o thin2.o

## Link with 3 LTO partitions.
RUN: ld.lld full.bc thin1.bc thin2.bc \
RUN:   --thinlto-distributor=%python \
RUN:   --thinlto-distributor-arg=%llvm_src_root/utils/dtlto/mock.py \
RUN:   --thinlto-distributor-arg=thin1.o \
RUN:   --thinlto-distributor-arg=thin2.o \
RUN:   --save-temps \
RUN:   --lto-partitions=3

## DTLTO temporary object files include the task number and a PID component. The
## task number should incorporate the LTO partition number.
RUN: ls | sort | FileCheck %s
CHECK: {{^}}thin1.3.[[PID:[a-zA-Z0-9_]+]].native.o{{$}}
CHECK: {{^}}thin2.4.[[PID]].native.o{{$}}

#--- full.ll
target datalayout = "e-m:e-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

define void @foo() {
  call void @bar()
  ret void
}

define void @bar() {
  call void @foo()
  ret void
}

#--- thin1.ll
target datalayout = "e-m:e-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

define void @baz() {
  ret void
}

#--- thin2.ll
target datalayout = "e-m:e-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-unknown-linux-gnu"

define void @_start() {
  ret void
}
