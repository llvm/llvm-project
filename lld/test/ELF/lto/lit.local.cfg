import os
import platform
import sysconfig

pypass_plugin = f"pypass-plugin{config.llvm_shlib_ext}"
pypass_plugin_shlib = os.path.join(config.llvm_shlib_dir, pypass_plugin)

# Run end-to-end tests if the reference pass-plugin exists in LLVM
if os.path.exists(pypass_plugin_shlib):
    config.available_features.add("pypass-plugin")

# Disable ASAN's leak detection for Python tests
config.environment["ASAN_OPTIONS"] = "detect_leaks=0"

if platform.system() != "Windows":
    libdir = sysconfig.get_config_var("LIBDIR")
    dylib = sysconfig.get_config_var("LDLIBRARY")
    config.substitutions.append(("%libpython", os.path.join(libdir, dylib)))

# FIXME: %llvmshlibdir is broken in standalone builds
config.substitutions.append(("%plugindir", config.llvm_libs_dir))
config.substitutions.append(("%pluginext", config.llvm_shlib_ext))
config.suffixes.add(".py")
