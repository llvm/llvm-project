#!/bin/bash
# postrm script for tpm2-accel-early-dkms
# Copyright (C) 2025 Military TPM2 Acceleration Project
# Classification: UNCLASSIFIED // FOR OFFICIAL USE ONLY

set -e

PACKAGE_NAME="tpm2-accel-early"
PACKAGE_VERSION="1.0.0"
MODULE_NAME="tpm2_accel_early"

case "$1" in
    remove)
        echo "Finalizing removal of tpm2-accel-early-dkms..."

        # Update initramfs to remove module from early boot
        echo "Updating initramfs to remove early boot module..."
        if command -v update-initramfs >/dev/null 2>&1; then
            update-initramfs -u -k all 2>/dev/null || {
                echo "WARNING: Failed to update initramfs" >&2
            }
        fi

        # Reload systemd daemon
        if [ -d /run/systemd/system ]; then
            systemctl daemon-reload 2>/dev/null || true
        fi

        echo "Module removed successfully"
        ;;

    purge)
        echo "Purging tpm2-accel-early-dkms configuration..."

        # Remove configuration files
        rm -f /etc/modprobe.d/tpm2-acceleration.conf
        rm -f /etc/modules-load.d/tpm2-acceleration.conf

        # Remove systemd service file
        rm -f /lib/systemd/system/tpm2-acceleration-early.service

        # Remove DKMS tree completely
        rm -rf "/usr/src/${PACKAGE_NAME}-${PACKAGE_VERSION}"
        rm -rf "/var/lib/dkms/${PACKAGE_NAME}"

        # Update initramfs after purge
        if command -v update-initramfs >/dev/null 2>&1; then
            update-initramfs -u -k all 2>/dev/null || true
        fi

        # Reload systemd daemon
        if [ -d /run/systemd/system ]; then
            systemctl daemon-reload 2>/dev/null || true
        fi

        echo ""
        echo "========================================="
        echo "TPM2 Acceleration Completely Removed"
        echo "========================================="
        echo "All configuration files have been purged."
        echo "A reboot is recommended to ensure complete"
        echo "removal of the module from the kernel."
        echo "========================================="
        echo ""
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Nothing to do in these cases
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
