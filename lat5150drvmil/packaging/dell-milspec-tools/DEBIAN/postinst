#!/bin/bash
set -e

# DEBIAN postinst script for dell-milspec-tools
# This script runs after package installation

PACKAGE_NAME="dell-milspec-tools"
CONFIG_DIR="/etc/dell-milspec"
LOG_DIR="/var/log/dell-milspec"
RUN_DIR="/var/run/dell-milspec"

case "$1" in
    configure)
        echo "Configuring $PACKAGE_NAME..."

        # Create system directories
        echo "  Creating system directories..."
        mkdir -p "$CONFIG_DIR"
        mkdir -p "$LOG_DIR"
        mkdir -p "$RUN_DIR"

        # Set proper permissions
        chmod 755 "$CONFIG_DIR"
        chmod 755 "$LOG_DIR"
        chmod 755 "$RUN_DIR"

        # Install default configuration files if not present
        if [ ! -f "$CONFIG_DIR/dsmil.conf" ]; then
            echo "  Installing default dsmil.conf..."
            cp /usr/share/dell-milspec/config/dsmil.conf.default "$CONFIG_DIR/dsmil.conf"
            chmod 644 "$CONFIG_DIR/dsmil.conf"
        fi

        if [ ! -f "$CONFIG_DIR/monitoring.json" ]; then
            echo "  Installing default monitoring.json..."
            cp /usr/share/dell-milspec/config/monitoring.json.default "$CONFIG_DIR/monitoring.json"
            chmod 644 "$CONFIG_DIR/monitoring.json"
        fi

        if [ ! -f "$CONFIG_DIR/safety.json" ]; then
            echo "  Installing default safety.json..."
            cp /usr/share/dell-milspec/config/safety.json.default "$CONFIG_DIR/safety.json"
            chmod 644 "$CONFIG_DIR/safety.json"
        fi

        # Create dsmil user group for device access
        if ! getent group dsmil >/dev/null 2>&1; then
            echo "  Creating dsmil group..."
            groupadd -r dsmil
            echo "  Group 'dsmil' created successfully"
        fi

        # Add current user to dsmil group (if running interactively)
        if [ -n "$SUDO_USER" ] && [ "$SUDO_USER" != "root" ]; then
            if ! id -nG "$SUDO_USER" | grep -qw dsmil; then
                echo "  Adding user '$SUDO_USER' to dsmil group..."
                usermod -a -G dsmil "$SUDO_USER"
                echo "  User added to group (logout/login required for changes to take effect)"
            fi
        fi

        # Set up device access rules (if devices exist)
        if [ -e /dev/dsmil0 ]; then
            echo "  Configuring DSMIL device permissions..."
            chgrp dsmil /dev/dsmil0 2>/dev/null || true
            chmod 660 /dev/dsmil0 2>/dev/null || true
        fi

        if [ -e /dev/tpm2_accel_early ]; then
            echo "  Configuring TPM2 acceleration device permissions..."
            chgrp dsmil /dev/tpm2_accel_early 2>/dev/null || true
            chmod 660 /dev/tpm2_accel_early 2>/dev/null || true
        fi

        # Create symbolic links for convenience
        if [ ! -e /usr/local/bin/milspec ]; then
            ln -s /usr/bin/milspec-control /usr/local/bin/milspec 2>/dev/null || true
        fi

        echo ""
        echo "======================================================================"
        echo " Dell MIL-SPEC Tools Installation Complete"
        echo "======================================================================"
        echo ""
        echo "Configuration directory: $CONFIG_DIR"
        echo "Log directory: $LOG_DIR"
        echo ""
        echo "Available commands:"
        echo "  dsmil-status          - Query DSMIL device status"
        echo "  dsmil-test            - Test DSMIL functionality (safe)"
        echo "  tpm2-accel-status     - Query TPM2 acceleration status"
        echo "  milspec-control       - Main control utility"
        echo "  milspec-monitor       - Start monitoring dashboard"
        echo "  milspec-emergency-stop - Emergency shutdown procedures"
        echo ""
        echo "Quick start:"
        echo "  1. Check device status:  dsmil-status"
        echo "  2. Start monitoring:     milspec-monitor"
        echo "  3. Test functionality:   dsmil-test --dry-run"
        echo ""
        echo "Documentation: /usr/share/doc/dell-milspec-tools/"
        echo "Examples: /usr/share/dell-milspec/examples/"
        echo ""
        if [ -n "$SUDO_USER" ] && [ "$SUDO_USER" != "root" ]; then
            echo "IMPORTANT: User '$SUDO_USER' has been added to 'dsmil' group."
            echo "           Please logout and login for changes to take effect."
            echo ""
        fi
        echo "For emergency stop: milspec-emergency-stop or Ctrl+C during operation"
        echo "======================================================================"
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
