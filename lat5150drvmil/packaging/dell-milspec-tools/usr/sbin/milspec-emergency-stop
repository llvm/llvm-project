#!/bin/bash
#
# milspec-emergency-stop - Emergency stop procedures for Dell MIL-SPEC platform
# Part of dell-milspec-tools package
#
# This script executes <85ms emergency shutdown procedures
#

set -e

LOG_DIR="/var/log/dell-milspec"
EMERGENCY_LOG="$LOG_DIR/emergency_$(date +%Y%m%d_%H%M%S).log"

# Create log directory if it doesn't exist
mkdir -p "$LOG_DIR"

# Start logging
exec > >(tee -a "$EMERGENCY_LOG")
exec 2>&1

echo "========================================================================="
echo " DELL MIL-SPEC EMERGENCY STOP"
echo "========================================================================="
echo "Timestamp: $(date -Iseconds)"
echo "Initiated by: $USER (PID: $$)"
echo ""

# Record start time for performance measurement
START_TIME=$(date +%s%3N)

# Step 1: Stop all monitoring processes (TARGET: <5ms)
echo "[STEP 1] Stopping monitoring processes..."
STEP1_START=$(date +%s%3N)

pkill -9 -f milspec-monitor 2>/dev/null || true
pkill -9 -f dsmil_comprehensive_monitor 2>/dev/null || true
pkill -9 -f safe_token_tester 2>/dev/null || true
pkill -9 -f dsmil-test 2>/dev/null || true

STEP1_END=$(date +%s%3N)
STEP1_DURATION=$((STEP1_END - STEP1_START))
echo "  Duration: ${STEP1_DURATION}ms"

# Step 2: Stop any active DSMIL operations (TARGET: <10ms)
echo "[STEP 2] Stopping DSMIL operations..."
STEP2_START=$(date +%s%3N)

# Kill any processes accessing DSMIL device
if [ -e /dev/dsmil0 ]; then
    fuser -k /dev/dsmil0 2>/dev/null || true
fi

STEP2_END=$(date +%s%3N)
STEP2_DURATION=$((STEP2_END - STEP2_START))
echo "  Duration: ${STEP2_DURATION}ms"

# Step 3: Unload kernel modules (TARGET: <30ms)
echo "[STEP 3] Unloading kernel modules..."
STEP3_START=$(date +%s%3N)

# Unload TPM2 acceleration first (lower priority)
if lsmod | grep -q "^tpm2_accel_early"; then
    rmmod tpm2_accel_early 2>/dev/null || echo "  Warning: Could not unload tpm2_accel_early"
fi

# Unload DSMIL module
if lsmod | grep -q "^dsmil_72dev"; then
    rmmod dsmil_72dev 2>/dev/null || echo "  Warning: Could not unload dsmil_72dev"
fi

STEP3_END=$(date +%s%3N)
STEP3_DURATION=$((STEP3_END - STEP3_START))
echo "  Duration: ${STEP3_DURATION}ms"

# Step 4: System health check (TARGET: <5ms)
echo "[STEP 4] System health check..."
STEP4_START=$(date +%s%3N)

# Check temperature
TEMP=$(cat /sys/class/thermal/thermal_zone*/temp 2>/dev/null | head -1 | awk '{printf "%d", $1/1000}' || echo "0")
echo "  Temperature: ${TEMP}°C"

if [ "$TEMP" -gt 85 ]; then
    echo "  WARNING: High temperature detected!"
    echo "  Recommendation: Allow system to cool before restart"
fi

# Check memory
MEM_USAGE=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
echo "  Memory usage: ${MEM_USAGE}%"

# Check load
LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | cut -d',' -f1 | xargs)
echo "  Load average: ${LOAD_AVG}"

STEP4_END=$(date +%s%3N)
STEP4_DURATION=$((STEP4_END - STEP4_START))
echo "  Duration: ${STEP4_DURATION}ms"

# Step 5: Cleanup and logging (TARGET: <5ms)
echo "[STEP 5] Cleanup and final logging..."
STEP5_START=$(date +%s%3N)

# Remove PID files
rm -f /var/run/dell-milspec/*.pid 2>/dev/null || true

# Save kernel messages
dmesg | tail -20 > "$LOG_DIR/dmesg_emergency_$(date +%Y%m%d_%H%M%S).log" 2>/dev/null || true

STEP5_END=$(date +%s%3N)
STEP5_DURATION=$((STEP5_END - STEP5_START))
echo "  Duration: ${STEP5_DURATION}ms"

# Calculate total duration
END_TIME=$(date +%s%3N)
TOTAL_DURATION=$((END_TIME - START_TIME))

# Final status
echo ""
echo "========================================================================="
echo " EMERGENCY STOP COMPLETE"
echo "========================================================================="
echo ""
echo "Performance Summary:"
echo "  Step 1 (Stop processes):    ${STEP1_DURATION}ms"
echo "  Step 2 (Stop operations):   ${STEP2_DURATION}ms"
echo "  Step 3 (Unload modules):    ${STEP3_DURATION}ms"
echo "  Step 4 (Health check):      ${STEP4_DURATION}ms"
echo "  Step 5 (Cleanup):           ${STEP5_DURATION}ms"
echo "  -------------------------------------------"
echo "  TOTAL DURATION:             ${TOTAL_DURATION}ms"
echo ""

# Performance assessment
if [ "$TOTAL_DURATION" -lt 85 ]; then
    echo "  Status: SUCCESS (target <85ms achieved)"
elif [ "$TOTAL_DURATION" -lt 100 ]; then
    echo "  Status: ACCEPTABLE (within 100ms)"
else
    echo "  Status: SLOW (exceeded 100ms threshold)"
fi

echo ""
echo "System Status:"
echo "  All monitoring stopped:     YES"
echo "  DSMIL operations halted:    YES"
echo "  Kernel modules unloaded:    $([ ! -e /dev/dsmil0 ] && echo 'YES' || echo 'PARTIAL')"
echo "  Emergency log saved:        $EMERGENCY_LOG"
echo ""

# Recommendations
echo "Recommendations:"
if [ "$TEMP" -gt 85 ]; then
    echo "  - Allow system to cool to <80°C before restart"
fi
echo "  - Review emergency log for details"
echo "  - Check system status: dsmil-status"
echo "  - To restart: milspec-control load"
echo ""
echo "========================================================================="

# Exit with success
exit 0
