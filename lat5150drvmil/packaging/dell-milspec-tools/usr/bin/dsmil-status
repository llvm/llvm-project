#!/bin/bash
#
# dsmil-status - Query DSMIL device status
# Part of dell-milspec-tools package
#

set -e

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Device paths
DSMIL_DEVICE="/dev/dsmil0"
DSMIL_MODULE="dsmil_72dev"
SYSFS_PATH="/sys/class/misc/dsmil0"

echo "======================================================================"
echo " DSMIL Device Status"
echo "======================================================================"
echo ""

# Check if module is loaded
echo -n "Kernel Module: "
if lsmod | grep -q "^${DSMIL_MODULE}"; then
    echo -e "${GREEN}Loaded${NC}"
    MODULE_VERSION=$(modinfo "$DSMIL_MODULE" 2>/dev/null | grep "^version:" | awk '{print $2}')
    if [ -n "$MODULE_VERSION" ]; then
        echo "  Version: $MODULE_VERSION"
    fi
else
    echo -e "${RED}Not Loaded${NC}"
    echo ""
    echo "The DSMIL kernel module is not loaded."
    echo "To load the module:"
    echo "  sudo modprobe $DSMIL_MODULE"
    echo ""
    echo "Or install the DKMS package:"
    echo "  sudo apt-get install dell-milspec-dsmil-dkms"
    exit 1
fi

# Check device node
echo -n "Device Node: "
if [ -e "$DSMIL_DEVICE" ]; then
    echo -e "${GREEN}${DSMIL_DEVICE}${NC}"

    # Show device permissions
    DEVICE_PERMS=$(stat -c "%a %U:%G" "$DSMIL_DEVICE" 2>/dev/null || echo "unknown")
    echo "  Permissions: $DEVICE_PERMS"

    # Check if current user has access
    if [ -r "$DSMIL_DEVICE" ] && [ -w "$DSMIL_DEVICE" ]; then
        echo -e "  Access: ${GREEN}Read/Write${NC}"
    elif [ -r "$DSMIL_DEVICE" ]; then
        echo -e "  Access: ${YELLOW}Read Only${NC}"
    else
        echo -e "  Access: ${RED}No Access${NC}"
        echo "  Hint: Add your user to 'dsmil' group:"
        echo "        sudo usermod -a -G dsmil \$USER"
        echo "        (logout/login required)"
    fi
else
    echo -e "${RED}Not Found${NC}"
    echo "  Expected: $DSMIL_DEVICE"
    echo "  The device node does not exist. Module may not have created it."
fi

# Check sysfs interface
echo -n "Sysfs Interface: "
if [ -d "$SYSFS_PATH" ]; then
    echo -e "${GREEN}Available${NC}"
    echo "  Path: $SYSFS_PATH"

    # Show available sysfs attributes
    if [ -d "$SYSFS_PATH" ]; then
        ATTRS=$(find "$SYSFS_PATH" -type f 2>/dev/null | wc -l)
        echo "  Attributes: $ATTRS files"
    fi
else
    echo -e "${YELLOW}Not Available${NC}"
fi

# Check DSMIL token ranges
echo ""
echo "DSMIL Token Ranges:"
echo "  Range_0400: 0x0400 - 0x0447 (72 tokens)"
echo "  Range_0480: 0x0480 - 0x04C7 (72 tokens) [PRIMARY]"
echo "  Range_0500: 0x0500 - 0x0547 (72 tokens)"
echo "  Range_1000: 0x1000 - 0x1047 (72 tokens)"
echo "  Range_1100: 0x1100 - 0x1147 (72 tokens)"
echo "  Range_1200: 0x1200 - 0x1247 (72 tokens)"
echo "  Range_1300: 0x1300 - 0x1347 (72 tokens)"
echo "  Range_1400: 0x1400 - 0x1447 (72 tokens)"
echo "  Range_1500: 0x1500 - 0x1547 (72 tokens)"
echo "  Range_1600: 0x1600 - 0x1647 (72 tokens)"
echo "  Range_1700: 0x1700 - 0x1747 (72 tokens)"
echo "  Total: 792 tokens across 11 ranges"

# System information
echo ""
echo "System Information:"
TEMP=$(cat /sys/class/thermal/thermal_zone*/temp 2>/dev/null | head -1 | awk '{printf "%.1f", $1/1000}' || echo "N/A")
echo "  Temperature: ${TEMP}Â°C"

MEM_USAGE=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
echo "  Memory Usage: ${MEM_USAGE}%"

LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | xargs)
echo "  Load Average: ${LOAD_AVG}"

# Quick tests (if device is accessible)
if [ -r "$DSMIL_DEVICE" ] && [ -w "$DSMIL_DEVICE" ]; then
    echo ""
    echo "Quick Device Tests:"

    # Try simple device read
    echo -n "  Device Read Test: "
    if timeout 2 dd if="$DSMIL_DEVICE" of=/dev/null bs=1 count=1 2>/dev/null; then
        echo -e "${GREEN}PASS${NC}"
    else
        echo -e "${YELLOW}SKIPPED${NC} (timeout or error)"
    fi
fi

echo ""
echo "Available Commands:"
echo "  dsmil-test            - Run comprehensive functionality tests"
echo "  milspec-monitor       - Start monitoring dashboard"
echo "  milspec-control       - Main control utility"
echo ""
echo "======================================================================"
