#!/usr/bin/env python3
"""
dsmil-test - DSMIL Device Functionality Testing
Part of dell-milspec-tools package
"""

import os
import sys
import argparse
import subprocess
from pathlib import Path

# Import the safe token tester
sys.path.insert(0, '/usr/share/dell-milspec/monitoring')

try:
    from safe_token_tester import SafeTokenTester
except ImportError:
    print("ERROR: Cannot import safe_token_tester module")
    print("Please ensure dell-milspec-tools is properly installed")
    sys.exit(1)


def check_prerequisites():
    """Check if prerequisites are met"""
    issues = []

    # Check if module is loaded
    try:
        result = subprocess.run(['lsmod'], capture_output=True, text=True)
        if 'dsmil_72dev' not in result.stdout:
            issues.append("DSMIL kernel module not loaded (run: sudo modprobe dsmil_72dev)")
    except Exception as e:
        issues.append(f"Cannot check kernel module: {e}")

    # Check if device exists
    if not os.path.exists('/dev/dsmil0'):
        issues.append("DSMIL device /dev/dsmil0 not found")

    # Check if device is accessible
    elif not (os.access('/dev/dsmil0', os.R_OK) and os.access('/dev/dsmil0', os.W_OK)):
        issues.append("No read/write access to /dev/dsmil0 (add user to 'dsmil' group)")

    return issues


def run_basic_tests():
    """Run basic device functionality tests"""
    print("=" * 70)
    print(" DSMIL Basic Functionality Tests")
    print("=" * 70)
    print()

    tests_passed = 0
    tests_failed = 0

    # Test 1: Module loaded
    print("Test 1: Kernel module loaded... ", end="")
    try:
        result = subprocess.run(['lsmod'], capture_output=True, text=True)
        if 'dsmil_72dev' in result.stdout:
            print("PASS")
            tests_passed += 1
        else:
            print("FAIL")
            tests_failed += 1
    except Exception as e:
        print(f"ERROR: {e}")
        tests_failed += 1

    # Test 2: Device exists
    print("Test 2: Device node exists... ", end="")
    if os.path.exists('/dev/dsmil0'):
        print("PASS")
        tests_passed += 1
    else:
        print("FAIL")
        tests_failed += 1

    # Test 3: Device readable
    print("Test 3: Device is readable... ", end="")
    if os.access('/dev/dsmil0', os.R_OK):
        print("PASS")
        tests_passed += 1
    else:
        print("FAIL")
        tests_failed += 1

    # Test 4: Device writable
    print("Test 4: Device is writable... ", end="")
    if os.access('/dev/dsmil0', os.W_OK):
        print("PASS")
        tests_passed += 1
    else:
        print("FAIL")
        tests_failed += 1

    # Test 5: Sysfs interface
    print("Test 5: Sysfs interface available... ", end="")
    if os.path.exists('/sys/class/misc/dsmil0'):
        print("PASS")
        tests_passed += 1
    else:
        print("SKIP (not critical)")

    print()
    print(f"Summary: {tests_passed} passed, {tests_failed} failed")
    print()

    return tests_failed == 0


def main():
    parser = argparse.ArgumentParser(
        description='DSMIL Device Functionality Testing',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  dsmil-test                    Run basic tests only
  dsmil-test --dry-run          Run safe token tests (simulation)
  dsmil-test --live             Run live token tests (DANGEROUS!)
  dsmil-test --range Range_0480 Test specific token range
        '''
    )

    parser.add_argument('--dry-run', action='store_true',
                       help='Run token tests in simulation mode (safe)')
    parser.add_argument('--live', action='store_true',
                       help='Run LIVE token tests (WARNING: Modifies SMBIOS!)')
    parser.add_argument('--range', default='Range_0480',
                       help='Token range to test (default: Range_0480)')
    parser.add_argument('--log-dir', default='/var/log/dell-milspec',
                       help='Log directory (default: /var/log/dell-milspec)')
    parser.add_argument('--basic-only', action='store_true',
                       help='Run only basic functionality tests')

    args = parser.parse_args()

    # Check prerequisites
    print("Checking prerequisites...")
    issues = check_prerequisites()

    if issues:
        print()
        print("Prerequisites check FAILED:")
        for issue in issues:
            print(f"  - {issue}")
        print()
        sys.exit(1)
    else:
        print("Prerequisites check passed")
        print()

    # Run basic tests
    basic_passed = run_basic_tests()

    if not basic_passed:
        print("Basic tests failed. Cannot proceed with token testing.")
        sys.exit(1)

    # Exit if basic-only mode
    if args.basic_only:
        print("Basic tests completed successfully")
        sys.exit(0)

    # Token testing
    if args.dry_run or args.live:
        print("=" * 70)
        print(" DSMIL Token Testing")
        print("=" * 70)
        print()

        if args.live:
            print("WARNING: Live token testing enabled!")
            print("This will attempt to modify SMBIOS tokens!")
            print()
            response = input("Type 'YES' to confirm: ")
            if response != 'YES':
                print("Aborted by user")
                sys.exit(0)
        else:
            print("Running in DRY RUN mode (simulation only)")
            print()

        # Ensure log directory exists
        os.makedirs(args.log_dir, exist_ok=True)

        # Run token tests
        tester = SafeTokenTester(log_dir=args.log_dir)
        dry_run = not args.live
        results = tester.run_safe_test(target_range=args.range, dry_run=dry_run)

        # Summary
        print()
        print("=" * 70)
        print(" Test Summary")
        print("=" * 70)
        print(f"Range tested: {args.range}")
        print(f"Total tokens: {len(results)}")
        print(f"Successful: {len([r for r in results if r.success])}")
        print(f"Changed: {len([r for r in results if r.changed])}")
        print(f"Mode: {'LIVE' if args.live else 'DRY RUN'}")
        print(f"Log file: {tester.log_file}")
        print("=" * 70)
    else:
        print("Basic tests completed successfully")
        print()
        print("To run token tests:")
        print("  dsmil-test --dry-run          (safe simulation)")
        print("  dsmil-test --live             (DANGEROUS - modifies SMBIOS)")


if __name__ == '__main__':
    main()
