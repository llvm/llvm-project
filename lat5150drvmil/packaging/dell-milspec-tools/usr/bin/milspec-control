#!/bin/bash
#
# milspec-control - Main control utility for Dell MIL-SPEC tools
# Part of dell-milspec-tools package
#

set -e

SCRIPT_DIR="/usr/share/dell-milspec"
CONFIG_DIR="/etc/dell-milspec"
LOG_DIR="/var/log/dell-milspec"

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_header() {
    echo "======================================================================"
    echo " Dell MIL-SPEC Control Utility"
    echo "======================================================================"
    echo " Dell Latitude 5450 MIL-SPEC Platform Management"
    echo "======================================================================"
    echo ""
}

show_status() {
    echo -e "${CYAN}System Status:${NC}"
    echo ""

    # DSMIL status
    echo -n "  DSMIL Module: "
    if lsmod | grep -q "^dsmil_72dev"; then
        echo -e "${GREEN}Loaded${NC}"
    else
        echo -e "${RED}Not Loaded${NC}"
    fi

    # TPM2 status
    echo -n "  TPM2 Accel Module: "
    if lsmod | grep -q "^tpm2_accel_early"; then
        echo -e "${GREEN}Loaded${NC}"
    else
        echo -e "${YELLOW}Not Loaded${NC}"
    fi

    # Devices
    echo -n "  DSMIL Device: "
    if [ -e /dev/dsmil0 ]; then
        echo -e "${GREEN}/dev/dsmil0${NC}"
    else
        echo -e "${RED}Not Found${NC}"
    fi

    echo -n "  TPM2 Device: "
    if [ -e /dev/tpm2_accel_early ]; then
        echo -e "${GREEN}/dev/tpm2_accel_early${NC}"
    else
        echo -e "${YELLOW}Not Found${NC}"
    fi

    # System health
    TEMP=$(cat /sys/class/thermal/thermal_zone*/temp 2>/dev/null | head -1 | awk '{printf "%.1f", $1/1000}' || echo "N/A")
    MEM_USAGE=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
    LOAD_AVG=$(uptime | awk -F'load average:' '{print $2}' | xargs | cut -d',' -f1)

    echo ""
    echo "  Temperature: ${TEMP}Â°C"
    echo "  Memory Usage: ${MEM_USAGE}%"
    echo "  Load Average: ${LOAD_AVG}"
    echo ""
}

show_menu() {
    echo -e "${CYAN}Available Operations:${NC}"
    echo ""
    echo "  1) Show Device Status (dsmil-status)"
    echo "  2) Show TPM2 Acceleration Status (tpm2-accel-status)"
    echo "  3) Run Device Tests (dsmil-test)"
    echo "  4) Start Monitoring Dashboard (milspec-monitor)"
    echo "  5) Load Kernel Modules"
    echo "  6) Unload Kernel Modules"
    echo "  7) View Configuration"
    echo "  8) View Recent Logs"
    echo "  9) Emergency Stop"
    echo "  0) Exit"
    echo ""
}

load_modules() {
    echo "Loading kernel modules..."

    echo -n "  Loading dsmil_72dev... "
    if sudo modprobe dsmil_72dev 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo "    Hint: Install dell-milspec-dsmil-dkms package"
    fi

    echo -n "  Loading tpm2_accel_early... "
    if sudo modprobe tpm2_accel_early 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}FAILED${NC} (non-critical)"
        echo "    Hint: Install tpm2-accel-early-dkms package"
    fi

    echo ""
}

unload_modules() {
    echo "Unloading kernel modules..."

    echo -n "  Unloading tpm2_accel_early... "
    if sudo rmmod tpm2_accel_early 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}Not loaded or in use${NC}"
    fi

    echo -n "  Unloading dsmil_72dev... "
    if sudo rmmod dsmil_72dev 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}Not loaded or in use${NC}"
    fi

    echo ""
}

view_config() {
    echo "Configuration Files:"
    echo ""

    for config in dsmil.conf monitoring.json safety.json; do
        CONFIG_FILE="$CONFIG_DIR/$config"
        echo "  $config:"
        if [ -f "$CONFIG_FILE" ]; then
            echo -e "    Status: ${GREEN}Present${NC}"
            echo "    Location: $CONFIG_FILE"
            echo "    Modified: $(stat -c %y "$CONFIG_FILE" | cut -d. -f1)"
        else
            echo -e "    Status: ${YELLOW}Missing${NC}"
        fi
    done

    echo ""
    echo "  To view configuration:"
    echo "    cat $CONFIG_DIR/dsmil.conf"
    echo "    cat $CONFIG_DIR/monitoring.json"
    echo ""
}

view_logs() {
    echo "Recent Log Files:"
    echo ""

    if [ -d "$LOG_DIR" ]; then
        LOG_COUNT=$(find "$LOG_DIR" -type f -name "*.log" 2>/dev/null | wc -l)

        if [ "$LOG_COUNT" -gt 0 ]; then
            find "$LOG_DIR" -type f -name "*.log" -mtime -7 | head -10 | while read log; do
                LOG_NAME=$(basename "$log")
                LOG_SIZE=$(stat -c %s "$log" | numfmt --to=iec 2>/dev/null || echo "?")
                LOG_DATE=$(stat -c %y "$log" | cut -d. -f1)
                echo "  $LOG_NAME ($LOG_SIZE) - $LOG_DATE"
            done

            echo ""
            echo "  To view logs:"
            echo "    tail -f $LOG_DIR/system.log"
            echo "    less $LOG_DIR/token_test_*.log"
        else
            echo "  No log files found"
        fi
    else
        echo "  Log directory not found: $LOG_DIR"
    fi

    echo ""
}

emergency_stop() {
    echo -e "${RED}Executing Emergency Stop...${NC}"
    echo ""

    if command -v milspec-emergency-stop >/dev/null 2>&1; then
        milspec-emergency-stop
    else
        echo "Emergency stop script not found. Performing manual shutdown:"

        # Stop monitoring processes
        pkill -f milspec-monitor 2>/dev/null || true
        pkill -f dsmil_comprehensive_monitor 2>/dev/null || true

        # Unload modules
        sudo rmmod tpm2_accel_early 2>/dev/null || true
        sudo rmmod dsmil_72dev 2>/dev/null || true

        echo "Emergency procedures completed"
    fi

    echo ""
}

main() {
    # Check if running as root (for some operations)
    if [ "$EUID" -eq 0 ]; then
        echo -e "${YELLOW}Warning: Running as root. Most operations don't require root.${NC}"
        echo ""
    fi

    show_header

    # If arguments provided, execute command directly
    case "${1:-}" in
        status)
            show_status
            exit 0
            ;;
        load)
            load_modules
            exit 0
            ;;
        unload)
            unload_modules
            exit 0
            ;;
        emergency|stop)
            emergency_stop
            exit 0
            ;;
        --help|-h|help)
            show_header
            echo "Usage: milspec-control [command]"
            echo ""
            echo "Commands:"
            echo "  status      Show system status"
            echo "  load        Load kernel modules"
            echo "  unload      Unload kernel modules"
            echo "  emergency   Execute emergency stop"
            echo ""
            echo "Run without arguments for interactive mode"
            exit 0
            ;;
    esac

    # Interactive mode
    while true; do
        show_status
        show_menu

        read -p "Select operation [0-9]: " choice
        echo ""

        case $choice in
            1)
                dsmil-status
                ;;
            2)
                tpm2-accel-status
                ;;
            3)
                echo "Running device tests..."
                dsmil-test --basic-only
                ;;
            4)
                echo "Starting monitoring dashboard..."
                milspec-monitor
                ;;
            5)
                load_modules
                ;;
            6)
                unload_modules
                ;;
            7)
                view_config
                ;;
            8)
                view_logs
                ;;
            9)
                emergency_stop
                ;;
            0)
                echo "Exiting MIL-SPEC control utility"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option${NC}"
                ;;
        esac

        read -p "Press Enter to continue..."
        clear
        show_header
    done
}

main "$@"
