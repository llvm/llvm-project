# DKMS Configuration for Dell MIL-SPEC DSMIL Driver
# Package: dell-milspec-dsmil-dkms
# Version: 2.1.0
#
# This configuration enables automatic kernel module rebuilds
# when new kernels are installed via apt.

PACKAGE_NAME="dell-milspec-dsmil"
PACKAGE_VERSION="2.1.0"

# Built modules
BUILT_MODULE_NAME[0]="dsmil-84dev"
BUILT_MODULE_LOCATION[0]="."
DEST_MODULE_LOCATION[0]="/updates/dkms"

# Build configuration
MAKE[0]="make KERNELRELEASE=\${kernelver} KERNEL_DIR=\${kernel_source_dir} -C \${dkms_tree}/\${PACKAGE_NAME}/\${PACKAGE_VERSION}/build all"
CLEAN="make clean"

# Module installation
AUTOINSTALL="yes"
REMAKE_INITRD="yes"

# Minimum kernel version requirement
KERNEL_VERSION_MINIMUM="6.14.0"

# Module parameters (default configuration)
MODULE_CONF[0]="options dsmil-84dev debug=0"

# PCI device aliases (automatic module loading)
MODULES_CONF_ALIAS[0]="dmi:*:svnDell*:pnLatitude5450*"

# Dependencies (must load after these)
BUILD_DEPENDS[0]="linux-headers"
BUILD_DEPENDS[1]="gcc"
BUILD_DEPENDS[2]="make"
BUILD_DEPENDS[3]="libc6-dev"

# Module description
PACKAGE_DESCRIPTION="Dell MIL-SPEC DSMIL 84-Device Driver with Rust Safety Layer"

# Post-build validation (optional)
POST_BUILD="modinfo \${BUILT_MODULE_NAME[0]}.ko"

# Post-install hook: provide legacy alias for tooling that expects dsmil-72dev.ko
POST_INSTALL="ln -sf dsmil-84dev.ko /lib/modules/\${kernelver}/updates/dkms/dsmil-72dev.ko && depmod \${kernelver}"
