<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Claude Code - Self-Coding System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #151b2b;
            --bg-tertiary: #1f2937;
            --text-primary: #10b981;
            --text-secondary: #6ee7b7;
            --text-dim: #a7f3d0;
            --border-color: #059669;
            --accent: #34d399;
            --error: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-rows: 60px 1fr 80px;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .stat {
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .stat-label {
            color: var(--text-dim);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: bold;
        }

        /* Chat Area */
        .chat-container {
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--bg-secondary);
            border-left: 3px solid var(--border-color);
        }

        .message.assistant {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent);
        }

        .message.system {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--success);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--error);
        }

        .message-icon {
            font-size: 24px;
            min-width: 30px;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-text {
            line-height: 1.6;
            font-size: 13px;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--border-color), var(--accent));
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 5px;
        }

        /* Event List */
        .event-list {
            margin-top: 10px;
            font-size: 12px;
        }

        .event-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-icon {
            min-width: 20px;
        }

        /* Input Area */
        .input-container {
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            padding: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 15px;
            font-family: inherit;
            font-size: 14px;
            border-radius: 6px;
            resize: none;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
        }

        .button {
            background: var(--border-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .button:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .button-secondary:hover {
            background: var(--bg-secondary);
        }

        /* Code Blocks */
        .code-block {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 12px;
        }

        pre {
            margin: 0;
        }

        code {
            color: var(--text-secondary);
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-tertiary);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-indicator.active {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-indicator.inactive {
            background: var(--error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }

        .quick-action {
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .quick-action:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <span class="status-indicator active"></span>
                LOCAL CLAUDE CODE - SELF-CODING SYSTEM
            </div>
            <div class="header-stats">
                <div class="stat">
                    <span class="stat-label">Tasks:</span>
                    <span class="stat-value" id="stat-tasks">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Patterns:</span>
                    <span class="stat-value" id="stat-patterns">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Session:</span>
                    <span class="stat-value" id="stat-session">Active</span>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container" id="chat-container">
            <!-- Welcome Message -->
            <div class="message system">
                <div class="message-icon">ü§ñ</div>
                <div class="message-content">
                    <div class="message-header">System Ready</div>
                    <div class="message-text">
                        <p>Welcome to the Integrated Local Claude Code system. I can:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Execute multi-step coding tasks</li>
                            <li>Modify my own code (self-coding)</li>
                            <li>Learn from your codebase</li>
                            <li>Generate optimized code (INT8)</li>
                            <li>Use RAG for context-aware suggestions</li>
                        </ul>
                        <p>Try asking me to: "Add logging to server.py" or "Improve yourself by adding better error handling"</p>

                        <div class="quick-actions">
                            <div class="quick-action" onclick="quickAction('Add comprehensive logging to server.py')">
                                Add Logging
                            </div>
                            <div class="quick-action" onclick="quickAction('Learn from this codebase')">
                                Learn Codebase
                            </div>
                            <div class="quick-action" onclick="quickAction('Show me system statistics')">
                                Show Stats
                            </div>
                            <div class="quick-action" onclick="quickAction('Improve yourself by optimizing execution speed')">
                                Self-Code
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <textarea
                id="message-input"
                class="input-field"
                placeholder="Type your request... (Shift+Enter for new line, Enter to send)"
                rows="2"
            ></textarea>
            <button id="send-button" class="button" onclick="sendMessage()">
                Send
            </button>
            <button id="clear-button" class="button button-secondary" onclick="clearChat()">
                Clear
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:5001/api';
        const WS_URL = 'ws://localhost:5001/ws/chat';

        // State
        let messageCount = 0;
        let websocket = null;
        let currentStreamDiv = null;
        let currentProgressDiv = null;
        let sessionId = Date.now().toString();

        // Event icons
        const EVENT_ICONS = {
            'planning': 'üìã',
            'executing': '‚ö°',
            'reading': 'üìñ',
            'editing': '‚úèÔ∏è',
            'writing': 'üíæ',
            'searching': 'üîç',
            'analyzing': 'ü§î',
            'testing': 'üß™',
            'learning': 'üéì',
            'complete': '‚úÖ',
            'error': '‚ùå',
            'step_start': '‚ñ∂Ô∏è',
            'step_complete': '‚úì',
            'progress': '‚è≥'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            loadStats();

            // Handle Enter key
            document.getElementById('message-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // WebSocket Connection
        function connectWebSocket() {
            try {
                websocket = new WebSocket(WS_URL);

                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    updateStatus('Connected', true);
                };

                websocket.onclose = () => {
                    console.log('WebSocket closed');
                    updateStatus('Disconnected', false);
                    // Reconnect after 3s
                    setTimeout(connectWebSocket, 3000);
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('Error', false);
                };

                websocket.onmessage = (event) => {
                    handleStreamEvent(JSON.parse(event.data));
                };
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateStatus('Failed', false);
            }
        }

        // Send Message
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Clear input
            input.value = '';

            // Add user message
            addMessage('user', message);

            // Prepare stream container
            currentStreamDiv = addMessage('assistant', '', true);
            currentProgressDiv = createProgressBar(currentStreamDiv);

            // Send via WebSocket
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'chat',
                    message: message,
                    session_id: sessionId
                }));
            } else {
                // Fallback to HTTP streaming
                sendViaHTTP(message);
            }

            messageCount++;
            updateStats({tasks: messageCount});
        }

        // Handle Stream Event
        function handleStreamEvent(event) {
            if (event.type === 'done') {
                finishStream();
                return;
            }

            if (event.type === 'error') {
                addMessage('error', `Error: ${event.message}`);
                finishStream();
                return;
            }

            const icon = EVENT_ICONS[event.type] || '‚Ä¢';
            const message = event.message;
            const progress = event.progress;

            // Update stream div
            if (currentStreamDiv) {
                const eventList = currentStreamDiv.querySelector('.event-list') || createEventList(currentStreamDiv);
                addEvent(eventList, icon, message);
            }

            // Update progress
            if (progress !== null && currentProgressDiv) {
                updateProgress(currentProgressDiv, progress, message);
            }
        }

        // Fallback HTTP Streaming
        async function sendViaHTTP(message) {
            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, session_id: sessionId})
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            handleStreamEvent(data);
                        }
                    }
                }

                finishStream();
            } catch (error) {
                console.error('HTTP streaming error:', error);
                addMessage('error', `Error: ${error.message}`);
                finishStream();
            }
        }

        // UI Helper Functions
        function addMessage(role, content, streaming = false) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const icons = {
                'user': 'üë§',
                'assistant': 'ü§ñ',
                'system': '‚öôÔ∏è',
                'error': '‚ùå'
            };

            const headers = {
                'user': 'You',
                'assistant': 'Assistant',
                'system': 'System',
                'error': 'Error'
            };

            messageDiv.innerHTML = `
                <div class="message-icon">${icons[role]}</div>
                <div class="message-content">
                    <div class="message-header">${headers[role]}</div>
                    <div class="message-text">${content || (streaming ? '<div class="spinner"></div> Processing...' : '')}</div>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            return messageDiv.querySelector('.message-text');
        }

        function createEventList(parent) {
            const eventList = document.createElement('div');
            eventList.className = 'event-list';
            parent.appendChild(eventList);
            return eventList;
        }

        function addEvent(eventList, icon, message) {
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <span class="event-icon">${icon}</span>
                <span>${message}</span>
            `;
            eventList.appendChild(eventItem);

            // Scroll to bottom
            document.getElementById('chat-container').scrollTop =
                document.getElementById('chat-container').scrollHeight;
        }

        function createProgressBar(parent) {
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">Starting...</div>
            `;
            parent.appendChild(progressContainer);
            return progressContainer;
        }

        function updateProgress(progressDiv, value, text) {
            const fill = progressDiv.querySelector('.progress-fill');
            const textDiv = progressDiv.querySelector('.progress-text');
            fill.style.width = `${value * 100}%`;
            textDiv.textContent = text || `${(value * 100).toFixed(0)}%`;
        }

        function finishStream() {
            if (currentProgressDiv) {
                updateProgress(currentProgressDiv, 1.0, 'Complete');
            }
            currentStreamDiv = null;
            currentProgressDiv = null;

            // Reload stats
            loadStats();
        }

        function quickAction(message) {
            document.getElementById('message-input').value = message;
            sendMessage();
        }

        function clearChat() {
            if (confirm('Clear conversation history?')) {
                const container = document.getElementById('chat-container');
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }

                // Clear on server
                fetch(`${API_BASE}/history/clear`, {method: 'POST'});
            }
        }

        function updateStatus(status, connected) {
            document.getElementById('stat-session').textContent = status;
            const indicator = document.querySelector('.status-indicator');
            indicator.className = `status-indicator ${connected ? 'active' : 'inactive'}`;
        }

        function updateStats(stats) {
            if (stats.tasks !== undefined) {
                document.getElementById('stat-tasks').textContent = stats.tasks;
            }
            if (stats.patterns !== undefined) {
                document.getElementById('stat-patterns').textContent = stats.patterns;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();

                if (data.status === 'success' && data.stats) {
                    const tasks = data.stats.session?.conversation_turns || 0;
                    const patterns = data.stats.database?.total_patterns || 0;
                    updateStats({tasks, patterns});
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Keepalive ping
        setInterval(() => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({type: 'ping'}));
            }
        }, 30000);
    </script>
</body>
</html>
