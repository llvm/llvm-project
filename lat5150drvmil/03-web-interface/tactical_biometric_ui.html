<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSMIL Tactical Interface - Biometric Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color schemes for different TEMPEST modes */
        :root[data-mode="day"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #3a3a3a;
            --text-primary: #00ff00;
            --text-secondary: #00cc00;
            --text-dim: #009900;
            --border-color: #00ff00;
            --accent: #00ff00;
            --error: #ff0000;
            --warning: #ffaa00;
        }

        :root[data-mode="night"] {
            --bg-primary: #0a0000;
            --bg-secondary: #1a0000;
            --bg-tertiary: #2a0000;
            --text-primary: #ff0000;
            --text-secondary: #cc0000;
            --text-dim: #990000;
            --border-color: #ff0000;
            --accent: #ff0000;
            --error: #ff0000;
            --warning: #ffaa00;
        }

        :root[data-mode="nvg"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a00;
            --bg-tertiary: #1a1a00;
            --text-primary: #33ff33;
            --text-secondary: #22cc22;
            --text-dim: #119911;
            --border-color: #33ff33;
            --accent: #33ff33;
            --error: #ff0000;
            --warning: #ffaa00;
        }

        :root[data-mode="oled"] {
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --bg-tertiary: #000000;
            --text-primary: #00ff00;
            --text-secondary: #00cc00;
            --text-dim: #009900;
            --border-color: #00ff00;
            --accent: #00ff00;
            --error: #ff0000;
            --warning: #ffaa00;
        }

        :root[data-mode="contrast"] {
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --bg-tertiary: #111111;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-dim: #999999;
            --border-color: #ffffff;
            --accent: #ffffff;
            --error: #ff0000;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Courier New', 'Monaco', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 13px;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-rows: 40px 40px 1fr 40px;
            height: 100vh;
        }

        /* Classification Banners */
        .classification-banner {
            background: green;
            color: black;
            text-align: center;
            font-weight: bold;
            padding: 10px;
            font-size: 16px;
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-bar .left {
            display: flex;
            gap: 30px;
        }

        .status-bar .right {
            display: flex;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-led.active {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 2px;
            background: var(--border-color);
            padding: 2px;
            overflow: hidden;
        }

        .panel {
            background: var(--bg-secondary);
            padding: 15px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Navigation Menu */
        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .nav-menu li:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .nav-menu li.active {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        /* Central Panel */
        .central-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 15px;
        }

        .card-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-tertiary);
            box-shadow: 0 0 5px var(--accent);
        }

        .btn:active {
            background: var(--accent);
            color: #000;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Authentication Section */
        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-method {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 20px;
        }

        .auth-method.active {
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .auth-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 15px;
        }

        /* Touch Overlay */
        .touch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .touch-overlay.active {
            display: flex;
        }

        .touch-prompt {
            text-align: center;
            padding: 50px;
            border: 3px solid var(--accent);
            background: var(--bg-secondary);
        }

        .touch-prompt-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* Auth Log */
        .auth-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
        }

        .auth-log-entry {
            padding: 5px;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .auth-log-entry.success {
            color: var(--accent);
        }

        .auth-log-entry.error {
            color: var(--error);
        }

        /* Right Panel */
        .info-group {
            margin-bottom: 20px;
        }

        .info-label {
            color: var(--text-dim);
            font-size: 11px;
            margin-bottom: 3px;
        }

        .info-value {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: bold;
        }

        /* Device List */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 10px;
            font-size: 11px;
        }

        .device-item.active {
            border-color: var(--accent);
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 5px 10px;
            font-size: 11px;
            flex: 1;
            min-width: 80px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Classification Banner -->
        <div class="classification-banner">UNCLASSIFIED // FOR OFFICIAL USE ONLY</div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="left">
                <div class="status-indicator">
                    <div class="status-led" id="securityLed"></div>
                    <span id="securityStatus">UNAUTHORIZED</span>
                </div>
                <div class="status-indicator">
                    <div class="status-led" id="yubikeyLed"></div>
                    <span id="yubikeyStatus">YUBIKEY: NOT DETECTED</span>
                </div>
                <div class="status-indicator">
                    <div class="status-led" id="fingerprintLed"></div>
                    <span id="fingerprintStatus">FINGERPRINT: NOT READY</span>
                </div>
            </div>
            <div class="right">
                <span id="clockDisplay">00:00:00Z</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Navigation -->
            <div class="panel">
                <div class="panel-title">NAVIGATION</div>
                <ul class="nav-menu">
                    <li class="active" onclick="showSection('auth')">üîê Authentication</li>
                    <li onclick="showSection('devices')">üîë Device Management</li>
                    <li onclick="showSection('logs')">üìã Audit Logs</li>
                    <li onclick="showSection('settings')">‚öôÔ∏è Settings</li>
                </ul>

                <div class="panel-title" style="margin-top: 30px;">TEMPEST MODE</div>
                <div class="mode-selector">
                    <button class="btn mode-btn" onclick="setMode('day')">DAY</button>
                    <button class="btn mode-btn" onclick="setMode('night')">NIGHT</button>
                    <button class="btn mode-btn" onclick="setMode('nvg')">NVG</button>
                    <button class="btn mode-btn" onclick="setMode('oled')">OLED</button>
                    <button class="btn mode-btn" onclick="setMode('contrast')">CONTRAST</button>
                </div>
            </div>

            <!-- Central Panel -->
            <div class="panel central-panel" id="centralPanel">
                <!-- Authentication Section -->
                <div id="authSection">
                    <div class="card">
                        <div class="card-title">BIOMETRIC AUTHENTICATION</div>
                        <p style="margin-bottom: 20px;">Select authentication method:</p>

                        <div class="auth-section">
                            <!-- Yubikey Authentication -->
                            <div class="auth-method" id="yubikeyMethod">
                                <div class="auth-icon">üîë</div>
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 16px; font-weight: bold;">YUBIKEY / FIDO2</div>
                                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Hardware security token authentication</div>
                                </div>
                                <div class="btn-group" style="justify-content: center;">
                                    <button class="btn" onclick="startYubikeyAuth()">AUTHENTICATE</button>
                                    <button class="btn" onclick="registerYubikey()">REGISTER NEW KEY</button>
                                </div>
                            </div>

                            <!-- Fingerprint Authentication -->
                            <div class="auth-method" id="fingerprintMethod">
                                <div class="auth-icon">üëÜ</div>
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 16px; font-weight: bold;">FINGERPRINT READER</div>
                                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Biometric fingerprint authentication</div>
                                </div>
                                <div class="btn-group" style="justify-content: center;">
                                    <button class="btn" onclick="startFingerprintAuth()">AUTHENTICATE</button>
                                    <button class="btn" onclick="enrollFingerprint()">ENROLL FINGERPRINT</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">AUTHENTICATION LOG</div>
                        <div class="auth-log" id="authLog">
                            <div class="auth-log-entry">System initialized - awaiting authentication</div>
                        </div>
                    </div>
                </div>

                <!-- Device Management Section (Hidden) -->
                <div id="devicesSection" style="display: none;">
                    <div class="card">
                        <div class="card-title">REGISTERED DEVICES</div>
                        <div id="devicesList">Loading devices...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - System Info -->
            <div class="panel">
                <div class="panel-title">SYSTEM STATUS</div>

                <div class="info-group">
                    <div class="info-label">SECURITY STATUS</div>
                    <div class="info-value" id="securityInfo">UNAUTHENTICATED</div>
                </div>

                <div class="info-group">
                    <div class="info-label">SESSION ID</div>
                    <div class="info-value" id="sessionId">-</div>
                </div>

                <div class="info-group">
                    <div class="info-label">LAST AUTH</div>
                    <div class="info-value" id="lastAuth">Never</div>
                </div>

                <div class="panel-title" style="margin-top: 30px;">HARDWARE STATUS</div>

                <div class="device-list" id="hardwareStatus">
                    <div class="device-item">
                        <div>YUBIKEY READER</div>
                        <div style="color: var(--text-dim);">Status: Checking...</div>
                    </div>
                    <div class="device-item">
                        <div>FINGERPRINT READER</div>
                        <div style="color: var(--text-dim);">Status: Checking...</div>
                    </div>
                </div>

                <div class="panel-title" style="margin-top: 30px;">REGISTERED DEVICES</div>
                <div id="registeredDeviceCount">Loading...</div>
            </div>
        </div>

        <!-- Bottom Classification Banner -->
        <div class="classification-banner">UNCLASSIFIED // FOR OFFICIAL USE ONLY</div>
    </div>

    <!-- Touch Overlay -->
    <div class="touch-overlay" id="touchOverlay">
        <div class="touch-prompt">
            <div class="touch-prompt-icon" id="touchIcon">üîë</div>
            <div style="font-size: 24px; margin-bottom: 10px;">TOUCH REQUIRED</div>
            <div id="touchMessage" style="font-size: 14px; color: var(--text-dim);">Touch your Yubikey or scan your fingerprint</div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="cancelAuth()">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let authenticated = false;
        let currentUser = 'tactical_user';
        let sessionId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setMode('day');
            updateClock();
            setInterval(updateClock, 1000);
            checkWebAuthnSupport();
            checkFingerprintSupport();
            generateSessionId();
        });

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clockDisplay').textContent =
                now.toISOString().substr(11, 8) + 'Z';
        }

        // Session ID
        function generateSessionId() {
            sessionId = 'SESS-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            document.getElementById('sessionId').textContent = sessionId;
        }

        // TEMPEST Mode
        function setMode(mode) {
            document.documentElement.setAttribute('data-mode', mode);
            logAuth(`Display mode changed to ${mode.toUpperCase()}`);
        }

        // Navigation
        function showSection(section) {
            document.getElementById('authSection').style.display =
                section === 'auth' ? 'block' : 'none';
            document.getElementById('devicesSection').style.display =
                section === 'devices' ? 'block' : 'none';

            // Update active nav
            document.querySelectorAll('.nav-menu li').forEach(li => {
                li.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Logging
        function logAuth(message, type = 'info') {
            const log = document.getElementById('authLog');
            const entry = document.createElement('div');
            entry.className = 'auth-log-entry ' + type;
            const timestamp = new Date().toISOString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        // Check WebAuthn Support
        function checkWebAuthnSupport() {
            if (window.PublicKeyCredential) {
                document.getElementById('yubikeyLed').classList.add('active');
                document.getElementById('yubikeyStatus').textContent = 'YUBIKEY: READY';
                logAuth('WebAuthn/FIDO2 supported', 'success');
            } else {
                logAuth('WebAuthn not supported in this browser', 'error');
            }
        }

        // Check Fingerprint Support
        async function checkFingerprintSupport() {
            try {
                const response = await fetch('http://127.0.0.1:5001/api/fingerprint/status');
                const data = await response.json();

                if (data.available) {
                    document.getElementById('fingerprintLed').classList.add('active');
                    document.getElementById('fingerprintStatus').textContent = 'FINGERPRINT: READY';
                    logAuth('Fingerprint reader detected', 'success');
                } else {
                    logAuth('Fingerprint reader not available', 'error');
                }
            } catch (e) {
                logAuth('Failed to check fingerprint status', 'error');
            }
        }

        // Yubikey Authentication
        async function startYubikeyAuth() {
            if (!window.PublicKeyCredential) {
                alert('WebAuthn not supported');
                return;
            }

            try {
                showTouchPrompt('üîë', 'Touch your Yubikey when it blinks');
                logAuth('Starting Yubikey authentication...');

                // Get challenge
                const response = await fetch('http://127.0.0.1:5001/api/yubikey/auth/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: currentUser})
                });

                if (!response.ok) throw new Error('Failed to begin authentication');

                const options = await response.json();

                // Perform WebAuthn authentication
                const credential = await navigator.credentials.get({
                    publicKey: options.publicKey
                });

                // Verify
                const verifyResponse = await fetch('http://127.0.0.1:5001/api/yubikey/auth/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: currentUser,
                        credential: {
                            id: credential.id,
                            rawId: arrayBufferToBase64(credential.rawId),
                            response: {
                                authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
                                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                                signature: arrayBufferToBase64(credential.response.signature),
                                userHandle: credential.response.userHandle ?
                                    arrayBufferToBase64(credential.response.userHandle) : null
                            },
                            type: credential.type
                        }
                    })
                });

                if (verifyResponse.ok) {
                    authenticated = true;
                    updateAuthStatus();
                    logAuth('Yubikey authentication successful', 'success');
                } else {
                    throw new Error('Authentication failed');
                }

            } catch (e) {
                logAuth(`Yubikey authentication failed: ${e.message}`, 'error');
                console.error(e);
            } finally {
                hideTouchPrompt();
            }
        }

        // Yubikey Registration
        async function registerYubikey() {
            if (!window.PublicKeyCredential) {
                alert('WebAuthn not supported');
                return;
            }

            const deviceName = prompt('Enter a name for this Yubikey:');
            if (!deviceName) return;

            try {
                showTouchPrompt('üîë', 'Touch your Yubikey to register');
                logAuth('Starting Yubikey registration...');

                // Get registration options
                const response = await fetch('http://127.0.0.1:5001/api/yubikey/register/begin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: currentUser,
                        displayName: 'Tactical User'
                    })
                });

                if (!response.ok) throw new Error('Failed to begin registration');

                const options = await response.json();

                // Create credential
                const credential = await navigator.credentials.create({
                    publicKey: options.publicKey
                });

                // Complete registration
                const completeResponse = await fetch('http://127.0.0.1:5001/api/yubikey/register/complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: currentUser,
                        deviceName: deviceName,
                        credential: {
                            id: credential.id,
                            rawId: arrayBufferToBase64(credential.rawId),
                            response: {
                                attestationObject: arrayBufferToBase64(credential.response.attestationObject),
                                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON)
                            },
                            type: credential.type
                        }
                    })
                });

                if (completeResponse.ok) {
                    logAuth('Yubikey registered successfully', 'success');
                    alert('Yubikey registered successfully!');
                } else {
                    throw new Error('Registration failed');
                }

            } catch (e) {
                logAuth(`Yubikey registration failed: ${e.message}`, 'error');
                console.error(e);
            } finally {
                hideTouchPrompt();
            }
        }

        // Fingerprint Authentication
        async function startFingerprintAuth() {
            try {
                showTouchPrompt('üëÜ', 'Scan your fingerprint');
                logAuth('Starting fingerprint authentication...');

                const response = await fetch('http://127.0.0.1:5001/api/fingerprint/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: currentUser})
                });

                const data = await response.json();

                if (data.success) {
                    authenticated = true;
                    updateAuthStatus();
                    logAuth('Fingerprint authentication successful', 'success');
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }

            } catch (e) {
                logAuth(`Fingerprint authentication failed: ${e.message}`, 'error');
                console.error(e);
            } finally {
                hideTouchPrompt();
            }
        }

        // Fingerprint Enrollment
        async function enrollFingerprint() {
            const fingerType = prompt('Enter finger type (e.g., right-index-finger):');
            if (!fingerType) return;

            try {
                showTouchPrompt('üëÜ', 'Scan your fingerprint multiple times');
                logAuth('Starting fingerprint enrollment...');

                const response = await fetch('http://127.0.0.1:5001/api/fingerprint/enroll', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: currentUser,
                        fingerType: fingerType
                    })
                });

                const data = await response.json();

                if (data.success) {
                    logAuth('Fingerprint enrolled successfully', 'success');
                    alert('Fingerprint enrolled successfully!');
                } else {
                    throw new Error(data.message || 'Enrollment failed');
                }

            } catch (e) {
                logAuth(`Fingerprint enrollment failed: ${e.message}`, 'error');
                console.error(e);
            } finally {
                hideTouchPrompt();
            }
        }

        // Update Authentication Status
        function updateAuthStatus() {
            document.getElementById('securityLed').classList.add('active');
            document.getElementById('securityStatus').textContent = 'AUTHENTICATED';
            document.getElementById('securityInfo').textContent = 'AUTHENTICATED';
            document.getElementById('lastAuth').textContent = new Date().toISOString();
            document.getElementById('yubikeyMethod').classList.add('active');
            document.getElementById('fingerprintMethod').classList.add('active');
        }

        // Touch Prompt
        function showTouchPrompt(icon, message) {
            document.getElementById('touchIcon').textContent = icon;
            document.getElementById('touchMessage').textContent = message;
            document.getElementById('touchOverlay').classList.add('active');
        }

        function hideTouchPrompt() {
            document.getElementById('touchOverlay').classList.remove('active');
        }

        function cancelAuth() {
            hideTouchPrompt();
            logAuth('Authentication cancelled by user');
        }

        // Helper: ArrayBuffer to Base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Helper: Base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }
    </script>
</body>
</html>
