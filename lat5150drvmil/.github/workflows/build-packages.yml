name: Build Dell MIL-SPEC Packages

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  build-dkms-packages:
    name: Build DKMS Packages
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        package:
          - name: dell-milspec-dsmil-dkms
            version: 2.1.0
          - name: tpm2-accel-early-dkms
            version: 1.0.0
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential debhelper dkms \
            linux-headers-$(uname -r) reprepro

      - name: Build ${{ matrix.package.name }}
        run: |
          cd deployment/debian-packages/${{ matrix.package.name }}
          dpkg-deb --build . ../../${{ matrix.package.name }}_${{ matrix.package.version }}-1_all.deb

      - name: Validate package
        run: |
          dpkg-deb --info deployment/${{ matrix.package.name }}_${{ matrix.package.version }}-1_all.deb
          dpkg-deb --contents deployment/${{ matrix.package.name }}_${{ matrix.package.version }}-1_all.deb

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package.name }}_${{ matrix.package.version }}-1_all.deb
          path: deployment/${{ matrix.package.name }}_${{ matrix.package.version }}-1_all.deb

  test-installation:
    name: Test Package Installation
    needs: build-dkms-packages
    runs-on: ubuntu-latest
    
    steps:
      - name: Download DSMIL package
        uses: actions/download-artifact@v4
        with:
          name: dell-milspec-dsmil-dkms_2.1.0-1_all.deb

      - name: Download TPM2 package
        uses: actions/download-artifact@v4
        with:
          name: tpm2-accel-early-dkms_1.0.0-1_all.deb

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dkms linux-headers-$(uname -r)

      - name: Test package installation
        run: |
          sudo dpkg -i dell-milspec-dsmil-dkms_2.1.0-1_all.deb || true
          sudo dpkg -i tpm2-accel-early-dkms_1.0.0-1_all.deb || true
          sudo apt-get install -f -y

      - name: Verify installation
        run: |
          dpkg -l | grep dell-milspec
          dpkg -l | grep tpm2-accel

  publish-to-repository:
    name: Publish to APT Repository
    needs: test-installation
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*_all.deb'
          path: packages

      - name: Install reprepro
        run: sudo apt-get install -y reprepro

      - name: Add packages to repository
        run: |
          for pkg in packages/*.deb; do
            reprepro -b deployment/apt-repository includedeb stable $pkg
          done

      - name: Update repository metadata
        run: |
          cd deployment/apt-repository
          ./scripts/update-repository.sh
