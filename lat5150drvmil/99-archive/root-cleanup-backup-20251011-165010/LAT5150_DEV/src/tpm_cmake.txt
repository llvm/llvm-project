# DSMIL TPM Bypass Tools - CMake Configuration
# Intel ME and TPM Coordination Bypass Utilities
# ‚ö†Ô∏è  AUTHORIZED PERSONNEL ONLY - MIL-SPEC SECURITY CLASSIFICATION

cmake_minimum_required(VERSION 3.20)

# ============================================================================
# SECURITY WARNING AND AUTHORIZATION CHECK
# ============================================================================

if(NOT ENABLE_TPM_BYPASS)
    message(FATAL_ERROR
        "üö® TPM BYPASS TOOLS DISABLED\n"
        "   These tools are classified for authorized personnel only.\n"
        "   To enable: cmake -DENABLE_TPM_BYPASS=ON .."
    )
endif()

message(WARNING
    "üö® TPM BYPASS TOOLS ENABLED\n"
    "   Classification: FOR AUTHORIZED PERSONNEL ONLY\n"
    "   Usage: MIL-SPEC security research and system hardening\n"
    "   Compliance: Ensure proper authorization before deployment"
)

# ============================================================================
# TPM BYPASS COMPONENT SOURCES
# ============================================================================

# Core TPM bypass functionality
set(TPM_CORE_SOURCES
    src/intel_me_tpm_bypass.c
    src/hardware_register_access.c
    src/security_coordination.c
    src/tpm_state_machine.c
    src/me_negotiation_protocol.c
)

# Hardware abstraction layer
set(TPM_HAL_SOURCES
    src/dell_latitude_hal.c
    src/intel_meteor_lake_hal.c
    src/pci_register_access.c
    src/memory_mapped_io.c
    src/smbios_token_access.c
)

# Cryptographic and security sources
set(TPM_CRYPTO_SOURCES
    src/tpm_crypto_bypass.c
    src/attestation_chain_bypass.c
    src/secure_boot_coordination.c
    src/key_derivation_bypass.c
)

# Logging and audit sources
set(TPM_AUDIT_SOURCES
    src/bypass_audit_logger.c
    src/security_event_recorder.c
    src/compliance_tracker.c
)

# Utility and tool sources
set(TPM_UTILITY_SOURCES
    src/tpm_diagnostics.c
    src/system_state_analyzer.c
    src/hardware_validator.c
    src/security_policy_checker.c
)

# All TPM sources combined
set(ALL_TPM_SOURCES
    ${TPM_CORE_SOURCES}
    ${TPM_HAL_SOURCES}
    ${TPM_CRYPTO_SOURCES}
    ${TPM_AUDIT_SOURCES}
    ${TPM_UTILITY_SOURCES}
)

# ============================================================================
# HEADER FILES
# ============================================================================

set(TPM_HEADERS
    include/intel_me_tpm_bypass.h
    include/hardware_register_access.h
    include/security_coordination.h
    include/tpm_state_machine.h
    include/me_negotiation_protocol.h
    include/dell_latitude_hal.h
    include/intel_meteor_lake_hal.h
    include/pci_register_access.h
    include/memory_mapped_io.h
    include/smbios_token_access.h
    include/tpm_crypto_bypass.h
    include/attestation_chain_bypass.h
    include/secure_boot_coordination.h
    include/key_derivation_bypass.h
    include/bypass_audit_logger.h
    include/security_event_recorder.h
    include/compliance_tracker.h
    include/tpm_diagnostics.h
    include/system_state_analyzer.h
    include/hardware_validator.h
    include/security_policy_checker.h
    include/tpm_bypass_common.h
    include/dsmil_tpm_integration.h
)

# ============================================================================
# STATIC LIBRARY TARGET
# ============================================================================

# TPM bypass static library (secure, no shared library exposure)
add_library(dsmil-tpm-bypass-static STATIC
    ${ALL_TPM_SOURCES}
    ${TPM_HEADERS}
)

# Security-hardened compile options
target_compile_options(dsmil-tpm-bypass-static PRIVATE
    -Wall
    -Wextra
    -Wpedantic
    -Werror
    -fstack-protector-strong
    -D_FORTIFY_SOURCE=2
    -fPIE
    -fno-plt
    -Wformat=2
    -Wformat-security
    -Wnull-dereference
    -Wstack-protector
    -Wtrampolines
)

# Include directories
target_include_directories(dsmil-tpm-bypass-static
    PUBLIC
        ${CMAKE_CURRENT_SOURCE_DIR}/include
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/src
        ${CMAKE_SOURCE_DIR}/include
)

# Security-sensitive compile definitions
target_compile_definitions(dsmil-tpm-bypass-static PRIVATE
    # Authorization and classification
    MIL_SPEC_AUTHORIZED=1
    TPM_BYPASS_SECURITY_LEVEL=3
    INTEL_ME_BYPASS_ENABLED=1
    HAP_MODE_SUPPORTED=1

    # Hardware platform
    DELL_LATITUDE_5450_JRTC1=1
    INTEL_METEOR_LAKE_ULTRA7_155H=1

    # Security features
    ENHANCED_AUDIT_LOGGING=1
    COMPLIANCE_TRACKING_ENABLED=1
    SECURE_MEMORY_OPERATIONS=1
    CRYPTOGRAPHIC_VALIDATION=1

    # Version and build info
    TPM_BYPASS_VERSION_MAJOR=${PROJECT_VERSION_MAJOR}
    TPM_BYPASS_VERSION_MINOR=${PROJECT_VERSION_MINOR}
    TPM_BYPASS_VERSION_PATCH=${PROJECT_VERSION_PATCH}
)

# Debug vs Release definitions
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(dsmil-tpm-bypass-static PRIVATE
        DEBUG_TPM_OPERATIONS=1
        VERBOSE_LOGGING=1
    )
else()
    target_compile_definitions(dsmil-tpm-bypass-static PRIVATE
        PRODUCTION_TPM_BYPASS=1
        OPTIMIZED_OPERATIONS=1
    )
endif()

# Link security libraries
target_link_libraries(dsmil-tpm-bypass-static
    OpenSSL::SSL
    OpenSSL::Crypto
)

# ============================================================================
# COMMAND-LINE TOOLS
# ============================================================================

# Intel ME TPM Bypass CLI Tool
add_executable(intel-me-bypass
    tools/intel_me_bypass_cli.c
    tools/command_line_parser.c
    tools/interactive_mode.c
)

target_include_directories(intel-me-bypass PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/tools/include
)

target_link_libraries(intel-me-bypass
    dsmil-tpm-bypass-static
    OpenSSL::SSL
    OpenSSL::Crypto
)

target_compile_definitions(intel-me-bypass PRIVATE
    TOOL_NAME="intel-me-bypass"
    TOOL_VERSION="${PROJECT_VERSION}"
    MIL_SPEC_CLI_TOOL=1
)

# TPM State Analyzer Tool
add_executable(tpm-state-analyzer
    tools/tpm_state_analyzer_cli.c
    tools/state_machine_debugger.c
    tools/hardware_probe.c
)

target_include_directories(tpm-state-analyzer PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/tools/include
)

target_link_libraries(tpm-state-analyzer
    dsmil-tpm-bypass-static
    OpenSSL::SSL
    OpenSSL::Crypto
)

target_compile_definitions(tpm-state-analyzer PRIVATE
    TOOL_NAME="tpm-state-analyzer"
    TOOL_VERSION="${PROJECT_VERSION}"
    DIAGNOSTIC_TOOL=1
)

# Security Policy Validator
add_executable(security-policy-validator
    tools/security_policy_validator_cli.c
    tools/compliance_checker.c
    tools/audit_log_analyzer.c
)

target_include_directories(security-policy-validator PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/tools/include
)

target_link_libraries(security-policy-validator
    dsmil-tpm-bypass-static
    OpenSSL::SSL
    OpenSSL::Crypto
)

target_compile_definitions(security-policy-validator PRIVATE
    TOOL_NAME="security-policy-validator"
    TOOL_VERSION="${PROJECT_VERSION}"
    COMPLIANCE_TOOL=1
)

# Hardware Diagnostic Suite
add_executable(hardware-diagnostic-suite
    tools/hardware_diagnostic_cli.c
    tools/register_dumper.c
    tools/pci_scanner.c
    tools/smbios_reader.c
)

target_include_directories(hardware-diagnostic-suite PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/tools/include
)

target_link_libraries(hardware-diagnostic-suite
    dsmil-tpm-bypass-static
    OpenSSL::SSL
    OpenSSL::Crypto
)

target_compile_definitions(hardware-diagnostic-suite PRIVATE
    TOOL_NAME="hardware-diagnostic-suite"
    TOOL_VERSION="${PROJECT_VERSION}"
    HARDWARE_TOOL=1
)

# ============================================================================
# SECURITY VALIDATION TARGETS
# ============================================================================

# Static analysis with enhanced security checks
add_custom_target(tpm-security-analysis
    COMMAND cppcheck --enable=all --error-exitcode=1
            --suppress=missingIncludeSystem
            --addon=cert
            ${CMAKE_CURRENT_SOURCE_DIR}/src/
    COMMAND scan-build -o ${CMAKE_BINARY_DIR}/scan-build-tpm
            ${CMAKE_MAKE_PROGRAM} -C ${CMAKE_BINARY_DIR} dsmil-tmp-bypass-static
    COMMENT "üîí Running security analysis on TPM bypass code"
)

# Memory safety validation
add_custom_target(tmp-memory-safety
    COMMAND valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all
            --error-exitcode=1
            ${CMAKE_CURRENT_BINARY_DIR}/intel-me-bypass --test-mode
    DEPENDS intel-me-bypass
    COMMENT "üîí Validating memory safety of TPM tools"
)

# Cryptographic validation
add_custom_target(tpm-crypto-validation
    COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/tests/validate_crypto_operations.sh
    DEPENDS dsmil-tpm-bypass-static
    COMMENT "üîí Validating cryptographic operations"
)

# ============================================================================
# TESTING TARGETS
# ============================================================================

if(BUILD_TESTING)
    # TPM bypass unit tests
    add_executable(test-tpm-bypass
        tests/test_intel_me_bypass.c
        tests/test_hardware_register_access.c
        tests/test_security_coordination.c
        tests/test_tpm_state_machine.c
        tests/test_crypto_bypass.c
        tests/test_runner.c
    )

    target_include_directories(test-tpm-bypass PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${CMAKE_CURRENT_SOURCE_DIR}/tests/include
    )

    target_link_libraries(test-tpm-bypass
        dsmil-tpm-bypass-static
        OpenSSL::SSL
        OpenSSL::Crypto
    )

    target_compile_definitions(test-tpm-bypass PRIVATE
        UNIT_TESTING=1
        TEST_MODE=1
    )

    add_test(NAME tpm-bypass-unit-tests
        COMMAND test-tpm-bypass
    )

    # Hardware integration tests (requires elevated privileges)
    add_test(NAME tpm-hardware-integration
        COMMAND sudo ${CMAKE_CURRENT_BINARY_DIR}/intel-me-bypass
                --test-mode --hardware-validation
    )

    # Security compliance tests
    add_test(NAME tpm-security-compliance
        COMMAND ${CMAKE_CURRENT_BINARY_DIR}/security-policy-validator
                --test-mode --full-validation
    )
endif()

# ============================================================================
# INSTALLATION WITH SECURITY RESTRICTIONS
# ============================================================================

# Install tools with restricted permissions (root only)
install(TARGETS
    intel-me-bypass
    tpm-state-analyzer
    security-policy-validator
    hardware-diagnostic-suite
    DESTINATION /usr/local/sbin
    PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE
    COMPONENT tpm-tools
)

# Install static library for development (restricted)
install(TARGETS dsmil-tpm-bypass-static
    ARCHIVE DESTINATION /usr/local/lib/dsmil-restricted
    PERMISSIONS OWNER_READ OWNER_WRITE
    COMPONENT tpm-development
)

# Install headers (restricted access)
install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/include/
    DESTINATION /usr/local/include/dsmil-restricted
    FILES_MATCHING PATTERN "*.h"
    PERMISSIONS OWNER_READ OWNER_WRITE
    COMPONENT tpm-development
)

# Install documentation (restricted)
install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/docs/
    DESTINATION /usr/local/share/doc/dsmil-tpm-restricted
    PERMISSIONS OWNER_READ OWNER_WRITE
    COMPONENT tpm-documentation
)

# Install configuration templates
install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/config/
    DESTINATION /etc/dsmil/tpm
    FILES_MATCHING PATTERN "*.conf" PATTERN "*.policy"
    PERMISSIONS OWNER_READ OWNER_WRITE
    COMPONENT tpm-configuration
)

# Create security policy enforcement script
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/scripts/enforce_tpm_security.sh.in
    ${CMAKE_BINARY_DIR}/enforce_tpm_security.sh
    @ONLY
)

install(PROGRAMS ${CMAKE_BINARY_DIR}/enforce_tpm_security.sh
    DESTINATION /usr/local/sbin
    PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE
    COMPONENT tpm-tools
)

# ============================================================================
# AUDIT AND COMPLIANCE TARGETS
# ============================================================================

# Generate security audit report
add_custom_target(tpm-audit-report
    COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/tools/generate_audit_report.py
            --source-dir ${CMAKE_CURRENT_SOURCE_DIR}
            --build-dir ${CMAKE_CURRENT_BINARY_DIR}
            --output ${CMAKE_BINARY_DIR}/tpm_security_audit_report.pdf
    COMMENT "üîí Generating TPM bypass security audit report"
)

# Compliance validation
add_custom_target(tpm-compliance-check
    COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/tools/compliance_validator.py
            --standard MIL-STD-188-220
            --classification AUTHORIZED_PERSONNEL_ONLY
            --validate-all
    COMMENT "üîí Validating MIL-SPEC compliance"
)

# Create deployment package with security restrictions
add_custom_target(tpm-secure-package
    COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/tools/create_secure_package.sh
            --build-dir ${CMAKE_CURRENT_BINARY_DIR}
            --output ${CMAKE_BINARY_DIR}/dsmil-tpm-bypass-secure.tar.gpg
            --encrypt --sign
    DEPENDS intel-me-bypass tpm-state-analyzer security-policy-validator
    COMMENT "üîí Creating encrypted, signed TPM bypass package"
)

# ============================================================================
# INFORMATION AND HELP TARGETS
# ============================================================================

add_custom_target(tpm-info
    COMMAND echo ""
    COMMAND echo "üö® DSMIL TPM Bypass Tools - SECURITY CLASSIFICATION üö®"
    COMMAND echo "========================================================="
    COMMAND echo "Classification: FOR AUTHORIZED PERSONNEL ONLY"
    COMMAND echo "Compliance: MIL-STD-188-220, Dell Latitude 5450 MIL-SPEC"
    COMMAND echo "Version: ${PROJECT_VERSION}"
    COMMAND echo ""
    COMMAND echo "Available Tools:"
    COMMAND echo "  intel-me-bypass           - Intel ME TPM coordination bypass"
    COMMAND echo "  tpm-state-analyzer        - TPM state machine diagnostics"
    COMMAND echo "  security-policy-validator - Security policy compliance checker"
    COMMAND echo "  hardware-diagnostic-suite - Hardware diagnostic tools"
    COMMAND echo ""
    COMMAND echo "Static Library:"
    COMMAND echo "  dsmil-tpm-bypass-static   - Core TPM bypass functionality"
    COMMAND echo ""
    COMMAND echo "Security Features:"
    COMMAND echo "  - Enhanced audit logging with cryptographic signatures"
    COMMAND echo "  - Compliance tracking for MIL-SPEC environments"
    COMMAND echo "  - Secure memory operations with buffer protection"
    COMMAND echo "  - Real-time security event recording"
    COMMAND echo "  - Hardware-backed attestation chain bypass"
    COMMAND echo ""
    COMMAND echo "‚ö†Ô∏è  WARNING: These tools require elevated privileges and"
    COMMAND echo "   proper authorization. Unauthorized use is prohibited."
    COMMAND echo ""
    COMMENT "Displaying TPM bypass tools information"
)

add_custom_target(tpm-help
    COMMAND echo ""
    COMMAND echo "DSMIL TPM Bypass Tools - Build Targets:"
    COMMAND echo "======================================"
    COMMAND echo ""
    COMMAND echo "Library Targets:"
    COMMAND echo "  dsmil-tpm-bypass-static   - Build static library"
    COMMAND echo ""
    COMMAND echo "Tool Targets:"
    COMMAND echo "  intel-me-bypass           - Build ME bypass CLI tool"
    COMMAND echo "  tpm-state-analyzer        - Build state analyzer"
    COMMAND echo "  security-policy-validator - Build policy validator"
    COMMAND echo "  hardware-diagnostic-suite - Build diagnostic suite"
    COMMAND echo ""
    COMMAND echo "Security Validation:"
    COMMAND echo "  tpm-security-analysis     - Run static security analysis"
    COMMAND echo "  tpm-memory-safety         - Validate memory safety"
    COMMAND echo "  tpm-crypto-validation     - Validate cryptographic operations"
    COMMAND echo ""
    COMMAND echo "Compliance:"
    COMMAND echo "  tpm-audit-report          - Generate security audit report"
    COMMAND echo "  tpm-compliance-check      - Validate MIL-SPEC compliance"
    COMMAND echo "  tpm-secure-package        - Create encrypted deployment package"
    COMMAND echo ""
    COMMAND echo "Testing:"
    COMMAND echo "  test-tpm-bypass           - Run unit tests"
    COMMAND echo ""
    COMMAND echo "Information:"
    COMMAND echo "  tpm-info                  - Display tool information"
    COMMAND echo ""
    COMMENT "Displaying TPM bypass build help"
)