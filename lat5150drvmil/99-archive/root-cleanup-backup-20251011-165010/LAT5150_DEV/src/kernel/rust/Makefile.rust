# Makefile for DSMIL Rust Components
# Builds Rust safety layer for kernel integration

RUST_TARGET := x86_64-unknown-linux-gnu
RUST_LIB := libdsmil_rust.a
CARGO := cargo
RUSTC := rustc

# Kernel build environment
KDIR ?= /lib/modules/$(shell uname -r)/build

# Rust build configuration
RUST_FLAGS := --release --target=$(RUST_TARGET)
CARGO_FLAGS := $(RUST_FLAGS) --offline

# Default target
all: $(RUST_LIB)

# Build Rust library
$(RUST_LIB): src/lib.rs src/smi.rs src/memory.rs src/ffi.rs Cargo.toml
	@echo "Building DSMIL Rust safety layer..."
	$(CARGO) build $(CARGO_FLAGS)
	cp target/$(RUST_TARGET)/release/$(RUST_LIB) .
	@echo "Rust library built: $(RUST_LIB)"

# Check Rust code without building
check:
	@echo "Checking Rust code..."
	$(CARGO) check $(RUST_FLAGS)

# Run Rust unit tests
test:
	@echo "Running Rust unit tests..."
	$(CARGO) test --features testing

# Clean Rust build artifacts
clean:
	@echo "Cleaning Rust build artifacts..."
	$(CARGO) clean
	rm -f $(RUST_LIB)

# Setup Rust environment for kernel development
setup:
	@echo "Setting up Rust environment for kernel development..."
	rustup component add rust-src
	rustup target add $(RUST_TARGET)
	@echo "Rust environment setup complete"

# Generate Rust documentation
docs:
	@echo "Generating Rust documentation..."
	$(CARGO) doc --no-deps $(RUST_FLAGS)
	@echo "Documentation generated in target/doc/"

# Format Rust code
fmt:
	@echo "Formatting Rust code..."
	$(CARGO) fmt

# Run Clippy linter
clippy:
	@echo "Running Clippy linter..."
	$(CARGO) clippy $(RUST_FLAGS) -- -D warnings

# Show Rust compiler version
version:
	@echo "Rust toolchain versions:"
	@$(CARGO) --version
	@$(RUSTC) --version
	@echo "Available targets:"
	@rustup target list --installed

# Install Rust toolchain if missing
install-rust:
	@echo "Installing Rust toolchain..."
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	source ~/.cargo/env
	rustup component add rust-src
	rustup target add $(RUST_TARGET)

# Verify kernel compatibility
verify-kernel:
	@echo "Verifying kernel Rust compatibility..."
	@if [ ! -f $(KDIR)/rust/Makefile ]; then \
		echo "WARNING: Kernel Rust support not detected"; \
		echo "This kernel may not have CONFIG_RUST=y"; \
	else \
		echo "Kernel Rust support detected"; \
	fi

# Show library information
info:
	@echo "DSMIL Rust Library Information:"
	@echo "  Library: $(RUST_LIB)"
	@echo "  Target: $(RUST_TARGET)"
	@echo "  Size: $(shell stat -c%s $(RUST_LIB) 2>/dev/null || echo 'not built') bytes"
	@echo "  Symbols: $(shell nm $(RUST_LIB) 2>/dev/null | grep -c ' T ' || echo '0') exported functions"

# Integration test with C module
integration-test: $(RUST_LIB)
	@echo "Running integration test..."
	@echo "Checking exported symbols..."
	nm $(RUST_LIB) | grep " T " | head -10
	@echo "Library ready for kernel module integration"

# Debug build for development
debug:
	@echo "Building debug version..."
	$(CARGO) build --target=$(RUST_TARGET)
	cp target/$(RUST_TARGET)/debug/$(RUST_LIB) $(RUST_LIB).debug
	@echo "Debug library built: $(RUST_LIB).debug"

# Profile-guided optimization build
pgo:
	@echo "Building with profile-guided optimization..."
	RUSTFLAGS="-Cprofile-generate=/tmp/pgo-data" $(CARGO) build $(RUST_FLAGS)
	@echo "Run your workload, then use 'make pgo-use'"

pgo-use:
	@echo "Building optimized version with PGO data..."
	RUSTFLAGS="-Cprofile-use=/tmp/pgo-data" $(CARGO) build $(RUST_FLAGS)
	cp target/$(RUST_TARGET)/release/$(RUST_LIB) .

# Security audit
audit:
	@echo "Running security audit..."
	cargo audit || echo "cargo-audit not installed, run: cargo install cargo-audit"

# Memory layout analysis
layout:
	@echo "Analyzing memory layout..."
	$(CARGO) build $(RUST_FLAGS) --message-format=json | jq -r '.target.src_path' | sort -u

# Cross-compilation verification
cross-check:
	@echo "Verifying cross-compilation support..."
	@rustup target list | grep $(RUST_TARGET) || (echo "Target not installed" && exit 1)
	@echo "Cross-compilation verified for $(RUST_TARGET)"

# Minimal build for testing
minimal:
	@echo "Building minimal configuration..."
	$(CARGO) build --no-default-features --target=$(RUST_TARGET)

# Help target
help:
	@echo "DSMIL Rust Build System"
	@echo ""
	@echo "Main targets:"
	@echo "  all          - Build the Rust library (default)"
	@echo "  check        - Check code without building"
	@echo "  test         - Run unit tests"
	@echo "  clean        - Clean build artifacts"
	@echo ""
	@echo "Development targets:"
	@echo "  setup        - Setup Rust environment"
	@echo "  docs         - Generate documentation"
	@echo "  fmt          - Format code"
	@echo "  clippy       - Run linter"
	@echo "  debug        - Build debug version"
	@echo ""
	@echo "Integration targets:"
	@echo "  verify-kernel - Check kernel Rust support"
	@echo "  integration-test - Test library integration"
	@echo "  info         - Show library information"
	@echo ""
	@echo "Advanced targets:"
	@echo "  pgo          - Profile-guided optimization"
	@echo "  audit        - Security audit"
	@echo "  cross-check  - Verify cross-compilation"
	@echo "  minimal      - Minimal build"

# Phony targets
.PHONY: all check test clean setup docs fmt clippy version install-rust
.PHONY: verify-kernel info integration-test debug pgo pgo-use audit layout
.PHONY: cross-check minimal help

# Default goal
.DEFAULT_GOAL := all