#!/bin/bash
# Dell MIL-SPEC DSMIL DKMS - Post-installation script
# This script runs after the package is installed

set -e

DKMS_NAME="dell-milspec-dsmil"
DKMS_VERSION="2.1.0"
KERNEL_VERSION=$(uname -r)

# Function to log messages
log_message() {
    echo "[dell-milspec-dsmil] $1"
}

case "$1" in
    configure)
        log_message "Configuring Dell MIL-SPEC DSMIL driver..."

        # Add module to DKMS tree
        log_message "Adding module to DKMS..."
        dkms add -m ${DKMS_NAME} -v ${DKMS_VERSION} || true

        # Check if kernel headers are available
        if [ ! -d "/lib/modules/${KERNEL_VERSION}/build" ]; then
            log_message "WARNING: Kernel headers not found for ${KERNEL_VERSION}"
            log_message "Please install linux-headers-${KERNEL_VERSION}"
            log_message "Module will be built when headers are available"
            exit 0
        fi

        # Build module for current kernel
        log_message "Building module for kernel ${KERNEL_VERSION}..."
        if dkms build -m ${DKMS_NAME} -v ${DKMS_VERSION} -k ${KERNEL_VERSION}; then
            log_message "Build successful"

            # Install module
            log_message "Installing module..."
            if dkms install -m ${DKMS_NAME} -v ${DKMS_VERSION} -k ${KERNEL_VERSION}; then
                log_message "Installation successful"

                # Update module dependencies
                log_message "Updating module dependencies..."
                depmod -a

                # Try to load the module
                log_message "Loading dsmil-72dev module..."
                if modprobe dsmil-72dev; then
                    log_message "Module loaded successfully"

                    # Display device information if available
                    if [ -d "/sys/devices/platform/dsmil" ]; then
                        DEVICE_COUNT=$(cat /sys/devices/platform/dsmil/device_count 2>/dev/null || echo "unknown")
                        log_message "DSMIL devices detected: ${DEVICE_COUNT}"
                    fi
                else
                    log_message "Note: Module will load on next boot"
                    log_message "Or run: sudo modprobe dsmil-72dev"
                fi
            else
                log_message "ERROR: Module installation failed"
                exit 1
            fi
        else
            log_message "ERROR: Module build failed"
            log_message "Check: dmesg | tail -50"
            exit 1
        fi

        # Create module configuration if it doesn't exist
        if [ ! -f "/etc/modprobe.d/dell-milspec.conf" ]; then
            log_message "Creating module configuration..."
            cat > /etc/modprobe.d/dell-milspec.conf << 'EOF'
# Dell MIL-SPEC DSMIL Module Configuration
# 84 DSMIL devices (token range 0x8000-0x806B)

options dsmil-72dev debug=0

# Automatic loading on Dell Latitude 5450
alias dmi:*:svnDell*:pnLatitude5450* dsmil-72dev
EOF
        fi

        # Create early boot loading configuration
        if [ ! -f "/etc/modules-load.d/dell-milspec.conf" ]; then
            log_message "Configuring early boot module loading..."
            cat > /etc/modules-load.d/dell-milspec.conf << 'EOF'
# Load Dell MIL-SPEC modules at boot
dsmil-72dev
EOF
        fi

        # Success message
        echo ""
        echo "════════════════════════════════════════════════════════"
        echo "  Dell MIL-SPEC DSMIL Driver Installed Successfully"
        echo "════════════════════════════════════════════════════════"
        echo ""
        echo "Module Information:"
        echo "  Package: ${DKMS_NAME} ${DKMS_VERSION}"
        echo "  Kernel: ${KERNEL_VERSION}"
        echo "  Device: /dev/dsmil0"
        echo ""
        echo "Check Status:"
        echo "  sudo dsmil-status   # System status"
        echo "  lsmod | grep dsmil  # Module loaded"
        echo "  dmesg | grep dsmil  # Kernel messages"
        echo ""
        echo "Documentation:"
        echo "  /usr/share/doc/dell-milspec-dsmil-dkms/"
        echo ""
        echo "DKMS will automatically rebuild this module when you"
        echo "install a new kernel version via 'apt upgrade'."
        echo ""
        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        # Nothing to do
        ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

#DEBHELPER#

exit 0
