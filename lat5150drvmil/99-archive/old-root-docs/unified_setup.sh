#!/usr/bin/env bash
#
# LAT5150DRVMIL Unified Setup Script
# Single comprehensive setup for entire AI platform
#
# Consolidates:
#  - MCP server setup
#  - AI engine setup
#  - NPU configuration
#  - All dependencies
#
# Usage: ./unified_setup.sh [--skip-mcp] [--skip-ai] [--minimal]
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Base directories
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AI_ENGINE_DIR="$BASE_DIR/02-ai-engine"
MCP_DIR="$BASE_DIR/.mcp"

# Parse arguments
SKIP_MCP=false
SKIP_AI=false
MINIMAL=false

for arg in "$@"; do
    case $arg in
        --skip-mcp) SKIP_MCP=true ;;
        --skip-ai) SKIP_AI=true ;;
        --minimal) MINIMAL=true ;;
    esac
done

echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}  LAT5150DRVMIL Unified Setup                                   ${NC}"
echo -e "${CYAN}  Complete AI Platform Installation                             ${NC}"
echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

print_header() {
    echo ""
    echo -e "${MAGENTA}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${MAGENTA}  $1${NC}"
    echo -e "${MAGENTA}═══════════════════════════════════════════════════════════════${NC}"
}

print_step() {
    echo -e "${BLUE}[SETUP]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[⚠]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

# ============================================================================
# PHASE 1: AI Engine Setup
# ============================================================================

if [ "$SKIP_AI" = false ]; then
    print_header "PHASE 1: AI Engine Setup"

    cd "$AI_ENGINE_DIR"

    if [ -f "setup_unified_ai_platform.sh" ]; then
        print_step "Running AI engine setup..."

        # Set environment variables for integrated setup
        export INSTALL_OPENVINO=yes
        export INSTALL_98_AGENTS=yes
        export INSTALL_VOICE_UI=yes
        export INSTALL_SHADOWGIT=yes
        export COMPILE_NATIVE=yes

        if [ "$MINIMAL" = true ]; then
            export INSTALL_VOICE_UI=no
            export COMPILE_NATIVE=no
        fi

        ./setup_unified_ai_platform.sh

        print_success "AI engine setup complete"
    else
        print_error "AI engine setup script not found at $AI_ENGINE_DIR/setup_unified_ai_platform.sh"
        exit 1
    fi
else
    print_warning "Skipping AI engine setup (--skip-ai)"
fi

# ============================================================================
# PHASE 2: MCP Server Setup (if exists)
# ============================================================================

if [ "$SKIP_MCP" = false ]; then
    print_header "PHASE 2: MCP Server Configuration"

    if [ -d "$MCP_DIR" ]; then
        print_step "Configuring MCP servers..."

        # Check for MCP setup script
        if [ -f "$MCP_DIR/setup.sh" ]; then
            cd "$MCP_DIR"
            ./setup.sh
            print_success "MCP servers configured"
        elif [ -f "$MCP_DIR/install.sh" ]; then
            cd "$MCP_DIR"
            ./install.sh
            print_success "MCP servers installed"
        else
            print_warning "No MCP setup script found - manual configuration may be needed"
        fi

        # Create unified MCP startup script if it doesn't exist
        if [ ! -f "$MCP_DIR/start_servers.sh" ]; then
            print_step "Creating MCP unified startup script..."

            cat > "$MCP_DIR/start_servers.sh" <<'MCPSTART'
#!/bin/bash
# MCP Servers Unified Startup
# Auto-generated by unified_setup.sh

# Start all configured MCP servers
echo "Starting MCP servers..."

# Add your MCP server start commands here
# Example:
# uvx create-mcp-server &
# python3 mcp_server.py &

echo "MCP servers started"
MCPSTART

            chmod +x "$MCP_DIR/start_servers.sh"
            print_success "MCP startup script created"
        fi
    else
        print_warning "MCP directory not found at $MCP_DIR - skipping MCP setup"
    fi
else
    print_warning "Skipping MCP setup (--skip-mcp)"
fi

# ============================================================================
# PHASE 3: Create Unified Configuration
# ============================================================================

print_header "PHASE 3: Unified Configuration"

print_step "Creating unified configuration file..."

cat > "$BASE_DIR/unified_config.env" <<'UNIFIEDCONF'
# LAT5150DRVMIL Unified Configuration
# Auto-generated - edit as needed

# NPU Military Configuration (auto-sourced by unified_start.sh)
export NPU_MILITARY_MODE=1
export NPU_COVERT_MODE=1
export NPU_MAX_TOPS=49.4
export NPU_SECURE_EXECUTION=1

# OpenVINO
export OPENVINO_HETERO_PRIORITY=NPU,GPU,CPU
export OV_SCALE_FACTOR=1.5

# AVX512 P-Core Pinning
export FORCE_AVX512_PCORE=1
export CPU_PCORE_MASK=0x0FFF

# Hardware Acceleration Hints
export USE_NPU_FOR_WHISPER=1
export USE_NPU_FOR_PIPER=1
export USE_GNA_FOR_WAKEWORD=1
export USE_AVX512_FOR_SHADOWGIT=1
export AGENT_COMM_USE_AVX512=1

# Paths
export AI_ENGINE_DIR="$BASE_DIR/02-ai-engine"
export MCP_DIR="$BASE_DIR/.mcp"

# Service Ports
export REDIS_PORT=6379
export GUI_PORT=5050
export VLLM_PORT=8000

echo "✓ Unified configuration loaded"
UNIFIEDCONF

# Replace $BASE_DIR with actual path
sed -i "s|\$BASE_DIR|$BASE_DIR|g" "$BASE_DIR/unified_config.env"

print_success "Configuration created: $BASE_DIR/unified_config.env"

# ============================================================================
# PHASE 4: Create Desktop Shortcuts (Optional)
# ============================================================================

print_header "PHASE 4: Desktop Integration"

if [ -d "$HOME/Desktop" ] || [ -d "$HOME/.local/share/applications" ]; then
    print_step "Creating desktop shortcuts..."

    DESKTOP_DIR="$HOME/.local/share/applications"
    mkdir -p "$DESKTOP_DIR"

    # Startup shortcut
    cat > "$DESKTOP_DIR/lat5150-ai-platform.desktop" <<DESKTOP1
[Desktop Entry]
Type=Application
Name=LAT5150 AI Platform
Comment=Start unified AI platform with NPU/GNA
Exec=gnome-terminal -- bash -c "cd $BASE_DIR && ./unified_start.sh --gui; exec bash"
Icon=computer
Terminal=true
Categories=Development;AI;
DESKTOP1

    chmod +x "$DESKTOP_DIR/lat5150-ai-platform.desktop"
    print_success "Desktop shortcuts created"
else
    print_warning "Desktop directory not found - skipping shortcuts"
fi

# ============================================================================
# PHASE 5: Final Validation
# ============================================================================

print_header "PHASE 5: Validation"

print_step "Validating installation..."

VALIDATION_PASS=true

# Check Python
if command -v python3 &> /dev/null; then
    PYTHON_VERSION=$(python3 --version | awk '{print $2}')
    print_success "Python $PYTHON_VERSION"
else
    print_error "Python not found"
    VALIDATION_PASS=false
fi

# Check Redis
if command -v redis-server &> /dev/null; then
    print_success "Redis installed"
else
    print_warning "Redis not found - binary protocol will use fallback"
fi

# Check PostgreSQL
if command -v psql &> /dev/null; then
    print_success "PostgreSQL installed"
else
    print_warning "PostgreSQL not found - conversation history disabled"
fi

# Check OpenVINO
if python3 -c "import openvino" 2>/dev/null; then
    OV_VERSION=$(python3 -c "import openvino as ov; print(ov.__version__)" 2>/dev/null)
    print_success "OpenVINO $OV_VERSION"
else
    print_warning "OpenVINO not available - NPU/GNA disabled"
fi

# Check AI engine files
if [ -f "$AI_ENGINE_DIR/comprehensive_98_agent_system.py" ]; then
    print_success "98-agent system ready"
else
    print_error "98-agent system not found"
    VALIDATION_PASS=false
fi

# Check unified startup
if [ -f "$BASE_DIR/unified_start.sh" ]; then
    print_success "Unified startup script ready"
else
    print_error "Unified startup script not found"
    VALIDATION_PASS=false
fi

echo ""

if [ "$VALIDATION_PASS" = true ]; then
    print_success "All critical components validated"
else
    print_error "Some critical components are missing"
    echo ""
    echo "Please review errors above and re-run setup if needed"
fi

# ============================================================================
# Summary
# ============================================================================

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Setup Complete!                                               ${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo ""

echo -e "${CYAN}Quick Start:${NC}"
echo ""
echo "  1. Start entire platform:"
echo "     ${YELLOW}./unified_start.sh --gui${NC}"
echo ""
echo "  2. Start with voice UI:"
echo "     ${YELLOW}./unified_start.sh --gui --voice${NC}"
echo ""
echo "  3. Start without GUI (terminal only):"
echo "     ${YELLOW}./unified_start.sh${NC}"
echo ""

echo -e "${CYAN}Manual Configuration:${NC}"
echo "  Edit:    $BASE_DIR/unified_config.env"
echo "  AI Cfg:  $AI_ENGINE_DIR/unified_config.json"
echo "  NPU Cfg: $AI_ENGINE_DIR/npu-military-build.env"
echo ""

echo -e "${CYAN}Individual Components:${NC}"
echo "  AI Engine:   cd $AI_ENGINE_DIR && ./start_ai_server.sh"
echo "  MCP Servers: cd $MCP_DIR && ./start_servers.sh"
echo "  GUI Only:    cd $AI_ENGINE_DIR && python3 ai_gui_dashboard.py"
echo ""

echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
echo ""
