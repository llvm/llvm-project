#!/bin/bash
# orchestrate-completion.sh
# Master orchestration script for final project completion
# Generated by: PROJECTORCHESTRATOR Agent (Claude Agent Framework v7.0)
# Date: 2025-10-11

set -euo pipefail

PROJECT_ROOT="/home/john/LAT5150DRVMIL"
LOG_DIR="$PROJECT_ROOT/99-archive/orchestration-logs"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
MASTER_LOG="$LOG_DIR/orchestration-$TIMESTAMP.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Create log directory
mkdir -p "$LOG_DIR"

# Logging function
log() {
  echo -e "$1" | tee -a "$MASTER_LOG"
}

# Error handler
error_exit() {
  log "${RED}ERROR: $1${NC}"
  log "Check log: $MASTER_LOG"
  exit 1
}

# Success message
success() {
  log "${GREEN}✓ $1${NC}"
}

# Warning message
warn() {
  log "${YELLOW}⚠ $1${NC}"
}

# Info message
info() {
  log "${BLUE}ℹ $1${NC}"
}

# Checkpoint function
run_checkpoint() {
  local checkpoint_num=$1
  local checkpoint_script="$PROJECT_ROOT/99-archive/checkpoint-$checkpoint_num.sh"

  log "\n${CYAN}═══════════════════════════════════════════════════════════════${NC}"
  log "${CYAN}Running Checkpoint $checkpoint_num${NC}"
  log "${CYAN}═══════════════════════════════════════════════════════════════${NC}"

  if [ ! -f "$checkpoint_script" ]; then
    error_exit "Checkpoint script not found: $checkpoint_script"
  fi

  if bash "$checkpoint_script"; then
    success "Checkpoint $checkpoint_num PASSED"
    return 0
  else
    error_exit "Checkpoint $checkpoint_num FAILED"
  fi
}

# Phase execution function
run_phase() {
  local phase_num=$1
  local phase_name=$2
  local duration=$3
  local start_time=$(date +%s)

  log "\n${CYAN}═══════════════════════════════════════════════════════════════${NC}"
  log "${CYAN}PHASE $phase_num: $phase_name${NC}"
  log "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
  log "Start time: $(date)"
  log "Estimated duration: $duration"
  log ""

  # Phase-specific execution would go here
  # This is a framework - actual Task() calls would be made by user

  local end_time=$(date +%s)
  local actual_duration=$((end_time - start_time))
  local mins=$((actual_duration / 60))
  local secs=$((actual_duration % 60))
  success "Phase $phase_num completed in ${mins}m ${secs}s"
}

# Display task instructions
show_task_instructions() {
  local phase=$1
  shift
  local tasks=("$@")

  log "${YELLOW}Execute these tasks in parallel:${NC}"
  log ""

  local i=1
  for task in "${tasks[@]}"; do
    log "  ${CYAN}$i.${NC} $task"
    ((i++))
  done

  log ""
  log "${YELLOW}Run these from Claude Code using the Task tool${NC}"
}

# Main orchestration flow
main() {
  log "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
  log "${CYAN}DELL MIL-SPEC PLATFORM - FINAL COMPLETION ORCHESTRATION${NC}"
  log "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
  log "Agent: PROJECTORCHESTRATOR (Claude Agent Framework v7.0)"
  log "Start time: $(date)"
  log "Project root: $PROJECT_ROOT"
  log "Log file: $MASTER_LOG"
  log ""

  # Pre-flight checks
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
  log "${BLUE}Pre-flight Checks${NC}"
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

  # Check we're in the right directory
  if [ ! -d "$PROJECT_ROOT" ]; then
    error_exit "Project directory not found: $PROJECT_ROOT"
  fi
  cd "$PROJECT_ROOT"
  success "Project directory found"

  # Check required directories exist
  for dir in 00-documentation 01-source 02-deployment 03-security 99-archive packaging; do
    if [ -d "$dir" ]; then
      success "Directory $dir exists"
    else
      error_exit "Required directory missing: $dir"
    fi
  done

  # Check git status
  if git status &>/dev/null; then
    success "Git repository healthy"
  else
    warn "Git repository check failed (continuing anyway)"
  fi

  # Create backup before starting
  log ""
  info "Creating safety backup..."
  backup_file="$HOME/LAT5150DRVMIL-orchestration-backup-$TIMESTAMP.tar.gz"
  log "Backup location: $backup_file"

  if tar -czf "$backup_file" --exclude='.git' --exclude='99-archive' . 2>/dev/null; then
    backup_size=$(du -h "$backup_file" | cut -f1)
    success "Backup created: $backup_file ($backup_size)"
  else
    warn "Backup creation failed (continuing anyway)"
  fi

  # Display project status
  log ""
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
  log "${BLUE}Current Project Status${NC}"
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

  # Count current packages
  pkg_count=$(find "$PROJECT_ROOT/packaging" -name "*.deb" -type f 2>/dev/null | wc -l)
  log "Existing packages: $pkg_count"
  if [ $pkg_count -gt 0 ]; then
    find "$PROJECT_ROOT/packaging" -name "*.deb" -type f -exec basename {} \; | while read pkg; do
      log "  - $pkg"
    done
  fi

  # Count root files
  root_files=$(find "$PROJECT_ROOT" -maxdepth 1 -type f | wc -l)
  log "Root directory files: $root_files (target: ≤10)"

  # Check old environments
  old_envs=0
  [ -d "$PROJECT_ROOT/LAT5150_DEV" ] && ((old_envs++))
  [ -d "$PROJECT_ROOT/LAT5150_PROD" ] && ((old_envs++))
  log "Old environments: $old_envs (target: 0)"

  log ""
  log "${YELLOW}════════════════════════════════════════════════════════════════${NC}"
  log "${YELLOW}Ready to execute 3-phase completion plan${NC}"
  log "${YELLOW}Total estimated time: 105 minutes (1h 45m)${NC}"
  log "${YELLOW}════════════════════════════════════════════════════════════════${NC}"
  log ""
  read -p "Press Enter to begin Phase 1, or Ctrl+C to abort..."

  # ═══════════════════════════════════════════════════════════════
  # PHASE 1: Foundation Cleanup (30 minutes)
  # ═══════════════════════════════════════════════════════════════

  run_phase 1 "Foundation Cleanup" "30 minutes"

  show_task_instructions "Phase 1" \
    "Task(subagent_type='janitor', prompt='Execute root directory cleanup: Run safe-delete-root-artifacts.sh, move 128 files to organized directories, delete obsolete files, create backup, verify structure. Target: ≤10 files in root. Deliverable: Clean root + log')" \
    "Task(subagent_type='janitor', prompt='Archive old environments: Compress LAT5150_DEV/ (25 MB) and LAT5150_PROD/ (1.3 MB) to 99-archive/, verify archives, remove originals, document. Deliverable: 2 archives + removal log')"

  log ""
  warn "Waiting for Phase 1 completion..."
  read -p "Press Enter when both Phase 1 tasks are complete..."

  # Run Checkpoint 1
  run_checkpoint 1

  # ═══════════════════════════════════════════════════════════════
  # PHASE 2: Core Package Building (45 minutes)
  # ═══════════════════════════════════════════════════════════════

  log ""
  read -p "Press Enter to begin Phase 2..."

  run_phase 2 "Core Package Building" "45 minutes"

  show_task_instructions "Phase 2" \
    "Task(subagent_type='packager', prompt='Build dell-milspec-dsmil-dkms package: Source from 01-source/kernel/dsmil/, template from deployment/debian-packages/dell-milspec-dsmil-dkms/, verify DEBIAN/control, copy sources, build .deb, test in chroot, run lintian. Target: dell-milspec-dsmil-dkms_2.1.0-1_all.deb')" \
    "Task(subagent_type='packager', prompt='Build tpm2-accel-early-dkms package: Source from tpm2_compat/c_acceleration/kernel_module/, template from deployment/debian-packages/dell-milspec-tpm2-dkms/, verify DEBIAN/control, copy sources, build .deb, test in chroot, run lintian. Target: tpm2-accel-early-dkms_1.0.0-1_all.deb')" \
    "Task(subagent_type='packager', prompt='Build tpm2-accel-examples package: Execute packaging/build_tpm2_examples_minimal.sh, verify package created, test installation, verify examples compile. Target: tpm2-accel-examples_1.0.0-1_all.deb')"

  log ""
  warn "Waiting for Phase 2 completion..."
  read -p "Press Enter when all 3 Phase 2 tasks are complete..."

  # Run Checkpoint 2
  run_checkpoint 2

  # ═══════════════════════════════════════════════════════════════
  # PHASE 3: Meta Packages (30 minutes)
  # ═══════════════════════════════════════════════════════════════

  log ""
  read -p "Press Enter to begin Phase 3..."

  run_phase 3 "Meta Packages" "30 minutes"

  show_task_instructions "Phase 3" \
    "Task(subagent_type='packager', prompt='Build dell-milspec-docs package: Create structure in deployment/debian-packages/dell-milspec-docs/, copy documentation from 00-documentation/ to usr/share/doc/dell-milspec/, create DEBIAN/control, add man page index, build .deb. Target: dell-milspec-docs_1.0.0-1_all.deb')" \
    "Task(subagent_type='packager', prompt='Build dell-milspec-meta package: Create structure in deployment/debian-packages/dell-milspec-meta/, create DEBIAN/control with dependencies (dell-milspec-dsmil-dkms, tpm2-accel-early-dkms, dell-milspec-tools, dell-milspec-docs as Recommends), build .deb. Target: dell-milspec-meta_1.0.0-1_all.deb')" \
    "Task(subagent_type='packager', prompt='Build thermal-guardian package: Copy thermal_guardian.py to usr/local/bin/, thermal-guardian.service to lib/systemd/system/, thermal_guardian.conf to etc/dell-milspec/, create DEBIAN/postinst for service enable, build .deb. Target: thermal-guardian_1.0.0-1_all.deb')"

  log ""
  warn "Waiting for Phase 3 completion..."
  read -p "Press Enter when all 3 Phase 3 tasks are complete..."

  # Run Checkpoint 3 (Final)
  run_checkpoint 3

  # ═══════════════════════════════════════════════════════════════
  # COMPLETION
  # ═══════════════════════════════════════════════════════════════

  log ""
  log "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
  log "${GREEN}ORCHESTRATION COMPLETE - PROJECT 100%${NC}"
  log "${GREEN}═══════════════════════════════════════════════════════════════${NC}"

  # Final summary
  log ""
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
  log "${BLUE}Final Summary${NC}"
  log "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

  if [ -d "$PROJECT_ROOT/packaging" ]; then
    final_pkg_count=$(find "$PROJECT_ROOT/packaging" -name "*.deb" -type f | wc -l)
    log "Total packages built: ${GREEN}$final_pkg_count${NC}"
    log ""
    log "Package listing:"
    find "$PROJECT_ROOT/packaging" -name "*.deb" -type f -exec basename {} \; | sort | while read pkg; do
      size=$(du -h "$PROJECT_ROOT/packaging/$pkg" 2>/dev/null | cut -f1)
      log "  ${GREEN}✓${NC} $pkg ($size)"
    done
  fi

  # Root directory status
  final_root_files=$(find "$PROJECT_ROOT" -maxdepth 1 -type f | wc -l)
  if [ $final_root_files -le 10 ]; then
    log ""
    success "Root directory cleaned: $final_root_files files (target ≤10)"
  else
    log ""
    warn "Root directory: $final_root_files files (target was ≤10)"
  fi

  # Next steps
  log ""
  log "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
  log "${YELLOW}Next Steps${NC}"
  log "${YELLOW}═══════════════════════════════════════════════════════════════${NC}"
  log ""
  log "1. Test installation:"
  log "   ${CYAN}sudo apt install ./packaging/dell-milspec-meta_*.deb${NC}"
  log ""
  log "2. Update APT repository:"
  log "   ${CYAN}cd deployment/apt-repository && ./scripts/update-repository.sh${NC}"
  log ""
  log "3. Create release notes:"
  log "   ${CYAN}See ORCHESTRATION_PLAN.md Section X${NC}"
  log ""
  log "4. Tag release:"
  log "   ${CYAN}git tag -a v1.0.0 -m 'Production release - 100% complete'${NC}"
  log "   ${CYAN}git push origin v1.0.0${NC}"
  log ""
  log "5. Review orchestration log:"
  log "   ${CYAN}less $MASTER_LOG${NC}"

  # Completion time
  log ""
  log "End time: $(date)"
  log "Log saved: $MASTER_LOG"

  log ""
  log "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
  log "${GREEN}✓✓✓ PROJECT 100% COMPLETE ✓✓✓${NC}"
  log "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
}

# Run orchestration
main "$@"
