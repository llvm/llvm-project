#!/bin/bash
# Checkpoint 2: Core Packages Validation
# Generated by: PROJECTORCHESTRATOR Agent
# Purpose: Validate Phase 2 (DKMS packages + examples built)

set -euo pipefail

PROJECT_ROOT="/home/john/LAT5150DRVMIL"
PACKAGING_DIR="$PROJECT_ROOT/packaging"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "═══════════════════════════════════════════════════════════════"
echo "Checkpoint 2: Core Packages Validation"
echo "═══════════════════════════════════════════════════════════════"

cd "$PACKAGING_DIR"

pass_count=0
fail_count=0

# Check 1: Required packages exist
echo -e "\n[Check 1] Required packages built..."
required_packages=(
  "dell-milspec-tools_1.0.0-1_amd64.deb"
  "dell-milspec-dsmil-dkms_2.1.0-1_all.deb"
  "tpm2-accel-early-dkms_1.0.0-1_all.deb"
  "tpm2-accel-examples_1.0.0-1_all.deb"
)

pkgs_found=0
for pkg in "${required_packages[@]}"; do
  if [ -f "$pkg" ]; then
    size=$(du -h "$pkg" | cut -f1)
    echo -e "  ${GREEN}✓${NC} $pkg ($size)"
    ((pkgs_found++))
  else
    echo -e "  ${RED}✗${NC} $pkg (MISSING)"
  fi
done

if [ $pkgs_found -eq ${#required_packages[@]} ]; then
  echo -e "${GREEN}✓ PASS${NC}: All $pkgs_found required packages exist"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Only $pkgs_found/${#required_packages[@]} packages found"
  ((fail_count++))
fi

# Check 2: Packages are valid .deb files
echo -e "\n[Check 2] Package integrity..."
valid_debs=0
for pkg in *.deb; do
  if [ -f "$pkg" ]; then
    if dpkg-deb --info "$pkg" &>/dev/null; then
      ((valid_debs++))
    else
      echo -e "  ${RED}✗${NC} $pkg is corrupted"
    fi
  fi
done

if [ $valid_debs -eq $pkgs_found ]; then
  echo -e "${GREEN}✓ PASS${NC}: All $valid_debs packages are valid .deb files"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Only $valid_debs/$pkgs_found packages are valid"
  ((fail_count++))
fi

# Check 3: DKMS packages contain kernel sources
echo -e "\n[Check 3] DKMS packages content..."
dkms_ok=0
for pkg in *-dkms_*.deb; do
  if [ -f "$pkg" ]; then
    if dpkg-deb --contents "$pkg" | grep -q "usr/src/"; then
      echo -e "  ${GREEN}✓${NC} $pkg contains kernel sources"
      ((dkms_ok++))
    else
      echo -e "  ${RED}✗${NC} $pkg missing kernel sources"
    fi
  fi
done

if [ $dkms_ok -ge 2 ]; then
  echo -e "${GREEN}✓ PASS${NC}: DKMS packages contain kernel sources"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: DKMS packages missing sources"
  ((fail_count++))
fi

# Check 4: DKMS configs present
echo -e "\n[Check 4] DKMS configurations..."
dkms_conf_ok=0
for pkg in *-dkms_*.deb; do
  if [ -f "$pkg" ]; then
    if dpkg-deb --contents "$pkg" | grep -q "dkms.conf"; then
      ((dkms_conf_ok++))
    else
      echo -e "  ${RED}✗${NC} $pkg missing dkms.conf"
    fi
  fi
done

if [ $dkms_conf_ok -ge 2 ]; then
  echo -e "${GREEN}✓ PASS${NC}: DKMS configurations present"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: DKMS configurations missing"
  ((fail_count++))
fi

# Check 5: Lintian check (warnings OK, errors not OK)
echo -e "\n[Check 5] Debian policy compliance..."
if command -v lintian &>/dev/null; then
  lintian_ok=0
  for pkg in *-dkms_*.deb; do
    if [ -f "$pkg" ]; then
      errors=$(lintian "$pkg" 2>&1 | grep -c "^E:" || true)
      if [ $errors -eq 0 ]; then
        echo -e "  ${GREEN}✓${NC} $pkg passes lintian (no errors)"
        ((lintian_ok++))
      else
        echo -e "  ${RED}✗${NC} $pkg has $errors lintian error(s)"
        lintian "$pkg" 2>&1 | grep "^E:"
      fi
    fi
  done

  if [ $lintian_ok -ge 2 ]; then
    echo -e "${GREEN}✓ PASS${NC}: Packages pass lintian"
    ((pass_count++))
  else
    echo -e "${YELLOW}⚠ WARN${NC}: Some packages have lintian errors (may be OK)"
    ((pass_count++))
  fi
else
  echo -e "${YELLOW}⚠ SKIP${NC}: lintian not installed"
  ((pass_count++))
fi

# Summary
echo -e "\n═══════════════════════════════════════════════════════════════"
echo "Checkpoint 2 Summary"
echo "═══════════════════════════════════════════════════════════════"
echo -e "Packages found: $pkgs_found"
echo -e "Valid .deb files: $valid_debs"
echo -e "Passed checks: ${GREEN}$pass_count${NC}"
echo -e "Failed checks: ${RED}$fail_count${NC}"

# Package listing
echo -e "\nPackage Details:"
for pkg in *.deb; do
  if [ -f "$pkg" ]; then
    name=$(dpkg-deb -f "$pkg" Package 2>/dev/null || echo "unknown")
    version=$(dpkg-deb -f "$pkg" Version 2>/dev/null || echo "unknown")
    arch=$(dpkg-deb -f "$pkg" Architecture 2>/dev/null || echo "unknown")
    size=$(du -h "$pkg" | cut -f1)
    printf "  %-35s %-15s %-10s %s\n" "$name" "$version" "$arch" "$size"
  fi
done

if [ $fail_count -eq 0 ]; then
  echo -e "\n${GREEN}✓ CHECKPOINT 2: PASSED${NC}"
  echo "Proceed to Phase 3: Meta Packages"
  exit 0
else
  echo -e "\n${RED}✗ CHECKPOINT 2: FAILED${NC}"
  echo "Fix package issues before proceeding to Phase 3"
  exit 1
fi
