#!/bin/bash
# Checkpoint 1: Foundation Validation
# Generated by: PROJECTORCHESTRATOR Agent
# Purpose: Validate Phase 1 (Root cleanup + Archive old environments)

set -euo pipefail

PROJECT_ROOT="/home/john/LAT5150DRVMIL"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "═══════════════════════════════════════════════════════════════"
echo "Checkpoint 1: Foundation Validation"
echo "═══════════════════════════════════════════════════════════════"

cd "$PROJECT_ROOT"

pass_count=0
fail_count=0

# Check 1: Root directory cleaned
echo -e "\n[Check 1] Root directory file count..."
root_file_count=$(find "$PROJECT_ROOT" -maxdepth 1 -type f | wc -l)
if [ $root_file_count -le 10 ]; then
  echo -e "${GREEN}✓ PASS${NC}: Root directory clean ($root_file_count files, target ≤10)"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Root directory cluttered ($root_file_count files, target ≤10)"
  ((fail_count++))
fi

# Check 2: No scripts in root
echo -e "\n[Check 2] Scripts moved from root..."
script_count=$(find "$PROJECT_ROOT" -maxdepth 1 \( -name "*.sh" -o -name "*.py" \) | wc -l)
if [ $script_count -eq 0 ]; then
  echo -e "${GREEN}✓ PASS${NC}: No scripts in root directory"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Scripts still in root ($script_count found)"
  find "$PROJECT_ROOT" -maxdepth 1 \( -name "*.sh" -o -name "*.py" \)
  ((fail_count++))
fi

# Check 3: Old environments removed
echo -e "\n[Check 3] Old environments archived..."
if [ ! -d "$PROJECT_ROOT/LAT5150_DEV" ] && [ ! -d "$PROJECT_ROOT/LAT5150_PROD" ]; then
  echo -e "${GREEN}✓ PASS${NC}: Old environments removed (LAT5150_DEV, LAT5150_PROD)"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Old environments still present"
  ls -d "$PROJECT_ROOT"/LAT5150_* 2>/dev/null || true
  ((fail_count++))
fi

# Check 4: Archives created
echo -e "\n[Check 4] Archives created in 99-archive..."
archive_count=0
[ -f "$PROJECT_ROOT/99-archive/LAT5150_DEV.tar.gz" ] && ((archive_count++))
[ -f "$PROJECT_ROOT/99-archive/LAT5150_PROD.tar.gz" ] && ((archive_count++))

if [ $archive_count -ge 1 ]; then
  echo -e "${GREEN}✓ PASS${NC}: Archives created ($archive_count found)"
  ls -lh "$PROJECT_ROOT/99-archive"/*.tar.gz 2>/dev/null || true
  ((pass_count++))
else
  echo -e "${YELLOW}⚠ WARN${NC}: No archives found (may have been cleaned differently)"
  ((pass_count++))
fi

# Check 5: Organized directories intact
echo -e "\n[Check 5] Organized directories present..."
dirs_ok=0
for dir in 00-documentation 01-source 02-deployment 03-security 99-archive; do
  if [ -d "$PROJECT_ROOT/$dir" ]; then
    ((dirs_ok++))
  else
    echo -e "${RED}✗ Missing directory: $dir${NC}"
  fi
done

if [ $dirs_ok -eq 5 ]; then
  echo -e "${GREEN}✓ PASS${NC}: All 5 organized directories present"
  ((pass_count++))
else
  echo -e "${RED}✗ FAIL${NC}: Only $dirs_ok/5 organized directories present"
  ((fail_count++))
fi

# Summary
echo -e "\n═══════════════════════════════════════════════════════════════"
echo "Checkpoint 1 Summary"
echo "═══════════════════════════════════════════════════════════════"
echo -e "Passed: ${GREEN}$pass_count${NC}"
echo -e "Failed: ${RED}$fail_count${NC}"

if [ $fail_count -eq 0 ]; then
  echo -e "\n${GREEN}✓ CHECKPOINT 1: PASSED${NC}"
  echo "Proceed to Phase 2: Core Package Building"
  exit 0
else
  echo -e "\n${RED}✗ CHECKPOINT 1: FAILED${NC}"
  echo "Fix issues before proceeding to Phase 2"
  exit 1
fi
