<!--
Heretic Abliteration Panel - DSMIL TEMPEST Web Interface
Model abliteration configuration and management
-->

<div class="heretic-panel" id="hereticPanel" style="display: none;">
    <div class="panel-header">
        <h2>üî¨ HERETIC - Model Abliteration System</h2>
        <p class="subtitle">Remove safety constraints via directional ablation</p>
    </div>

    <!-- Status Banner -->
    <div class="status-banner" id="hereticStatusBanner">
        <div class="status-indicator" id="hereticStatusIndicator"></div>
        <span id="hereticStatusText">Loading...</span>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button active" onclick="switchHereticTab('config')">Configuration</button>
        <button class="tab-button" onclick="switchHereticTab('abliterate')">Abliterate Model</button>
        <button class="tab-button" onclick="switchHereticTab('evaluate')">Evaluate</button>
        <button class="tab-button" onclick="switchHereticTab('models')">Models</button>
        <button class="tab-button" onclick="switchHereticTab('datasets')">Datasets</button>
    </div>

    <!-- Configuration Tab -->
    <div class="tab-content active" id="configTab">
        <h3>Optimization Configuration</h3>

        <div class="config-section">
            <div class="form-group">
                <label for="nTrials">Number of Trials:</label>
                <input type="number" id="nTrials" value="200" min="50" max="1000" step="50">
                <span class="help-text">More trials = better optimization (longer runtime)</span>
            </div>

            <div class="form-group">
                <label for="startupTrials">Startup Trials (Random Exploration):</label>
                <input type="number" id="startupTrials" value="60" min="20" max="200" step="10">
                <span class="help-text">Initial random sampling phase</span>
            </div>

            <div class="form-group">
                <label for="maxBatchSize">Maximum Batch Size:</label>
                <input type="number" id="maxBatchSize" value="128" min="8" max="256" step="8">
                <span class="help-text">GPU memory dependent</span>
            </div>

            <div class="form-group">
                <label for="klScale">KL Divergence Scale:</label>
                <input type="number" id="klScale" value="1.0" min="0.1" max="10.0" step="0.1">
                <span class="help-text">Normalization factor for capability preservation</span>
            </div>

            <button class="btn btn-primary" onclick="saveHereticConfig()">üíæ Save Configuration</button>
            <button class="btn btn-secondary" onclick="loadHereticConfig()">üîÑ Reload</button>
        </div>

        <div class="config-info" id="configInfo">
            <h4>Current Configuration</h4>
            <pre id="configDisplay">Loading...</pre>
        </div>
    </div>

    <!-- Abliterate Tab -->
    <div class="tab-content" id="abliterateTab">
        <h3>Model Abliteration Workflow</h3>

        <div class="abliteration-section">
            <div class="form-group">
                <label for="modelSelect">Select Model:</label>
                <select id="modelSelect">
                    <option value="uncensored_code">Uncensored Code (34B)</option>
                    <option value="large">Large (70B)</option>
                    <option value="quality_code">Quality Code (7B)</option>
                    <option value="code">Code (6.7B)</option>
                    <option value="fast">Fast (1.5B)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="abliterateTrials">Optimization Trials:</label>
                <input type="number" id="abliterateTrials" value="200" min="50" max="500" step="50">
                <span class="help-text">Uses configured settings above</span>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="saveModel" checked>
                    Save abliterated model
                </label>
            </div>

            <button class="btn btn-primary btn-large" onclick="startAbliteration()">
                üöÄ Start Abliteration
            </button>
        </div>

        <div class="job-status" id="jobStatus" style="display: none;">
            <h4>Abliteration Progress</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p class="status-text" id="statusText">Starting...</p>
            <div class="job-details" id="jobDetails"></div>
        </div>

        <div class="recent-jobs" id="recentJobs">
            <h4>Recent Abliteration Jobs</h4>
            <div id="jobsList">No jobs yet</div>
        </div>
    </div>

    <!-- Evaluate Tab -->
    <div class="tab-content" id="evaluateTab">
        <h3>Model Safety Evaluation</h3>

        <div class="evaluation-section">
            <div class="form-group">
                <label for="evalModel">Model to Evaluate:</label>
                <select id="evalModel">
                    <option value="uncensored_code">Uncensored Code (34B)</option>
                    <option value="large">Large (70B)</option>
                    <option value="quality_code">Quality Code (7B)</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="evaluateModel()">
                üîç Run Evaluation
            </button>
        </div>

        <div class="evaluation-results" id="evaluationResults" style="display: none;">
            <h4>Evaluation Results</h4>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Refusal Count</div>
                    <div class="metric-value" id="refusalCount">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Refusal Rate</div>
                    <div class="metric-value" id="refusalRate">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">KL Divergence</div>
                    <div class="metric-value" id="klDivergence">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Model Fidelity</div>
                    <div class="metric-value" id="modelFidelity">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Models Tab -->
    <div class="tab-content" id="modelsTab">
        <h3>Abliterated Models</h3>

        <button class="btn btn-secondary" onclick="refreshModelsList()">üîÑ Refresh</button>

        <div class="models-list" id="modelsList">
            <p class="loading">Loading models...</p>
        </div>
    </div>

    <!-- Datasets Tab -->
    <div class="tab-content" id="datasetsTab">
        <h3>Available Datasets</h3>

        <div class="datasets-section">
            <h4>Registered Datasets</h4>
            <div id="registeredDatasets">Loading...</div>

            <h4>Custom Prompt Sets</h4>
            <div id="customDatasets">Loading...</div>
        </div>

        <button class="btn btn-secondary" onclick="refreshDatasets()">üîÑ Refresh</button>
    </div>
</div>

<style>
.heretic-panel {
    padding: 20px;
    background: #1a1a1a;
    color: #e0e0e0;
    border-radius: 8px;
    margin: 20px 0;
}

.panel-header {
    margin-bottom: 20px;
    border-bottom: 2px solid #00ff00;
    padding-bottom: 10px;
}

.panel-header h2 {
    margin: 0;
    color: #00ff00;
    font-size: 24px;
}

.subtitle {
    color: #888;
    margin: 5px 0 0 0;
    font-size: 14px;
}

.status-banner {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #2a2a2a;
    border-radius: 4px;
    margin-bottom: 20px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
}

.status-indicator.active {
    background: #00ff00;
}

.status-indicator.inactive {
    background: #ff0000;
}

.tab-navigation {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
    border-bottom: 1px solid #333;
}

.tab-button {
    padding: 10px 20px;
    background: #2a2a2a;
    border: none;
    color: #e0e0e0;
    cursor: pointer;
    border-radius: 4px 4px 0 0;
    transition: background 0.3s;
}

.tab-button:hover {
    background: #3a3a3a;
}

.tab-button.active {
    background: #00ff00;
    color: #000;
}

.tab-content {
    display: none;
    padding: 20px;
    background: #2a2a2a;
    border-radius: 4px;
    min-height: 400px;
}

.tab-content.active {
    display: block;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #00ff00;
    font-weight: bold;
}

.form-group input[type="number"],
.form-group input[type="text"],
.form-group select {
    width: 100%;
    max-width: 400px;
    padding: 8px;
    background: #1a1a1a;
    border: 1px solid #444;
    color: #e0e0e0;
    border-radius: 4px;
}

.help-text {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #888;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.btn-primary {
    background: #00ff00;
    color: #000;
}

.btn-primary:hover {
    background: #00cc00;
}

.btn-secondary {
    background: #444;
    color: #e0e0e0;
}

.btn-secondary:hover {
    background: #555;
}

.btn-large {
    font-size: 16px;
    padding: 15px 30px;
}

.config-info {
    margin-top: 30px;
    padding: 20px;
    background: #1a1a1a;
    border-radius: 4px;
}

.config-info pre {
    background: #0a0a0a;
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
    color: #00ff00;
    font-family: monospace;
}

.progress-bar {
    width: 100%;
    height: 30px;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
    margin: 20px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff00, #00cc00);
    transition: width 0.5s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    font-weight: bold;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.metric-card {
    background: #1a1a1a;
    padding: 20px;
    border-radius: 4px;
    text-align: center;
}

.metric-label {
    color: #888;
    font-size: 12px;
    margin-bottom: 10px;
}

.metric-value {
    color: #00ff00;
    font-size: 32px;
    font-weight: bold;
}

.models-list {
    margin-top: 20px;
}

.model-card {
    background: #1a1a1a;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 4px;
    border-left: 4px solid #00ff00;
}

.model-card h4 {
    margin: 0 0 10px 0;
    color: #00ff00;
}

.model-card p {
    margin: 5px 0;
    color: #888;
    font-size: 14px;
}

.loading {
    text-align: center;
    color: #888;
    padding: 40px;
}
</style>

<script>
// Heretic Panel JavaScript Functions

function switchHereticTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('#hereticPanel .tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active class from all buttons
    document.querySelectorAll('#hereticPanel .tab-button').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');

    // Load data for tab
    if (tabName === 'config') {
        loadHereticConfig();
    } else if (tabName === 'models') {
        refreshModelsList();
    } else if (tabName === 'datasets') {
        refreshDatasets();
    } else if (tabName === 'abliterate') {
        loadRecentJobs();
    }
}

async function loadHereticStatus() {
    try {
        const response = await fetch('/api/heretic/status');
        const data = await response.json();

        const indicator = document.getElementById('hereticStatusIndicator');
        const text = document.getElementById('hereticStatusText');

        if (data.available) {
            indicator.className = 'status-indicator active';
            text.textContent = `Heretic Active - ${data.active_jobs} jobs, ${data.jobs_running} running`;
        } else {
            indicator.className = 'status-indicator inactive';
            text.textContent = 'Heretic Unavailable';
        }
    } catch (error) {
        console.error('Failed to load Heretic status:', error);
    }
}

async function loadHereticConfig() {
    try {
        const response = await fetch('/api/heretic/config');
        const config = await response.json();

        document.getElementById('nTrials').value = config.optimization.n_trials;
        document.getElementById('startupTrials').value = config.optimization.n_startup_trials;
        document.getElementById('maxBatchSize').value = config.optimization.max_batch_size;
        document.getElementById('klScale').value = config.optimization.kl_divergence_scale;

        document.getElementById('configDisplay').textContent = JSON.stringify(config, null, 2);
    } catch (error) {
        console.error('Failed to load config:', error);
        alert('Failed to load configuration');
    }
}

async function saveHereticConfig() {
    try {
        const config = {
            n_trials: parseInt(document.getElementById('nTrials').value),
            n_startup_trials: parseInt(document.getElementById('startupTrials').value),
            max_batch_size: parseInt(document.getElementById('maxBatchSize').value),
            kl_divergence_scale: parseFloat(document.getElementById('klScale').value)
        };

        const response = await fetch('/api/heretic/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });

        const result = await response.json();
        alert('Configuration saved successfully!');
        loadHereticConfig();
    } catch (error) {
        console.error('Failed to save config:', error);
        alert('Failed to save configuration');
    }
}

async function startAbliteration() {
    try {
        const model = document.getElementById('modelSelect').value;
        const trials = parseInt(document.getElementById('abliterateTrials').value);
        const save = document.getElementById('saveModel').checked;

        const response = await fetch('/api/heretic/abliterate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model, trials, save})
        });

        const result = await response.json();

        if (result.job_id) {
            alert(`Abliteration started! Job ID: ${result.job_id}`);
            document.getElementById('jobStatus').style.display = 'block';
            monitorJob(result.job_id);
        }
    } catch (error) {
        console.error('Failed to start abliteration:', error);
        alert('Failed to start abliteration');
    }
}

async function monitorJob(jobId) {
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/heretic/abliterate/${jobId}`);
            const job = await response.json();

            document.getElementById('statusText').textContent = `Status: ${job.status}`;
            document.getElementById('progressFill').style.width = `${job.progress}%`;

            if (job.status === 'completed' || job.status === 'failed') {
                clearInterval(interval);
                document.getElementById('jobDetails').textContent = JSON.stringify(job.result || job.error, null, 2);
            }
        } catch (error) {
            console.error('Failed to monitor job:', error);
            clearInterval(interval);
        }
    }, 2000);
}

async function evaluateModel() {
    try {
        const model = document.getElementById('evalModel').value;

        const response = await fetch('/api/heretic/evaluate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model})
        });

        const result = await response.json();

        document.getElementById('evaluationResults').style.display = 'block';
        document.getElementById('refusalCount').textContent = result.total_prompts || '-';
        document.getElementById('refusalRate').textContent = result.evaluation || 'N/A';
        document.getElementById('klDivergence').textContent = '-';
        document.getElementById('modelFidelity').textContent = '-';
    } catch (error) {
        console.error('Failed to evaluate model:', error);
        alert('Failed to evaluate model');
    }
}

async function refreshModelsList() {
    try {
        const response = await fetch('/api/heretic/models');
        const data = await response.json();

        const list = document.getElementById('modelsList');

        if (data.count === 0) {
            list.innerHTML = '<p class="loading">No abliterated models found</p>';
            return;
        }

        list.innerHTML = data.models.map(model => `
            <div class="model-card">
                <h4>${model.name}</h4>
                <p>Path: ${model.path}</p>
                <p>Metadata: ${JSON.stringify(model.metadata).substring(0, 100)}...</p>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load models:', error);
    }
}

async function refreshDatasets() {
    try {
        const response = await fetch('/api/heretic/datasets');
        const data = await response.json();

        document.getElementById('registeredDatasets').innerHTML = data.registered.map(d =>
            `<div>${d.name} (${d.type}, ${d.split})</div>`
        ).join('');

        document.getElementById('customDatasets').innerHTML = data.custom.map(d =>
            `<div>${d.name}: ${d.good_count} good, ${d.bad_count} bad prompts</div>`
        ).join('');
    } catch (error) {
        console.error('Failed to load datasets:', error);
    }
}

async function loadRecentJobs() {
    try {
        const response = await fetch('/api/heretic/abliterate/jobs');
        const data = await response.json();

        const list = document.getElementById('jobsList');

        if (data.jobs.length === 0) {
            list.innerHTML = 'No jobs yet';
            return;
        }

        list.innerHTML = data.jobs.map(job => `
            <div>${job.job_id} - ${job.model} - ${job.status} (${job.started_at})</div>
        `).join('');
    } catch (error) {
        console.error('Failed to load jobs:', error);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadHereticStatus();
    setInterval(loadHereticStatus, 5000); // Update every 5 seconds
});
</script>
