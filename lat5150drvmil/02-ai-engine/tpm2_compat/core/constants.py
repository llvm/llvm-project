#!/usr/bin/env python3
"""
Constants and Configuration for TPM2 Compatibility Layer
Centralized constants, magic values, and configuration settings

Author: C-INTERNAL Agent
Date: 2025-09-23
Classification: UNCLASSIFIED // FOR OFFICIAL USE ONLY
"""

# ===== Hardware Constants =====

# Intel ME Configuration
ME_BASE_ADDR = 0xFED1A000
ME_REGION_SIZE = 0x1000
ME_DEVICE_PATH = "/dev/mei0"

# ME Registers
ME_H_CSR = 0x04          # Host Control Status Register
ME_ME_CSR_HA = 0x0C      # ME Control Status Register
ME_H_GS = 0x4C           # Host General Status Register
ME_TPM_STATE = 0x40      # TPM coordination state
ME_TPM_CTRL = 0x44       # TPM coordination control

# Dell Platform-Specific Registers
DELL_ME_COMMAND_REG = 0xFED10000
DELL_ME_STATUS_REG = 0xFED10004
DELL_ME_DATA_REG = 0xFED10008
DELL_TPM_CRB_BASE = 0xFED40000
DELL_MILITARY_TOKEN_REG = 0xFED50000

# Hidden Memory Regions
DELL_HIDDEN_MEMORY_BASE = 0x52000000
DELL_HIDDEN_MEMORY_SIZE = 0x16800000

# ===== Protocol Constants =====

# ME Protocol Settings
ME_MAX_MESSAGE_SIZE = 512
ME_TIMEOUT_MS = 5000
ME_RETRY_COUNT = 3
ME_CONNECTION_TIMEOUT_MS = 10000

# TPM2 Command Tags
TPM_ST_NO_SESSIONS = 0x8001
TPM_ST_SESSIONS = 0x8002

# TPM2 Response Codes
TPM_RC_SUCCESS = 0x00000000
TPM_RC_FAILURE = 0x00000101
TPM_RC_SEQUENCE = 0x00000103
TPM_RC_INITIALIZE = 0x00000100

# ===== Military Token Constants =====

# Dell SMBIOS Token Base Path
SMBIOS_TOKEN_BASE_PATH = "/sys/devices/platform/dell-smbios.0/tokens"

# Military Token IDs
MILITARY_TOKEN_IDS = [
    "049e",  # Primary Authorization
    "049f",  # Secondary Validation
    "04a0",  # Hardware Activation
    "04a1",  # Advanced Security
    "04a2",  # System Integration
    "04a3"   # Military Validation
]

# Token State Values
TOKEN_STATE_INACTIVE = 0x00000000
TOKEN_STATE_INITIALIZING = 0x00000001
TOKEN_STATE_READY = 0x00000002
TOKEN_STATE_ACTIVE = 0x00000003
TOKEN_STATE_ERROR = 0x000000FF
TOKEN_STATE_MILITARY_PATTERN = 0x44000000
TOKEN_STATE_DEBUG_PATTERN = 0xDEADBEEF

# Token Value Ranges (security validation)
TOKEN_VALUE_RANGES = {
    0x049e: {'min': 0x00000001, 'max': 0x000000FF},
    0x049f: {'min': 0x00000100, 'max': 0x0000FFFF},
    0x04a0: {'min': 0x00010000, 'max': 0x00FFFFFF},
    0x04a1: {'min': 0x01000000, 'max': 0x0FFFFFFF},
    0x04a2: {'min': 0x10000000, 'max': 0xEFFFFFFF},
    0x04a3: {'min': 0xF0000000, 'max': 0xFFFFFFFE}
}

# ===== PCR Translation Constants =====

# Standard PCR to Hex Mapping
STANDARD_PCR_MAP = {
    # BIOS/UEFI PCRs (0-7)
    0: 0x0000, 1: 0x0001, 2: 0x0002, 3: 0x0003,
    4: 0x0004, 5: 0x0005, 6: 0x0006, 7: 0x0007,

    # OS PCRs (8-15)
    8: 0x0008, 9: 0x0009, 10: 0x000A, 11: 0x000B,
    12: 0x000C, 13: 0x000D, 14: 0x000E, 15: 0x000F,

    # Extended PCRs (16-23)
    16: 0x0010, 17: 0x0011, 18: 0x0012, 19: 0x0013,
    20: 0x0014, 21: 0x0015, 22: 0x0016, 23: 0x0017
}

# Special Configuration PCRs
SPECIAL_CONFIG_PCRS = {
    'CAFE': 0xCAFE,  # Algorithm configuration
    'BEEF': 0xBEEF,  # Extended functionality
    'DEAD': 0xDEAD,  # Debug/diagnostic
    'FACE': 0xFACE   # Factory configuration
}

# Reverse mapping
HEX_PCR_MAP = {v: k for k, v in STANDARD_PCR_MAP.items()}

# ===== Security Level Constants =====

# Security Classification Levels
SECURITY_LEVEL_NONE = 0
SECURITY_LEVEL_UNCLASSIFIED = 1
SECURITY_LEVEL_CONFIDENTIAL = 2
SECURITY_LEVEL_SECRET = 3
SECURITY_LEVEL_TOP_SECRET = 4

# Security Level Names
SECURITY_LEVEL_NAMES = {
    0: "NONE",
    1: "UNCLASSIFIED",
    2: "CONFIDENTIAL",
    3: "SECRET",
    4: "TOP_SECRET"
}

# ===== TPM Command Codes =====

TPM_CC_STARTUP = 0x00000144
TPM_CC_SHUTDOWN = 0x00000145
TPM_CC_SELF_TEST = 0x00000143
TPM_CC_GET_CAPABILITY = 0x0000017A
TPM_CC_GET_RANDOM = 0x0000017B
TPM_CC_STIR_RANDOM = 0x00000146
TPM_CC_PCR_READ = 0x0000017E
TPM_CC_PCR_EXTEND = 0x00000182
TPM_CC_PCR_EVENT = 0x0000017C
TPM_CC_CREATE_PRIMARY = 0x00000131
TPM_CC_CREATE = 0x00000153
TPM_CC_LOAD = 0x00000157
TPM_CC_LOAD_EXTERNAL = 0x00000167
TPM_CC_READ_PUBLIC = 0x00000173
TPM_CC_ACTIVATE_CREDENTIAL = 0x00000147
TPM_CC_MAKE_CREDENTIAL = 0x00000168
TPM_CC_UNSEAL = 0x0000015E
TPM_CC_OBJECT_CHANGE_AUTH = 0x00000150
TPM_CC_DUPLICATE = 0x0000014B
TPM_CC_REWRAP = 0x00000152
TPM_CC_IMPORT = 0x00000156
TPM_CC_RSA_ENCRYPT = 0x00000174
TPM_CC_RSA_DECRYPT = 0x00000159
TPM_CC_ECDH_KEY_GEN = 0x00000163
TPM_CC_ECDH_Z_GEN = 0x00000154
TPM_CC_ECC_PARAMETERS = 0x00000162
TPM_CC_ZK_2PHASE = 0x0000015B
TPM_CC_SIGN = 0x0000015D
TPM_CC_VERIFY_SIGNATURE = 0x00000177
TPM_CC_QUOTE = 0x00000158
TPM_CC_GET_SESSION_AUDIT_DIGEST = 0x0000014D
TPM_CC_GET_COMMAND_AUDIT_DIGEST = 0x0000014C
TPM_CC_GET_TIME = 0x0000014E
TPM_CC_COMMIT = 0x0000018B
TPM_CC_EC_EPHEMERAL = 0x0000018E

# ===== Algorithm Constants =====

# Hash Algorithms
TPM_ALG_SHA1 = 0x0004
TPM_ALG_SHA256 = 0x000B
TPM_ALG_SHA384 = 0x000C
TPM_ALG_SHA512 = 0x000D
TPM_ALG_SHA3_256 = 0x0027
TPM_ALG_SHA3_384 = 0x0028
TPM_ALG_SHA3_512 = 0x0029
TPM_ALG_SM3_256 = 0x0012

# Encryption Algorithms
TPM_ALG_RSA = 0x0001
TPM_ALG_ECC = 0x0023
TPM_ALG_AES = 0x0006
TPM_ALG_SM4 = 0x0013

# Key Derivation Functions
TPM_ALG_KDF1_SP800_56A = 0x0020
TPM_ALG_KDF2 = 0x0021
TPM_ALG_KDF1_SP800_108 = 0x0022

# ===== Error Codes =====

# Bridge Operation Results
BRIDGE_SUCCESS = 0
BRIDGE_ERROR_INVALID_COMMAND = 1
BRIDGE_ERROR_PCR_TRANSLATION = 2
BRIDGE_ERROR_TOKEN_VALIDATION = 3
BRIDGE_ERROR_ME_COMMUNICATION = 4
BRIDGE_ERROR_AUTHORIZATION = 5
BRIDGE_ERROR_TIMEOUT = 6

# ME Status Codes
ME_STATUS_SUCCESS = 0x00
ME_STATUS_INVALID_STATE = 0x01
ME_STATUS_NOT_READY = 0x02
ME_STATUS_TIMEOUT = 0x03
ME_STATUS_INVALID_COMMAND = 0x04
ME_STATUS_INSUFFICIENT_AUTH = 0x05
ME_STATUS_HAP_RESTRICTION = 0x06
ME_STATUS_TPM_ERROR = 0x80

# ===== Platform Information =====

# Dell Platform Identifiers
DELL_LATITUDE_5450_MILSPEC = 0x0545

# Platform String
PLATFORM_STRING = "Dell_Latitude_5450_MILSPEC"

# ME Firmware Version (HAP Mode)
ME_HAP_MODE_VERSION = 0x94000245

# ===== Audit and Logging Constants =====

# Audit Log Path
DEFAULT_AUDIT_LOG_PATH = "/var/log/military_tpm_audit.log"

# Event Types
AUDIT_EVENT_TOKEN_VALIDATION = "TOKEN_VALIDATION"
AUDIT_EVENT_AUTHORIZATION_GRANTED = "AUTHORIZATION_GRANTED"
AUDIT_EVENT_AUTHORIZATION_DENIED = "AUTHORIZATION_DENIED"
AUDIT_EVENT_AUTHORIZATION_ERROR = "AUTHORIZATION_ERROR"
AUDIT_EVENT_ME_SESSION_ESTABLISHED = "ME_SESSION_ESTABLISHED"
AUDIT_EVENT_ME_SESSION_CLOSED = "ME_SESSION_CLOSED"
AUDIT_EVENT_TPM_COMMAND_PROCESSED = "TPM_COMMAND_PROCESSED"

# ===== Performance Constants =====

# Cache TTL (seconds)
PCR_TRANSLATION_CACHE_TTL = 300
TOKEN_VALIDATION_CACHE_TTL = 300
ME_SESSION_CACHE_TTL = 3600

# Timeout Values
OPERATION_TIMEOUT_SHORT = 5.0
OPERATION_TIMEOUT_MEDIUM = 30.0
OPERATION_TIMEOUT_LONG = 120.0

# ===== Feature Flags =====

# Enable/disable features
ENABLE_PCR_TRANSLATION = True
ENABLE_MILITARY_TOKEN_VALIDATION = True
ENABLE_ME_COORDINATION = True
ENABLE_AUDIT_LOGGING = True
ENABLE_PERFORMANCE_MONITORING = True
ENABLE_NPU_ACCELERATION = False  # Future feature

# Debug flags
DEBUG_PCR_TRANSLATION = False
DEBUG_ME_COMMUNICATION = False
DEBUG_TOKEN_VALIDATION = False

# ===== Version Information =====

TPM2_COMPAT_VERSION = "1.0.0"
TPM2_COMPAT_BUILD_DATE = "2025-09-23"
TPM2_COMPAT_AUTHOR = "C-INTERNAL Agent"
TPM2_COMPAT_CLASSIFICATION = "UNCLASSIFIED // FOR OFFICIAL USE ONLY"